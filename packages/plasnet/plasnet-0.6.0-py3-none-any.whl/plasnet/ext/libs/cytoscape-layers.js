!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CytoscapeLayers={})}(this,(function(e){"use strict";const t={position:"absolute",left:"0",top:"0",userSelect:"none",outlineStyle:"none",width:"100%",height:"100%"};function s(e){e.stopPropagation()}function n(e){e.addEventListener("click",s),e.addEventListener("mousedown",s),e.addEventListener("mouseup",s),e.addEventListener("mousemove",s)}class i{constructor(e){this.adapter=e,this.updateOnRenderEnabled=!1,this.updateOnRenderOnceEnabled=!1,this.updateOnRenderOnce=()=>{this.updateOnRenderOnceEnabled||(this.updateOnRenderOnceEnabled=!0,this.cy.one("render",(()=>{this.updateOnRenderOnceEnabled=!1,this.update()})))}}inVisibleBounds(e){return this.adapter.inVisibleBounds(e)}supportsRender(){return!1}renderInto(e,t){}get updateOnRender(){return this.updateOnRenderEnabled}set updateOnRender(e){this.updateOnRenderEnabled!==e&&(this.updateOnRenderEnabled=e,e?this.cy.on("render",this.update):this.cy.off("render",this.update))}get cy(){return this.adapter.cy}moveUp(){this.adapter.move(this,-1)}moveDown(){this.adapter.move(this,1)}moveBack(){this.adapter.move(this,Number.NEGATIVE_INFINITY)}moveFront(){this.adapter.move(this,Number.POSITIVE_INFINITY)}insertBefore(e,t){return this.adapter.insert("before",this,e,t)}insertAfter(e,t){return this.adapter.insert("after",this,e,t)}}class r extends i{constructor(e,s){super(e),this.callbacks=[],this.update=()=>{for(const e of this.callbacks)e(this.node)},this.root=s,Object.assign(this.root.style,t)}get visible(){return"none"!==this.root.style.display}set visible(e){this.visible!==e&&(this.root.style.display=e?"":"none")}show(){this.visible=!0}hide(){this.visible=!1}callback(e){return this.callbacks.push(e),this.update(),this}resize(){}remove(){this.root.remove()}}const o="http://www.w3.org/2000/svg";class a extends r{constructor(e,t,s={}){super(e,t.createElementNS(o,"svg")),this.type="svg",this.updateOnTransform=!1,this.root.__cy_layer=this,this.node=t.createElementNS(o,"g"),this.node.__cy_layer=this,this.root.appendChild(this.node),s.stopClicks&&n(this.node)}setViewport(e,t,s){this.node.setAttribute("transform",`translate(${e},${t})scale(${s})`),this.updateOnTransform&&this.update()}supportsRender(){return 0===this.node.childElementCount}}class c extends r{constructor(e,t,s={}){super(e,t.createElementNS(o,"svg")),this.type="svg-static",this.root.__cy_layer=this,this.node=t.createElementNS(o,"g"),this.node.__cy_layer=this,this.root.appendChild(this.node),s.stopClicks&&n(this.node)}setViewport(){}}class d extends i{constructor(e,s,i={}){var r,o;super(e),this.callbacks=[],this.transform={tx:0,ty:0,zoom:1},this.update=()=>this.draw(),this.node=s.createElement("canvas"),Object.assign(this.node.style,t),i.stopClicks&&n(this.node),this.pixelRatio=null!==(o=null!==(r=i.pixelRatio)&&void 0!==r?r:(null!==window&&void 0!==window?window:{}).devicePixelRatio)&&void 0!==o?o:1,this.ctx=this.node.getContext("2d",i),this.ctx.resetTransform()}get visible(){return"none"!==this.node.style.display}set visible(e){this.node.style.display=e?"":"none"}show(){this.visible=!0}hide(){this.visible=!1}get root(){return this.node}callback(e){return this.callbacks.push(e),this.update(),this}clear(){const e=this.ctx,t=e.getTransform();e.resetTransform(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.setTransform(t)}draw(){this.clear(),this.drawImpl(this.ctx)}drawImpl(e,t=1){e.save(),e.resetTransform(),e.scale(this.pixelRatio,this.pixelRatio),e.translate(this.transform.tx*t,this.transform.ty*t),e.scale(this.transform.zoom*t,this.transform.zoom*t);for(const t of this.callbacks)t(e);e.restore()}supportsRender(){return!0}renderInto(e,t){this.drawImpl(e,t.scale)}resize(e,t){this.node.width=e*this.pixelRatio,this.node.height=t*this.pixelRatio,this.update()}setViewport(e,t,s){}remove(){this.node.remove()}}class h extends d{constructor(e,t,s={}){super(e,t,s),this.type="canvas",this.node.__cy_layer=this}setViewport(e,t,s){this.transform.tx=e,this.transform.ty=t,this.transform.zoom=s,this.update()}}class l extends d{constructor(e,t,s={}){super(e,t,s),this.type="canvas-static",this.node.__cy_layer=this}}class u extends r{constructor(e,t,s={}){super(e,t.createElement("div")),this.type="html",this.updateOnTransform=!1,this.root.__cy_layer=this,this.node=t.createElement("div"),this.node.__cy_layer=this,this.node.style.position="absolute",this.node.style.left="0px",this.node.style.top="0px",this.root.appendChild(this.node),s.stopClicks&&n(this.node)}setViewport(e,t,s){this.node.style.transform=`translate(${e}px,${t}px)scale(${s})`,this.updateOnTransform&&this.update()}supportsRender(){return 0===this.node.childElementCount}}class p extends r{constructor(e,t,s={}){super(e,t.createElement("div")),this.type="html-static",this.node.__cy_layer=this,s.stopClicks&&n(this.node)}get node(){return this.root}setViewport(){}}class y extends i{constructor(e,t){super(e),this.update=()=>{},this.node=t}get root(){return this.node}resize(){}setViewport(){}remove(){}supportsRender(){return!0}}class f extends y{constructor(e,t){super(e,t),this.type="node",this.node.__cy_layer=this}}class m extends y{constructor(e,t){super(e,t),this.type="drag",this.node.__cy_layer=this}}class g extends y{constructor(e,t){super(e,t),this.type="select-box",this.node.__cy_layer=this}}function v(e,t,s){const n=Array.from(e.children);if(!s.uniqueElements){t.forEach((t=>{const i=s.bb(t);if(s.isVisible(i))if(n.length>0)s.update(n.shift(),t,i);else{const n=s.enter(t,i);e.appendChild(n),s.update(n,t,i)}}));for(const e of n)e.remove();return}const i=new Map(n.map((e=>[e.dataset.id,e])));let r=-1;t.forEach((t=>{const o=s.bb(t);if(!s.isVisible(o))return;r++;const a=t.id(),c=n[r],d=i.get(a);let h;if(d){if(s.update(d,t,o),i.delete(a),c===d)return;h=d}else h=s.enter(t,o),h.dataset.id=a,s.update(h,t,o);0===r?e.insertAdjacentElement("afterbegin",h):n[r-1].insertAdjacentElement("afterend",h),n.splice(r,0,h)})),i.forEach((e=>e.remove()))}function b(e,t){return e.callback(t),{remove:()=>{e.callbacks.splice(e.callbacks.indexOf(t),1)}}}function x(e){return{selector:":visible",updateOn:null!=e&&e.queryEachTime?"render":"position",queryEachTime:!1,checkBounds:!0}}function w(e,t,s){const n=Object.assign({checkBoundsPointCount:5,initCollection:()=>{}},x(s),s),i=n.queryEachTime?e.cy.collection():e.cy.edges(n.selector);n.queryEachTime||n.initCollection(i),"render"===n.updateOn?e.updateOnRender=!0:"position"===n.updateOn?(i.on("position add remove",e.updateOnRenderOnce),i.sources().on("position",e.updateOnRenderOnce),i.targets().on("position",e.updateOnRenderOnce)):i.on("add remove",e.updateOnRenderOnce);const r=b(e,(s=>{const r=n.queryEachTime?e.cy.edges(n.selector):i;n.queryEachTime&&n.initCollection(r),r.forEach((i=>{const r=i._private.rscratch,o=r&&null!=r.startX&&null!=r.startY?{x:r.startX,y:r.startY}:i.sourceEndpoint(),a=r&&null!=r.endX&&null!=r.endY?{x:r.endX,y:r.endY}:i.targetEndpoint();if(n.checkBounds&&n.checkBoundsPointCount>0&&!function(e,t,s,n){const i=e=>({x:t.x*e+s.x*(1-e),y:t.y*e+s.y*(1-e)});if(1===n)return e.inVisibleBounds(i(.5));const r=1/n;for(let t=0;t<=n;t++)if(e.inVisibleBounds(i(t*r)))return!0;return!1}(e,o,a,n.checkBoundsPointCount))return;if(r&&r.pathCache)return void t(s,i,r.pathCache,o,a);const c=new Path2D;c.moveTo(o.x,o.y),c.lineTo(a.x,a.y),t(s,i,c,o,a)}))}));return{layer:e,edges:i,remove:()=>{i.off("position add remove",void 0,e.updateOnRenderOnce),i.sources().off("position",void 0,e.updateOnRenderOnce),i.targets().off("position",void 0,e.updateOnRenderOnce),r.remove()}}}function O(e,t,s={}){const n=Object.assign({transform:"",position:"top-left",boundingBox:{includeLabels:!1,includeOverlays:!1},uniqueElements:!1,initCollection:()=>{}},x(s),s),i=n.queryEachTime?e.cy.collection():e.cy.nodes(n.selector);n.queryEachTime||n.initCollection(i),"render"===n.updateOn?e.updateOnRender=!0:"position"===n.updateOn?i.on("position add remove",e.updateOnRenderOnce):i.on("add remove",e.updateOnRenderOnce);const r=t=>({layer:e,nodes:i,remove:()=>{i.off("position add remove",void 0,e.updateOnRenderOnce),t.remove()}});if("canvas"===e.type){const s=n,o=r=>{const o=r.getTransform(),a=s.queryEachTime?e.cy.nodes(s.selector):i;n.queryEachTime&&n.initCollection(a),a.forEach((i=>{const a=i.boundingBox(n.boundingBox);if(!s.checkBounds||e.inVisibleBounds(a)){if("top-left"===s.position)r.translate(a.x1,a.y1);else if("center"===s.position){const e=i.position();r.translate(e.x,e.y)}t(r,i,a),"none"!==s.position&&r.setTransform(o)}}))};return r(b(e,o))}const a=n,c={bb:e=>e.boundingBox(a.boundingBox),isVisible:a.checkBounds?t=>e.inVisibleBounds(t):()=>!0,uniqueElements:!0===a.uniqueElements};if(a.checkBounds&&(e.updateOnTransform=!0),"html"===e.type){const s={...c,enter:(t,s)=>{const n=e.node.ownerDocument.createElement("div");return n.style.position="absolute",a.init&&a.init(n,t,s),n},update:(e,s,n)=>{if("top-left"===a.position)e.style.transform=`${a.transform}translate3d(${n.x1}px,${n.y1}px,0)`;else if("center"===a.position){const t=s.position();e.style.transform=`${a.transform}translate3d(${t.x}px,${t.y}px,0)`}t(e,s,n)}},o=t=>{const r=a.queryEachTime?e.cy.nodes(a.selector):i;n.queryEachTime&&n.initCollection(r),v(t,r,s)};return r(b(e,o))}const d={...c,enter:(t,s)=>{const n=e.node.ownerDocument.createElementNS(o,"g");return a.init&&a.init(n,t,s),n},update:(e,s,n)=>{if("top-left"===a.position)e.setAttribute("transform",`${a.transform}translate3d(${n.x1},${n.y1},0)`);else if("center"===a.position){const t=s.position();e.setAttribute("transform",`${a.transform}translate3d(${t.x},${t.y},0)`)}t(e,s,n)}};return r(b(e,(t=>{const s=a.queryEachTime?e.cy.nodes(a.selector):i;n.queryEachTime&&n.initCollection(s),v(t,s,d)})))}function E(e){const t=e.indexOf(",");return e.substring(t+1)}function _(e,t,s){const n=function(){return t.toDataURL(s,e.quality)};switch(e.output){case"blob-promise":return new Promise(((n,i)=>{try{t.toBlob((function(e){null!=e?n(e):i(new Error("`canvas.toBlob()` sent a null value in its callback"))}),s,e.quality)}catch(e){i(e)}}));case"blob":return function(e,t){const s=atob(e),n=new ArrayBuffer(s.length),i=new Uint8Array(n);for(let e=0;e<s.length;e++)i[e]=s.charCodeAt(e);return new Blob([n],{type:t})}(E(n()),s);case"base64":return E(n());default:return n()}}class C extends Error{}class R{constructor(e){this.bak={},this.resize=()=>{const e=this.cy.width(),t=this.cy.height();this.viewport.width=e,this.viewport.height=t;for(const s of this.layers)s.resize(e,t)},this.destroy=()=>{for(const e of this.layers)e.remove();this.cy.off("destroy",this.destroy),this.cy.off("viewport",this.zoomed),this.cy.off("resize",this.resize),this.cy.scratch("_layers",void 0),this.cy.png=this.bak.png,this.cy.jpg=this.bak.jpg,this.cy.jpeg=this.bak.jpeg,this.bak={}},this.zoomed=()=>{const e=this.cy.pan(),t=this.cy.zoom();this.viewport.tx=e.x,this.viewport.ty=e.y,this.viewport.zoom=t;for(const s of this.layers)s.setViewport(e.x,e.y,t)},this.renderPerEdge=w,this.renderPerNode=O,this.cy=e,this.adapter={cy:this.cy,insert:(e,t,s)=>this.insert(e,t,s),move:(e,t)=>this.move(e,t),inVisibleBounds:e=>{const t=this.viewport,s=e=>{const s=e*t.zoom+t.tx;return s>=0&&s<=t.width},n=e=>{const s=e*t.zoom+t.ty;return s>=0&&s<=t.height};return function(e){return null!=e.x}(e)?s(e.x)&&n(e.y):s(e.x1)&&n(e.y1)||s(e.x2)&&n(e.y1)||s(e.x2)&&n(e.y2)||s(e.x1)&&n(e.y2)||s((e.x1+e.x2)/2)&&n((e.y1+e.y2)/2)}};const t=e.container(),s=new f(this.adapter,t.querySelector('[data-id="layer2-node"]'));this.nodeLayer=s;const n=new m(this.adapter,t.querySelector('[data-id="layer1-drag"]'));this.dragLayer=n;const i=new g(this.adapter,t.querySelector('[data-id="layer0-selectbox"]'));this.selectBoxLayer=i,s.root.style.zIndex="",n.root.style.zIndex="",i.root.style.zIndex="",s.root.insertAdjacentElement("afterend",n.root),n.root.insertAdjacentElement("afterend",i.root),e.on("viewport",this.zoomed),e.on("resize",this.resize),e.on("destroy",this.destroy),this.bak={png:e.png,jpg:e.jpg,jpeg:e.jpeg},e.png=this.png.bind(this),e.jpg=this.jpg.bind(this),e.jpeg=this.jpeg.bind(this),this.viewport={width:this.cy.width(),height:this.cy.height(),tx:this.cy.pan().x,ty:this.cy.pan().y,zoom:this.cy.zoom()}}move(e,t){const s=this.layers,n=s.indexOf(e),i=Math.max(Math.min(n+t,s.length,0));i!==n&&(n>=s.length-1?this.root.appendChild(e.root):this.root.insertBefore(e.root,s[i].root))}get document(){return this.cy.container().ownerDocument}get root(){return this.nodeLayer.node.parentElement}get layers(){return Array.from(this.root.children).map((e=>e.__cy_layer)).filter((e=>null!=e))}getLayers(){return this.layers}init(e){return e.resize(this.viewport.width,this.viewport.height),e.setViewport(this.viewport.tx,this.viewport.ty,this.viewport.zoom),e}update(){this.zoomed();for(const e of this.layers)e instanceof h&&e.draw()}createLayer(e,t){switch(e){case"svg":return this.init(new a(this.adapter,this.document,t));case"html":return this.init(new u(this.adapter,this.document,t));case"canvas":return this.init(new h(this.adapter,this.document,t));case"html-static":return this.init(new p(this.adapter,this.document,t));case"svg-static":return this.init(new c(this.adapter,this.document,t));case"canvas-static":return this.init(new l(this.adapter,this.document,t))}}append(e,t){const s=this.createLayer(e,t);return this.root.appendChild(s.root),s}insert(e,t,s,n){const i=this.createLayer(s,n);return t.root.insertAdjacentElement("before"===e?"beforebegin":"afterend",i.root),i}getLast(){var e;const t=this.layers;return null!==(e=t[t.length-1])&&void 0!==e?e:null}getFirst(){var e;return null!==(e=this.layers[0])&&void 0!==e?e:null}hasCustomLayer(){return this.layers.some((e=>!(e instanceof y)))}toCanvas(e){var t,s;const n=this.layers;if(n.some((e=>!e.supportsRender))&&!e.ignoreUnsupportedLayers)throw new C("some layer doesn't support exporting, use {ignoreUnsupportedLayers: true} option to ignore");const i=n.indexOf(this.nodeLayer),r=n.indexOf(this.dragLayer),o=n.indexOf(this.selectBoxLayer);if((i!==r-1||r!==o-1)&&!e.ignoreUnsupportedLayerOrder)throw new C("cytoscape layers are not in order, use {ignoreUnsupportedLayerOrder: true} option to ignore");const a=this.cy.renderer(),c=e.bg,d=a.bufferCanvasImage({...e,bg:void 0}),h=d.width,l=d.height,u=d.getContext("2d"),p=n.slice(0,i).reverse().filter((e=>e.supportsRender()&&e!==this.dragLayer&&e!==this.selectBoxLayer)),y=n.slice(i+1).filter((e=>e.supportsRender()&&e!==this.dragLayer&&e!==this.selectBoxLayer)),f={scale:null!==(t=e.scale)&&void 0!==t?t:1,width:h,height:l,full:null!==(s=e.full)&&void 0!==s&&s};u.globalCompositeOperation="destination-over";for(const e of p)e.renderInto(u,f);u.globalCompositeOperation="source-over";for(const e of y)e.renderInto(u,f);return c&&(u.globalCompositeOperation="destination-over",u.fillStyle=c,u.rect(0,0,h,l),u.fill()),d}png(e){return this.hasCustomLayer()?_(null!=e?e:{},this.toCanvas(null!=e?e:{}),"image/png"):this.bak.png.call(this.cy,e)}jpg(e){if(!this.hasCustomLayer())return this.bak.jpg.call(this.cy,e);const t={bg:"#fff",...null!=e?e:{}};return _(t,this.toCanvas(t),"image/png")}jpeg(e){return this.hasCustomLayer()?this.jpg(e):this.bak.jpeg.call(this.cy,e)}}function k(e=this){if(!e.container())throw new Error("layers plugin does not work in headless environments");const t=e.scratch("_layers");if(t)return t;const s=new R(e);return e.scratch("_layers",s),s}function T(e){e("core","layers",k)}void 0!==window.cytoscape&&T(window.cytoscape),e.LayerExportException=C,e.LayersPlugin=R,e.default=T,e.layers=k,e.renderPerEdge=w,e.renderPerNode=O,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.min.js.map
