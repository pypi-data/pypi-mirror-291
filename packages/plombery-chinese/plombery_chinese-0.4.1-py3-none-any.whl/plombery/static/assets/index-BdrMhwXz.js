const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HandsonTable-BL5bSNAs.js","assets/vendor-RR7AYvzk.js","assets/HandsonTable-CeXsD9Sv.css"])))=>i.map(i=>d[i]);
var os=Object.defineProperty;var cs=(s,t,r)=>t in s?os(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r;var re=(s,t,r)=>cs(s,typeof t!="symbol"?t+"":t,r);import{k as ds,r as m,j as e,u as ze,a as us,F as ms,b as xs,c as hs,d as js,e as gs,o as ps,f as fs,s as bs,g as ys,h as vs,i as Ns,l as ws,m as j,n as _,p as Q,q as k,t as ks,v as y,w as _s,x as Es,y as ne,z as Ts,A as Ss,B as $s,C as Cs,D as ae,_ as ie,E as F,G as A,H as c,I as O,J as C,K as ge,L as Rs,M as Ls,N as Fs,O as pe,P as W,Q as $,R as qe,S as de,T as Os,U as Ve,V as U,W as L,X as Ps,Y as Ds,Z as Be,$ as Ms,a0 as Is,a1 as fe,a2 as H,a3 as D,a4 as be,a5 as ye,a6 as As,a7 as Ge,a8 as R,a9 as N,aa as J,ab as Y,ac as ve,ad as Ne,ae as we,af as T,ag as ke,ah as Us,ai as Hs,aj as zs,ak as qs,al as Vs,am as Bs,an as _e,ao as Gs,ap as De,aq as Me,ar as Ks,as as Ke,at as Qs,au as Ws,av as Js,aw as Ys,ax as Xs,ay as Zs,az as et,aA as st,aB as tt,aC as rt,aD as nt,aE as at}from"./vendor-RR7AYvzk.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function r(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(a){if(a.ep)return;a.ep=!0;const i=r(a);fetch(a.href,i)}})();class ue{constructor(t,r,n,a,i){this.id=t,this.name=r,this.description=n,this.tasks=a,this.triggers=i}hasTrigger(){return this.triggers.some(t=>!!t.schedule)}getNextFireTime(){const r=this.triggers.filter(n=>!!n.next_fire_time).sort((n,a)=>n.next_fire_time.getTime()-a.next_fire_time.getTime())[0];if(r)return r.next_fire_time}}class it extends Error{constructor(r,n,a){super(r);re(this,"data");re(this,"status");this.data={data:a,status:n},this.status=n}}const lt=`${window.location.protocol}//${window.location.host}/api`,z=lt,Ee=ds.create({prefixUrl:z,credentials:"include",redirect:"follow"}),ot=()=>z,P=async(s,t)=>(await Ee.get(s,t)).json(),Qe=async(s,t)=>{try{return await Ee.post(s,t).json()}catch(r){const n=r;throw new it(n.message,n.response.status,await n.response.json())}},ct=()=>{const s=new URL(z);return s.protocol=s.protocol==="http:"?"ws":"wss",s.pathname+="/ws/",s},le=s=>`${z}/pipelines/${s}/run`,oe=(s,t)=>`${z}/pipelines/${s}/triggers/${t}/run`,dt=async()=>await P("auth/whoami"),ut=async()=>{await Qe("auth/logout")},mt=()=>({queryKey:["pipelines"],queryFn:async()=>{const s=await P("pipelines/");return s.forEach(t=>{t.triggers.forEach(r=>{r.next_fire_time&&(r.next_fire_time=new Date(r.next_fire_time))})}),s.map(t=>new ue(t.id,t.name,t.description,t.tasks,t.triggers))},initialData:[]}),Te=s=>({queryKey:["pipeline",s],queryFn:async()=>{const t=await P(`pipelines/${s}`);return t.triggers.forEach(r=>{r.next_fire_time&&(r.next_fire_time=new Date(r.next_fire_time))}),new ue(t.id,t.name,t.description,t.tasks,t.triggers)},initialData:new ue("","","",[],[]),enabled:!!s}),xt=s=>({queryKey:["pipeline-input",s],queryFn:async()=>await P(`pipelines/${s}/input-schema`)}),Se=(s,t)=>({queryKey:["runs",s,t],queryFn:async()=>{const n=await P("runs/",{searchParams:{pipeline_id:s??"",trigger_id:t??""}});return n.forEach(a=>{a.start_time=new Date(a.start_time)}),n},initialData:[]}),Ie=(s,t,r)=>({queryKey:["runs",s,t,r],queryFn:async()=>{const n=await P(`runs/${r}`);return n.start_time=new Date(n.start_time),n},enabled:!!(s&&t&&r)}),ht=s=>({queryKey:["logs",s],queryFn:async()=>{const t=await Ee.get(`runs/${s}/logs`).text();return t?t.split(`
`).map((r,n)=>{const a=JSON.parse(r);return a.id=n,a.timestamp=new Date(a.timestamp),a}):[]},enabled:!!s,initialData:[]}),jt=(s,t)=>({queryKey:["getRunData",{runId:s,taskId:t}],queryFn:async()=>await P(`runs/${s}/data/${t}`)}),We=(s,t)=>({async mutationFn(r){return await Qe("runs/",{json:{pipeline_id:s,trigger_id:t,params:r}})}}),Je=m.createContext({isAuthenticated:!1,isAuthenticationEnabled:!0,isLoading:!0,logout:async()=>{},user:null}),gt=(s,t)=>{switch(t.type){case"LOGIN":return{...s,isAuthenticated:!0,isAuthenticationEnabled:t.payload.isAuthenticationEnabled,user:t.payload.user};case"LOGOUT":return{...s,isAuthenticated:!1,user:null};case"POPULATE":return{...s,user:t.payload?{...s.user,...t.payload}:null};case"STOP_LOADING":return{...s,isLoading:!1};default:throw new Error("Unknown action type")}},pt=({children:s})=>{const[t,r]=m.useReducer(gt,{isAuthenticated:!1,isAuthenticationEnabled:!0,isLoading:!0,logout:async()=>{await ut(),r({type:"LOGOUT"})},user:null});return m.useEffect(()=>{(async()=>{try{const{is_authentication_enabled:a,user:i}=await dt();(a&&i||!a)&&r({type:"LOGIN",payload:{user:i,isAuthenticationEnabled:a}})}catch(a){console.error(a)}finally{r({type:"STOP_LOADING"})}})()},[]),e.jsx(Je.Provider,{value:t,children:t.isAuthenticationEnabled&&t.isLoading?"加载中...":s})},$e=()=>m.useContext(Je),ft=s=>`translate${s==="bottom"||s==="top"?"Y":"X"}(${s==="bottom"||s==="right"?"-":"+"}10%)`;function bt({initialOpen:s=!1,placement:t="bottom",modal:r,open:n,onOpenChange:a}={}){const[i,l]=m.useState(s),[o,h]=m.useState(),[g,d]=m.useState(),u=n??i,f=a??l,b=js({placement:t,open:u,onOpenChange:f,whileElementsMounted:gs,middleware:[ps(5),fs({fallbackAxisSideDirection:"end"}),bs({padding:5})]}),v=b.context,w=ys(v,{enabled:n==null}),x=vs(v),p=Ns(v),E=ws([w,x,p]);return m.useMemo(()=>({open:u,setOpen:f,...E,...b,modal:r,labelId:o,descriptionId:g,setLabelId:h,setDescriptionId:d}),[u,f,E,b,r,o,g])}const Ye=m.createContext(null),X=()=>{const s=m.useContext(Ye);if(s==null)throw new Error("Popover components must be wrapped in <Popover />");return s};function yt({children:s,modal:t=!0,...r}){const n=bt({modal:t,...r});return e.jsx(Ye.Provider,{value:n,children:s})}const vt=m.forwardRef(function({children:t,asChild:r=!1,...n},a){const i=X(),l=t.ref,o=ze([i.refs.setReference,a,l]);return r&&m.isValidElement(t)?m.cloneElement(t,i.getReferenceProps({ref:o,...n,...t.props,"data-state":i.open?"open":"closed"})):e.jsx("button",{ref:o,type:"button","data-state":i.open?"open":"closed",...i.getReferenceProps(n),children:t})}),Nt=m.forwardRef(function(t,r){const{context:n,...a}=X(),i=ze([a.refs.setFloating,r]),{isMounted:l,styles:o}=us(n,{initial:({side:h})=>({opacity:0,transform:ft(h)})});return e.jsx(ms,{children:l&&e.jsx(xs,{context:n,modal:a.modal,children:e.jsx("div",{ref:i,style:{position:a.strategy,top:a.y??0,left:a.x??0,width:"max-content",...t.style,...o},"aria-labelledby":a.labelId,"aria-describedby":a.descriptionId,...a.getFloatingProps(t),children:t.children})})})});m.forwardRef(function({children:t,...r},n){const{setDescriptionId:a}=X(),i=hs();return m.useLayoutEffect(()=>(a(i),()=>a(void 0)),[i,a]),e.jsx("p",{...r,ref:n,id:i,children:t})});m.forwardRef(function(t,r){const{setOpen:n}=X();return e.jsx("button",{type:"button",ref:r,...t,onClick:a=>{var i;(i=t.onClick)==null||i.call(t,a),n(!1)}})});const wt=()=>{const{logout:s,user:t}=$e();return t?e.jsxs(j,{className:"gap-4 mt-8",children:[e.jsxs("div",{children:[e.jsx(_,{children:t.name}),e.jsx(Q,{children:t.email})]}),e.jsx(k,{size:"xs",variant:"secondary",color:"rose",icon:ks,onClick:async()=>await s()})]}):e.jsx("div",{children:"Not authenticated"})},Xe=0,me=1,Ae=2,kt={[Xe]:"light",[me]:"dark"},q="plomberyTheme",_t=()=>{const s=localStorage[q]==="dark"?me:q in localStorage?Xe:Ae,[t,r]=m.useState(s);return e.jsx(_s,{onIndexChange:n=>{let a=!1;return n===Ae?(localStorage.removeItem(q),a=window.matchMedia("(prefers-color-scheme: dark)").matches):(a=n===me,localStorage[q]=kt[n]),a?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),r(n)},index:t,children:e.jsxs(Es,{variant:"solid",children:[e.jsx(ne,{icon:Ts,children:"浅色主题"}),e.jsx(ne,{icon:Ss,children:"深色主题"}),e.jsx(ne,{icon:$s,children:"跟随系统"})]})})},Et=()=>{const{user:s,isAuthenticationEnabled:t}=$e();let r=e.jsx(Cs,{});if(t&&s){const n=s.name.split(" ");r=n.length>1?`${n.at(0)[0]}${n.at(-1)[0]}`:n[0]}return e.jsxs(yt,{placement:"bottom-start",children:[e.jsx(vt,{children:e.jsx("div",{className:"flex justify-center items-center font-medium dark:bg-dark-tremor-background dark:ring-dark-tremor-ring ring-1 ring-slate-300 text-indigo-500 rounded-full hover:ring-2 hover:ring-indigo-400 dark:hover:ring-indigo-700 transition-shadow",style:{width:34,height:34},children:r})}),e.jsx(Nt,{children:e.jsxs(y,{className:"shadow-xl z-20",children:[e.jsx(_t,{}),t&&e.jsx(wt,{})]})})]})},Z=({children:s,header:t})=>e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-950 p-6 sm:p-10 min-h-screen",children:[e.jsxs(j,{className:"items-start gap-8",children:[t&&e.jsx("div",{className:"flex-grow max-w-full",children:t}),e.jsx(Et,{})]}),e.jsx("main",{children:s})]}),ee=({children:s,footer:t,isOpen:r,subtitle:n,title:a,onClose:i})=>e.jsx(ae,{show:r,as:m.Fragment,children:e.jsxs(ie,{onClose:i,className:"relative z-50",children:[e.jsx(ae.Child,{as:m.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black/30 dark:bg-black/50 backdrop-blur-sm","aria-hidden":"true"})}),e.jsx("div",{className:"fixed inset-0 flex w-screen items-center justify-center p-12",children:e.jsx(ae.Child,{as:m.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 translate-y-1/3",enterTo:"opacity-100 translate-y-0",leave:"ease-in duration-300",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 -translate-y-1/3",children:e.jsx(ie.Panel,{className:"max-w-full",children:e.jsxs(y,{children:[a&&e.jsx(ie.Title,{children:e.jsx(_,{children:a})}),n&&e.jsx(Q,{children:n}),e.jsx("div",{className:(a||n)&&"mt-6",children:s}),t&&e.jsx(j,{className:"justify-end space-x-6 mt-6",children:t})]})})})})]})}),Tt=({label:s,...t})=>{const r=m.createRef();return e.jsxs("div",{children:[e.jsx("input",{type:"range",onInput:n=>r.current&&(r.current.value=n.target.value),className:"w-full cursor-ew-resize appearance-none accent-indigo-500 h-2 bg-tremor-background border border-tremor-border dark:border-dark-tremor-border dark:bg-dark-tremor-background rounded",...t}),e.jsxs(F,{numItems:3,className:"items-baseline",children:[e.jsx(A,{children:e.jsxs("div",{className:"ml-1 inline-block",children:[e.jsx("div",{className:"border-r border-slate-300 dark:border-slate-600 h-2 mx-auto",style:{width:1}}),e.jsx(c,{children:t.min})]})}),e.jsx(j,{className:"justify-center",children:e.jsx(c,{children:e.jsx(O,{children:e.jsx("output",{ref:r,className:"px-2 py-1 rounded bg-tremor-background-subtle dark:bg-dark-tremor-background-subtle block truncate text-center",children:t.defaultValue})})})}),e.jsx(j,{className:"justify-end",children:e.jsxs("div",{className:"mr-1",children:[e.jsx("div",{className:"border-r border-slate-300 dark:border-slate-600 h-2 mx-auto",style:{width:1}}),e.jsx(c,{children:t.max})]})})]})]})},St={checkbox:s=>e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("input",{id:s.name,name:s.name,type:"checkbox",defaultChecked:s.defaultValue==="true",className:"w-4 h-4 accent-indigo-500 bg-tremor-background rounded dark:bg-dark-tremor-background cursor-pointer"}),e.jsx("label",{htmlFor:s.name,className:"pl-2 cursor-pointer",children:e.jsx(c,{children:s.label})})]}),number:s=>{const t=s.value.minimum??s.value.exclusiveMinimum,r=s.value.maximum??s.value.exclusiveMaximum;return e.jsx(Rs,{name:s.name,min:t,max:r,defaultValue:s.defaultValue,required:s.required})},range:s=>{const t=s.value.minimum??s.value.exclusiveMinimum??0,r=s.value.maximum??s.value.exclusiveMaximum??0,n=s.type==="number"?(r-t)/10:1;return e.jsx(Tt,{name:s.name,label:s.label,min:t,max:r,step:n,defaultValue:s.defaultValue,required:s.required})},select:s=>{const[t,r]=m.useState(s.defaultValue||"");return e.jsxs("div",{children:[e.jsx(Ls,{defaultValue:s.defaultValue,onValueChange:r,value:t,children:s.value.enum.map(n=>e.jsx(Fs,{value:n.toString(),children:n==null?void 0:n.toString()},n==null?void 0:n.toString()))}),e.jsx("input",{type:"hidden",name:s.name,value:t})]})},text:s=>e.jsx(pe,{name:s.name,placeholder:s.label,defaultValue:s.defaultValue})},$t=s=>{let t="text";if(s.type==="number"||s.type==="integer"){const r=s.value.minimum??s.value.exclusiveMinimum,n=s.value.maximum??s.value.exclusiveMaximum;r!==void 0&&n!==void 0?t="range":t="number"}else s.type==="enum"?t="select":s.type==="boolean"&&(t="checkbox");return St[t](s)},Ct=({errors:s={},schema:t})=>{const r=m.useCallback(i=>{const l=t.definitions||t.$defs;if(!l)return;const o=i.split("/").pop();return l[o]},[t]),n=t.properties;if(!n)return e.jsx(c,{className:"mt-4",children:"该管道不支持输入参数，但你仍然可以手动运行!"});const a=Object.entries(n).map(([i,l])=>{var b,v,w;if(typeof l=="boolean")return;let o=l,h;const g=o.title||i;if(l.allOf){const x=l.allOf[0];if(h=(b=l.default)==null?void 0:b.toString(),x.$ref){const p=r(x.$ref);p&&(o=p)}}else if(l.$ref){const x=r(l.$ref);x&&(o=x)}else h=(v=o.default)==null?void 0:v.toString();const d=(o.enum?"enum":Array.isArray(o.type)?o.type[0]:o.type)||"string",u=((w=t.required)==null?void 0:w.includes(i))??!1,f=$t({defaultValue:h,label:g,name:i,required:u,type:d,value:o});return e.jsxs("div",{children:[e.jsxs(j,{className:"justify-between",children:[e.jsxs(c,{className:"mb-2",children:[g,u&&" *"]}),o.description&&e.jsx(C,{icon:ge,tooltip:o.description,color:"neutral"})]}),f,s[i]&&e.jsx(c,{color:"rose",className:"mt-1",children:s[i]})]},i)});return e.jsx(j,{className:"gap-4 flex-col items-stretch",children:a})},Ce=({pipeline:s})=>{var h;const[t,r]=m.useState(!1),n=W(),a=$({...xt(s.id),enabled:t}),i=qe(We(s.id)),l=i.isError&&i.error.status===422?Object.fromEntries(i.error.data.data.detail.map(g=>[g.loc.join("."),g.msg])):void 0,o=(h=i.error)==null?void 0:h.message;return e.jsxs(e.Fragment,{children:[e.jsx(k,{color:"indigo",variant:"secondary",size:"xs",icon:de,onClick:()=>r(!0),children:"运行"}),e.jsx(ee,{isOpen:t,title:`手动运行 "${s.name}"`,onClose:()=>r(!1),children:e.jsxs("form",{onSubmit:async g=>{g.preventDefault();const d=Object.fromEntries(new FormData(g.target).entries());try{const u=await i.mutateAsync(d);n(`/pipelines/${u.pipeline_id}/triggers/${u.trigger_id}/runs/${u.id}`),r(!1)}catch(u){console.error(u)}},children:[a.isLoading?"加载中...":a.isError?"错误":e.jsxs("div",{style:{width:350},children:[e.jsx(Ct,{schema:a.data,errors:l}),o&&e.jsx(c,{className:"mt-2",color:"rose",children:o})]}),e.jsxs(j,{className:"justify-end space-x-6 mt-6",children:[e.jsx(k,{type:"button",variant:"secondary",color:"indigo",onClick:()=>{r(!1)},disabled:i.isLoading,children:"关闭"}),e.jsx(k,{color:"indigo",type:"submit",icon:de,disabled:i.isLoading,children:"运行"})]})]})})]})},Rt=()=>e.jsx("div",{className:"tremor-Badge-icon -ml-1 mr-1.5 h-4 w-4 animate-spin",children:e.jsx(Os,{})}),V={pending:"slate",completed:"emerald",failed:"rose",cancelled:"slate",running:"blue",warning:"amber"},xe={pending:Ps,completed:Ds,failed:Be,cancelled:Ms,running:Rt,warning:Is},he=["cyan","violet","pink","emerald","orange","stone","fuchsia"],Ze=s=>Object.fromEntries(s.map((t,r)=>[t.id,`bg-${he[r%he.length]}-500`])),M=(s,t=!1)=>{if(t){const r=Ve(s,s.getTimezoneOffset());return U(r,"yyyy年MMMdd日 HH:mm:ss",{locale:L})+" (UTC)"}else return U(s,"yyyy年MMMdd日 HH:mm:ss (OOOO)",{locale:L})},B=(s,t=!1)=>{if(t){const r=Ve(s,s.getTimezoneOffset());return U(r,"HH:mm:ss.SSS",{locale:L})+" (UTC)"}else return U(s,"HH:mm:ss.SSS",{locale:L})},G=s=>U(s,"yyyy年MMMdd日",{locale:L}),Lt=new Intl.NumberFormat,Ft=s=>Lt.format(s),es=s=>s.replace("pending","等待中...").replace("running","运行中...").replace("completed","成功").replace("failed","失败").replace("cancelled","取消").replace("warning","警告"),Ot=()=>{const s=$(mt());if(s.isLoading)return e.jsx("div",{children:"加载中..."});if(s.isError)return e.jsx("div",{children:"出现了一个错误"});const t=s.data;return e.jsxs(y,{children:[e.jsx(_,{children:"管道列表"}),e.jsxs(fe,{children:[t.map(r=>e.jsxs(H,{className:"gap-x-1",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(c,{className:"truncate",children:e.jsx(O,{children:e.jsx(D,{to:`/pipelines/${r.id}`,children:r.name})})}),r.description&&e.jsx(c,{className:"truncate",children:r.description})]}),r.hasTrigger()&&e.jsxs("div",{className:"min-w-0",title:M(r.getNextFireTime(),!1),children:[e.jsx(c,{className:"truncate",children:"下次运行时间"}),e.jsx(c,{className:"truncate",children:e.jsx(O,{children:be(r.getNextFireTime(),{addSuffix:!0,includeSeconds:!0,locale:L})})})]}),e.jsx(Ce,{pipeline:r})]},r.id)),t.length===0&&e.jsxs("div",{className:"mt-4",children:[e.jsx(c,{className:"text-center italic",children:"没有管道，哪也跳不进去"}),e.jsx("div",{className:"text-center mt-2 text-sm",children:e.jsxs("a",{href:"https://yhdsl.github.io/plombery/pipelines/",target:"_blank",className:"inline-flex items-center gap-2 bg-indigo-50/30 hover:bg-indigo-50 dark:bg-indigo-950/50 dark:hover:bg-indigo-950 rounded-sm px-4 py-2 text-indigo-500 transition-colors duration-300 cursor-pointer no-underline",children:["如何创建管道",e.jsx(C,{icon:ye,size:"sm",className:"p-0",color:"indigo"})]})})]})]})]})},Re=s=>{const t=o=>{const{type:h}=JSON.parse(o.data);return h===s},r=As(ct().toString(),{share:!0,filter:s?t:void 0}),n=r.lastJsonMessage,a=(o,h)=>{r.sendJsonMessage({type:o,data:h})},i=o=>{a("subscribe",o)},l=o=>{a("unsubscribe",o)};return m.useEffect(()=>{if(s)return i(s),()=>{l(s)}},[]),{lastMessage:n,send:a,subscribe:i,unsubscribe:l}},ss=({status:s})=>e.jsx(Ge,{color:V[s],icon:xe[s],children:es(s)}),ts=({startTime:s})=>{const[t,r]=m.useState(Date.now()-s.getTime());return m.useEffect(()=>{const n=setInterval(()=>{r(Date.now()-s.getTime())},500);return()=>{clearInterval(n)}}),e.jsx("span",{children:(t/1e3).toFixed(2)})},Le=({query:s})=>s.isError?e.jsxs(e.Fragment,{children:[e.jsxs(j,{justifyContent:"start",children:[e.jsx(C,{icon:Be,color:"rose",className:"pl-0"}),e.jsx(_,{children:"获取数据时出错"})]}),e.jsx(c,{children:s.error.message}),e.jsx(j,{justifyContent:"center",className:"mt-4",children:e.jsx(k,{color:"rose",variant:"light",size:"xs",onClick:()=>s.refetch(),children:"重试"})})]}):null,se="animate-pulse rounded",te="bg-slate-200 dark:bg-slate-700",Pt=({className:s})=>e.jsx("div",{className:J("h-10",se,te,s)}),Dt=({className:s})=>e.jsx("div",{className:J("h-28",se,te,s)}),je=({className:s})=>e.jsx(c,{className:J(se,te,s),children:" "}),rs=({className:s})=>e.jsx(Y,{className:J("w-24",se,te,s),children:" "}),Mt=({columns:s=6,rows:t=10})=>new Array(t).fill(1).map((r,n)=>e.jsx(R,{className:"animate-pulse",children:new Array(s).fill(1).map((a,i)=>e.jsx(N,{children:e.jsx(je,{})},i))},n)),Fe=({pipelineId:s,query:t,triggerId:r})=>{const[n,a]=m.useState(t.data||[]),i=ve(),l=W(),{lastMessage:o}=Re("run-update"),h=m.useCallback(d=>{const{data:u,type:f}=d;if(u.run.start_time=new Date(u.run.start_time),u.run.trigger_id=u.trigger,u.run.status==="running")a([u.run,...n]);else{let b=[...n];const v=b.findIndex(w=>w.id===u.run.id);v>=0?b[v]=u.run:b=[u.run,...b],a(b),i.invalidateQueries({queryKey:["runs",s,r]})}},[s,i,n,r]);m.useEffect(()=>{o&&h(o)},[o]),m.useEffect(()=>{var d;(d=t.data)!=null&&d.length&&a(t.data)},[t.data]);const g=4+ +!!s+ +!!r;return e.jsxs(y,{children:[e.jsx(_,{children:"运行状态"}),e.jsxs(Ne,{className:"overflow-auto max-h-[50vh]",children:[e.jsx(we,{className:"sticky top-0 bg-tremor-background dark:bg-dark-tremor-background shadow dark:shadow-tremor-dropdown z-10",children:e.jsxs(R,{children:[e.jsx(T,{className:"text-right",children:"#"}),e.jsx(T,{children:"状态"}),!s&&e.jsx(T,{children:"管道ID"}),!r&&e.jsx(T,{children:"触发器ID"}),e.jsx(T,{children:"启动时间"}),e.jsx(T,{className:"text-right",children:"运行时长"})]})}),e.jsxs(ke,{children:[n.map(d=>e.jsxs(R,{className:"cursor-pointer hover:bg-slate-50 dark:hover:bg-dark-tremor-background-subtle transition-colors",onClick:()=>l(`/pipelines/${d.pipeline_id}/triggers/${d.trigger_id}/runs/${d.id}`),children:[e.jsx(N,{className:"text-right",children:d.id}),e.jsx(N,{children:e.jsx(ss,{status:d.status})}),!s&&e.jsx(N,{children:e.jsx(D,{to:`/pipelines/${d.pipeline_id}`,className:"link--arrow",title:"单击查看管道信息",onClick:u=>u.stopPropagation(),children:d.pipeline_id})}),!r&&e.jsx(N,{children:e.jsx(D,{to:`/pipelines/${d.pipeline_id}/triggers/${d.trigger_id}`,className:"link--arrow",title:"单击查看触发器信息",onClick:u=>u.stopPropagation(),children:d.trigger_id})}),e.jsx(N,{title:M(d.start_time,!1),children:e.jsx(c,{children:Us(new Date,d.start_time)<=1?be(d.start_time,{addSuffix:!0,includeSeconds:!0,locale:L}):M(d.start_time)})}),e.jsxs(N,{className:"text-right",children:[d.status!=="running"?(d.duration/1e3).toFixed(2):e.jsx(ts,{startTime:d.start_time})," ","s"]})]},d.id)),(t.isFetching||t.isLoading)&&e.jsx(Mt,{columns:g}),t.isError&&e.jsx(R,{children:e.jsx(N,{colSpan:g,children:e.jsx(Le,{query:t})})})]})]})]})},It=()=>{const s=$(Se());return e.jsx(Z,{header:e.jsx(e.Fragment,{children:e.jsx(_,{children:"Plombery"})}),children:e.jsxs(F,{numItemsMd:2,className:"gap-6 mt-6",children:[e.jsx(A,{children:e.jsx(Ot,{})}),e.jsx(A,{children:e.jsx(Fe,{query:s})})]})})},At=()=>e.jsx("div",{className:"bg-slate-100 dark:bg-slate-950 h-screen flex justify-center items-center",children:e.jsxs(y,{className:"w-auto",children:[e.jsx("div",{className:"w-12 rounded-full mx-auto mb-4",children:e.jsx("img",{src:"/mario-pipe-flower.png",alt:"Plombery logo"})}),e.jsx(_,{className:"mb-6",children:"欢迎使用 Plombery"}),e.jsx(k,{onClick:()=>{location.href=`${ot()}/auth/login`},size:"lg",color:"indigo",className:"shadow-none w-full",children:"登录"})]})}),ns=({className:s,content:t})=>{const[r,n]=m.useState(!1),a=m.useRef();return e.jsx(k,{variant:"light",color:"indigo",size:"sm",icon:r?Hs:zs,tooltip:"单击复制",className:s,onClick:()=>{navigator.clipboard.writeText(t),n(!0),a.current=setTimeout(()=>n(!1),3e3)}})},I=()=>e.jsx(c,{children:"/"}),Oe=({pipeline:s,trigger:t,run:r,className:n})=>{if(r&&!t)throw new Error;return e.jsxs(j,{className:`gap-x-2 justify-start flex-wrap ${n||""}`,children:[e.jsx(c,{children:e.jsx(D,{to:"/",children:"管道"})}),e.jsx(I,{}),e.jsx(c,{children:t?e.jsx(D,{to:`/pipelines/${s.id}`,children:s.name}):s.name}),t&&e.jsxs(e.Fragment,{children:[e.jsx(I,{}),e.jsx(c,{children:"触发器"}),e.jsx(I,{}),e.jsx(c,{children:r?e.jsx(D,{to:`/pipelines/${s.id}/triggers/${t.id}`,children:t.name}):t.name})]}),r&&t&&e.jsxs(e.Fragment,{children:[e.jsx(I,{}),e.jsx(c,{children:"运行"}),e.jsx(I,{}),e.jsxs(c,{children:["#",r.id]})]})]})},ce=s=>(s/1e3).toFixed(1)+" s",Ut=()=>e.jsxs(y,{children:[e.jsx(c,{children:"运行时长 (平均)"}),e.jsx(rs,{}),e.jsx(Dt,{className:"mt-6"})]}),as=({query:s})=>{if(s.isFetching||s.isLoading)return e.jsx(Ut,{});if(s.isError)return e.jsx(y,{children:e.jsx(Le,{query:s})});const t=s.data.filter(a=>a.status==="completed").reverse(),r=t.reduce((a,i)=>a+i.duration,0)/t.length||0,n=a=>{const{payload:i,active:l,label:o}=a;return!l||!i?null:e.jsx("div",{className:"w-56 rounded-tremor-default border border-tremor-border bg-tremor-background p-2 text-tremor-default shadow-tremor-dropdown dark:bg-dark-tremor-background dark:ring-dark-tremor-ring dark:shadow-dark-tremor-card dark:border-dark-tremor-brand",children:i.map((h,g)=>e.jsxs("div",{className:"flex flex-1 space-x-2.5",children:[e.jsx("div",{className:`flex w-1 flex-col bg-${h.color}-500 rounded`}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"font-medium text-tremor-content",children:["#",o," 运行时长"]}),e.jsx("p",{className:"font-medium text-tremor-content-emphasis",children:ce(Number(h.value))})]})]},g))})};return e.jsxs(y,{children:[e.jsx(j,{className:"items-start",children:e.jsx(c,{children:"运行时长 (平均)"})}),e.jsx(j,{className:"justify-start items-baseline space-x-3 truncate",children:e.jsx(Y,{children:ce(r)})}),e.jsx(qs,{data:t,index:"id",categories:["duration"],colors:["indigo"],valueFormatter:ce,yAxisWidth:40,showLegend:!1,autoMinValue:!0,className:"mt-6 h-28",noDataText:"无数据",customTooltip:n})]})},Ht=({subject:s})=>e.jsxs(y,{children:[e.jsx(c,{children:"成功运行"}),e.jsx(rs,{}),e.jsxs(c,{className:"mt-4",children:[s," 健康监控"]}),e.jsx(Pt,{}),e.jsxs(j,{className:"mt-2",children:[e.jsx(je,{className:"w-20"}),e.jsx(je,{className:"w-20"})]})]}),is=({query:s,subject:t})=>{var o,h;if(s.isLoading||s.isFetching)return e.jsx(Ht,{subject:t});if(s.isError)return e.jsx(y,{children:e.jsx(Le,{query:s})});const r=[...s.data].reverse(),a=r.filter(g=>g.status==="completed").length/r.length*100||0,i=(o=r[0])==null?void 0:o.start_time,l=(h=r[r.length-1])==null?void 0:h.start_time;return e.jsxs(y,{children:[e.jsx(j,{className:"items-start",children:e.jsx(c,{children:"健康状态"})}),e.jsx(j,{className:"justify-start items-baseline space-x-3 truncate",children:e.jsxs(Y,{children:[a.toFixed(1)," ",e.jsx("span",{className:"text-lg",children:"%"})]})}),r.length?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"mt-4",children:e.jsxs(c,{children:[t.replace("Trigger","触发器").replace("Pipeline","管道"),"健康监控"]})}),e.jsx(Vs,{className:"mt-2",data:r.map(g=>({key:g.id,color:V[g.status],tooltip:`#${g.id} ${es(g.status)}`}))})]}):e.jsx(c,{className:"text-center mt-8",children:e.jsxs(Bs,{children:["该",t.replace("Trigger","触发器").replace("Pipeline","管道"),"尚未运行过"]})}),e.jsxs(j,{className:"mt-2",children:[e.jsx(c,{children:i&&G(i)}),e.jsx(c,{children:l&&G(l)})]})]})},zt=({pipeline:s})=>{const t=W();return e.jsxs(y,{children:[e.jsx(_,{children:"触发器信息"}),e.jsxs(Ne,{children:[e.jsx(we,{className:"sticky top-0 bg-tremor-background dark:bg-dark-tremor-background shadow dark:shadow-tremor-dropdown z-10",children:e.jsxs(R,{children:[e.jsx(T,{children:"名称"}),e.jsx(T,{children:"调度"}),e.jsx(T,{children:"下次运行时间"})]})}),e.jsxs(ke,{children:[s.triggers.map(r=>e.jsxs(R,{className:"cursor-pointer hover:bg-slate-50 dark:hover:bg-dark-tremor-background-subtle transition-colors",onClick:()=>t(`/pipelines/${s.id}/triggers/${r.id}`),children:[e.jsx(N,{children:r.name}),e.jsx(N,{children:e.jsx(c,{children:r.schedule})}),e.jsx(N,{title:M(s.getNextFireTime(),!1),children:be(s.getNextFireTime(),{includeSeconds:!0,addSuffix:!0,locale:L})})]},r.id)),s.triggers.length===0&&e.jsx(R,{children:e.jsxs(N,{colSpan:3,children:[e.jsx(c,{className:"text-center italic",children:"该管道尚未设置触发器，仅能手动运行"}),e.jsx("div",{className:"text-center mt-2 text-sm",children:e.jsxs("a",{href:"https://yhdsl.github.io/plombery/triggers/",target:"_blank",className:"inline-flex items-center gap-2 bg-indigo-50/30 hover:bg-indigo-50 dark:bg-indigo-950/50 dark:hover:bg-indigo-950 rounded-sm px-4 py-2 text-indigo-500 transition-colors duration-300 cursor-pointer no-underline",children:["如何创建触发器",e.jsx(C,{icon:ye,size:"sm",className:"p-0",color:"indigo"})]})})]})})]})]})]})},qt=()=>{const t=_e().pipelineId,r=$(Te(t)),n=$(Se(t)),a=()=>e.jsx(ns,{content:le(t),className:"ml-2.5"});if(r.isLoading)return e.jsx("div",{children:"加载中..."});if(r.isError)return e.jsx("div",{children:"出现了一个错误"});const i=r.data;return e.jsxs(Z,{header:e.jsxs("div",{children:[e.jsxs(j,{className:"items-start",children:[e.jsxs(j,{className:"justify-start items-start md:items-center flex-col md:flex-row min-w-0",children:[e.jsxs(_,{className:"truncate max-w-full",children:['管道 "',i.name,'"']}),i.description&&e.jsxs(c,{className:"truncate max-w-full",children:[e.jsx("span",{className:"hidden md:inline mx-2",children:"·"}),i.description]})]}),e.jsx(Ce,{pipeline:i})]}),e.jsx(Oe,{pipeline:i,className:"mt-4"})]}),children:[e.jsxs(F,{numItemsMd:2,numItemsLg:3,className:"gap-6 mt-6",children:[e.jsxs(y,{className:"flex flex-col h-full",children:[e.jsx(_,{children:"任务信息"}),e.jsxs(fe,{children:[i.tasks.map(l=>e.jsx(H,{children:e.jsxs("div",{children:[e.jsx(c,{children:e.jsx(O,{children:l.name})}),l.description&&e.jsx(c,{className:"truncate",children:l.description})]})},l.id)),i.tasks.length===0&&e.jsxs("div",{className:"mt-4",children:[e.jsx(c,{className:"text-center italic",children:"该管道未定义任何任务，无法运行"}),e.jsx("div",{className:"text-center mt-2 text-sm",children:e.jsxs("a",{href:"https://yhdsl.github.io/plombery/tasks/",target:"_blank",className:"inline-flex items-center gap-2 bg-indigo-50/30 hover:bg-indigo-50 dark:bg-indigo-950/50 dark:hover:bg-indigo-950 rounded-sm px-4 py-2 text-indigo-500 transition-colors duration-300 cursor-pointer no-underline",children:["如何创建任务",e.jsx(C,{icon:ye,size:"sm",className:"p-0",color:"indigo"})]})})]})]}),e.jsx("div",{style:{flexGrow:1}}),e.jsxs(j,{className:"gap-8",children:[e.jsxs(j,{className:"justify-start w-auto flex-shrink-0",children:[e.jsx(c,{children:"运行 URL"}),e.jsx(C,{size:"sm",color:"slate",icon:ge,tooltip:"以编程的方式使用 HTTP POST 请求来运行管道的 URL"})]}),e.jsx(pe,{title:le(t),value:le(t),readOnly:!0,icon:a,className:"flex-grow"})]})]}),e.jsx(is,{subject:"Pipeline",query:n}),e.jsx(as,{query:n})]}),e.jsxs(F,{numItems:1,numItemsSm:1,numItemsMd:1,numItemsLg:2,className:"gap-6 mt-6",children:[e.jsx(A,{children:e.jsx(zt,{pipeline:i})}),e.jsx(A,{children:e.jsx(Fe,{query:n,pipelineId:t})})]})]})},Vt=({trigger:s})=>{const[t,r]=m.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx(k,{color:"indigo",variant:"light",size:"sm",icon:Gs,onClick:()=>r(!0),children:"查看参数"}),e.jsx(ee,{isOpen:t,title:"触发器参数",subtitle:s.name,footer:e.jsx(k,{variant:"primary",color:"indigo",onClick:()=>{r(!1)},children:"关闭"}),onClose:()=>r(!1),children:e.jsx("pre",{className:"p-3 bg-slate-100 dark:bg-dark-tremor-background-subtle dark:text-dark-tremor-content-emphasis rounded-md",children:JSON.stringify(s.params,null,2)})})]})},K={id:"_manual",name:"手动运行",description:"代表由用户手动运行管道的特殊触发器"},Bt=()=>{const s=W(),t=_e(),r=t.pipelineId,n=t.triggerId,a=$(Te(r)),i=$({...Se(r,n),enabled:!!n}),l=qe({...We(r,n),onSuccess(f){s(`/pipelines/${f.pipeline_id}/triggers/${f.trigger_id}/runs/${f.id}`)}}),o=()=>e.jsx(ns,{content:oe(r,n),className:"ml-2.5"});if(a.isLoading)return e.jsx("div",{children:"加载中..."});if(a.isError)return e.jsx("div",{children:"出现了一个错误"});const h=a.data,g=n===K.id,d=g?K:h.triggers.find(f=>f.id===n);if(!d)return e.jsx("div",{children:"未找到触发器"});const u=g?e.jsx(Ce,{pipeline:h}):e.jsx(k,{size:"xs",color:"indigo",variant:"secondary",icon:de,onClick:()=>{l.mutateAsync()},children:"运行"});return e.jsxs(Z,{header:e.jsxs("div",{children:[e.jsxs(j,{className:"items-start",children:[e.jsxs(j,{className:"justify-start items-start md:items-center flex-col md:flex-row min-w-0",children:[e.jsxs(_,{className:"truncate max-w-full",children:['触发器 "',d.name,'"']}),d.description&&e.jsxs(c,{className:"truncate max-w-full",children:[e.jsx("span",{className:"hidden md:inline mx-2",children:"·"}),d.description]})]}),u]}),e.jsx(Oe,{pipeline:h,trigger:d,className:"mt-4"})]}),children:[e.jsxs(F,{numItemsMd:2,numItemsLg:3,className:"gap-6 mt-6",children:[e.jsxs(y,{className:"flex flex-col h-full",children:[e.jsx(_,{children:d.name}),e.jsx(Q,{children:d.description}),e.jsx("div",{style:{flexGrow:1}}),e.jsxs(H,{children:[e.jsx(c,{children:"调度"}),e.jsx(c,{children:e.jsx(O,{children:d.schedule})})]}),e.jsxs(H,{children:[e.jsx(c,{children:"参数"}),d.params?e.jsx(Vt,{trigger:d}):e.jsx(c,{children:e.jsx("em",{children:"无参数"})})]}),e.jsxs(j,{className:"gap-8",children:[e.jsxs(j,{className:"justify-start w-auto flex-shrink-0",children:[e.jsx(c,{children:"运行 URL"}),e.jsx(C,{size:"sm",color:"slate",icon:ge,tooltip:"以编程的方式使用 HTTP POST 请求来运行管道的 URL"})]}),e.jsx(pe,{title:oe(r,n),value:oe(r,n),readOnly:!0,icon:o,className:"flex-grow"})]})]}),e.jsx(is,{subject:"Trigger",query:i}),e.jsx(as,{query:i})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Fe,{query:i,pipelineId:r,triggerId:n})})]})},Gt=({logEntry:s})=>{const[t,r]=m.useState(!1);return e.jsxs(j,{className:"mt-1",children:[e.jsx(k,{color:"rose",variant:"secondary",size:"xs",onClick:()=>r(!0),children:"异常栈信息"}),e.jsx(ee,{isOpen:t,title:"异常栈信息",footer:e.jsx(k,{variant:"primary",color:"indigo",onClick:()=>{r(!1)},children:"关闭"}),onClose:()=>r(!1),children:e.jsx("div",{className:"flex flex-col",children:e.jsx("div",{style:{minWidth:350,maxWidth:"100%",overflow:"auto",flexGrow:1,maxHeight:"70vh"},className:"p-3 my-3 bg-tremor-background-subtle dark:bg-dark-tremor-background-subtle rounded-md whitespace-pre font-mono",children:s.exc_info})})})]})},Kt=30,Ue={DEBUG:"slate",INFO:"sky",WARNING:"amber",ERROR:"rose"},Qt=({pipeline:s,run:t})=>{const[r,n]=m.useState({levels:[],tasks:[]}),[a,i]=m.useState(!0),{lastMessage:l}=Re(`logs.${t.id}`),o=ve(),h=m.createRef(),g=$(ht(t.id)),d=m.useCallback(x=>{const{data:p}=x;o.setQueryData(["logs",t.id],(E=[])=>{const S=JSON.parse(p);return S.id=E.length,S.timestamp=new Date(S.timestamp),[...E,S]})},[t.id]),u=m.useCallback(x=>{var Pe;const p=(Pe=h.current)==null?void 0:Pe.parentElement;if(!p)return;const E=x;let S=Math.max(p.scrollTop+p.clientHeight+E.deltaY,0);S=Math.min(S,p.scrollHeight);const ls=p.scrollHeight-S<Kt;i(ls)},[h]);m.useEffect(()=>{var x,p;return(p=(x=h.current)==null?void 0:x.parentElement)==null||p.addEventListener("wheel",u),()=>{var E,S;(S=(E=h.current)==null?void 0:E.parentElement)==null||S.removeEventListener("wheel",u)}},[h]),m.useEffect(()=>{var x;if(a){const p=(x=h.current)==null?void 0:x.parentElement;p==null||p.scrollTo({top:p.scrollHeight,behavior:"smooth"})}}),m.useEffect(()=>{l&&d(l)},[l]);const f=m.useCallback(x=>{n(p=>({...p,...x}))},[]);if(g.isLoading)return e.jsx("div",{children:"加载中..."});if(g.isError)return e.jsx("div",{children:"加载日志时出错"});const b=g.data.filter(x=>(r.levels.length===0||r.levels.includes(x.level))&&(r.tasks.length===0||r.tasks.includes(x.task))),v=Ze(s.tasks),w=["running","pending"].includes(t.status);return e.jsxs(j,{flexDirection:"col",alignItems:"stretch",style:{maxHeight:600},children:[e.jsxs(F,{numItemsMd:3,className:"gap-6 items-start",children:[e.jsxs("div",{children:[e.jsx(c,{children:"任务"}),e.jsx(De,{className:"mt-1 z-20",onValueChange:x=>{f({tasks:x})},placeholder:"选择...",placeholderSearch:"搜索",children:s.tasks.map(x=>e.jsx(Me,{value:x.id,children:x.name},x.id))})]}),e.jsxs("div",{children:[e.jsx(c,{children:"日志等级"}),e.jsx(De,{className:"mt-1 z-20",onValueChange:x=>{f({levels:x})},placeholder:"选择...",placeholderSearch:"搜索",children:Object.keys(Ue).map(x=>e.jsx(Me,{value:x},x))})]}),w&&e.jsxs(j,{justifyContent:"end",className:"order-first md:order-last",children:[e.jsx(C,{icon:Ks,variant:"light",color:a?"indigo":"gray",tooltip:"自动滚动至最新的日志。单击进行切换",className:"mr-4",style:{cursor:"pointer"},onClick:()=>{i(!a)}}),e.jsxs("span",{className:"relative flex h-3 w-3",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-indigo-500"})]}),e.jsx(c,{className:"ml-2 opacity-80",children:"实时日志"})]})]}),e.jsxs(Ne,{className:"mt-6 flex-grow",ref:h,children:[e.jsx(we,{className:"sticky top-0 bg-tremor-background dark:bg-dark-tremor-background shadow dark:shadow-tremor-dropdown z-10",children:e.jsxs(R,{children:[e.jsx(T,{children:"时间"}),e.jsx(T,{children:"等级"}),e.jsx(T,{children:"任务"}),e.jsx(T,{children:"消息"})]})}),e.jsx(ke,{children:b.map((x,p)=>{const E=p!==0?x.timestamp.getTime()-b[p-1].timestamp.getTime():-1;return e.jsxs(R,{children:[e.jsx(N,{children:e.jsxs(c,{className:"font-mono text-xs",children:[e.jsx("span",{title:B(x.timestamp,!1),children:B(x.timestamp)}),E>=0&&e.jsxs("span",{className:"text-slate-400 ml-2",children:["+",Ft(E)," ms"]})]})}),e.jsx(N,{children:e.jsx(Ge,{size:"xs",color:Ue[x.level],children:x.level})}),e.jsx(N,{children:e.jsxs(j,{children:[e.jsx("div",{className:`h-2 w-2 mr-2 rounded-full ${v[x.task]}`}),x.task]})}),e.jsxs(N,{className:"w-full",children:[e.jsx(c,{children:x.message}),x.exc_info&&e.jsx(Gt,{logEntry:x})]})]},x.id)})})]})]})},Wt="modulepreload",Jt=function(s){return"/"+s},He={},Yt=function(t,r,n){let a=Promise.resolve();if(r&&r.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),l=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));a=Promise.all(r.map(o=>{if(o=Jt(o),o in He)return;He[o]=!0;const h=o.endsWith(".css"),g=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${g}`))return;const d=document.createElement("link");if(d.rel=h?"stylesheet":Wt,h||(d.as="script",d.crossOrigin=""),d.href=o,l&&d.setAttribute("nonce",l),document.head.appendChild(d),h)return new Promise((u,f)=>{d.addEventListener("load",u),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${o}`)))})}))}return a.then(()=>t()).catch(i=>{const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=i,window.dispatchEvent(l),!l.defaultPrevented)throw i})},Xt=Ke.lazy(()=>Yt(()=>import("./HandsonTable-BL5bSNAs.js"),__vite__mapDeps([0,1,2]))),Zt=({runId:s,taskId:t,open:r,onClose:n})=>{const a=$({...jt(s,t),enabled:r});return e.jsx(e.Fragment,{children:e.jsxs(ee,{title:t,subtitle:"任务数据",isOpen:r,footer:e.jsx(k,{variant:"secondary",color:"indigo",onClick:()=>n(),children:"关闭"}),onClose:n,children:[!a.isLoading&&!a.isError&&e.jsx(m.Suspense,{fallback:e.jsx("div",{children:"加载中..."}),children:e.jsx(Xt,{data:a.data,rowHeaders:!0,colHeaders:Object.keys(a.data[0]),height:"70vh",width:"700px",licenseKey:"non-commercial-and-evaluation"})}),a.isError&&(a.error.response.status===404?e.jsx(c,{children:"该任务无数据输出"}):e.jsxs(c,{color:"rose",children:["获取数据时出错: ",a.error.message]}))]})})},er=({pipeline:s,run:t})=>{const[r,n]=m.useState(),a=Ze(s.tasks);return e.jsxs(y,{children:[e.jsx(Zt,{runId:t.id,taskId:r||"",open:!!r,onClose:()=>n(void 0)}),e.jsx(_,{children:"任务"}),e.jsx(fe,{children:s.tasks.map((i,l)=>{var o;return e.jsxs(H,{className:"space-x-4",children:[t.tasks_run&&t.tasks_run[l]?e.jsx(C,{variant:"light",icon:xe[t.tasks_run[l].status],color:V[t.tasks_run[l].status]}):e.jsx(C,{variant:"light",icon:xe.pending,color:V.pending}),e.jsxs("div",{className:"truncate flex-grow",children:[e.jsxs(j,{className:"justify-start",children:[e.jsx("div",{className:`h-2 w-2 mr-2 rounded-full ${a[i.id]}`}),e.jsx(Q,{className:"truncate text-base text-tremor-content-emphasis dark:text-dark-tremor-content-emphasis",children:i.name})]}),i.description&&e.jsx(c,{className:"truncate",children:i.description})]}),t.tasks_run&&((o=t.tasks_run[l])==null?void 0:o.has_output)&&e.jsx(k,{variant:"light",color:"indigo",size:"xs",icon:Qs,onClick:()=>n(i.id),children:"查看数据"})]},i.id)})})]})},sr=()=>{const{lastMessage:s}=Re("run-update"),t=ve(),r=_e(),n=r.pipelineId,a=r.triggerId,i=parseInt(r.runId);m.useEffect(()=>{s&&t.invalidateQueries({queryKey:Ie(n,a,i).queryKey})},[s,n]);const l=$(Te(n)),o=$(Ie(n,a,i));if(l.isLoading)return e.jsx("div",{children:"加载中..."});if(l.isError)return e.jsx("div",{children:"错误"});const h=l.data,d=a===K.id?K:h.triggers.find(w=>w.id===a),u=o.data;if(!u)return e.jsx("div",{children:"未找到运行数据"});if(!d)return e.jsx("div",{children:"未找到触发器"});const f=(u.tasks_run||[]).reduce((w,x)=>w+x.duration,0),b=(u.tasks_run||[]).map(w=>f?w.duration/f*100:0),v=Ws(u.start_time,u.duration);return e.jsxs(Z,{header:e.jsxs(e.Fragment,{children:[e.jsxs(_,{children:['运行ID "#',i,'"']}),e.jsx(Oe,{pipeline:h,trigger:d,run:u})]}),children:[e.jsxs(F,{numItemsMd:3,className:"gap-6 mt-6",children:[e.jsx(er,{pipeline:h,run:u}),e.jsxs(y,{children:[e.jsxs(j,{className:"items-start",children:[e.jsx(c,{children:"耗时"}),e.jsx(ss,{status:u.status})]}),e.jsx(j,{className:"justify-start items-baseline space-x-3 truncate",children:e.jsxs(Y,{children:[u.status!=="running"?(u.duration/1e3).toFixed(2):e.jsx(ts,{startTime:u.start_time})," ","s"]})}),e.jsx(Js,{values:b,colors:he,showLabels:!1,className:"mt-3"}),e.jsxs(j,{alignItems:"start",className:"mt-2",children:[e.jsxs("div",{children:[e.jsx(c,{children:e.jsx(O,{title:M(u.start_time,!1),children:B(u.start_time)})}),e.jsx(c,{className:"mt-1",children:G(u.start_time)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(c,{children:e.jsx(O,{title:M(v,!1),children:B(v)})}),!Ys(u.start_time,v)&&e.jsx(c,{children:G(v)})]})]})]})]}),e.jsx("div",{className:"mt-6",children:e.jsx(y,{children:e.jsx(Qt,{pipeline:h,run:u})})})]})},tr=({children:s})=>{const{isAuthenticated:t,isLoading:r}=$e(),n=Xs();return!t&&!r?e.jsx(Zs,{to:"/login",replace:!0,state:{from:n}}):e.jsx(e.Fragment,{children:s})},rr=Object.assign({"./pages/index.tsx":It,"./pages/login.tsx":At,"./pages/pipelines/[pipelineId]/index.tsx":qt,"./pages/pipelines/[pipelineId]/triggers/[triggerId]/index.tsx":Bt,"./pages/pipelines/[pipelineId]/triggers/[triggerId]/runs/[runId]/index.tsx":sr}),nr=Object.entries(rr).map(([s,t])=>{const r=s.slice(7).replace(/(index)?\.tsx$/,"").split("/").map(n=>n.replace(/\[(.+)\]/,":$1")).join("/");return{path:r,element:r!=="/login"?e.jsx(tr,{children:e.jsx(t,{})}):e.jsx(t,{})}}),ar=()=>e.jsx(et,{children:nr.map(s=>e.jsx(st,{path:s.path,element:s.element},s.path))}),ir=new tt({defaultOptions:{queries:{retry:!1}}});function lr(){return e.jsx(rt,{client:ir,children:e.jsx(nt,{children:e.jsx(pt,{children:e.jsx(ar,{})})})})}at.createRoot(document.getElementById("root")).render(e.jsx(Ke.StrictMode,{children:e.jsx(lr,{})}));
