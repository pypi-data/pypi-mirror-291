**APM支付 | 结账支付 | 蚂蚁金服文档**
==================================================
![支付宝，中国领先的第三方在线支付解决方案](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![支付宝，中国领先的第三方在线支付解决方案](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)  
**[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fapm_api)** **[返回首页](../../)**

**结账支付**
-------------

**结账支付** 功能可以帮助您的网站或应用开始在线接收支付。本篇文章介绍了支持桌面浏览器、移动浏览器或应用的集成解决方案。集成后，您可以使用多种支付方式，如数字钱包、银行卡和银行转账。

### **用户体验**

#### **Web**

如果支付在桌面网站上发起，您需要将买家重定向到重定向URL或在新标签页中打开URL。

#### **WAP**

在WAP场景中，不同的支付方式可能会在**pay** API的响应中返回以下三个URL中的一个或全部：

1.  **applinkUrl**：已安装支付方式应用时，会自动拉起应用。如果应用未安装，将显示H5页面，具体H5页面的功能根据不同的支付方式有所不同。
2.  **schemeUrl**：如果买家安装了支付方式应用，它将自动拉起应用。如果未安装，应用不会启动，会停留在当前页面。如果应用未安装，会显示H5页面。
3.  **normalUrl**：显示该支付方式的H5页面。

#### **App**

在App场景中，不同的支付方式可能在**pay** API响应中返回以下三个URL之一：

1.  **applinkUrl**：已安装支付方式应用时，会自动拉起应用。如果应用未安装，会停留在当前页面。
2.  **schemeUrl**：如果买家安装了支付方式应用，它将自动拉起应用。如果未安装，应用不会启动，会停留在当前页面。
3.  **normalUrl**：显示该支付方式的H5页面。

**支付方式**
------------

### **高级功能**

*   **预前端解决方案API**
*   **先买后付API**
*   **卡存储API**
*   **卡支付功能API（SDK）**

**APM支付**
------------

**2024-05-11 10:13**

结账支付可以帮助您的网站或应用程序开始在线接收付款。本文档介绍了如何支持桌面浏览器、移动浏览器或应用程序支付的集成方案。集成后，您可以接受数字钱包、银行卡和其他支付方式的付款。

### **用户体验**

#### **Web**

在桌面网站上启动支付时，需要将买家重定向到重定向URL或在新窗口中打开URL。

#### **WAP**

在WAP场景中，不同的支付方式可能在**pay** API的响应中返回以下三个URL之一：

1.  **applinkUrl**：如果支付方式应用已安装，会自动启动应用；如果未安装，将显示H5页面。
2.  **schemeUrl**：如果买家安装了支付方式应用，它会直接跳转到应用；如果未安装，将留在当前页面。
3.  **normalUrl**：显示该支付方式的H5页面。

#### **App**

在App场景中，不同的支付方式在**pay** API响应中可能返回以下三个URL之一：

1.  **applinkUrl**：如果支付方式应用已安装，会自动拉起应用；如果未安装，会停留在当前页面。
2.  **schemeUrl**：如果买家安装了支付方式应用，它会直接跳转到应用；如果未安装，应用不会启动，会停留在当前页面。
3.  **normalUrl**：显示该支付方式的H5页面。

**支付流程**
------------

每个支付方法的支付流程通常包括以下步骤：

1.  买家进入结账页面。
2.  调用**pay** API创建支付请求。
3.  处理支付继续URL。
4.  获取支付结果。

### **集成步骤**

1.  (可选) 客户端添加支付方式列表。
2.  调用**pay** API获取支付继续URL。
3.  获取支付结果。

**步骤1：** **（可选）** **客户端添加支付方式列表**

在结账页面上，为买家显示要集成的支付方式的标志和名称。标志和名称可以通过以下两种方式获取：

1.  通过联系蚂蚁金服技术支持获取，支付宝+支付方式的标志需要遵守支付宝+品牌规范，可以按照所需尺寸和风格自动生成。更多详情请参考[品牌资产](https://global.alipay.com/docs/ac/ref/brandasset)。
2.  调用**咨询** API，根据交易的货币、交易发起终端类型、买家所在地区和已签约的支付方式，获取当前交易支持的支付方式和标志URL。

以下展示了添加支付方式后的页面效果示例：

-   Web
-   WAP
-   App

**完成以上步骤后，您将能够开始集成支付宝的结账支付功能。**
### 网页效果  
![Image 15: 图片.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713348005995-375d5402-fa2a-4233-92c5-d0e23db55f75.png)
### WAP页面效果
![图片16: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712827010224-ae4112ad-1de9-4cfc-bac2-26b8adaa3c8f.png)  
支付方式  
玩家450455  
英文  
9.99美元  
9.99美元  
立即支付  
确认订单  
3+50  
FPX  
公司  
:.10美元  
支付  
KAKAOAY  
FPX  
999  
总计：  
代币  
大小
### 应用页面效果
![图像 17: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713348044054-4dedaba1-8800-4fad-9f0d-025b2b77af2e.png)

步骤2：调用支付API获取支付继续URL（服务器端和客户端）
------------------------------------------------------------

当买家选择使用蚂蚁金服提供的支付方式付款时，您需要收集关键信息，如支付请求ID、订单金额、支付方式、交易环境信息、订单描述、支付重定向页面URL以及接收支付结果通知的URL。接下来，调用**pay** API来获取支付继续URL，并将买家重定向到该URL指向的结账页面进行支付。
### 服务器端发起支付请求  
Antom 提供了多种语言的服务器端 API 库。以下以 Java 为例，需要安装 Java 6 或更高版本。  
#### 安装 API 库  
最新的版本可以在 [GitHub](https://github.com/alipay/global-open-sdk-java) 上找到。  
```xml
<dependency>
  <groupId>com.alipay.global.sdk</groupId>
  <artifactId>global-open-sdk-java</artifactId>
  <version>2.0.21</version>
</dependency>
```  
#### 初始化请求实例  
```java
String merchantPrivateKey = "YOUR PRIVATE KEY";
String alipayPublicKey = "ALIPAY PUBLIC KEY";
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG, 
merchantPrivateKey, alipayPublicKey);
```  
#### 创建支付请求  
支付请求包含以下参数：  
| 参数名 | 是否必需 | 描述 |
| --- | --- | --- |
| productCode | 是 | 在此场景中固定为 `CASHIER_PAYMENT`。 |
| paymentRequestId | 是 | 商户生成的唯一标识。 |
| paymentAmount | 是 | 以支付货币的最小单位设定的支付金额。 |
| paymentMethod | 是 | 支付方式枚举值。 |
| paymentRedirectUrl | 是 | 商户侧的支付结果页面，需要根据服务器返回结果展示。 |
| paymentNotifyUrl | 否 | 支付结果通知地址，可通过 API 指定或在门户中设置固定值。 |
| settlementStrategy | 否 | 支付的结算货币，如签署有多种结算货币，需要在 API 中指定。 |
| order | 是 | 订单信息，包括订单金额、订单 ID 和订单描述。 |
| env | 是 | 买家发起交易的环境。 |

对于完整的参数信息，请参阅 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 文档。

以下代码示例用于发起支付请求：  
```java
AlipayPayRequest alipayPayRequest = new AlipayPayRequest();
alipayPayRequest.setClientId(CLIENT_ID);
alipayPayRequest.setPath("/ams/api/v1/payments/pay");
alipayPayRequest.setProductCode(ProductCodeType.CASHIER_PAYMENT);  
// 替换为你的 paymentRequestId
alipayPayRequest.setPaymentRequestId("paymentRequestId01");  
// 设置金额
Amount amount = new Amount();
amount.setCurrency("HKD");
amount.setValue("100");
alipayPayRequest.setPaymentAmount(amount);  
// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("ALIPAY_HK");
alipayPayRequest.setPaymentMethod(paymentMethod);  
// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId01");
order.setOrderDescription("antom test order");
order.setOrderAmount(amount);
alipayPayRequest.setOrder(order);  
// 设置环境信息
Env env = new Env();
env.setTerminalType(TerminalType.WAP);
env.setClientIp("114.121.121.01");
env.setOsType(OsType.ANDROID);
alipayPayRequest.setEnv(env);  
// 替换为你的通知地址
alipayPayRequest.setPaymentNotifyUrl("http://www.yourNotifyUrl.com");  
// 替换为你的重定向地址
alipayPayRequest.setPaymentRedirectUrl("http://www.yourRedirectUrl.com");  
// 执行支付
AlipayPayResponse alipayPayResponse = null;
try {
    alipayPayResponse = defaultAlipayClient.execute(alipayPayRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}
```
请求消息的示例如下：

- **Web**
- **WAP**
- **App**

#### Web 示例代码
```json
{
  "paymentNotifyUrl": "http://www.yourNotifyUrl.com",
  "paymentRequestId": "paymentRequestId01",
  "env": {
    "terminalType": "WEB",
    "clientIp": "114.121.121.01"
  },
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentRedirectUrl": "http://www.yourRedirectUrl.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_HK"
  },
  "order": {
    "orderAmount": {
      "currency": "HKD",
      "value": "100"
    },
    "referenceOrderId": "referenceOrderId01",
    "orderDescription": "antom test order"
  }
}
```
#### WAP 示例代码
```json
{
  "paymentNotifyUrl": "http://www.yourNotifyUrl.com",
  "paymentRequestId": "paymentRequestId01",
  "env": {
    "terminalType": "WAP",
    "clientIp": "114.121.121.01",
    "osType": "ANDROID"
  },
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentRedirectUrl": "http://www.yourRedirectUrl.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_HK"
  },
  "order": {
    "orderAmount": {
      "currency": "HKD",
      "value": "100"
    },
    "referenceOrderId": "referenceOrderId01",
    "orderDescription": "antom test order"
  }
}
```
#### App 示例代码
```json
{
  "paymentNotifyUrl": "http://www.yourNotifyUrl.com",
  "paymentRequestId": "paymentRequestId01",
  "env": {
    "terminalType": "APP",
    "clientIp": "114.121.121.01",
    "osType": "ANDROID"
  },
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentRedirectUrl": "http://www.yourRedirectUrl.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_HK"
  },
  "order": {
    "orderAmount": {
      "currency": "HKD",
      "value": "100"
    },
    "referenceOrderId": "referenceOrderId01",
    "orderDescription": "antom test order"
  }
}
```
#### 常见问题

##### 如何设置 terminalType 的值？
- 买家在 PC 端发起交易时，`terminalType` 需设置为 `WEB`。
- 买家在移动浏览器发起交易时，`terminalType` 需设置为 `WAP`，并添加 `osType` 参数，根据买家手机填入相应的系统参数 `ANDROID` 或 `IOS`。
- 买家在 App 内发起交易时，`terminalType` 需设置为 `APP`。

##### 请求中可以使用中文字符吗？
不要在请求字段中使用中文字符，以避免某些支付方式（如 QRIS 和 Mastercard）的兼容性问题。

##### 如何设置支付结果通知地址？
Antom 会通过 [**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) 发送支付结果，可以通过 `pay` API 中的 `paymentNotifyUrl` 参数指定。如果每个支付的地址都相同，也可在 Antom 控制台中配置。如果同时设置了地址和 API 参数，Antom 将使用 API 中设置的地址。
### 服务器端接收支付响应  
以下代码是示例响应：  
**Web 示例代码**  
复制  
```json
{
  "normalUrl": "https://open-sea.alipayplus.com/api/open/v1/ac/cashier/self/codevalue/checkout.htm?codeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040090bbmmzTC4BzSex92tUglv31de",
  "orderCodeForm": {
    "codeDetails": [
      {
        "codeValue": "https://global.alipay.com/281002040090bbmmzTC4BzSex92tUglv31de",
        "displayType": "TEXT"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040090bbmmzTC4BzSex92tUglv31de&picSize=L",
        "displayType": "BIGIMAGE"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040090bbmmzTC4BzSex92tUglv31de&picSize=M",
        "displayType": "MIDDLEIMAGE"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040090bbmmzTC4BzSex92tUglv31de&picSize=S",
        "displayType": "SMALLIMAGE"
      }
    ],
    "expireTime": "2024-01-15T01:34:45-08:00"
  },
  "paymentActionForm": "{\"method\":\"GET\",\"paymentActionFormType\":\"RedirectActionForm\",\"redirectUrl\":\"https://open-sea.alipayplus.com/api/open/v1/ac/cashier/self/codevalue/checkout.htm?codeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040090bbmmzTC4BzSex92tUglv31de\"}",
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "paymentCreateTime": "2024-01-15T01:20:46-08:00",
  "paymentId": "20240115194010800100188640298283440",
  "paymentRequestId": "PAY_20240115172044263",
  "redirectActionForm": {
    "method": "GET",
    "redirectUrl": "https://open-sea.alipayplus.com/api/open/v1/ac/cashier/self/codevalue/checkout.htm?codeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040090bbmmzTC4BzSex92tUglv31de"
  },
  "result": {
    "resultCode": "PAYMENT_IN_PROCESS",
    "resultMessage": "payment in process",
    "resultStatus": "U"
  }
}
```  
**WAP 示例代码**  
复制  
```json
{
  "appIdentifier": "hk.alipay.wallet",
  "applinkUrl": "https://render.alipay.hk/p/w/hk-ulink/?path=/mobile&scheme=alipayhk%3A%2F%2Fplatformapi%2FstartApp%3FappId%3D85200168%26fromSite%3Dapp%26CashierAction%3DtradePay%26orderCode%3Dhttps%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR%26paymentRedirectUrl%3Dhttps%3A%2F%2Fkademo.intlalipay.cn%2Fmelitigo%2FTest_114.html%26terminalType%3DWAP",
  "normalUrl": "https://render.alipay.hk/p/h5/hk-cashier-merchant/www/index.html/#/otp?scene=uefa&redirectUrl=https%3A%2F%2Frender.alipay.hk%2Fp%2Fh5%2Fhk-cashier-merchant%2Fwww%2Findex.html%23%2Fpreorder%3ForderCode%3Dhttps%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR",
  "orderCodeForm": {
    "codeDetails": [
      {
        "codeValue": "https://global.alipay.com/281002040092tDM89hJ66zUrMS9hbIRv3kWR",
        "displayType": "TEXT"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR&picSize=L",
        "displayType": "BIGIMAGE"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR&picSize=M",
        "displayType": "MIDDLEIMAGE"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR&picSize=S",
        "displayType": "SMALLIMAGE"
      }
    ],
    "expireTime": "2024-02-28T19:53:58-08:00"
  },
  "paymentActionForm": "{\"method\":\"GET\",\"paymentActionFormType\":\"RedirectActionForm\",\"redirectUrl\":\"https://render.alipay.com/p/w/ac-fe-adaptor/?ACCodeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR&paymentMethodType=ALIPAY_HK&ACPaymentRedirectUrl=https%3A%2F%2Fkademo.intlalipay.cn%2Fmelitigo%2FTest_114.html&ACAppType=WAP\"}",
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "paymentCreateTime": "2024-02-28T19:40:00-08:00",
  "paymentId": "20240229194010800100188940208068249",
  "paymentRequestId": "PAY_20240229113956783",
  "redirectActionForm": {
    "method": "GET",
    "redirectUrl": "https://render.alipay.com/p/w/ac-fe-adaptor/?ACCodeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040092tDM89hJ66zUrMS9hbIRv3kWR&paymentMethodType=ALIPAY_HK&ACPaymentRedirectUrl=https%3A%2F%2Fkademo.intlalipay.cn%2Fmelitigo%2FTest_114.html&ACAppType=WAP"
  },
  "result": {
    "resultCode": "PAYMENT_IN_PROCESS",
    "resultMessage": "payment in process",
    "resultStatus": "U"
  }
}
```  
**App 示例代码**  
复制  
```json
{
  "appIdentifier": "hk.alipay.wallet",
  "applinkUrl": "https://render.alipay.hk/p/w/hk-ulink/?path=/mobile&scheme=alipayhk%3A%2F%2Fplatformapi%2FstartApp%3FappId%3D85200168%26fromSite%3Dapp%26CashierAction%3DtradePay%26orderCode%3Dhttps%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB%26paymentRedirectUrl%3Dhttps%3A%2F%2Fkademo.intlalipay.cn%2Forder%2Fdetail%3Fid%3DALIPAY_HK_1709199158552F696Z%26wallet%3DALIPAY_HK%26terminalType%3DWAP",
  "normalUrl": "https://render.alipay.hk/p/h5/hk-cashier-merchant/www/index.html/#/otp?scene=uefa&redirectUrl=https%3A%2F%2Frender.alipay.hk%2Fp%2Fh5%2Fhk-cashier-merchant%2Fwww%2Findex.html%23%2Fpreorder%3ForderCode%3Dhttps%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB",
  "orderCodeForm": {
    "codeDetails": [
      {
        "codeValue": "https://global.alipay.com/281002040090cQa97QFkz1kHL8zTDW47PyqB",
        "displayType": "TEXT"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB&picSize=L",
        "displayType": "BIGIMAGE"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB&picSize=M",
        "displayType": "MIDDLEIMAGE"
      },
      {
        "codeValue": "https://global.alipay.com/merchant/order/showQrImage.htm?code=https%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB&picSize=S",
        "displayType": "SMALLIMAGE"
      }
    ],
    "expireTime": "*************************"
  },
  "paymentActionForm": "{\"method\":\"GET\",\"paymentActionFormType\":\"RedirectActionForm\",\"redirectUrl\":\"https://render.alipay.com/p/w/ac-fe-adaptor/?ACCodeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB&paymentMethodType=ALIPAY_HK&ACPaymentRedirectUrl=https%3A%2F%2Fkademo.intlalipay.cn%2Forder%2Fdetail%3Fid%3DALIPAY_HK_1709199158552F696Z%26wallet%3DALIPAY_HK&ACAppType=WAP\"}",
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "paymentCreateTime": "2024-02-29T01:32:41-08:00",
  "paymentId": "20240229194010800100188010209093907",
  "paymentRequestId": "ALIPAY_HK_1709199158552F696Z",
  "redirectActionForm": {
    "method": "GET",
    "redirectUrl": "https://render.alipay.hk/p/w/ac-fe-adaptor/?ACCodeValue=https%3A%2F%2Fglobal.alipay.com%2F281002040090cQa97QFkz1kHL8zTDW47PyqB&paymentMethodType=ALIPAY_HK&ACPaymentRedirectUrl=https%3A%2F%2Fkademo.intlalipay.cn%2Forder%2Fdetail%3Fid%3DALIPAY_HK_1709199158552F696Z%26wallet%3DALIPAY_HK&ACAppType=WAP"
  },
  "result": {
    "resultCode": "PAYMENT_IN_PROCESS",
    "resultMessage": "payment in process",
    "resultStatus": "U"
  }
}
```  
**常见问题解答**  
#### 什么是 normalUrl？  
对于网页交易，Antom 会返回 _normalUrl_，服务器端需要将此 URL 传递给客户端以便重定向。如果要为同一订单再次发起支付，需要获取新的 _normalUrl_ 进行重定向。  
#### 什么是 paymentId？  
如果您需要存储相应的订单号以备后续退款和对账，可以使用 _paymentId_。
### 客户端重定向至支付方式的支付确认页  
**Web**  
**WAP**  
**App**  
#### Web的链接类型  
商家服务器将_normalUrl_传递给客户端，由客户端页面处理重定向至_normalUrl_的过程。  
#### WAP的链接类型  
服务器端将_normalUrl_传递给客户端，由客户端页面执行重定向。  
#### App的链接类型  
对于App交易，发起支付请求后，Antom会根据支付方式的能力返回一个或多个支付链接，包括_normalUrl_、_applinkUrl_和_schemeUrl_。  

| 链接类型 | 功能描述 | 方法 |
| --- | --- | --- |
| applinkUrl | 如果买家已安装支付方式应用，直接弹出应用内支付确认页。若买家未安装支付方式应用，弹出移动浏览器。 | 重定向到商户应用打开此链接。详情参考[最佳实践](https://global.alipay.com/docs/ac/autodebit_en/best_practice)。 |
| normalUrl | 弹出移动浏览器，部分支付方式会跳转到应用内支付确认页，部分支付方式会直接进行H5支付。 |  |
| schemeUrl | 如果买家已安装支付方式应用，直接弹出应用内支付确认页。若买家未安装支付方式应用，返回错误。 |  |

完成此步骤后的页面效果如下图所示：

[图片18: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712831790503-d4a64766-1c85-4e6d-8a07-948e5eb3c220.png)  
**RMO.33将从您的BOOST中扣除**  
**0%纯棉预购**  
**DCZ5SU65IANWKBO2CXMUIAL6**  
**去支付**  
**RM0.33**  
**支付方式**  
**DCZ5SU65JANWKRG2CXWUJAL6**  
**TEST.ACQ.O1**  
**经典黑色棉T恤**  
**XCWMDJKFZ2J7AB4T**  
**确认支付**  
**确认支付**  
**余额：RM542**  
**钱包账户**  
**信用卡&借记卡**  
**XCWMDJKFZ2J7AB4T**  
**验证**  
**O221OO5OVCHBMFXL3N**  
**RM0.33**  
**余额：RM542**  
**忘记PIN码？**  
**应付总额：**  
**订单确认**  
**额外柔软触感**  
**RM0.33**  
**TESTACO\_O1**  
**订单回顾**  
**RM0.33**  
**TESTACO\_O1**  
**配送**  
**DBYALIPAY-**  
**20221O05OVCHBMFXL3MGXT**  
**RM0.33**  
**小计：**  
**RM0.33**  
**15:01**  
**15:01**  
**O**  
**15:01**  
**支付**  
**RM0.00**  
**支付宝**  
**BOOST**  
**$二**  
**DCZ5SU65IANWKRA2CXWUIA**  
**总计：**  
**O**  
**一**  
**X**  
**RMO.33将从您的BOOST中扣除**  
**0%纯棉预购**  
**DCZ5SU65IANWKBO2CXMUIAL6**  
**去支付**  
**RM0.33**  
**支付方式**  
**DCZ5SU65JANWKRG2CXWUJAL6**  
**TEST.ACQ.O1**  
**经典黑色棉T恤**  
**XCWMDJKFZ2J7AB4T**  
**确认支付**  
**确认支付**  
**余额：RM542**  
**钱包账户**  
**信用卡&借记卡**  
**XCWMDJKFZ2J7AB4T**  
**验证**  
**O221OO5OVCHBMFXL3N**  
**RM0.33**  
**余额：RM542**  
**忘记PIN码？**  
**应付总额：**  
**订单确认**  
**额外柔软触感**  
**RM0.33**  
**TESTACO\_O1**  
**订单回顾**  
**RM0.33**  
**TESTACO\_O1**  
**配送**  
**DBYALIPAY-**  
**20221O05OVCHBMFXL3MGXT**  
**RM0.33**  
**小计：**  
**RM0.33**  
**15:01**  
**15:01**  
**O**  
**15:01**  
**支付**  
**RM0.00**  
**支付宝**  
**BOOST**  
**$二**  
**DCZ5SU65IANWKRA2CXWUIA**  
**总计：**  
**O**  
**一**  
**X**  
#### 常见问题解答  
##### 如何处理不同的支付体验？  
您不需要处理与不同支付方式对应的不同的体验。只需通过前端页面重定向到_normalUrl_。不同的支付体验由_normalUrl_负责完成渲染和支付流程。
### 客户端展示支付结果页面  
您需要提供一个HTTPS地址，并通过`paymentRedirectUrl`字段在**pay** API中指定，此字段用于在商家端显示支付结果。  
![图片19: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712827877509-9d6a4347-c27a-41e3-aa2b-dfeb66715aeb.png)  

#### 常见问题解答  
##### 支付结果页面显示什么？  
无论支付成功或失败，支付方式侧都可以重定向到结果页面。  
##### 重定向到结果页面意味着支付成功了吗？  
结果页面不能作为判断支付是否成功的依据：  
*   买家成功支付后，可能因网络或其他原因没有被重定向到结果页面。
*   如果买家未完成支付，仍有可能被重定向到结果页面。
*   Antom 不支持在`paymentRedirectUrl`字段中指定代表支付结果的信息。  

### 步骤3：获取支付结果 - 客户端
--------------------------------------------  
当买家完成支付或支付超时，您可以通过Antom的异步通知或者主动查询支付结果来获取相应的支付状态。
### **接收异步通知**  
当支付完成或失败时，蚂蚁金服会通过支付API中的`paymentNotifyUrl`参数指定的地址，发送异步通知([**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online))。如果每个支付的地址相同，您也可以在蚂蚁金服控制台中配置地址。  
以下是通知请求的示例代码：  
```json
{
"notifyType": "PAYMENT_RESULT",
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "success"
},
"paymentRequestId": "paymentRequestId01",
"paymentId": "2020010123456789XXXX",
"paymentAmount": {
"value": "100",
"currency": "HKD"
},
"paymentCreateTime": "2020-01-01T12:01:00+08:30",
"paymentTime": "2020-01-01T12:01:01+08:30"
}
```  
以下是验证并响应通知的示例代码：  
```java
@RequestMapping(path = "/payResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> paymentNotifyProcessor(HttpServletRequest request,
@RequestBody String body) {
// 从请求头中获取所需参数。
String requestTime = request.getHeader("request-time");
String clientId = request.getHeader("client-id");
String rawSignature = request.getHeader("signature");
String signature = "";  
// 从原始签名中获取有效部分
if(rawSignature==null||rawSignature.isEmpty()){
throw new RuntimeException("empty notify signature");
}else {
String[] parts = rawSignature.split("signature=");
if (parts.length > 1) {
signature = parts[1];
}
}  
// 验证支付结果通知的签名
boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
clientId, requestTime, body, signature,
ALIPAY_PUBLIC_KEY);
if (!verifyResult) {
throw new RuntimeException("Invalid notify signature");
}  
// 根据通知结果更新记录状态  
// 响应服务器接收通知
Result result = new Result("SUCCESS", "success", ResultStatusType.S);
AlipayResponse response = new AlipayResponse();
response.setResult(result);
return ResponseEntity.ok().body(response);
}
```  
以下是通知响应的示例代码：  
```json
{
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "Success"
}
}
```
#### 常见问题  
##### 何时会发送通知？  
支付完成后，蚂蚁金服将在3~5秒内向您发送异步通知。如果支付未完成，您需要等待蚂蚁金服关闭订单后才会发送异步通知。不同支付方式的订单关闭时间不同，通常默认为14分钟。  
##### 异步通知会被重新发送吗？  
如果您收到蚂蚁金服的异步通知，需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应。如果您没有按照要求响应异步通知，或者由于网络原因通知未送达，通知将在24小时内自动重试，最多重试8次或直至收到正确的响应为止。重试发送间隔为：0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时和15小时。  
##### 是否需要对响应进行签名？  
如果您收到蚂蚁金服的异步通知，需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应，但不需要对响应进行签名。  
##### 如何理解以下关键字段的含义？  
*   _result_：表示订单的支付结果。
*   _paymentRequestId_：表示您为咨询、取消和对账生成的支付请求号。
*   _paymentId_：表示蚂蚁金服生成的支付订单号，用于退款和对账。
*   _paymentAmout_：表示支付金额。
### 查询支付结果  
发起查询请求涉及以下参数。  
<table style="width:784px;outline:none;border-collapse:collapse;border:1px solid #D9E0F2" class="lake-table"><colgroup><col width="211" span="1"><col width="133" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td style="background-color:#D9E0F2;width:211px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid #D9E0F2;padding:4px 8px;cursor:default"><p style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong>参数名</strong></p></td><td style="background-color:#D9E0F2;width:211px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid #D9E0F2;padding:4px 8px;cursor:default"><p style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong>是否必填</strong></p></td><td style="background-color:#D9E0F2;width:211px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid #D9E0F2;padding:4px 8px;cursor:default"><p style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong>描述</strong></p></td></tr><tr style="height:33px"><td style="width:211px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid #D9E0F2;padding:4px 8px;cursor:default"><p style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px">paymentRequestId</p></td><td style="width:211px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid #D9E0F2;padding:4px 8px;cursor:default"><p style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px">否</p></td><td style="width:211px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid #D9E0F2;padding:4px 8px;cursor:default"><p style="font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px">商户生成的支付请求号</p></td></tr></tbody></table>  
以下是示例代码：  
```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG, merchantPrivateKey, alipayPublicKey);
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/sandbox/api/v1/payments/inquiryPayment");
alipayPayQueryRequest.setPaymentRequestId("paymentRequestId01");
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}
```  
**获取响应码**  
```json
{
    "result": {
        "resultCode": "SUCCESS",
        "resultStatus": "S",
        "resultMessage": "Success"
    },
    "paymentStatus": "SUCCESS",
    "paymentRequestId": "paymentRequestId01",
    "paymentId": "2019060811401080010018882020035XXXX",
    "paymentAmount": {
        "value": "100",
        "currency": "HKD"
    },
    "paymentCreateTime": "2019-06-01T12:01:01+08:30",
    "paymentTime": "2019-06-01T12:01:01+08:30",
    "transactions": null
}
```  
#### 常见问题  
##### 如何理解以下关键字段的含义？  
*   _result_：API调用的结果。它仅表示**inquiryPayment** API调用的结果。订单结果应基于_paymentStatus_确定。`SUCCESS`和`FAIL`表示最终结果，而`PROCESSING`表示交易仍在进行中。
*   _paymentAmount_：金额验证。如果需要验证金额，可以使用此字段。  
##### 应该多久发起一次查询？  
建议每隔2秒轮询查询一次，直到获取到最终支付结果或收到异步支付通知为止。  
#### 最佳实践  
遵循以下最佳实践以提高集成效率。  
**自定义支付超时时间**  
在结账支付场景中，蚂蚁侧的默认超时时间为14分钟，超时后买家无法继续支付。要定义超时时间，可以通过**pay** API 的_paymentExpireTime_ 参数来指定。超过指定时间后，买家将无法扫码或登录结账页面。  
以下示例代码展示了如何在**pay** API 中指定_paymentExpireTime_ 参数：  
-   Web
-   WAP
-   App
### 网页示例代码

```json
{
  "env": {
    "terminalType": "WEB"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "1314"
    },
    "orderDescription": "Cappuccino 大杯 (Mika's咖啡店)",
    "referenceOrderId": "ORDER_0517884936248XXXX"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "1314"
  },
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "paymentExpiryTime": "2024-01-20T08:51:06+08:00",
  "paymentNotifyUrl": "https://www.gaga.com/notify",
  "paymentRedirectUrl": "imeituan://",
  "paymentRequestId": "iJ9lsVgTx8pX7qJpvW6rfqEE2Kdv9M3lgL8e1999ydfz52uMSqwvT3qXYw8IFBYt",
  "productCode": "CASHIER_PAYMENT",
  "settlementStrategy": {
    "settlementCurrency": "USD"
  }
}
```

这段JSON代码描述了一个网页支付的示例，其中包含以下字段：

- `env.terminalType`: 环境类型，这里是"WEB"，表示网页端。
- `order`: 订单信息，包括订单金额（CNY，1314元）、订单描述和参考订单ID。
- `paymentAmount`: 支付金额与订单金额相同，也是CNY 1314元。
- `paymentMethod`: 支付方式，使用的是"ALIPAY_CN"，即支付宝中国版。
- `paymentExpiryTime`: 支付有效期，2024年1月20日8点51分06秒（北京时间）。
- `paymentNotifyUrl`: 支付成功后通知的URL，这里是"gaga.com"的服务器地址。
- `paymentRedirectUrl`: 支付完成后重定向的URL，这里可能是"美团"的某个特定页面。
- `paymentRequestId`: 支付请求ID，用于标识本次支付请求。
- `productCode`: 产品代码，"CASHIER_PAYMENT"可能表示结账支付。
- `settlementStrategy`: 结算策略，结算货币为USD（美元）。
### WAP 示例代码
复制
```json
{
  "env": {
    "osType": "ANDROID",
    "terminalType": "WAP"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "1314"
    },
    "orderDescription": "卡布奇诺（大杯）（Mika's咖啡店）",
    "referenceOrderId": "ORDER_0517884936248XXXX"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "1314"
  },
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "paymentExpiryTime":"2024-01-20T08:51:06+08:00",
  "paymentNotifyUrl": "https://www.gaga.com/notify",
  "paymentRedirectUrl": "imeituan://",
  "paymentRequestId": "iJ9lsVgTx8pX7qJpvW6rfqEE2Kdv9M3lgL8e1999ydfz52uMSqwvT3qXYw8IFBYt",
  "productCode": "CASHIER_PAYMENT",
  "settlementStrategy": {
    "settlementCurrency": "USD"
  }
}
```

这是用于WAP支付的示例数据，其中包含了支付环境、订单信息、支付金额、支付方式、支付有效期、通知URL、重定向URL、请求ID、产品代码以及结算策略等关键参数。这个例子中，订单描述是购买一杯大杯卡布奇诺，支付方式为中国地区的支付宝（ALIPAY_CN），并且结算货币为美元（USD）。
### 应用示例代码
```json
{
  "env": {
    "osType": "ANDROID",
    "terminalType": "APP"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "1314"
    },
    "orderDescription": "Cappuccino #grande (Mika's coffee shop)",
    "referenceOrderId": "ORDER_0517884936248XXXX"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "1314"
  },
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "paymentExpiryTime":"2024-01-20T08:51:06+08:00",
  "paymentNotifyUrl": "https://www.gaga.com/notify",
  "paymentRedirectUrl": "imeituan://",
  "paymentRequestId": "iJ9lsVgTx8pX7qJpvW6rfqEE2Kdv9M3lgL8e1999ydfz52uMSqwvT3qXYw8IFBYt",
  "productCode": "CASHIER_PAYMENT",
  "settlementStrategy": {
    "settlementCurrency": "USD"
  }
}
```
### 支付过期时间
如果指定了 `_paymentExpireTime_`，买家支付的有效时间将变为 `_paymentExpireTime_` 中的时间。如果买家在此时间后付款，会有两种体验：
1. 买家无法完成支付。
2. 买家付款后立即退款。

### 获取支付继续URL
部分支付方法订单接口耗时，可能导致你无法收到响应，买家无法被重定向到指定的地址。建议将接口超时设为10秒，确保获取响应的成功率。如果调用支付超时，建议重新发起原始请求以获取支付继续URL。

### 优化网页支付体验（仅限Web）
某些支付方法支持买家在PC上通过扫描二维码或密码支付。在买家选择此类支付方法时，API响应中的代码值可以直接在商户页面上渲染显示二维码或密码，减少页面重定向，提升体验。Antom返回的二维码不会自动刷新，显示二维码时，应添加API响应中的`expireTime`以显示超时时间。显示密码时，实现密码复制功能，方便买家将支付信息粘贴到支付应用中。

### 重定向至商户结果页面
1. **客户端重定向异常**  
   如果买家支付成功，由于网络原因或支付方法本身限制未能重定向至`_paymentRedirectUrl_`，请注意以下两点：
   - 不应将客户端重定向作为支付成功的依据。
   - 如果支付方法页面的`_paymentRedirectUrl_`重定向失败，买家可能会手动点击返回原始商户页面。因此，建议在原始商户订单页面中引导查询交易结果的弹窗，买家点击后显示订单结果，避免再次支付。
2. **重定向后触发订单结果查询**  
   - 商户支付结果页面展示时。
   - 发货给买家之前。
   - 收到Antom对账文件时。

### 打开支付方法URL（仅限App）
| 支付方法特性 | 链接类型 | 解决方案 | 优缺点 |
| --- | --- | --- | --- |
| 只支持APP支付 | applinkUrl | - iOS调用`openUrl`，Android调用`startActivity`<br>- 优点：在支付方法应用中完成支付<br>- 优点：无需处理买家未安装支付应用的异常 | 无 |
| normalUrl | normalUrl | - iOS调用`openUrl`，Android调用`startActivity`<br>- 优点：在支付方法应用中完成支付<br>- 优点：无需处理买家未安装支付应用的异常<br>- 缺点：支付过程中会先弹出浏览器再重定向至支付应用 |
| schemeUrl | schemeUrl | - iOS调用`openUrl`，Android调用`startActivity`<br>- 优点：在支付方法应用中完成支付 | - 优点：订单处理过程全部在商户应用内完成<br>- 缺点：需要处理买家未安装支付应用的异常 |

### 处理支付失败的重试
1. 在支付请求中，将`_referenceOrderId_`设置为订单ID，`_paymentRequestId_`设置为支付订单ID。
2. 对于同一个商户订单，如果第一次支付未完成，且支持买家再次发起支付，建议如下步骤：
   - 保持`_referenceOrderId_`不变，更新对应的新的支付订单ID `_paymentRequestId_`。
   - 如果有不支持退款的支付方式，建议在发起新支付前取消第一个支付订单。

### 获取支付结果
为了确保稳定获取支付结果，避免买家支付完成但你未收到支付结果的情况，建议在以下阶段检查支付结果：
1. 商户支付结果页面显示时。
2. 买家发货前。
3. 收到Antom对账文件时。
### 常见问题解答  
#### 在Android中遇到歧义框时该怎么办？  
请参阅[Google文档](https://developer.android.com/training/package-visibility/use-cases?hl=zh-cn#avoid-a-disambiguation-dialog)以获取更多信息。  
#### 如何使用WebView加载订单页面？  
为了提供良好的用户体验，您可以在客户端使用WebView加载订单页面。用户点击订单后，可以直接重定向到支持支付方式的移动应用来完成支付，可以参考JavaScript代码与移动客户端代码的绑定来实现这种交互体验。  
*   Android: [https://developer.android.com/develop/ui/views/layout/webapps/webview?hl=zh-cn#BindingJavaScript](https://developer.android.com/develop/ui/views/layout/webapps/webview?hl=zh-cn#BindingJavaScript)
*   iOS: [https://developer.apple.com/documentation/javascriptcore/jsexport?language=objc](https://developer.apple.com/documentation/javascriptcore/jsexport?language=objc)  
要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。  
![图片20](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片21](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 本页面是否有帮助？  
#### 本页内容  
[用户体验](#Ksw2W "用户体验")  
[支付流程](#N7q25 "支付流程")  
[集成步骤](#nbBeY "集成步骤")  
[步骤1：（可选）添加支付方式列表](#VTOFD "步骤1：（可选）添加支付方式列表")  
[步骤2：调用支付API并获取支付继续URL](#dUZwg "步骤2：调用支付API并获取支付继续URL")  
[发起支付请求](#vPvsX "发起支付请求")  
[安装API库](#6hGTH "安装API库")  
[初始化请求实例](#ft0LA "初始化请求实例")  
[创建支付请求](#BGvIj "创建支付请求")  
[接收支付响应](#QhTNS "接收支付响应")  
[常见问题解答](#v5Jyj "常见问题解答")  
[重定向到支付方式的结账页面](#62lB0 "重定向到支付方式的结账页面")  
[常见问题解答](#cXZYo "常见问题解答")  
[显示支付结果页面](#x1EYF "显示支付结果页面")  
[常见问题解答](#WblBX "常见问题解答")  
[步骤3：获取支付结果](#7FBHl "步骤3：获取支付结果")  
[接收异步通知](#PMBUH "接收异步通知")  
[常见问题解答](#nmLpr "常见问题解答")  
[查询支付结果](#O1jRy "查询支付结果")  
[常见问题解答](#tkpZO "常见问题解答")  
[最佳实践](#6620B "最佳实践")  
[自定义支付超时](#f5gU1 "自定义支付超时")  
[获取支付继续URL](#CRUkl "获取支付继续URL")  
[优化支付体验](#luUxS "优化支付体验")  
[重定向到商户结果页面](#qDjwR "重定向到商户结果页面")  
[商户结果页面处理逻辑的建议](#GdEle "商户结果页面处理逻辑的建议")  
[支付失败重试](#hAeaV "支付失败重试")  
[获取支付结果](#o55cG "获取支付结果")  
[打开支付方式URL](#jyh8F "打开支付方式URL")  
[常见问题解答](#QamNx "常见问题解答")  
[在Android中遇到歧义框时该怎么办？](#XTN3K "在Android中遇到歧义框时该怎么办？")  
[如何使用WebView加载订单页面？](#2IeMu "如何使用WebView加载订单页面？")  
提供反馈