创建
====

2024-04-10 03:24

POST /v1/subscriptions/create

使用**创建** API 来发起订阅创建请求。成功调用此 API 后，您可以获取授权 URL 并将用户重定向到该 URL 进行订阅授权。用户成功授权订阅后，支付宝将在每个订阅周期自动扣款，并将支付结果通知您。

结构
====

消息由头和正文组成。以下部分专注于正文结构。关于头结构，请参阅：

*   [请求头](https://global.alipay.com/docs/ac/ams/api_fund#ML5ur)
*   [响应头](https://global.alipay.com/docs/ac/ams/api_fund#WWH90)

**注意**：将每个字段（除数组外）的数据类型设置为 String。这意味着您必须使用双引号（" "）包围字段值。例如：

*   如果字段的数据类型为 Integer，其值为 20，则设置为 "20"。
*   如果字段的数据类型为 Boolean，其值为 true，则设置为 "true"。
### 请求参数  
显示全部  
#### subscriptionRequestId 字符串  必填  
商家为识别订阅请求分配的唯一ID。支付宝使用此字段进行幂等性控制。  
关于此字段的更多信息：  
*   此字段是API幂等字段。对于使用相同`subscriptionRequestId`发起并达到最终状态S或F的订阅请求，应返回相同的结果。
*   最大长度：64个字符  
#### subscriptionDescription 字符串  必填  
订阅的描述，用于显示用户消费记录和其他操作。  
关于此字段的更多信息：  
*   最大长度：256个字符  
#### subscriptionRedirectUrl URL  必填  
用户授权订阅后重定向到的商家页面URL。  
关于此字段的更多信息：  
*   最大长度：2048个字符  
#### subscriptionStartTime 日期时间  必填  
订阅开始生效的日期和时间。  
关于此字段的更多信息：  
*   值遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式。例如，"2019-11-27T12:01:01+08:00"。  
#### subscriptionEndTime 日期时间  
订阅结束的日期和时间。  
当需要指定订阅结束时间时，提供此参数。  
关于此字段的更多信息：  
*   值遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式。例如，"2019-11-27T12:01:01+08:00"。  
#### periodRule 期规则对象  必填  
订阅周期规则，用于定义订阅的计费周期。  
显示子参数  
#### subscriptionExpiryTime 日期时间  
创建的订阅过期的特定日期和时间。订阅过期后，订单必须终止。此参数的默认值为订阅创建请求发送后30分钟。
如果需要指定订阅创建的过期时间，请设置此参数。指定的支付过期时间必须在订阅请求发送后48小时内。  
关于此字段的更多信息：  
*   值遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式，例如："2019-11-27T12:01:01+08:00"。  
#### paymentMethod PaymentMethod 对象 **必需**  
商家或收单机构用于收集支付的方法。  
显示子参数  
#### subscriptionNotificationUrl URL  
用于接收订阅结果通知的URL。  
您也可以在Antom控制台中配置订阅通知URL。如果在此API和Antom控制台中都指定了此URL，API中配置的URL优先。  
> Antom控制台中只能配置一个订阅通知URL。  
关于此字段的更多信息：  
*   最大长度：2048个字符  
#### paymentNotificationUrl URL  
用于接收每个订阅周期支付结果通知的URL。  
您也可以在[Antom控制台](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fopen%2Fconsole%2Fdeveloper%2Fapp%2Flist&from_site=MERCHANT&terminal_type=pc&loginScene=MERCHANT&locale=cn&loginId=&_route=QK)中配置。如果在此API和Antom控制台中都指定了此URL，API中配置的URL优先。  
> Antom控制台中只能配置一个订阅通知URL。  
关于此字段的更多信息：  
*   最大长度：2048个字符  
#### orderInfo OrderInfo 对象 **必需**  
订阅的订单信息。此字段用于不同目的：  
*   在支付过程中，主要用于支付宝的风险控制或反洗钱。
完成支付后，此字段用于记录和报告，如购买跟踪和监管报告。  
显示子参数  
#### paymentAmount Amount 对象 **必需**
每个订阅周期向用户收取的支付金额。  
显示子参数  
#### settlementStrategy SettlementStrategy 对象 **必需**
支付请求的结算策略。  
显示子参数  
#### env Env 对象 **必需**
关于订单放置环境的信息，如设备信息。  
显示子参数  
#### trials Array<Trial> 对象
订阅的试用信息列表。  
如果订阅包含任何试用期，请指定此参数。  
关于此字段的更多信息  
*   最大大小：无限制  
显示子参数
### 响应参数  
显示全部  
#### result 结果对象 **必需**  
指示此 API 是否调用成功。如果 API 调用成功，将返回订阅授权 URL。  
显示子参数  
#### schemeUrl URL  
当目标应用已安装时，用于在 Android 或 iOS 系统中重定向用户打开应用的 URL 方案。  
当 *result.resultCode* 的值为 `S` 时，需要返回 *schemeUrl*、*applinkUrl* 和 *normalUrl* 中的至少一个。  
关于此字段的更多信息：  
*   最大长度：2048 个字符  
#### applinkUrl URL  
当目标应用已安装时，用于重定向用户打开应用的 URL，或者当目标应用未安装时打开 WAP 页面。对于 Android，URL 是 Native App Link。对于 iOS，URL 是 Universal Link。  
当 *result.resultCode* 的值为 `S` 时，需要返回 *schemeUrl*、*applinkUrl* 和 *normalUrl* 中的至少一个。  
关于此字段的更多信息：  
*   最大长度：2048 个字符  
#### normalUrl URL  
用于在默认浏览器或嵌入式 WebView 中重定向用户到 WAP 或 Web 页面的 URL。  
当 *result.resultCode* 的值为 `S` 时，需要返回 *schemeUrl*、*applinkUrl* 和 *normalUrl* 中的至少一个。  
关于此字段的更多信息：  
*   最大长度：2048 个字符  
#### appIdentifier URL  
Android 包名，用于 Android 应用打开收银台页面。  
当 *result.resultCode* 为 `S` 且 *terminalType* 为 `APP` 或 `WAP` 时返回此字段。  
关于此字段的更多信息：  
*   最大长度：128 个字符  
API 探索器  
示例代码在沙箱中运行
### 请求  
URL  
北美地区  
https://open-na-global.alipay.com/ams/api/v1/subscriptions/create  
场景  
订阅创建  
请求体  
```json
{
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodId": "paymentMethodId_paymentMethodId"
  },
  "env": {
    "osType": "ANDROID",
    "terminalType": "WAP"
  },
  "paymentAmount": {
    "currency": "PHP",
    "value": "1100"
  },
  "paymentNotificationUrl": "https://www.alipay.com",
  "periodRule": {
    "periodType": "YEAR",
    "periodCount": 1
  },
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "subscriptionDescription": "Subscription test",
  "subscriptionEndTime": "2024-08-09T14:55:16+08:00",
  "subscriptionExpiryTime": "2023-08-09T14:55:16+08:00",
  "subscriptionNotificationUrl": "https://www.alipay.com",
  "orderInfo": {
    "orderAmount": {
      "currency": "PHP",
      "value": "1100"
    }
  },
  "subscriptionRedirectUrl": "https://www.alipay.com",
  "subscriptionRequestId": "merchant_subscription_2100000123456789_21200000987654321",
  "subscriptionStartTime": "2023-08-09T14:30:16+08:00"
}
```
### 请求  
URL  
北美地区  
https://open-na-global.alipay.com/ams/api/v1/subscriptions/create  
案例  
创建订阅  
请求体  
```json
{
  "result": {
    "resultStatus": "S",
    "resultCode": "SUCCESS",
    "resultMessage": "success."
  },
  "applinkUrl": "http://xmock.inc.alipay.net/applinkUrl/test/url.htm",
  "normalUrl": "http://xmock.inc.alipay.net/normalUrl/test/url.htm",
  "schemeUrl": "http://xmock.inc.alipay.net/schemeUrl/test/url.htm",
  "appIdentifier": "http://xmock.inc.alipay.net/appIdentifier/test/url.htm"
}
```

#### 结果处理逻辑
对于不同的请求结果，需要执行不同的操作。 细节如下：
*   如果 *result.resultStatus* 的值为 `S`，则授权 URL 会通过响应中的 schemeUrl、applinkUrl 或 normalUrl 字段成功返回。 您可以将用户重定向到该 URL 以授权订阅付款。
*   如果*result.resultStatus*的值为`U`，则API调用状态未知。您可以再次调用此API以重试流程。
*   如果*result.resultStatus*的值为`F`，则未能返回授权URL。这通常由系统缺陷或系统故障引起。请检查错误代码并采取相应的措施，或联系支付宝技术支持。

### 结果/错误代码  
| 代码 | 值 | 消息 | 进一步操作 |
| --- | --- | --- | --- |
| SUCCESS | S | 成功 | 接口调用成功。从响应中获取*schemeUrl*、*applinkUrl*或*normalUrl*。 |
| ACCESS\_DENIED | F | 访问被拒绝。 | 联系支付宝技术支持获取详细原因。 |
| CLIENT\_FORBIDDEN\_ACCESS\_API | F | 访问被拒绝。 | 联系支付宝技术支持获取详细原因。 |
| INVALID\_API | F | 调用的API无效或未激活。 | 联系支付宝技术支持解决问题。 |
| INVALID\_CLIENT\_STATUS | F | 客户端状态无效。 | 联系支付宝技术支持获取详细原因。 |
| INVALID\_SIGNATURE | F | 签名验证失败。请求签名所用的私钥与Antom Dashboard的公钥不匹配。 | 检查请求签名所用的私钥是否与Antom Dashboard的公钥匹配。参考签名信息如下：  <br>*   请求头中的[签名](https://global.alipay.com/docs/ac/ams/api_fund)字段<br>*   如何[计算签名](https://global.alipay.com/docs/ac/ams/digital_signature)  |
| KEY\_NOT\_FOUND | F | 支付宝或商家的私钥或公钥未找到。 | 检查私钥或公钥是否存在。如不存在，请在Antom Dashboard上传私钥。 |
| MERCHANT\_NOT\_REGISTERED | F | 商家未注册。 | 使用注册接口注册商家。如调用注册接口失败，请联系支付宝技术支持。 |
| OAUTH\_FAILED | F | OAuth流程失败。 | 联系支付宝技术支持获取详细原因。 |
| PARAM\_ILLEGAL | F | 必要参数未传递，或存在非法参数。例如，非数字输入、无效日期或参数长度和类型错误。 |检查并验证当前API所需的请求字段（包括头部字段和正文字段）是否正确传递并有效。|
| PAYMENT\_NOT\_QUALIFIED | F | 商户因未注册、未签订自动扣款协议或被禁止支付而不具备支付资格。 | 请咨询支付宝技术支持以获取详细原因。 |
| PROCESS\_FAIL | F | 发生了一般的业务失败。 | 不要重试，通常需要人工干预。建议联系支付宝技术支持解决。 |
| RISK\_REJECT | F | 由于风险控制，交易无法进一步处理。如果用户已支付，交易将被退款。 | 若用户在两周内未收到退款，联系支付宝技术支持。 |
| UNKNOWN\_CLIENT | F | 客户未知。 | 请咨询支付宝技术支持以获取详细原因。 |
| REQUEST\_TRAFFIC\_EXCEED\_LIMIT | U | 请求流量超过限制。 | 重新调用接口以解决问题。如未解决，联系支付宝技术支持。 |
| UNKNOWN\_EXCEPTION | U | 由于未知原因，API调用失败。 | 重新调用接口以解决问题。如未解决，联系支付宝技术支持。 |
| REPEAT\_REQ\_INCONSISTENT | F | 金额或货币与先前请求不一致。 | 确保所有请求字段相同，或使用新的*subscriptionRequestId*重新发起支付。 |

要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。

