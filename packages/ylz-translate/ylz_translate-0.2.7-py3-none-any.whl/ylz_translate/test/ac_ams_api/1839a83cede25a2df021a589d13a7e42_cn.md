使用SDK进行请求签名和验证签名 | 产品API | 支付宝文档
==========================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](./img_m_a52690f40beef33d7d37f1bda6f48c27.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](./img_m_d70d46fd32b98952674df01c03131d87.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fams%2Fsignature_sdk)

[返回首页](../../)

产品API

[支付宝API](/docs/ac/ams/api)

[概览](/docs/ac/ams/api_fund)

[幂等性](/docs/ac/ams/idempotency)

[消息编码](/docs/ac/ams/me)

[使用SDK进行请求签名和验证签名](/docs/ac/ams/signature_sdk)

[请求签名和验证签名](/docs/ac/ams/digital_signature?pageVersion=34)

[API变更历史](/docs/ac/ams/changehistory)

在线支付

店内支付

使用SDK进行请求签名和验证签名
======================================

2024-05-29 10:14

通过使用Antom提供的SDK进行请求签名和签名验证，可以极大地简化编程任务并加速添加和验证API签名的过程。所有可用的SDK都可以在[SDKs](https://global.alipay.com/docs/sdks)中找到。如果你不想使用SDK，可以参考[手动签名和验证签名](https://global.alipay.com/docs/ac/ams/digital_signature)的指南。

为了确保数据传输后的真实性与完整性，Antom要求所有请求必须进行签名，并且需要验证签名：

调用API
========

前提条件
------------

确保您已经在[Antom仪表板](https://dashboard.alipay.com/global-payments/developers/quickStart)上生成了一对非对称的公钥和私钥。更多详情，请参阅[生成密钥](https://global.alipay.com/docs/dashboard_en#D584U)。

发送请求与处理响应
------------------------------

如果您使用SDK进行API调用，签名和验证过程将自动完成。

1.  添加Maven依赖项：

> 您可以在[GitHub](https://github.com/alipay/global-open-sdk-java)上找到最新版本。

复制代码

依赖
----

在Java项目中添加以下依赖以使用蚂蚁金服全球开放服务SDK：

```xml
<dependency>
  <groupId>com.alipay.global.sdk</groupId>
  <artifactId>global-open-sdk-java</artifactId>
  <version>{最新版本}</version>
</dependency>
```

使用SDK发起请求
----------------

以下代码示例展示了如何使用Java发送支付请求：

```java
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.alipay.global.api.AlipayClient;
import com.alipay.global.api.DefaultAlipayClient;
import com.alipay.global.api.exception.AlipayApiException;
import com.alipay.global.api.model.ams.*;
import com.alipay.global.api.model.constants.EndPointConstants;
import com.alipay.global.api.request.ams.pay.AlipayPayRequest;
import com.alipay.global.api.response.ams.pay.AlipayPayResponse;

@RestController
public class PaymentBySDK {

    /**
     * 支付宝公钥，用于验证签名
     */
    private static final String SERVER_PUBLIC_KEY = "";

    /**
     * 你的私钥，用于签名
     * 请确保私钥的安全存储，防止泄露
     */
    private static final String CLIENT_PRIVATE_KEY = "";

    /**
     * 你的客户端ID
     */
    private static final String CLIENT_ID = "";

    public static AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG, CLIENT_PRIVATE_KEY, SERVER_PUBLIC_KEY);

    @RequestMapping("/pay")
    public Object pay() {
        AlipayPayRequest alipayPayRequest = composePayRequest();

        AlipayPayResponse alipayPayResponse = null;
        try {
            // 自动签名并验证
            alipayPayResponse = defaultAlipayClient.execute(alipayPayRequest);
        } catch (AlipayApiException e) {
            String errorMsg = e.getMessage();
            // 处理错误情况
        }
        return alipayPayResponse;
    }

    private AlipayPayRequest composePayRequest() {
        AlipayPayRequest alipayPayRequest = new AlipayPayRequest();

        alipayPayRequest.setClientId(CLIENT_ID);
        alipayPayRequest.setPath("/ams/api/v1/payments/pay");

        Env env = new Env();
        env.setTerminalType(TerminalType.WEB);
        alipayPayRequest.setEnv(env);

        Amount amount = new Amount();
        amount.setCurrency("CNY");
        amount.setValue("100");
        alipayPayRequest.setPaymentAmount(amount);

        Amount orderAmount = new Amount();
        orderAmount.setCurrency("CNY");
        orderAmount.setValue("100");

        Order order = new Order();
        order.setReferenceOrderId("ORDER_ID_1685599933871");
        order.setOrderDescription("测试订单");
        order.setOrderAmount(orderAmount);
        alipayPayRequest.setOrder(order);

        PaymentMethod paymentMethod = new PaymentMethod();
        paymentMethod.setPaymentMethodType("ALIPAY_CN");
        alipayPayRequest.setPaymentMethod(paymentMethod);

        alipayPayRequest.setPaymentRequestId("REQUEST_ID_1685599933871");

        alipayPayRequest.setProductCode(ProductCodeType.CASHIER_PAYMENT);

        alipayPayRequest.setPaymentRedirectUrl("https://www.example.com");
        return alipayPayRequest;
    }
}
```

接收通知
========

处理请求
--------

收到蚂蚁金服的通知后，需要验证请求的签名。验证请求签名的过程与[发送请求与处理响应](#oTHvx)部分介绍的类似。按照以下步骤验证签名：

1.  从[前提条件](#sxRYf)获取用于验证签名的蚂蚁金服请求公钥。
2.  从请求头中获取`request-time`、`client-id`和`signature`。
3.  验证签名。

以下代码示例展示了如何使用Java验证签名：

```java
import com.alipay.api.AlipayClient;
import com.alipay.api.DefaultAlipayClient;
import com.alipay.api.request.AlipaySystemOauthTokenRequest;
import com.alipay.api.response.AlipaySystemOauthTokenResponse;
import com.alipay.api.response.AlipayUserAuthCodeExchangeResponse;
import com.alipay.api.internal.util.AlipaySignature;
import java.util.Map;

public class SignatureVerificationExample {

    public static void main(String[] args) {
        // Your Alipay app ID
        String appId = "your_app_id";
        // Your Alipay private key
        String privateKey = "your_private_key";
        // Alipay public key
        String publicKey = "alipay_public_key";
        // Alipay server URL
        String serverUrl = "https://openapi.alipay.com/gateway.do";

        // Create Alipay client
        AlipayClient alipayClient = new DefaultAlipayClient(serverUrl, appId, privateKey, "json", "utf-8", publicKey, "RSA2");

        // Example request with signature to verify
        Map<String, String> params = new HashMap<>();
        params.put("param1", "value1");
        params.put("param2", "value2");
        String sign = "the_signature_to_verify";

        // Verify the signature
        boolean isVerified = AlipaySignature.rsa256Verify(params, sign, alipayClient.getFormat(), alipayClient.getCharset(), alipayClient.getPublicKey());

        if (isVerified) {
            System.out.println("Signature verified successfully.");
        } else {
            System.out.println("Signature verification failed.");
        }
    }
}
```

这段代码演示了如何使用Alipay SDK在Java中验证一个签名。首先，它设置了支付宝应用ID、私钥、公钥和服务器URL。然后，创建一个AlipayClient实例。接着，创建一个包含要验证的参数和签名的示例请求。最后，使用`AlipaySignature.rsa256Verify`方法来验证签名，并根据结果输出验证是否成功。

```java
import javax.servlet.http.HttpServletRequest;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

import com.alipay.global.api.model.Result;
import com.alipay.global.api.model.ResultStatusType;
import com.alipay.global.api.response.AlipayResponse;
import com.alipay.global.api.tools.WebhookTool;

@RestController
public class PaymentNotifyHandleBySDK {

    /**
     * 支付宝公钥，用于验证签名
     */
    private static final String SERVER_PUBLIC_KEY = "";

    /**
     * 使用Spring框架处理支付结果通知
     *
     * @param request        HttpServletRequest对象
     * @param notifyBody     通知体
     * @return
     */
    @PostMapping("/payNotify")
    public Object payNotifyHandler(HttpServletRequest request, @RequestBody String notifyBody) {

        // 从HTTP请求中获取所需参数
        String requestUri = request.getRequestURI();
        String requestMethod = request.getMethod();

        // 从请求头中获取所需参数
        String requestTime = request.getHeader("request-time");
        String clientId = request.getHeader("client-id");
        String signature = request.getHeader("signature");

        Result result;
        AlipayResponse response = new AlipayResponse();

        try {
            // 验证通知的签名
            boolean verifyResult = WebhookTool.checkSignature(requestUri, requestMethod, clientId, requestTime, signature, notifyBody, SERVER_PUBLIC_KEY);
            if (!verifyResult) {
                throw new RuntimeException("无效的通知签名");
            }

            // 反序列化通知体内容

            // 根据通知结果更新订单状态

            // 响应服务器已接收到通知
            result = new Result("SUCCESS", "success", ResultStatusType.S);

        } catch (Exception e) {
```

```java
String errorMsg = e.getMessage();
// 处理错误情况
Result result = new Result("ERROR", errorMsg, ResultStatusType.F);
response.setResult(result);
return ResponseEntity.ok().body(response);
```

查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。

![图片 3](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![图片 4](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面是否有帮助？

#### 在此页面上

[调用API](#zt532 "调用API")

[前提条件](#sxRYf "前提条件")

[发送请求及处理响应](#oTHvx "发送请求及处理响应")

[接收通知](#KpEOV "接收通知")

[处理请求](#a8PNS "处理请求")