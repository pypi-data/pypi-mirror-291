通知授权
===================

2024年4月24日 07:15

> 支付宝使用**notifyAuthorization**在授权成功或取消授权成功时，将授权结果发送给商家。

结构
=========

一条消息由头和体组成。以下部分关注体的结构。关于头的结构，请参阅：
*   [请求头](https://global.alipay.com/docs/ac/ams/api_fund#ML5ur)
*   [响应头](https://global.alipay.com/docs/ac/ams/api_fund#WWH90)

**注意**：除数组外，每个字段的数据类型应设置为字符串。这意味着必须使用双引号（" "）包围字段值。示例：

*   如果字段的数据类型为Integer，其值为20，则设置为"20"。
*   如果字段的数据类型为Boolean，其值为true，则设置为"true"。

### 请求参数  
显示全部  
#### authorizationNotifyType 字符串  必填  
授权通知类型。有效值包括：  
*   `AUTHCODE_CREATED`（仅限自动扣款）：表示用户同意授权自动扣款支付。用户同意授权后，可以从该通知中获取由钱包生成的授权码，并在 **applyToken** API 中使用以获取访问令牌。
*   `TOKEN_CREATED`：表示用户在商户客户端成功发起授权。
*   `TOKEN_CANCELED`：表示用户在支付方式侧成功取消了授权。  
关于此字段的更多信息：  
*   最大长度：32 个字符  
#### authClientId 字符串  
用户授予资源访问权限的二级商户的唯一 ID。该值由收单方指定，需要在支付宝中注册。  
注意事项：  
*   当 **consult** API 由 Alipay+ MPP 启动时，此字段将返回。
*   对于 Alipay+ MPP，此字段的值与 [pay (Cashier Payment)](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中的 _referenceMerchantId_ 的值相同。  
关于此字段的更多信息：  
*   最大长度：64 个字符  
#### accessToken 字符串  
用于访问用户资源相应范围的访问令牌。  
注意：当 *authorizationNotifyType* 的值为 `TOKEN_CANCELED` 或 `TOKEN_CREATED` 时，此字段将返回。  
关于此字段的更多信息：  
*   最大长度：128 个字符  
#### authState 字符串  
由收单方生成的字符串，用于表示咨询请求。此字段的值用于验证是否与 **consult** 请求中指定的 *authState* 值一致。  
注意：当 *authorizationNotifyType* 为 `AUTHCODE_CREATED` 和 `TOKEN_CREATED` 时，此字段将返回。  
关于此字段的更多信息：  
*   最大长度：256 个字符  
#### authCode 字符串  
授权码，用于获取访问令牌。此值由应用程序从钱包重定向后返回的重建重定向 URL 中获取。  
注意：当 *authorizationNotifyType* 为 `AUTHCODE_CREATED` 时，此字段将返回。  
关于此字段的更多信息：  
*   最大长度：64 个字符  
#### reason 字符串  
取消授权的原因。当用户提供取消授权的原因时，此字段会发送给商户。  
注意：当 *authorizationNotifyType* 为 `TOKEN_CANCELED` 时，此字段将返回。  
关于此字段的更多信息：  
*   最大长度：256 个字符  
#### result Result 对象  必填  
授权结果。支付宝仅在授权成功或取消授权成功时返回授权通知。因此，仅提供成功的授权结果。  
显示子参数  
#### userLoginId 字符串  
用户在钱包中注册时使用的登录 ID。登录 ID 可以是用户的电子邮件地址或电话号码。  
指定此参数以避免用户手动输入登录 ID。  
关于此字段的更多信息：  
*   最大长度：64 个字符  
#### userId 字符串  
支付方式提供商分配给用户以标识用户的 ID。  
关于此字段的更多信息：  
*   最大长度：64 个字符
### 响应参数  
显示全部  
#### result 结果对象 **必需**  
一个固定值，需要发送给支付宝以确认已接收到通知。  
显示子参数  
API 探索器
### 请求  
情况  
已取消的授权结果  
请求体  
```json
{
  "authorizationNotifyType": "TOKEN_CANCELED",
  "accessToken": "28100103_20215703001538122119",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success",
    "resultStatus": "S"
  }
}
```
### 响应  
响应体  
```json
{
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "Success"
  }
}
```

#### 响应处理逻辑  
在接收到支付宝的通知后，发送包含固定值的消息给支付宝，以确认已收到支付宝的通知：  
示例代码  
```json
{
 "result": {
    "resultCode":"SUCCESS",
    "resultStatus":"S",
    "resultMessage":"success"
 }
}
```

如果由于操作问题或网络问题，没有将此类消息返回给支付宝，支付宝会间歇性地重新发送通知，直到商家返回所需消息。首次通知发送后的24小时内会进行重试。通知将重试最多8次，间隔为0秒、2分钟、10分钟、10分钟、1小时、2小时、6小时和15小时。
