易安宝支付（Web/WAP） | 易安宝 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Feasypay_en%2FWW)  
[返回首页](../../)

易安宝支付
[概述](/docs/ac/easypay_en/overview_en)  
接收支付  
[易安宝支付（Web/WAP）](/docs/ac/easypay_en/WW)  
[易安宝支付（Android）](/docs/ac/easypay_en/android)  
[易安宝支付（iOS）](/docs/ac/easypay_en/ios)  
支付后  
易安宝支付（Web/WAP）
=====================  
2024-05-16 03:26

本文档介绍了支持从桌面浏览器或移动浏览器接收支付的集成解决方案。集成后，您可以提供数字钱包、银行卡和银行转账等多种支付方式。

用户体验
==========

以下截图展示了钱包支付和银行转账的用户体验。首次支付时，买家可以启用免密支付，以便后续支付时无需输入支付密码。后续支付的整个过程将在您的网站或应用内完成。

钱包支付
--------  

买家可以在首次支付时完成支付并启用免密支付，之后的支付无需输入支付密码，整个过程在您的网站或应用内进行。

首次支付  
后续支付
### 首次支付
在首次支付时，买家会完成授权流程，以支付并启用后续的免密支付功能。
![图片 3: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715067956632-8df88d11-5c30-405d-b3f6-37ebf683d4e1.png)
### 后续支付  
后续支付无需密码即可进行。对于大额支付，您可以设定一个最低支付金额，当支付金额超过这个值时，需要额外的验证步骤以增强安全性。  

#### 小额支付  
对于小额订单，买家可以直接提交订单并进行支付，无需进一步确认。  
![图4: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715067987211-e7a344a9-96e3-4f0e-b944-f681ecfc0816.png)  

#### 大额支付  
为了增强支付安全性，您可以要求买家确认超过预设金额的支付。  
![图5: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1710926297396-d1e77a67-3153-497f-bf6b-b541300cba9b.png)  
**商户**  
**商户**  
**商户**  
115.00  
银行转账  
----------------  
对于银行转账支付方式，以下图形展示了首次支付和后续支付的用户体验。  

**首次支付**  
**后续支付**
### 首次支付  
在首次支付时，用户需要输入支付密码和验证码。  
![图片6: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715062419262-049a8f73-b56e-44b7-9e6f-03cb575e9ff0.png)
### 后续支付  
后续支付无需验证号码即可进行。  
![图片 7: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715062470488-622345be-9004-44c4-82d6-b60c203d806c.png)  
支付流程
========  
首次支付
------------  
当买家选择蚂蚁金服提供的支付方式时，您需要收集必要的信息，包括支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL。然后调用**createPaymentSession** API创建订单，并调用蚂蚁金服SDK的相关方法来协助支付流程。  
![图片 8: Easy Pay 首次支付流程图@3x.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715417235698-b9af58be-a7da-4b19-8c7f-1d222fb83e93.png)  
1.  **买家进入结账页面。**
2.  **创建**[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**请求**
买家选择支付方式并提交订单后，您可以通过调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口获取支付会话。
3.  **调用客户端SDK**
在客户端，通过支付会话调用SDK。SDK会根据支付方式的特性收集支付要素，显示代码信息，重定向，调用并引导买家完成支付。
4.  **获取授权结果**  
*   异步通知：授权成功后，蚂蚁金服会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API向您发送异步通知。
*   同步查询：调用[**查询支付**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口检查授权状态。
5.  **获取支付结果**
    *   异步通知：在[**创建支付会话**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口中设置_paymentNotifyUrl_，指定接收异步通知的地址。支付成功或超时时，Antom会使用[**通知支付**](https://global.alipay.com/docs/ac/ams/paymentrn_online)向您发送异步通知。
    *   同步查询：调用[**查询支付**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口检查支付状态。

后续支付
----------------
当买家选择Antom提供的支付方式时，您需要收集必要的信息，包括支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL。然后调用**createPaymentSession** API创建订单，并调用Antom SDK中的相关方法来辅助支付流程。

![图片9: Easy Pay 再次支付流程图@3x.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715414803432-40c1d868-9a88-465d-8ff1-811b2b04db47.png)

1.  **买家进入结账页面。**
2.  **创建**[**创建支付会话**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**请求**
    买家选择支付方式并提交订单后，您可以调用[**创建支付会话**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口获取支付会话。
3.  **调用客户端SDK**
在客户端，通过支付会话调用SDK。SDK会根据支付方式的特性收集支付要素，展示代码信息，重定向，调用并引导买家完成支付。

4. **获取支付结果**
可以通过以下两种方法之一获取支付结果：
* 异步通知：在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口中指定_paymentNotifyUrl_，设置接收异步通知的地址。支付成功或超时时，蚂蚁金服会使用[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)向您发送异步通知。
* 同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口检查支付状态。

**集成步骤**
----------------
按照以下步骤开始集成：
1. 创建支付会话
2. 调用SDK
3. 获取授权或支付结果

步骤1：创建支付会话（服务器端）
-----------------------------------------------  
当买家选择蚂蚁金服提供的支付方式时，您需要收集必要的信息，包括支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL。然后，通过以下步骤调用**createPaymentSession** API来创建支付会话：
1. 安装API库
2. 初始化请求实例
3. 调用**createPaymentSession** API  
> **注意**：蚂蚁金服提供了多种语言的服务器端API库。以下代码以Java为例，您需要安装Java 6或更高版本。
### 安装API库
您可以在[GitHub](https://github.com/alipay/global-open-sdk-java)上找到最新版本。  
复制以下内容：  
```xml
<dependency>
    <groupId>com.alipay.global.sdk</groupId>
    <artifactId>global-open-sdk-java</artifactId>
    <version>2.0.21</version>
</dependency>
```

这段代码是用于Maven项目的依赖配置，将它添加到您的`pom.xml`文件中，即可引入蚂蚁金服的全球开放SDK Java版本2.0.21。
### 初始化请求实例  
创建一个单例资源以向Antom发起请求。  
复制  
```java
import com.alipay.global.api.AlipayClient;
import com.alipay.global.api.DefaultAlipayClient;

String merchantPrivateKey = "您的私钥";
String alipayPublicKey = "支付宝公钥";
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
```

这里的代码是在Java环境中，导入了蚂蚁金服的API库，然后初始化了一个默认的`AlipayClient`实例。`merchantPrivateKey`是商户的私钥，`alipayPublicKey`是支付宝的公钥，`EndPointConstants.SG`通常代表请求的服务器端点。这个实例将用于后续与蚂蚁金服接口的交互。
### 调用 createPaymentSession API  
首次支付  
后续支付  
#### 首次支付  
调用 **createPaymentSession** API，通过指定以下参数创建支付会话：  
| **参数名** | **必填** | **描述** |
| --- | --- | --- |
| paymentRedirectUrl | ✅ | 支付完成后买家被重定向到的商户页面URL。 |
| authState | ✅ | 由您分配的用于启动授权的唯一标识，用于后续免密支付获取令牌。此参数仅在首次支付时传递，后续支付不需要传递此参数。 |
| paymentNotifyUrl | ✅ | 支付结果通知地址。该地址必须为HTTPS。 |
| paymentSessionExpiryTime | ✅ | 支付会话超时时间。默认为1小时，可设置为1小时内超时，值的格式遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准。例如，2019-11-27T12:01:01+08:00。 |
| userLoginId | ✅ | 买家的钱包侧登录账号，可以是买家的电子邮件地址或电话号码。 |
| order.buyer: referenceBuyerId/buyerPhoneNo/buyerEmail | ✅ | 为风险决策传递买家信息。只需传递referenceBuyerId、buyerPhoneNo、buyerEmail中的一个参数即可。 |  

上述参数不全面，完整参数列表及特定支付方式的额外要求请参考[**createPaymentSession (EasySafePay)**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay) API文档。  
以下示例代码展示了如何调用 **createPaymentSession** API：  
```java
AlipayPaymentSessionRequest alipayPaymentSessionRequest = new AlipayPaymentSessionRequest();
alipayPaymentSessionRequest.setClientId(clientId);
alipayPaymentSessionRequest.setPath("/ams/sandbox/api/v1/payments/createPaymentSession");
```

请注意，这只是一个示例，实际使用时需要根据具体的应用场景和接口文档填充完整参数。
支付宝支付会话请求设置如下：

```java
alipayPaymentSessionRequest.setProductCode(ProductCodeType.AGREEMENT_PAYMENT); // 设置产品代码为协议支付
alipayPaymentSessionRequest.setProductScene(ProductSceneConstants.EASY_PAY); // 设置产品场景为快捷支付
alipayPaymentSessionRequest.setPaymentRequestId("paymentRequestId001"); // 替换为你的支付请求ID
Amount amount = new Amount(); // 设置金额
amount.setCurrency("CNY"); // 设置货币类型为人民币
amount.setValue("100"); // 设置金额为100元
alipayPaymentSessionRequest.setPaymentAmount(amount); // 设置支付金额
SettlementStrategy settlementStrategy = new SettlementStrategy(); // 设置结算货币
settlementStrategy.setSettlementCurrency("USD"); // 设置结算货币为美元
alipayPaymentSessionRequest.setSettlementStrategy(settlementStrategy); // 设置结算策略
AgreementInfo agreementInfo = new AgreementInfo(); // 设置协议信息
agreementInfo.setAuthState("authState001"); // 设置授权状态
agreementInfo.setUserLoginId("userLoginId001"); // 设置用户登录ID
alipayPaymentSessionRequest.setAgreementInfo(agreementInfo); // 设置协议信息
PaymentMethod paymentMethod = new PaymentMethod(); // 设置支付方式
paymentMethod.setPaymentMethodType("ALIPAY_CN"); // 设置支付方式类型为支付宝中国
Order order = new Order(); // 设置订单信息
order.setReferenceOrderId("referenceOrderId001"); // 设置参考订单ID
order.setOrderDescription("orderDescription001"); // 设置订单描述
order.setOrderAmount(amount); // 设置订单金额
Buyer buyer = new Buyer(); // 设置买家信息
buyer.setReferenceBuyerId("referenceBuyerId001"); // 设置参考买家ID
order.setBuyer(buyer); // 设置买家
order.setOrderAmount(amount); // 设置订单金额
alipayPaymentSessionRequest.setOrder(order); // 设置订单
alipayPaymentSessionRequest.setPaymentNotifyUrl("https://www.yourNotifyUrl"); // 替换为你的通知URL
alipayPaymentSessionRequest.setPaymentRedirectUrl("https://www.yourMerchantWeb.com"); // 替换为你的重定向URL
AlipayPaymentSessionResponse alipayPaymentSessionResponse = defaultAlipayClient.execute(alipayPaymentSessionRequest); // 执行支付会话请求
```

以下是一个请求消息的示例：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId001",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  // ...其他可能的字段
}
```

请注意替换示例中的占位符为实际值。
"支付方式": { "支付方式类型": "ALIPAY_CN" }, "协议信息": { "授权状态": "authState001", "用户登录ID": "userLoginId001" }, "支付金额": { "货币": "CNY", "值": "100" }, "订单": { "订单金额": { "货币": "CNY", "值": "100" }, "参考订单号": "referenceOrderId001", "订单描述": "orderDescription001", "买家": { "参考买家ID": "referenceBuyerId001" } } }

以下代码显示了一个响应示例，其中包含以下参数：  
*   _paymentSessionData_: 需要转发给客户端的支付会话数据。
*   _paymentSessionExpiryTime_: 支付会话的过期时间。

```
{
"paymentSessionData": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Kvvmsdk+akdLvoShW5avHX8e8J15P8uNVEf/PcCMyXg==&&SG&&111",
"paymentSessionExpiryTime": "2023-04-06T03:28:49+08:00",
"paymentSessionId": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Ikyj9FPVUOpv+DjiIZqMe",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}
```

#### 后续支付

调用 **createPaymentSession** API 创建支付会话，指定以下参数：  
| **参数名** | **是否必需** | **描述** |
| --- | --- | --- |
| paymentMethod.paymentMethodId | ✅ | 传递在第一次支付后从[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API 接收到的 *accessToken* 的值。 |
| paymentRedirectUrl | ✅ | 买家支付完成后重定向的商户页面URL。 |
| paymentNotifyUrl | ✅ | 支付结果通知地址。该地址必须为HTTPS。 |
| paymentSessionExpiryTime | ✅ | 支付会话超时时间。默认为1小时，可设置为1小时内超时，值的格式遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准。例如，2019-11-27T12:01:01+08:00。 |
| 买家信息: referenceBuyerId/buyerPhoneNo/buyerEmail | ✅ | 用于风险决策的买家信息。传递referenceBuyerId、buyerPhoneNo、buyerEmail中的任意一个参数即可。 |

以上参数不全面，完整参数列表及特定支付方式的额外要求请参考[**创建支付会话（EasySafePay）**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay) API文档。

以下示例代码展示了如何调用**createPaymentSession** API：

```java
AlipayPaymentSessionRequest alipayPaymentSessionRequest = new AlipayPaymentSessionRequest();
alipayPaymentSessionRequest.setClientId(clientId);
alipayPaymentSessionRequest.setPath("/ams/sandbox/api/v1/payments/createPaymentSession");
alipayPaymentSessionRequest.setProductCode(ProductCodeType.AGREEMENT_PAYMENT);
alipayPaymentSessionRequest.setProductScene(ProductSceneConstants.EASY_PAY);

// 替换为你的支付请求ID
alipayPaymentSessionRequest.setPaymentRequestId("paymentRequestId002");

Amount amount = new Amount();
// 设置金额
amount.setCurrency("CNY");
amount.setValue("100");
alipayPaymentSessionRequest.setPaymentAmount(amount);

// 设置结算货币
SettlementStrategy settlementStrategy = new SettlementStrategy();
settlementStrategy.setSettlementCurrency("USD");
alipayPaymentSessionRequest.setSettlementStrategy(settlementStrategy);

// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("ALIPAY_CN");
paymentMethod.setPaymentMethodId("*****************************");

// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId002");
order.setOrderDescription("orderDescription001");
order.setOrderAmount(amount);

Buyer buyer = new Buyer();
buyer.setReferenceBuyerId("referenceBuyerId001");
order.setBuyer(buyer);
order.setOrderAmount(amount);
alipayPaymentSessionRequest.setOrder(order);

// 替换为你的重定向URL
```

请注意，实际使用时请将示例代码中的占位符替换为实际的值。
支付宝支付会话请求设置如下：

```java
alipayPaymentSessionRequest.setPaymentNotifyUrl("https://www.yourNotifyUrl");
alipayPaymentSessionRequest.setPaymentRedirectUrl("https://www.yourMerchantWeb.com");  
AlipayPaymentSessionResponse alipayPaymentSessionResponse = defaultAlipayClient
.execute(alipayPaymentSessionRequest);  
```

请求消息示例如下：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId002",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentMethod": {
    "paymentMethodId": "*****************************",
    "paymentMethodType": "ALIPAY_CN"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "30000"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "30000"
    },
    "referenceOrderId": "referenceOrderId002",
    "orderDescription": "orderDescription002",
    "buyer": {
      "referenceBuyerId": "referenceBuyerId002"
    }
  }
}
```

响应示例包含以下关键参数：

```json
{
  "paymentSessionData": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Kvvmsdk+akdLvoShW5avHX8e8J15P8uNVEf/PcCMyXg==&&SG&&111",
  "paymentSessionExpiryTime": "2023-04-06T03:28:49+08:00",
  "paymentSessionId": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Ikyj9FPVUOpv+DjiIZqMe",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```

翻译解释：
- `paymentSessionData`：支付会话数据，需要转发给客户端。
- `paymentSessionExpiryTime`：支付会话的过期时间。
- `paymentSessionId`：支付会话ID。
- `resultCode`：结果代码，此处为“SUCCESS”表示成功。
- `resultMessage`：结果消息，此处为“success.”。
- `resultStatus`：结果状态，此处为“S”代表成功状态。
### 常见问题
#### 我可以在请求参数的值中使用中文字符吗？
为了避免某些支付方式的兼容性问题，不要在请求中包括`paymentRequestId`、`referenceOrderId`、`orderDescription`和`goods`等字段使用中文字符。

#### 如何设置接收支付通知的URL？
蚂蚁金服会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)接口发送支付结果。您可以在`createPaymentSession` API中通过`paymentNotifyUrl`参数指定这个URL。如果每个支付的回调地址相同，您也可以在蚂蚁金服控制台中进行全局配置。如果您同时在控制台设置了地址并在API中设置了参数，蚂蚁金服将使用API中设置的地址。

### 步骤2：调用SDK 客户端
------------------------------
### 安装

在开始集成之前，请确保已完成以下环境准备：

1. 兼容性处理：为Internet Explorer和其他旧版浏览器提供相应的polyfills。建议在构建项目时使用[Babel-preset-env](https://babeljs.io/docs/en/babel-preset-env)来解决浏览器兼容性问题。

2. 推荐使用以下浏览器版本：

   - 移动浏览器：
     - iOS：11及以上版本
     - Android：5.0及以上版本
   - 电脑浏览器，推荐以下版本：
     | ![Edge](http://godban.github.io/browsers-support-badges/)**Edge** 最后2个版本 | ![Firefox](http://godban.github.io/browsers-support-badges/)**Firefox** 最后2个版本 | ![Chrome](http://godban.github.io/browsers-support-badges/)**Chrome** 最后2个版本 | ![Safari](http://godban.github.io/browsers-support-badges/)**Safari** 最后2个版本 | ![Opera](http://godban.github.io/browsers-support-badges/)**Opera** 最后2个版本 | ![Electron](http://godban.github.io/browsers-support-badges/)**Electron** 最后2个版本 |
     | --- | --- | --- | --- | --- | --- |

通过CDN资源集成SDK包：

```html
<script src="https://sdk.marmot-cloud.com/package/ams-checkout/1.13.0/dist/umd/ams-checkout.min.js"></script>
```

通过npm安装：

```bash
npm install @alipay/ams-checkout
```
### 初始化SDK  
使用`AMSEasyPay`创建SDK实例，并指定基础配置。配置对象包含以下参数：

| **参数名称** | **是否必需** | **描述** |
| --- | --- | --- |
| *enviroment* | ✅ | 用于传递环境信息。有效值为：* `sandbox`：沙盒环境 * `prod`：生产环境 |
| *locale* |  | 用于传递语言信息。有效值如下，根据支付方法所在地区选择传递的值。如果传递其他值，默认使用本地语言：* `en_US`：英语 * `in_ID`：印度尼西亚语 * `th_TH`：泰语 * `ms_MY`：马来语 * `tl_PH`：菲律宾语 * `ko_KR`：韩语 * `vi_VN`：越南语 * `zh_HK`：繁体中文 |
| *analytics* |  | 用于配置和分析数据。包含以下值：* *enabled*：可选布尔值。默认为`true`，表示允许SDK上传和分析操作数据以提供更好的服务。如果不允许上传和分析数据，将其设置为`false`。 |
| *onLog* |  | 一个回调方法，用于生成SDK执行期间的日志和API异常的错误信息。 |
| *onEventCallback* |  | 当SDK运行时发生支付事件（如支付结果或表单提交错误）时，返回特定事件代码的回调函数。更多详细信息，请参考参考资料。 |

以下示例代码展示了如何获取浏览器语言：

```javascript
let language = navigator.language || navigator.userLanguage;
language = language.replace("-", "_"); // 将"-"替换为"_" 
```

以下示例代码展示了如何使用npm初始化SDK：

```javascript
import { AMSEasyPay } from '@alipay/ams-checkout' // 管理包
const checkoutApp = new AMSEasyPay({
  environment: "sandbox",
  locale: "en_US",
  analytics: {
    enabled: true
  },
  // 其他配置项...
});
```

请注意，这是一段假设的代码，实际使用时请根据蚂蚁金服的SDK文档进行调整。
以下是使用CDN方式实例化SDK的示例代码：

```javascript
const checkoutApp = new window.AMSEasyPay({
  environment: "sandbox", // 设置为沙箱环境
  locale: "en_US", // 设置为英文（美国）语言
  analytics: {
    enabled: true // 启用分析
  },
  onLog: ({code, message})=>{}, // 日志回调函数
  onClose:()=>{
    // 关闭半屏弹窗
  },
  onEventCallback: ({code, message})=>{}, // 事件回调函数
});
```

这段代码创建了一个名为`checkoutApp`的`AMSEasyPay`对象，用于处理支付流程。参数包括环境配置、语言设置、分析选项以及日志和事件处理回调函数。
### 调用SDK  
使用实例对象中的`createComponent`函数创建支付组件：  

| 参数名 | 是否必填 | 描述 |
| --- | --- | --- |
| *sessionData* | ✅ | 使用*sessionData*参数创建配置对象：将通过**createpaymentSession（结账支付）**API获取的*paymentSessionData*参数中的完整数据传递给*sessionData*参数。 |
| *appearance* |  | 自定义外观主题配置，包含以下子参数：* *showLoading*：可选。布尔类型。默认值为`true`，显示默认加载动画。如果不使用默认加载动画，需要将此值设置为`false`。 |

以下示例代码展示了如何渲染组件：  

```javascript
async function create(sessionData) {
  await checkoutApp.createComponent({
    sessionData: sessionData,
    appearance: {
      showLoading: true, // 默认为true，启用默认加载样式。
    }
  });
}
```

在以下情况下调用`unmount`方法释放SDK组件资源：  
*   当买家切换视图离开结账页面时，释放**createPaymentSession**中创建的组件资源。
*   当买家发起多次支付时，释放之前**createPaymentSession**中创建的组件资源。  

```javascript
// 释放SDK组件资源
checkoutApp.unmount();
```
### 常见问题
#### 收到`SDK_CREATEPAYMENT_PARAMETER_ERROR`时我该怎么办？
当收到此事件代码时，请检查传递的`sessionData`是否正确且完整。
#### 收到`SDK_PAYMENT_ERROR`或渲染视图错误时我该怎么办？
当收到此事件代码时，请检查网络请求。初始化接口可能存在异常，确保创建支付会话请求的环境与所实例化SDK的环境参数一致。检查支付会话创建参数是否正确传递。如果接口异常仍然存在，可以联系我们进行故障排除。
### 步骤3：在服务器端获取授权或支付结果
对于首次支付，您可以获取授权和支付结果；对于后续支付，仅获取支付结果。您可以通过以下方法之一获取授权或支付结果：
*   接收异步通知
*   查询结果
### **接收异步通知**  
获取授权结果  
获取支付结果  
#### 获取授权结果  
当授权成功时，蚂蚁金服会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API 向您发送异步通知。收到通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。同时，您需要在您的系统中更新买家的授权状态，并在授权管理页面上显示从通知中获取的买家脱敏账户。

以下是一个通知请求的示例代码：
```json
{
  "accessToken": "2810123456789012345678901234567890",
  "authState": "AUTHSTATE_SAMPLE_1234567890",
  "authorizationNotifyType": "TOKEN_CREATED",
  "userLoginId": "852-52***184",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```
以下示例代码展示了如何验证通知的签名并做出响应：
```java
@RequestMapping(path = "/authResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> authNotifyProcessor(HttpServletRequest request,
    @RequestBody String body) {
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  String rawSignature = request.getHeader("signature");
  String signature = "";  

  // 从原始签名中获取有效部分
  if(rawSignature==null||rawSignature.isEmpty()){
    throw new RuntimeException("empty notify signature");
  } else {
    String[] parts = rawSignature.split("signature=");
    if (parts.length > 1) {
      signature = parts[1];
    }
  }  

  // 验证授权结果通知的签名
  boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
      clientId, requestTime, body, signature, 
```

请注意，上面的代码片段没有完整展示验证签名的完整过程，通常会涉及到使用私钥进行签名验证。您需要使用蚂蚁金服提供的工具或SDK来完成这个步骤。如果`verifyResult`为`true`，则签名验证成功，您可以继续处理通知内容。
### 验证支付宝公钥并处理通知
```java
// 使用支付宝公钥验证通知签名
String ALIPAY_PUBLIC_KEY = "您的支付宝公钥";
boolean verifyResult = AlipaySignature.rsa256Verify(
    body, ALIPAY_PUBLIC_KEY, "UTF-8", "RSA2");
if (!verifyResult) {
    throw new RuntimeException("无效的通知签名");
}  
// 根据通知结果更新记录状态
// 回复服务器我们已接受通知
Result result = new Result("SUCCESS", "success", ResultStatusType.S);
AlipayResponse response = new AlipayResponse();
response.setResult(result);
return ResponseEntity.ok().body(response);
```
#### 获取支付结果
当支付状态最终确定为成功或失败时，蚂蚁金服会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API，向在**createPaymentSession** API中指定的_支付通知URL_发送异步通知。收到蚂蚁金服的通知后，您需要按照[要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)返回响应。

您可以在**createPaymentSession** API的_paymentNotifyUrl_参数中指定URL。如果每个支付的URL相同，您也可以在蚂蚁金服控制台中进行配置。

以下是一个通知请求的示例：
```json
{
  "notifyType": "PAYMENT_RESULT",
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "success"
  },
  "paymentRequestId": "2020010123456789XXXX",
  "paymentId": "2020010123456789XXXX",
  "paymentAmount": {
    "value": "4200",
    "currency": "SGD"
  },
  "paymentCreateTime": "2020-01-01T12:01:00+08:30",
  "paymentTime": "2020-01-01T12:01:01+08:30"
}
```
以下示例代码展示了如何验证通知的签名并做出响应：
```java
@RequestMapping(path = "/payResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> paymentNotifyProcessor(HttpServletRequest request,
    @RequestBody String body) {
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  // 其他处理和验证代码...
}
```
请注意，上述代码片段中省略了验证通知签名和构建响应的具体实现，您需要根据实际的业务逻辑和安全策略来完成这部分代码。
```java
String 原始签名 = request.getHeader("signature");
String 签名 = "";  
// 从原始签名中获取有效部分
if (原始签名 == null || 原始签名.isEmpty()) {
    throw new RuntimeException("通知签名为空");
} else {
    String[] 部分 = 原始签名.split("signature=");
    if (部分.length > 1) {
        签名 = 部分[1];
    }
}  
// 验证支付结果通知的签名
boolean 验证结果 = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
        客户端ID, 请求时间, 请求体, 签名,
        ALIPAY_PUBLIC_KEY);
if (!验证结果) {
    throw new RuntimeException("无效的通知签名");
}  
// 根据通知结果更新记录状态
// 响应服务器我们已接受通知
Result 结果对象 = new Result("SUCCESS", "success", ResultStatusType.S);
AlipayResponse 响应对象 = new AlipayResponse();
响应对象.setResult(结果对象);
return ResponseEntity.ok().body(响应对象);
}  
#### 常见问题解答  
##### 何时会发送通知？  
这取决于支付是否完成：  
*   如果支付成功完成，蚂蚁金服通常会在3到5秒内发送异步通知。对于像柜台支付等某些支付方式，通知可能会稍有延迟。
*   如果支付未完成，蚂蚁金服需要先关闭订单，然后才会发送异步通知。不同支付方式关闭订单所需的时间会有所不同，通常默认为14分钟。  
##### 异步通知会重新发送吗？
```

请注意，这里我已将Markdown格式的代码块翻译成中文，保留了原始结构。FAQs部分的翻译也已提供。如果有其他文档内容需要翻译，请提供更多信息。
当从Antom接收到异步通知时，您需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应。如果未按要求响应异步通知，或者由于网络原因通知未送达，系统将在24小时内自动重试发送，最多重试8次，或者直到收到正确的响应以终止发送。发送间隔如下：0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时，15小时。

#### 在响应授权通知时，是否需要添加数字签名？
如果您收到Antom的异步通知，需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)格式作出响应，但不需要添加签名。

#### 在授权通知中，我需要使用哪些关键参数？
请注意通知中的这些关键参数：
*   _result_：表示订单的支付结果。
*   _authState_：由商家生成的代扣请求ID。
*   _accessToken_：Antom生成的用于后续支付的自动扣款ID。
*   _userLoginId_：用户的脱敏账户号。

#### 在支付通知中，我需要使用哪些关键参数？
请注意通知中的这些关键参数：
*   _result_：订单的支付结果。
*   _paymentRequestId_：由商家生成的支付请求ID，用于查询、取消和对账。
*   _paymentId_：Antom生成的支付订单ID，用于退款和对账。
*   _paymentAmount_：如有金额对账需求，可以使用此字段。
### 查询支付结果  
您可以调用 **inquiryPayment** API 来查询订单的支付结果。  
| **参数名** | **是否必填** | **描述** |
| --- | --- | --- |
| *paymentRequestId* |  | 您生成的支付请求ID。 |  
此参数并非完整参数集，请参考 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 获取完整参数列表以及特定支付方式的额外要求。  
以下示例代码展示了如何调用 **inquiryPayment** API：  
```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);  
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/sandbox/api/v1/payments/inquiryPayment");  
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}
```  
以下是一个请求消息的示例：  
```json
{
  "paymentRequestId": "2019060811401080010018882020035****"
}
```  
以下是一个响应消息的示例：  
```json
{
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "Success"
  },
  "paymentStatus": "SUCCESS",
  "paymentRequestId": "pay_1089760038715669_10277574507XXXX",
  "paymentId": "2019060811401080010018882020035XXXX",
  "paymentAmount": {
    "value": "4200",
    "currency": "SGD"
  },
  "paymentCreateTime": "2019-06-01T12:01:01+08:30",
  "paymentTime": "2019-06-01T12:01:01+08:30",
  "transactions": null
}
```  
#### 常见问题  
##### 应该多久调用一次 inquiryPayment API？  
建议以2秒的间隔进行轮询查询，直到获取到最终的支付结果或接收到异步支付通知为止。
### 什么是在通知中需要使用的关键参数？
请注意以下关键参数：
*   `_result_`：表示**inquiryPayment** API 调用的结果，订单状态应根据 `_paymentStatus` 判断，`SUCCESS` 和 `FAIL` 分别代表最终结果，`PROCESSING` 表示处理中。
*   `_paymentAmount_`：指示支付金额。

#### 示例代码
**前端完整示例代码：**
```javascript
// 步骤1：实例化SDK
const checkoutApp = new window.AMSCashierPayment({
  environment: "sandbox",
  locale: "en_US",
  onLog: ({ code, message }) => {},
  onEventCallback: ({ code, message }) => {},
});

// 处理支付按钮事件。
document
  .querySelector("#your form id")
  .addEventListener("submit", handleSubmit);

async function handleSubmit() {
  // 步骤2：服务器调用createPaymentSession API获取paymentSessionData。
  async function getPaymentSessionData() {
    const url = "填写服务器地址";
    const config = {
      // 填写请求配置。
    };
    const response = await fetch(url, config);
    // 从响应中获取paymentSessionData参数的值。
    const { paymentSessionData } = await response.json();
    return paymentSessionData;
  }
  const paymentSessionData = await getPaymentSessionData();

  // 步骤3：创建渲染组件。
  await checkoutApp.createComponent({
    sessionData: paymentSessionData,
    appearance: {
      showLoading: true, // 默认为true，允许配置是否显示加载动画。
    },
  });
}

**自定义加载动画示例代码：**
在卡片支付场景中支持配置自定义加载动画：
1.  在渲染组件时将`showLoading`设置为`false`。
2.  在调用`createComponent`函数时在当前页面渲染自定义加载动画。
3.  监听`onEventCallback`事件。
```

请注意，您需要将`"Fill in the server address"`替换为实际的服务器地址，并根据需要配置请求配置。
1. 当收到`SDK_START_OF_LOADING`事件代码时，显示自定义加载动画。
2. 当收到`SDK_END_OF_LOADING`事件代码时，结束自定义加载动画。

```javascript
async function create(sessionData) {
  await checkoutApp.createComponent({
    sessionData: sessionData,
    appearance: {
      showLoading: false, // 默认为true，允许配置是否显示加载动画。
    },
  });
}
```

**事件代码**

您可能会遇到两种类型的事件代码：

* 状态代码：在组件运行时生命周期中由`onEventCallback`返回。
* 错误代码：在组件初始化阶段由`onEventCallback`或`onError`返回。

| 类型 | 代码 | 描述 | 进一步操作 |
| --- | --- | --- | --- |
| 状态代码 | SDK\_START\_OF\_LOADING | 组件创建时开始显示加载动画。当配置为隐藏加载并使用自定义动画时，此时可以显示自定义动画。 | 无需进一步操作。 |
| SDK\_END\_OF\_LOADING | 组件创建时加载动画结束。当配置为隐藏加载并使用自定义动画时，此时可以隐藏动画。 | 无需进一步操作。 |
| SDK\_CALL\_URL\_ERROR | \* 事件信息中表示以下情况之一： + 重定向到商家页面失败。 + 重定向到3D挑战页面失败。 + 调用**createPaymentSession**请求时，*paymentRedirectUrl*参数未指定或指定不正确。 在Web或WAP场景中，重定向链接通常不异常，建议检查重定向链接。在App场景中，如果此异常频繁发生，请联系Antom技术支持解决重定向或调用问题。 | 无需进一步操作。 |
| 错误代码 | SDK\_INTERNAL\_ERROR | SDK内部错误。 | 联系Antom技术支持。 |

请注意，"Antom"可能是指"Ant"，即蚂蚁金服。
| SDK\_CREATEPAYMENT\_PARAMETER\_ERROR | `mountComponent` 方法指定的参数异常。 | 检查参数是否正确，并重新初始化组件。 |
| SDK\_INIT\_PARAMETER\_ERROR | `AMSEasyPay` 方法指定的参数异常。 | 检查参数是否正确，并重新实例化 SDK。 |
| SDK\_CREATECOMPONENT\_ERROR | 组件初始化异常。 | 联系蚂蚁金服技术支持。 |
| SDK\_SUBMIT\_NETWORK\_ERROR | 由于网络原因，接口调用失败，可能发生在提交方法提交时。 | 尝试再次提交。 |

要查看文档的最新更新，请访问 [发行说明](https://global.alipay.com/docs/releasenotes)。

![图片 16](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 17](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

[用户体验](#EkRff "用户体验")  
[钱包](#SmTJp "钱包")  
[银行转账](#YL8Ri "银行转账")  
[支付流程](#jrWt0 "支付流程")  
[集成步骤](#bXiTb "集成步骤")  
[步骤 1：创建支付会话](#zhBSk "步骤 1：创建支付会话")  
[安装 API 库](#d3kyo "安装 API 库")  
[初始化请求实例](#WLui0 "初始化请求实例")  
[调用 createPaymentSession API](#aQius "调用 createPaymentSession API")  
[常见问题](#UGjGp "常见问题")  
[请求参数的值是否可以使用中文字符？](#asEuc "请求参数的值是否可以使用中文字符？")  
[如何设置接收支付通知的 URL？](#rr3ki "如何设置接收支付通知的 URL？")  
[步骤 2：调用 SDK](#Oqulw "步骤 2：调用 SDK")  
[安装](#JmurT "安装")  
[实例化 SDK](#W3xvc "实例化 SDK")
**调用SDK**

**常见问题**

**收到SDK_CREATEPAYMENT_PARAMETER_ERROR时怎么办？**

**收到SDK_PAYMENT_ERROR或渲染视图错误时怎么办？**

**步骤3：获取授权或支付结果**

**接收异步通知**

**常见问题**

**在响应授权通知时，需要添加数字签名吗？**

**在授权通知中需要使用的关键参数是什么？**

**在支付通知中需要使用的关键参数是什么？**

**查询结果**

**常见问题**

**示例代码**

**事件代码**