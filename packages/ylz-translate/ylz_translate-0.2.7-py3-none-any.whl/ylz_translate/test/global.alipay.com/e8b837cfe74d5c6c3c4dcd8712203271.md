Best practice | Auto Debit | Alipay Docs
===============
                        

[![Image 1: Alipay, China's leading third-party online payment solution](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![Image 2: Alipay, China's leading third-party online payment solution](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[Log In](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fautodebitpay%2Fbest_practice)

[Go to Homepage](../../)

Auto Debit

[Overview](/docs/ac/autodebitpay/overview)

[User experience](/docs/ac/autodebitpay/user_ex)

Development

[Best practice](/docs/ac/autodebitpay/best_practice)

Other resources

Best practice
=============

2022-12-21 03:09

To improve integration efficiency and avoid payment disputes, please read the best practices to ensure that the system and all involved parties make integration according to the standard procedures.

Task flow and API interactions
==============================

In Auto Debit, the overall procedure involves the following roles:

*   **User**: An individual or institution that uses the payment service.
*   **Merchant**: A company or individual that trades in goods or services. This role is the "you" in the documentation.
*   **Alipay**: Alipay provides the Auto Debit service.
*   **Alipay+ MPP**: Alipay+ Mobile Payment Provider. In Auto Debit, an Alipay+ Mobile Payment Provider is a digital wallet, such as GCash.

All APIs need to be used properly at the right time so that your system will perform as expected:

*   For the authorization phase, it is suggested to create a data table that contains data about accessTokens created for each account. When the _accessToken_ needs to be refreshed or invalidated, the table will be updated accordingly.
*   For the payment and refund phase, it is suggested to create a table that contains data about the transaction. The table will be updated accordingly when the payment or refund action proceeds.

![Image 3: general process.png](https://yuque.antfin.com/images/lark/0/2021/png/134374/1615355994217-3473d47e-20f6-42b7-bee1-f50fde3d040f.png)

Figure 1. Overall procedure of Auto Debit integration

Obtain user authorization
-------------------------

You need to obtain the user's authorization before you can deduct money from the user's account automatically. To get the user's authorization, the following tasks need to be completed:

1.  Configure your address to receive the authorization result notification.
2.  Call the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API to get _authUrl_ and redirect the user to _authUrl_.
3.  Get _authCode_ after the user agrees to authorize.
4.  Get _accessToken_ by calling the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API with _authCode_.
5.  (Optional) Refresh _accessToken_ by calling the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API with the corresponding _refreshToken_ when the _accessToken_ is about to expire.
6.  (Optional) Revoke the authorization by invalidating _accessToken_ via the [**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation) API if you need.

In the preceding steps, _authUrl_ and _authCode_ can be used only once. If the authorization process fails, call the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API again with an updated value for the _authState_ field in the request. For example, the updated value for the _authState_ field can be made by appending numbers at the end of the previous value, such as authstatexxxx\_1. In addition, to ensure a smooth client-side redirection process, follow the integration instructions in [Redirect from merchant to wallet](https://global.alipay.com/docs/ac/43trgzdfg/56xgzfer) and [Redirect form wallet to merchant](https://global.alipay.com/docs/ac/autodebitpay/redirect_wallet-merchant).

If the _accessToken_ is about to expire, you can use the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API with the correct fields specified to refresh the _accessToken_. In addition, you can use the [**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation) API to invalidate the _accessToken_ when necessary.

The following graphic shows the overall authorization procedure between different roles. After the authorization is completed, you can initiate the payment request with _accessToken_.

![Image 4: consult接口流程图-.jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/12884741/1643008492038-b603d272-56b2-464f-bd61-bd3cd3efed41.jpeg)  
Figure 2. Overall authorization process flow

Auto debit
----------

Once the authorization is completed, auto debit payment can be performed as long as the _accessToken_ is valid, without the need to reinitiate authorization for each payment.

1.  Call the [**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API to initiate the auto debit payment. If the API is called successfully, auto debit succeeds. If the API call failed, auto debit fails.
2.  Get the payment result: The asynchronous notification is sent to you by Alipay when the auto debit succeeds or fails. If the [**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API call status is unknown, you need to call the [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API in the form of polling until getting the payment result:

*   If you get the information that the payment is completed successfully, you can proceed with other tasks.
*   If the payment is not completed successfully, you need to call the [**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API again with a new paymentRequestId.

3.  (Optional) When the transaction is successfully paid and still within the cancellable period, or when the transaction is not paid and needs to be canceled in advance before Alipay's payment expiration time, you can call the [**cancel**](https://global.alipay.com/docs/ac/ams/paymentc_online) API to cancel the transaction per your needs. The payment status of the merchant and the user will be kept consistent.
4.  (Optional) After the transaction is successfully paid and still within the refundable period, you can call the [**refund**](https://global.alipay.com/docs/ac/ams/refund_online) API to issue a refund against the transaction per your needs. You can check the refund status by using the [**inquiryRefund**](https://global.alipay.com/docs/ac/ams/ir_online) API.

> **Notes**:
> 
> *   To obtain accurate payment results, you must integrate both the asynchronous notification and payment result inquiry services. Because some wallets might not return a notification when the payment fails, integrating both the asynchronous notification and payment result inquiry services will ensure the payment result is obtained from any wallet.
> *   There are various transaction-related amounts and currencies you might use during different integration tasks. For details, see [Usage rules of the Amount object](https://global.alipay.com/docs/ac/ref/cc).

The following graphic shows the payment procedure and other operations that can be performed after making a payment:

![Image 5: image](https://yuque.antfin.com/images/lark/0/2021/jpeg/134374/1640253345485-40ba8594-991e-4940-9f6c-af6124131027.jpeg)

Figure 3. Overall payment process flow

Getting the accurate payment result is very important. Therefore, it is suggested to maintain an order table in the database to contain at least two fields: the order number and the order status. And use the asynchronous notification and payment result inquiry services in the following way:

*   Asynchronous notification: Listen to Alipay's asynchronous notifications and make a response upon receiving an asynchronous notification. Then check the order status in the database:

*   If the order status is `INIT`, update the order status according to the asynchronous notification.
*   If the order status is not `INIT`, it indicates that the final payment result has been obtained through inquiry and the order status has been updated accordingly. No further actions need to be taken.

*   Payment inquiry: Initiate an active inquiry to the payment result in the form of polling. Before each inquiry, you need to check the order status in the database:

*   If the order status is `INIT`, initiate an inquiry. Update the order status in the database if a final payment result is obtained, otherwise, continue the polling process.
*   If the order status is not `INIT`, it indicates that the inquiry process has been conducted and a final payment result has been obtained and used for updating the order status. No further actions need to be taken.

![Image 6: image](https://cdn.nlark.com/yuque/0/2021/png/561635/1619061903693-545f78ce-8cd7-4a54-8a83-763289bf7bbf.png)

Figure 4. Use both the asynchronous notification and payment result inquiry services to get the payment result

To view the latest updates to the documentation, visit [Release notes](https://global.alipay.com/docs/releasenotes).

![Image 7](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![Image 8](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 Alipay [Legal Information](https://global.alipay.com/docs/ac/platform/membership)

#### Is this page helpful?

#### On this page

[Task flow and API interactions](#bqnLy "Task flow and API interactions")

[Obtain user authorization](#Dch0r "Obtain user authorization")

[Auto debit](#PBv2v "Auto debit")