后支付服务 | 用户展示模式支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fams_upm%2Fpostpayment)  
[返回首页](../../)

用户展示模式支付
----------------

[介绍](/docs/ac/ams_upm/introduction)  
[开始使用](/docs/ac/ams_upm/start)  
[接受支付](/docs/ac/ams_upm/acceptpayment)  
[后支付服务](/docs/ac/ams_upm/postpayment)  
[最佳实践](/docs/ac/ams_upm/bp)  

开发
---

[API 列表](/docs/ac/ams_upm/apilist)  
[对账](/docs/ac/ams_upm/reconcile)  

参考
----

[版本发布说明](/docs/ac/ams_upm/releasenotes)  
[旧版接口](/docs/ac/ams_upm/sppmkt)  

后支付服务
------------

2023-06-29 10:25

在处理支付后，商家可以执行查询、取消和退款等后支付操作。请参考 [开发](https://global.alipay.com/doc/ams_upm/byb) 部分，了解如何在沙箱和生产环境中调用接口。

查询支付结果
------------

可以通过使用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri) 接口来查询交易订单的状态。在以下情况之一时调用 **inquiryPayment** 接口：

*   无法获取明确的支付结果。
*   支付过程超时，未获取支付结果。
*   需要检查与交易相关的退款记录。
使用在**支付** API 中使用的相同的 _paymentRequestId_ 来查询支付交易状态。支付宝处理结果后，会同步将支付或退款详情返回给商家。如果未收到支付宝的响应，应重试查询过程。

**构建请求消息**
构建请求消息，HTTP 正文如下：

```json
{
"paymentRequestId": "pay_test_1106_0002"
}
```

**处理响应**
通过验证通知的签名来处理查询响应。以下是一个查询请求的典型响应示例：

```json
{
"result":{
"resultCode":"SUCCESS",
"resultStatus":"S",
"resultMessage":"success"
},
"paymentStatus": "Success",
"paymentRequestId":"pay_test_1106_0002",
"paymentId":"20190608114010800100188820200355883",
"paymentAmount":{
"value":"500",
"currency":"USD"
},
"actualPaymentAmount":{
"value":"500",
"currency":"USD"
},
"paymentCreateTime":"2019-06-01T12:01:01+08:30",
"paymentTime":"2019-06-01T12:01:01+08:30"
}
```

**注意**：

查询请求可能返回的结果状态详情如下：

*   `S`：表示查询成功，商家可以从 _paymentStatus_ 的值获取支付状态。
*   `F`：收到 _resultStatus_ 为 `F` 时，会触发系统警报。商家的技术支持团队需要调查根本原因。如果问题可修复且订单在支付宝系统中仍然存在，商家需要重试 **inquiryPayment** API，直到获得 `S` 结果。
*   `U`：在收到 _resultStatus_ 为 `U` 后，商家需要多次使用相同的参数调用 **inquiryPayment** API，直到获得 `S` 或 `F` 结果。达到最大重试次数后，如果仍未返回 `S` 或 `F`，商家必须调用 **取消** 接口来取消交易。

**取消交易**
------------------
如果交易在支付过程中遇到技术问题，可以取消交易。使用[**cancel**](https://global.alipay.com/doc/ams/paymentc)接口可以撤销支付宝系统中针对特定交易执行的所有操作。可取消的期限在合同中规定，超出约定时间则无法取消。

使用在**pay** API中使用的相同_paymentId_来取消支付交易。支付宝处理取消请求后，会同步返回取消结果。如果未收到支付宝的响应，应重试取消过程。

**构建请求消息**
构建请求消息，HTTP正文如下：

```json
{
"paymentId":"20190612184010800100188820200355884"
}
```

**处理响应**
通过验证通知的签名来处理取消响应。以下是一个典型的取消请求响应示例：

```json
{
"result":
{
"resultCode":"SUCCESS",
"resultStatus":"S",
"resultMessage":"success"
},
"paymentRequestId":"pay_2089760038715669_202775745075669",
"paymentId":"20190612184010800100188820200355884",
"cancelTime":"2019-06-12T19:07:11+08:00"
}
```

以下图表展示了取消交易的过程：

[Image 3: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1592968691772-495f900c-964a-48dc-8342-df372c675b96.png)

**图1. 取消过程**

**注意事项：**
1. 集成商可能在网关中实现存储转发逻辑。如果取消请求在**pay** API请求之前到达网关，不应将取消请求转发到下一个环节。
2. 取消请求可能返回的结果状态详情如下：
   * `S`：表示取消成功。
*   `F`: 当收到_resultStatus_为`F`时，系统会触发警报。商家的技术支持团队必须调查根本原因。如果问题可修复且订单在支付宝系统中仍然存在，商家需要重试**取消** API，直到获得结果`S`。
*   `U`: 当获得_resultStatus_为`U`时，商家需要使用相同的参数多次调用**取消** API，直到获得结果`S`或`F`。达到最大重试次数后，如果仍未返回`S`或`F`，应触发系统警报，并需要商家的技术支持团队介入解决问题。

**退款**
--------

可以通过[**退款**](https://global.alipay.com/doc/ams/refund)接口进行退款。退款服务仅适用于已成功支付的交易，可在交易支付后至退款期限结束前的任何时间发起。

交易退款可以是全额或部分退款，即退款金额可以等于或小于原始支付的交易金额。如果退款请求失败，应合理次数地重试，并遵循以下建议：
*   使用原始退款请求ID重试退款请求。如果商家使用相同的退款请求，支付宝支持幂等性。
*   需要配置最大重试次数以及同步和异步退款的间隔时间。
退款交易不收取费用。退款时，支付宝收取的交易费用是否退还取决于您与支付宝签订的合同。退款请求被支付宝处理后，资金将退还到付款人的支付工具。退款结算完成的时间取决于银行的政策。如果付款人使用信用卡支付且拒付信用卡账单，那么拒付的金额无法退款。

**构建请求消息**
使用以下HTTP正文构建请求消息：
```json
{
"paymentId":"201811291907410100070000001111",
"refundRequestId":"201811291907410200070000001111",
"refundAmount":{
"value":"100",
"currency":"USD"
}
}
```

**处理响应**
通过验证通知的签名来处理退款响应。以下是一个退款请求的典型响应示例：
```json
{
"result": {
"resultCode":"SUCCESS",
"resultStatus":"S",
"resultMessage":"success"
},
"refundAmount":{
"value":"100",
"currency":"USD"
},
"refundTime": "2020-10-10T12:01:01+08:30",
"paymentId":"201811291907410100070000001111",
"refundRequestId":"201811291907410200070000001111",
"refundId":"401811291907410200070000001111"
}
```
以下图表展示了使用退款服务的过程：
![Image 4: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1592968691964-3bc43a87-bfcc-4d3e-9a30-7a269968a7ef.png)
图2. 退款流程

**注意事项：**
1. 支付宝完成退款后，交易无法取消。
2. 网关集成商可能需要实现存储转发逻辑。如果退款请求在网关收到支付成功的结果之前到达，那么不应将退款请求转发到下一个环节。
以下是退款请求可能返回的结果状态的详细信息。商家必须获取确认性的结果状态，即退款请求的`S`或`F`：

*   `S`：表示退款成功。
*   `F`：表示在收到`resultStatus`为`F`后，系统会触发警报。商家的技术支持团队需要调查根本原因。如果问题可以解决，且订单仍然存在于支付宝系统中，商家需要再次尝试调用**refund** API。
*   `U`：商家需要多次调用**refund** API，直到获得`S`或`F`的结果。在最大重试次数后，如果仍未获得`S`或`F`，商家应初始化异步退款请求。在尝试最大次数的异步退款请求后，应触发系统警报，商家的技术支持团队需要介入解决问题。

查询退款状态
------------

商家可以通过两种方式获取退款结果：等待**refund**接口的响应或主动调用[**inquiryRefund**](https://global.alipay.com/docs/ac/ams/ir_online)接口。

在以下情况下，调用inquiryRefund接口获取退款结果：

*   超时未获得明确的退款结果。
*   用户向商家请求退款结果。

如果域名是open-na.alipay.com，[inquiryRefund](https://global.alipay.com/docs/ac/ams/ir_online)接口的请求URL如下：

*   沙箱环境：[https://open-na-global.alipay.com/ams/sandbox/api/v1/payments/inquiryRefund](https://open-na-global.alipay.com/ams/sandbox/api/v1/payments/inquiryRefund)
*   生产环境：[https://open-na-global.alipay.com/ams/api/v1/payments/inquiryRefund](https://open-na-global.alipay.com/ams/api/v1/payments/inquiryRefund)
作为商家，您可以使用`refundId`或`refundRequestId`发起**inquiryRefund**请求。

- 如果退款超时且无法获取`refundId`，您只能使用`refundRequestId`字段发送**inquiryRefund**请求。
- 如果获取到`refundId`，建议使用`refundId`字段。
- 注意，如果同时指定了`refundId`和`refundRequestId`，`refundId`优先。

以下是一个示例，展示了指定`refundId`字段的**inquiryRefund**请求：
```json
{
  "refundId": "2021080419401080130018866020092XXXX"
}
```
以下是一个**inquiryRefund**请求的响应示例，退款结果在**`refundStatus`**字段中呈现：
```json
{
  "refundAmount": {
    "currency": "HKD",
    "value": "10000"
  },
  "refundId": "2021080419401080130018866020092XXXX",
  "refundRequestId": "amsdemorefund_zhangsan_zs_20210804_165236_XXX",
  "refundStatus": "SUCCESS",
  "refundTime": "2021-08-04T01:52:37-07:00",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```
*   `refundId`: 唯一的退款处理ID。为了实现相同的退款轮询，此字段必须唯一。为了实现不同的退款轮询，此字段必须不同。
*   `refundRequestId`: 商家分配的唯一ID，用于标识退款请求。
*   `refundStatus`: 此字段指示订单的**退款结果**。当`result.resultStatus`的值为`S`或找到退款记录时返回此字段。此字段的值可以是：
    *   `SUCCESS`: 表示退款成功。
    *   `PROCESSING`: 表示退款仍在处理中。当返回此值时，商家可以重试**refund**接口。
*   `result`: 此字段仅指示此查询请求的调用状态，不指示退款状态。
退款查询请求可能返回的结果状态如下：

*   `S`: 表示**inquiryRefund** API 调用成功，商家可以通过_refundStatus_的值获取退款状态。
*   `F`: 表示**inquiryRefund** API 调用失败，可能是由于系统错误或参数无效导致。
*   `U`: 表示**inquiryRefund** API 的调用状态未知。请使用相同的请求参数重试查询请求。

有关何时实现**inquiryPayment**、**cancel**和**refund**接口的更多信息，请参阅[_最佳实践_](https://global.alipay.com/doc/ams_upm/bp)。

更多信息
==========

*   [支付宝开发者中心用户指南](https://global.alipay.com/doc/ams_upm/adpud)
*   [测试](https://global.alipay.com/docs/ac/ams_upm/testing)
*   查看文档的最新更新，请访问[发布说明](https://global.alipay.com/docs/releasenotes)。

![Image 5](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![Image 6](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

*   [查询支付结果](#ddbOs "查询支付结果")
*   [取消交易](#IQYws "取消交易")
*   [退款](#Agiei "退款")
*   [查询退款状态](#UJfpV "查询退款状态")
*   [更多信息](#7W3Xu "更多信息")