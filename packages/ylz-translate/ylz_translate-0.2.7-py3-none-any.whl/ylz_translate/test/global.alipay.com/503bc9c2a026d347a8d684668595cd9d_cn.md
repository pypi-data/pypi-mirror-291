卡信息存储 | 结账支付 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fcvsdk)  
[返回首页](../../)

结账支付
[概述](/docs/ac/cashierpay/overview)  
接收支付  
支付后处理  
支付方式  
其他资源  
高级功能  
[预前端解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡信息存储API](/docs/ac/cashierpay/cv)  
[卡信息存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API SDK](/docs/ac/cashierpay/mf?pageVersion=7)  

卡信息存储
==================

2024-05-11 10:13

Antom SDK 是一个预构建的UI组件，用于收集卡信息和管理商户的3D验证流程。集成该组件不需要商户符合PCI标准，非常适合那些希望委托Antom收集卡信息的商户。

支付流程
==========

对于每种支付方式，支付流程包括以下步骤：

[![图片3：下载.svg](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712894644625-8b82f0cf-c338-4c96-8dc4-c840456bca76.svg)]()

1.  买家进入结账页面。
2.  您的服务器创建一个卡信息存储会话。
3.  您的客户端创建并调用带有卡信息存储会话的组件。
4.  组件从买家那里收集支付信息。
5.  您的服务器接收卡信息存储结果通知。

集成步骤
==========

通过以下步骤开始集成。

1.  创建卡信息存储会话
2.  创建并调用SDK
3.  获取卡信息存储结果

步骤1：创建卡信息存储会话 - 服务器端
---------------------------------------------

当买家选择由Antom提供的支付方式时，您需要收集关键信息，如卡信息存储请求ID、卡信息存储重定向页面URL、卡信息存储结果通知URL等，然后调用**createVaultingSession** API 创建卡信息存储会话，并将卡信息存储会话返回给客户端。

Antom 提供了多语言的服务器端API库，以下以Java（Java 6或更高版本）为例进行说明。
### 安装API库
您可以在[GitHub](https://github.com/alipay/global-open-sdk-java)上找到最新版本。  
复制以下内容：  
```xml
<dependency>
    <groupId>com.alipay.global.sdk</groupId>
    <artifactId>global-open-sdk-java</artifactId>
    <version>2.0.21</version>
</dependency>
```

这段代码是用于Maven项目的依赖配置，将允许您在Java项目中使用蚂蚁金服的全球开放SDK。
### 初始化请求实例  
创建一个单例资源以向Antom发起请求。  
复制  
```java
import com.alipay.global.api.AlipayClient;
import com.alipay.global.api.DefaultAlipayClient;

String merchantPrivateKey = "您的私钥";
String alipayPublicKey = "支付宝公钥";
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
```

这里，我们导入了蚂蚁金服的API客户端类，并使用`DefaultAlipayClient`创建了一个实例。`merchantPrivateKey`是您的商户私钥，`alipayPublicKey`是支付宝的公钥。`EndPointConstants.SG`代表请求的端点，通常是指新加坡地区的蚂蚁金服API接口。这个实例将用于后续的API调用。
### 创建保管箱会话  
创建保管箱会话涉及以下参数：  
<table style="width:748px;outline:none;border-collapse:collapse;border:1px solid #D9E4FC" class="lake-table"><colgroup><col width="211" span="1"><col width="97" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td style="background-color:#D4EEFC;font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="ue38567b6" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><strong>参数名称</strong></p></td><td style="background-color:#D4EEFC;font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="uf08cd1d4" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><strong>是否必需</strong></p></td><td style="background-color:#D4EEFC;font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="u13e60852" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><strong>描述</strong></p></td></tr><tr style="height:33px"><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="u86726a03" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><em>paymentMethodType</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="ubad826e0" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span>必需</span></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p style="font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span style="color:rgba(4, 15, 36, 0.85)">需要绑定的支付方式。</span></p></td></tr><tr style="height:33px"><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="u4e6ff591" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><em>vaultingRequestId</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="uf44a1a4c" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span>必需</span></p></td><td style="text-align:left;font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p style="font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span style="color:rgba(4, 15, 36, 0.85)">商家生成的唯一ID，每次启动保管箱会话时需要新的ID。</span></p></td></tr><tr style="height:33px"><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="u4e6ff591" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><em>vaultingNotificationUrl</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="udcf296a7" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span>必需</span></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p style="font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span style="color:rgba(4, 15, 36, 0.85)">保管箱结果的通知地址。</span></p></td></tr><tr style="height:33px"><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="uef5976f3" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><em>redirectUrl</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p id="u7c87723b" style="text-align:center;font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span>可选</span></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4FC;padding:4px 8px;cursor:default"><p style="font-size:14px;color:#141E34;line-height:1.74;letter-spacing:0.05em"><span style="color:rgba(4, 15, 36, 0.85)">保管箱完成后的跳转URL。</span></p></td></tr></tbody></table>  
以上参数是创建支付会话的基本参数，完整参数和特定支付方式的额外要求请参考[**createVaultingSession**](https://global.alipay.com/docs/ac/ams/vaulting_session)**。**  
#### 调用createVaultingSession API的示例代码  
以下示例代码展示了如何调用**createVaultingSession** API：  
```java
AlipayVaultingSessionRequest alipayVaultingSessionRequest = new AlipayVaultingSessionRequest();
alipayVaultingSessionRequest.setPath("/ams/api/v1/vaults/createVaultingSession");
// 替换为你的paymentRequestId
alipayVaultingSessionRequest.setVaultingRequestId("vaultingRequestId_001");
alipayVaultingSessionRequest.setPaymentMethodType("CARD");
alipayVaultingSessionRequest.setVaultingNotificationUrl("http://www.yourNotifyUrl.com");
alipayVaultingSessionRequest.setRedirectUrl("http://www.yourRedirectUrl.com");
AlipayVaultingSessionResponse alipayVaultingSessionResponse;
try{
    alipayVaultingSessionResponse = defaultAlipayClient.execute(alipayVaultingSessionRequest);
}catch (AlipayApiException e){
    String errorMsg = e.getMessage();
}
```
以下代码展示了请求消息的示例：  
```json
{
"paymentMethodType": "CARD",
"vaultingRequestId": "vaultingRequestId_001",
"vaultingNotificationUrl": "http://www.yourNotifyUrl.com",
"redirectUrl": "http://www.yourRedirectUrl.com"
}
```
以下代码展示了响应的示例，其中包含以下参数：
*   `vaultingSessionData`: 需要返回给前端的保管箱会话数据
*   `vaultingSessionExpiryTime`: 保管箱会话的过期时间  
```json
{
"vaultingSessionData": "WxJmmCKNyIh2UOSxcMM52ljZKHpQdVVeZf7AqTB4ZywITFwBt6BfAvkCoac/OlrJdX+o7kZZ25q1iZ5t7555Xw==&&SG&&188&&eyJleHRlbmRJbmZvIjoie1widmVyc2lvbk1hcFwiOntcIndlYlwiOntcIjEuMS4wXCI6e1widGFyZ2V0V2ViVmVyaXNvblwiOlwiMS4xLjBcIn0sXCIxLjIuMFwiOntcInRhcmdldFdlYlZlcmlzb25cIjpcIjEuMi4wXCJ9fSxcImlPU1wiOntcIjEuMS4wXCI6e1widGFyZ2V0V2ViVmVyaXNvblwiOlwiMS4xLjBcIn0sXCIxLjIuMFwiOntcInRhcmdldFdlYlZlcmlzb25cIjpcIjEuMi4wXCJ9fSxcIkFuZHJvaWRcIjp7XCIxLjEuMFwiOntcInRhcmdldFdlYlZlcmlzb25cIjpcIjEuMS4wXCJ9LFwiMS4yLjBcIjp7XCJ0YXJnZXRXZWJWZXJpc29uXCI6XCIxLjIuMFwifX19fSIsInBheW1lbnRTZXNzaW9uQ29uZmlnIjp7InBheW1lbnRNZXRob2RDYXRlZ29yeVR5cGUiOiJDQVJEIiwicHJvZHVjdFNjZW5lIjoiVkFVTFRJTkciLCJwcm9kdWN0U2NlbmVWZXJzaW9uIjoiMS4wIn19",
"vaultingSessionExpiryTime": "2023-11-22T17:47:08+08:00",
"vaultingSessionId": "WxJmmCKNyIh2UOSxcMM52ljZKHpQdVVeZf7AqTB4ZyyidRSREbL0YHpqq/hjPUaE",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}
```
请注意，以上代码示例是基于假设的API调用，实际使用时需要替换为实际的API接口和参数。
### 常见问题解答  
#### 如何设置保险箱扣款结果通知地址？  
保险箱扣款的结果将通过 [**notifyVaulting**](https://global.alipay.com/docs/ac/ams/notify_vaulting) API 进行[通知](https://global.alipay.com/docs/ac/ams/paymentrn_online)。您可以在 **createVaultingSession** API 中的 _vaulting__NotifyUrl_ 参数中传递通知URL。  
步骤2：创建并调用SDK客户端
--------------------------------------------  
Antom SDK 是用于处理保险箱扣款流程的组件。您通过创建保险箱会话来收集信息，并根据 **createVaultingSession** API 中指定的支付方式在应用之间切换。
### 安装
在开始集成之前，请确保已完成以下环境准备：
1. 兼容性处理：为Internet Explorer和其他旧版浏览器提供相应的polyfills。我们建议您在构建项目时使用 [babel-preset-env](https://babeljs.io/docs/en/babel-preset-env) 解决浏览器兼容性问题。
2. 推荐使用以下浏览器版本：
   - 移动浏览器：
     - iOS 11 及以上版本
     - Android 5.0 及以上版本
   - 电脑浏览器，请使用以下推荐版本：
   
   |浏览器| 支持版本|
   |---|---|
   |Edge| 最后2个版本|
   |Firefox| 最后2个版本|
   |Chrome| 最后2个版本|
   |Safari| 最后2个版本|
   |Opera| 最后2个版本|
   |Electron| 最后2个版本|
   
您可以通过CDN或npm来集成SDK资源包。
```html
<!-- 通过CDN引入 -->
<script src="https://sdk.marmot-cloud.com/package/ams-checkout/1.10.1/dist/umd/ams-checkout.min.js"></script>
```
```bash
# 通过npm安装
npm install @alipay/ams-checkout
```

请注意，以上内容是关于一个SDK的集成指南，但没有明确指出是蚂蚁金服的哪个具体服务。在蚂蚁金服的背景下，通常涉及的可能是支付宝或其他金融服务的SDK。
### 初始化 SDK  
使用 `AMSVaulting` 创建 SDK 实例，并指定基础配置。配置对象包括以下参数：  

| 参数名称 | 是否必需 | 描述 |
| --- | --- | --- |
| `locale` | 不是 | 用于传递语言信息。有效值如下，根据支付方式所在地区选择传递的值。传递其他值时，默认使用本地语言： |
| | | - `en_US`：英语 |
| | | - `pt_BR`：葡萄牙语 |
| | | - `ko_KR`：韩语 |
| | | - `es_ES`：西班牙语 |
| | | - `ms_MY`：马来语 |
| | | - `in_ID`：印尼语 |
| | | - `tl_PH`：他加禄语（菲律宾语） |
| | | - `th_TH`：泰语 |
| | | - `vi_VN`：越南语 |
| | | - `fr_FR`：法语 |
| | | - `nl_NL`：荷兰语 |
| | | - `it_IT`：意大利语 |
| | | - `de_DE`：德语 |
| | | - `zh_CN`：简体中文 |
| | | - `zh_HK`：繁体中文 |

| `environment` | 是 | 用于传递环境信息。有效值为： |
| --- | --- | --- |
| | | - `sandbox`：沙箱环境 |
| | | - `prod`：生产环境 |

| `analytics` | 不是 | 用于配置和分析数据，包含以下值： |
| --- | --- | --- |
| | | - `enabled`：可选布尔值，默认为 `true`，表示允许 SDK 上传和分析操作数据以提供更好的服务。如果不允许上传和分析数据，将其设置为 `false`。 |

| `onLog` | 不是 | 一个回调方法，用于生成 SDK 执行期间的日志和 API 异常的错误信息。 |

| `onEventCallback` | 不是 | 当 SDK 运行时发生支付事件（如支付结果或表单提交错误）时，返回特定事件代码的回调函数。详细信息请参考相关文档。 |

以下示例代码展示了如何获取浏览器语言：
```javascript
let language = navigator.language || navigator.userLanguage;
language = language.replace("-", "_"); // 将 "-" 替换为 "_" 
```

以下示例代码展示了如何实例化 SDK：
```javascript
const checkoutApp = new window.AMSCashierPayment({
  environment: "sandbox",
  locale: "en_US",
  onLog: ({ code, message }) => {},
  onEventCallback: ({ code, message }) => {},
});
```

请注意，上述代码示例是基于 JavaScript 的，并且假设 `AMSVaulting` 已经在全局作用域 `window` 中定义。实际使用时，请确保已正确引入 SDK。
### 调用SDK  
当买家在页面上选择支付方式后，需要创建存储会话来调用SDK。  
使用实例对象中的`createComponent`或`mountComponent`函数创建支付组件：  

| 参数名 | 必须 | 描述 |
| --- | --- | --- |
| sessionData | ✅ | 使用`sessionData`参数创建配置对象：将通过`createVaultingSession` API响应中获取的完整`paymentSessionData`参数传递给`sessionData`参数。 |

**嵌入式体验与弹出式体验**  
可以通过弹出窗口或页面内嵌入的方式在页面上显示组件。  

| 嵌入式体验 | 弹出式体验 |
| --- | --- |
| ![嵌入式体验示例](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1711004209329-7acacb6e-2af6-4e93-8a9f-3edb2f277b3c.png) | ![弹出式体验示例](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1711005118975-de070b73-45cb-4395-a85a-13a70582d9c7.png) |

**弹出式体验**  
弹出式体验的优点是对页面样式影响较小，流程相对独立。  
买家在页面上选择支付方式并提交后，需要调用组件，加载后会渲染交互弹窗。

```javascript
async function create(sessionData) {
  await checkoutApp.createComponent({
    sessionData: sessionData,
    appearance: {
      showLoading: true, // 默认为true，启用默认加载样式
    },
    notRedirectAfterComplete: true,
  });
}
```

**嵌入式体验**  
嵌入式体验涉及在指定视图内渲染嵌入式元素内容，因此需要关注支付列表的样式调整。嵌入内容的宽度会自动适应父容器，高度会随视图变化动态更新。

```javascript
async function create(sessionData) {
  await checkoutApp.mountComponent({
    sessionData: sessionData,
    appearance: {
      showLoading: true, // 默认为true，可配置是否显示加载动画
      showSubmitButton: false, // 配置是否由组件渲染支付按钮
    },
    notRedirectAfterComplete: true,
  }, '#ContainerNodeId');
}
```

**嵌入式提交**  
使用嵌入式渲染和自定义提交按钮时，记得主动调用submit函数来启动提交过程。

```javascript
// 当买家完成表单并点击提交按钮时执行
checkoutApp.submit().then(({ code, message }) => {})
```

在以下情况下调用`unmount`方法释放SDK组件资源：
* 买家切换视图离开结账页面时，释放`createPaymentSession`中创建的组件资源。
* 买家进行多次支付时，释放前一次`createPaymentSession`中创建的组件资源。
* 买家完成支付并设置`notRedirectAfterComplete`为`true`时，在获取特定支付结果代码后释放组件资源。

```javascript
// 释放SDK组件资源
checkoutApp.unmount();
```

#### 常见问题解答

##### 如何处理`SDK_CREATEPAYMENT_PARAMETER_ERROR`错误？
收到此事件代码时，请检查传递的`sessionData`是否正确且完整。

##### 如何处理`SDK_PAYMENT_ERROR`或渲染视图错误？
收到此事件代码时，请检查网络请求。初始化接口可能存在异常，确保创建支付会话请求的环境与SDK实例化时的环境参数一致。检查支付会话创建参数是否正确传递。如果接口异常仍然存在，可以联系支持进行故障排查。

##### 如何处理`SDK_FORM_VERIFICATION_FAILED`错误？
可能是因为买家未填写所有必需的元素。提交时，可能会返回表示表单验证失败的错误代码。建议引导买家完善表单内容。
### 显示保管卡信息结果  
如果在调用`createVaultingSession` API时设置了`notRedirectAfterComplete`为`false`，买家在完成保管卡信息后会被重定向到您提供的`vaultingRedirectUrl`，您可以通过这个URL主动查询并展示保管卡信息的结果给买家。  
如果`notRedirectAfterComplete`为`true`，保管卡信息的结果会通过`onEventCallback`函数返回。这里的保管卡信息结果仅用于前端展示，最终订单状态以服务器端为准。  
您需要通过`onEventCallback`返回结果中的数据自定义每个保管卡信息结果的处理流程。  
以下是`onEventCallback`可能返回的保管卡信息结果事件代码：  

| 事件代码 | 消息 | 解决方案 |
| --- | --- | --- |
| SDK_ASSET_BINDING_SUCCESSFUL | 保管成功 | 建议将买家重定向到保管结果页面 |
| SDK_ASSET_BINDING_PROCESSING | 保管处理中 | 根据提供的信息引导买家尝试重新保管 |
| SDK_ASSET_BINDING_FAIL | 保管失败 | 可以根据`vaultingResultCode`错误代码提示信息，将买家重定向到绑定卡页面 |
| SDK_ASSET_BINDING_CANCEL | 买家取消 | 买家未提交订单退出保管页面，SDK在有效期内可重新调用，过期则需要重新请求保管SessionData |
| SDK_ASSET_BINDING_ERROR | 保管状态异常 | 可以等待卡绑定结果的通知或重新引导买家绑定卡 |

以下是一个处理`onEventCallback`的示例代码：

```javascript
function onEventCallback({ code, result }) {
  switch (code) {
    case 'SDK_ASSET_BINDING_SUCCESSFUL':
      // 保管成功，释放SDK组件并重定向到保管结果页面
      break;
    case 'SDK_ASSET_BINDING_FAIL':
      // 保管失败，可以根据vaultingResultCode错误代码提示信息，将买家重定向到绑定卡页面
      break;
    case 'SDK_ASSET_BINDING_ERROR':
      // 卡绑定异常，可以等待卡绑定结果的通知或重新引导买家绑定卡
      break;
    case 'SDK_ASSET_BINDING_CANCEL':
      // 引导买家重试保管
      break;
    default:
      break;
  }
}
```

### 步骤3：服务器端获取保管卡信息结果  
当买家完成保管或保管超时，蚂蚁会通过服务器端交互将相应的保管结果发送给商家，您可以通过以下方式之一获取支付结果：  
1. 接收异步通知
2. 查询结果
### **接收异步通知**  
商家需要在服务器端实现一个 [**notifyVaulting**](https://global.alipay.com/docs/ac/ams/notify_vaulting) API。当扣款完成或扣款失败时，Antom 会通过此 URL 发送异步通知。  
以下是通知请求的示例：  
```json
{
  "result": {
    "resultStatus": "S",
    "resultCode": "SUCCESS",
    "resultMsg": "success"
  },
  "acquirerInfo": {
    "acquirerName": "ADYEN",
    "acquirerTransactionId": "******",
    "referenceRequestId": "********"
  },
  "paymentMethodDetail": {
    "card": {
      "avsResultRaw": "4",
      "billingAddress": {
        "address1": "address1",
        "address2": "address2",
        "city": "Madrid",
        "region": "ES",
        "state": "Madrid",
        "zipCode": "280**"
      },
      "brand": "VISA",
      "cardToken": "******",
      "cvvResultRaw": "1",
      "expiredMonth": "02",
      "expiredYear": "27",
      "funding": "DEBIT",
      "issuingCountry": "BR",
      "lastFour": "0000",
      "bin": "409280",
      "issuerName": "BANCO ITAUCARD, S.A."
    },
    "paymentMethodType": "CARD"
  },
  "vaultingCreateTime": "2023-10-16T01:07:22-07:00",
  "vaultingRequestId": "requestId1697443641665"
}
```
以下示例代码展示了如何验证通知的签名并做出响应：  
```java
@RequestMapping(path = "/payResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> paymentNotifyProcessor(HttpServletRequest request,
    @RequestBody String body) {
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  String rawSignature = request.getHeader("signature");
  String signature = "";  

  // 从原始签名中获取有效部分
  if (rawSignature == null || rawSignature.isEmpty()) {
    throw new RuntimeException("empty notify signature");
  } else {
    String[] parts = rawSignature.split("signature=");
    if (parts.length > 1) {
      signature = parts[1];
    }
  }  

  // 验证支付结果通知的签名
  boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
      clientId, requestTime, body, signature,
      ALIPAY_PUBLIC_KEY);
  if (!verifyResult) {
    throw new RuntimeException("Invalid notify signature");
  }  

  // 根据通知结果更新记录状态
  // 响应服务器，表示接受通知
  Result result = new Result("SUCCESS", "success", ResultStatusType.S);
  AlipayResponse response = new AlipayResponse();
  response.setResult(result);
  return ResponseEntity.ok().body(response);
}
```
#### 常见问题  
##### 何时发送通知？  
这取决于支付是否完成：  
*   如果支付成功完成，Antom 通常会在 3 到 5 秒内发送异步通知。对于某些支付方式，如 OTC，通知可能需要更长时间。
*   如果支付未完成，Antom 需要先关闭订单，然后才发送异步通知。不同支付方式关闭订单所需的时间会有所不同，通常默认为 14 分钟。  

##### 通知会重新发送吗？  
如果您收到 Antom 的异步通知，您需要按照 [示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification) 的格式返回响应。如果您未按要求响应异步通知，或者由于网络原因通知未送达，通知将在 24 小时内自动重新发送。通知最多可重新发送 8 次，或直到收到正确的响应以终止发送。发送间隔为：0 分钟、2 分钟、10 分钟、10 分钟、1 小时、2 小时、6 小时和 15 小时。  

##### 是否需要在响应中添加数字签名？  
如果您收到 Antom 的异步通知，您需要按照 [示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification) 的格式返回响应，但不需要在您的响应中添加数字签名。  

##### 如何理解以下关键字段的含义？  
*   _result_：订单的扣款结果。
*   _paymentMethodDetail_：如 `cardToken` 等扣款关键信息。
### **查询结果**
商家可以通过调用[**查询扣款**](https://global.alipay.com/docs/ac/ams/inquire_vaulting)API来查询订单的结果。
<table style="width:748px;outline:none;border-collapse:collapse;border:1px solid #D9E4F2;" class="lake-table"><colgroup><col width="211" span="1"><col width="97" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td style="background-color:#D4E4FC;font-size:14px;white-space:normal;border:1px solid #D9E4F2;padding:4px 8px;cursor:default"><p id="ue21c967f" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong><span style="color:#141E30">参数名称</span></strong></p></td><td style="background-color:#D4E4FC;font-size:14px;white-space:normal;border:1px solid #D9E4F2;padding:4px 8px;cursor:default"><p id="u84887414" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong><span style="color:#141E30">是否必需</span></strong></p></td><td style="background-color:#D4E4FC;font-size:14px;white-space:normal;border:1px solid #D9E4F2;padding:4px 8px;cursor:default"><p id="u6e9473cf" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong><span style="color:#141E30">描述</span></strong></p></td></tr><tr style="height:33px"><td style="font-size:14px;white-space:normal;border:1px solid #D9E4F2;padding:4px 8px;cursor:default"><p id="u6e9473cf" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>vaultingRequestId</span></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4F2;padding:4px 8px;cursor:default"><p id="ue5a82a97" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>是</span></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9E4F2;padding:4px 8px;cursor:default"><p id="ub536f85e" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span style="color:rgba(6, 19, 57, 0.8)">商家生成的扣款请求ID。</span></p></td></tr></tbody></table>  
以下示例代码展示了如何调用**查询扣款**API：
```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/api/v1/payments/inquiryPayment");  
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}
```
以下是一个请求消息的示例：
```json
{
  "vaultingRequestId": "123456789206"
}
```
以下是一个响应消息的示例：
```json
{
  "paymentMethodDetail": {
    "card": {
      "brand": "VISA",
      "cardToken": "ALIPAY9CGwsAeMBug+G2dSKDV6AIsNKTxAFNkOMoj8Gxvt8h0eDUbd6nO5CwMFIjEFERWxCAo/b1OjVTvtl1zspyMGcg==",
      "maskedCardNo": "************8764"
    },
    "paymentMethodType": "CARD"
  },
  "vaultingRequestId": "123487889889",
  "vaultingStatus": "SUCCESS",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```
#### 常见问题
##### 如何理解以下关键字段的含义？
*   _result_：API调用的结果，仅表示**inquiryPayment**API调用的结果。订单结果应基于_paymentStatus_来确定。`SUCCESS`和`FAIL`表示最终结果，`PROCESSING`表示交易仍在进行中。
*   _paymentAmount_：金额验证。如果需要进行金额验证，可以使用此字段。
##### 应该多频繁发起查询？
建议每2秒轮询一次，直到获取到最终的支付结果或收到异步支付通知为止。
要查看文档的最新更新，请访问[版本更新](https://global.alipay.com/docs/releasenotes)。
![](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？
#### 本页内容
[支付流程](#eLZVd "支付流程")  
[集成步骤](#nbBeY "集成步骤")  
[步骤1：创建扣款会话](#d7WfL "步骤1：创建扣款会话")  
[安装API库](#d3kyo "安装API库")  
[初始化请求实例](#WLui0 "初始化请求实例")  
[创建扣款会话](#Cwfah "创建扣款会话")  
[调用createVaultingSession API的示例代码](#cCfDw "调用createVaultingSession API的示例代码")  
[常见问题](#lr4ng "常见问题")  
[如何设置扣款结果通知地址？](#rHmht "如何设置扣款结果通知地址？")  
[步骤2：创建并调用SDK](#xhgER "步骤2：创建并调用SDK")  
[安装](#39v5P "安装")  
[实例化SDK](#cJVO5 "实例化SDK")  
[调用SDK](#rJC4B "调用SDK")  
[常见问题](#ARgvG "常见问题")  
[显示扣款结果](#UJQ0j "显示扣款结果")  
[步骤3：获取扣款结果](#Mo7TZ "步骤3：获取扣款结果")  
[接收异步通知](#WDV7j "接收异步通知")  
[常见问题](#esw1y "常见问题")  
[查询结果](#wlAb8 "查询结果")  
[常见问题](#tkpZO "常见问题")