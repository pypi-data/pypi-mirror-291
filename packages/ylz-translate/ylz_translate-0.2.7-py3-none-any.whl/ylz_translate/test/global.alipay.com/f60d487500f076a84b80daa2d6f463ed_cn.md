iOS | EasySafePay | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Feasypay_en%2Fios_en)  
[返回首页](../../)

EasySafePay  
[概述](/docs/ac/easypay_en/overview_en)  
接受支付  
支付后  
iOS
===

在这个主题中，你将学习如何在iOS客户端集成SDK，以便在移动应用中渲染收银台页面。无缝体验和重定向体验的集成过程相同。

前提条件  
在集成SDK之前，请确保完成以下任务：  
*   安装Xcode 12或更高版本。
*   使用iOS 11或更高版本。

关键集成步骤  
无论是首次支付还是后续支付，按照以下步骤集成SDK：  
1  
导入SDK包  
客户端  
请参考[Integrate the SDK Package](https://global.alipay.com/docs/ac/antom_sdk/ios_en)来集成SDK包。  
2  
显示可用支付方式  
客户端  
使用[工具](https://global.alipay.com/docs/ac/ref/brandasset)获取可用的支付方式，自定义其图标，并在收银台页面上显示它们。  
对于首次支付，建议显示可用支付方式的名称和图标。对于后续支付，建议显示这些支付方式的名称和图标，以及脱敏的买家账户。  
![图片3：iOS](https://mdn.alipayobjects.com/huamei_1vxa1o/afts/img/A*MgHwQL2O1NUAAAAAAAAAAAAADjeBAQ/original)  
3  
使用`AMSEasyPay`方法创建SDK实例：  
客户端
创建收银台页面的实例。实例包含以下参数：

*   `_configuration_`: 一个必需的 _AMSEasyPayConfiguration_ 类型的对象，必须包含所有配置参数。

创建 `AMSEasyPayConfiguration` 类，其中必须包含以下参数：

*   `_locale_`: 一个可选字符串，用于商户客户端识别买家浏览器的语言。设置此参数以确保SDK显示正确语言的页面。有效值如下。如果传递其他值，将默认使用英语。
    *   `en_US`: 英语
    *   `in_ID`: 印尼语
    *   `th_TH`: 泰语
    *   `ms_MY`: 马来语
    *   `tl_PH`: 菲律宾语
    *   `ko_KR`: 韩语
    *   `vi_VN`: 越南语
    *   `zh_HK`: 繁体中文（中国香港）
*   `_options_`: 一个可选的 _NSDictionary_ 类型参数，用于指定是否使用默认加载模式和沙盒环境。有效值如下：
    *   `"sandbox", "true"`: 沙盒环境
    *   `"sandbox", "false"`: 生产环境
    *   `"showLoading", "true"`: 使用默认加载模式。
    *   `"showLoading", "false"`: 不使用默认加载模式。

创建用于处理后续流程中相应事件的 **AMSPaymentProtocol** 接口实例。它包含以下方法：

*   `onEventCallback`: 监听收银台页面支付事件的回调函数，返回 _eventCode_ 和 _eventResult_。

创建用于管理日志输出的 **AMSLoggerProtocol** 接口实例。它包含以下方法：

*   `logWithName`: 用于默认输出日志的回调函数。

创建SDK实例：

Objective-C

```objc
#import <AMSComponent/AMSComponent-Swift.h>

AMSEasyPayConfiguration *configuration = [[AMSEasyPayConfiguration alloc] init];
configuration.locale = @"en_US"; // 设置语言
configuration.options = @{@"sandbox": @"true", @"showLoading": @"true"}; // 设置环境和加载模式

AMSPaymentProtocol *paymentProtocol = [[AMSPaymentProtocol alloc] init];
paymentProtocol.onEventCallback = ^(NSString *eventCode, id eventResult) {
    // 处理支付事件
};

AMSLoggerProtocol *logger = [[AMSLoggerProtocol alloc] init];
logger.logWithName = ^(NSString *logMessage) {
    // 输出日志
};

// 创建SDK实例
AMSComponent *sdkInstance = [[AMSComponent alloc] initWithConfiguration:configuration paymentProtocol:paymentProtocol logger:logger];
```

请注意，上述代码是示例，实际使用时需要根据具体需求和项目结构进行调整。
* componentConfig =  
\[AMSEasyPayConfiguration new\];  
componentConfig.locale =  
@"en\_US";  
// 指定使用沙箱环境的选项。如果为空，默认使用生产环境。  
NSDictionary \*options =  
@{@"showLoading": @"true",  
@"sandbox": @"true"};  
componentConfig.options =  
options;  
\[AMSEasyPay shared\]  
.initConfiguration(componentConfig);  
\[AMSEasyPay shared\].paymentDelegate = self;  
\[AMSEasyPay shared\].loggerDelegate = self;  
\[AMSEasyPay shared\]  
.createComponent(paymentSessionData);  

#pragma AMSPaymentProtocol  
\- (void)onEventCallback:(NSString \*)eventCode  
eventResult:(AMSEventResult \*)eventResult {  
NSLog(@"eventCode%@ eventResult%@", eventCode, eventResult);  
}  

#pragma AMSLogProtocol  
\- (void)logWithName:(NSString \*)name  
parameter:(NSDictionary<NSString \*,id\> \*)parameter {  
NSLog(@"name%@ parameter%@", name, parameter);  
}  

```
此处省略了大量重复的符号“ה”
```

XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  

4  
向支付宝服务器发送一个[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)请求。  
服务器端  
当用户选择支付方式并且您的客户端检测到支付按钮点击事件后，您的服务器端发送一个[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)请求。从createPaymentSession响应中获取paymentSessionData值，并在步骤5中使用它。
对于首次支付或后续支付，调用**createPaymentSession** API时需要指定不同的参数：

**首次支付：**
*   _paymentRedirectUrl_: 商家结果页面的URL。建议传入scheme URL或H5-scheme URL。
*   _authState_: 商家生成的用于启动EasySafePay授权的唯一ID。指定此参数以获取未来免密支付的访问令牌。
*   _paymentNotifyUrl_: 用于接收支付结果通知的URL，必须是HTTPS URL。
*   _paymentSessionExpiryTime_: 支付会话过期的日期和时间，默认为1小时，但不能超过1小时。值遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式，例如 "2019-11-27T12:01:01+08:00"。
*   _userLoginId_: 用户在钱包中注册时使用的登录ID，可以是用户的电子邮件地址或电话号码。
*   _order.buyer.referenceBuyerId/buyerPhoneNo/buyerEmail_: 传入买家信息，以便支付宝提供风险控制策略。传入三个参数之一：_referenceBuyerId_、_buyerPhoneNo_ 或 _buyerEmail_。

**后续支付：**
*   _paymentMethod.paymentMethodId_: 传入首次支付时从**notifyAuthorization** API获取的_accessToken_。
*   _paymentRedirectUrl_: 商家结果页面的URL。建议传入scheme URL或H5-scheme URL。
*   _paymentNotifyUrl_: 用于接收支付结果通知的URL，必须是HTTPS URL。
*   _paymentSessionExpiryTime_: 支付会话过期的日期和时间，默认为1小时，但不能超过1小时。值遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式，例如 "2019-11-27T12:01:01+08:00"。
* _order.buyer.referenceBuyerId/buyerPhoneNo/buyerEmail_: 传递买家信息，以便支付宝提供风险控制策略。请提供三个参数之一：_referenceBuyerId_、_buyerPhoneNo_ 或 _buyerEmail_。
  
**首次支付**
  
JSON

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId001",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "agreementInfo": {
    "authState": "authState001",
    "userLoginId": "userLoginId001"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "100"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "100"
    },
    "referenceOrderId": "referenceOrderId001",
    "orderDescription": "orderDescription001",
    "buyer": {
      "referenceBuyerId": "referenceBuyerId001"
    }
  }
}
```

**后续支付**

JSON

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId002",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "agreementInfo": {
    "authState": "authState002",
    "userLoginId": "userLoginId002"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "100"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "100"
    },
    "referenceOrderId": "referenceOrderId002",
    "orderDescription": "orderDescription002",
    "buyer": {
      "referenceBuyerId": "referenceBuyerId002"
    }
  }
}
```

请注意，以上JSON示例分别代表首次支付和后续支付的请求结构。其中包含的参数如结算策略、产品代码、支付场景、通知URL、请求ID、重定向URL、支付方式、授权状态、用户登录ID、支付金额、订单金额、参考订单ID、订单描述以及买家信息等。这些参数用于定义支付流程和相关设置。
"paymentNotifyUrl": "https://www.yourNotifyUrl",  
"paymentRequestId": "paymentRequestId002",  
"paymentRedirectUrl": "https://www.yourMerchantWeb.com",  
"paymentMethod": {  
"paymentMethodId": "************\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*",  
"paymentMethodType": "ALIPAY_CN"  
},  
"paymentAmount": {  
"currency": "CNY",  
"value": "30000"  
},  
"order": {  
"orderAmount": {  
"currency": "CNY",  
"value": "30000"  
},  
"referenceOrderId": "referenceOrderId002",  
"orderDescription": "orderDescription002",  
"buyer": {  
"referenceBuyerId": "referenceBuyerId002"  
}  
}  
}

生成支付页面  
客户端  
使用配置对象中的`createComponent`方法。  
1. 使用`_sessionData_`参数创建配置对象：将步骤4中获取的`_paymentSessionData_`值传递给`createComponent`方法的`_sessionData_`参数。
2. 调用`createComponent()`方法初始化SDK。  
在以下情况下调用`onDestroy()`方法释放SDK组件资源：  
* 当用户离开结账页面时，释放`createPaymentSession`中创建的组件资源。
* 当用户发起多次支付时，释放前一次`createPaymentSession`中创建的组件资源。  
使用`createComponent`方法  
Objective-C  
1  
2  
3  
4  
[[AMSEasyPay shared] createComponent:sessionData];  
// 释放SDK组件资源
[[AMSEasyPay shared] onDestroy];  
哈哈哈哈哈  
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  
6  
获取授权结果或支付结果  
服务器端  
无论是无缝体验还是重定向体验，对于首次支付，您可以获取授权结果和支付结果；对于后续支付，仅能获取支付结果：  
*   **获取授权结果**
授权成功后，支付宝会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth)通知接口向您发送异步通知。收到通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。同时，您需要在自己的系统中更新买家的授权状态，并在授权管理页面上显示从通知中获取的买家脱敏账户信息。
*   **获取支付结果**
当支付达到最终的成功或失败状态时，支付宝会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)API向您在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)API中传递的_paymentNotifyUrl_发送异步通知。收到支付宝的通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。
**注意**: 如果买家放弃支付后，您调用了 **[查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online)** API 和 **[取消支付](https://global.alipay.com/docs/ac/ams/paymentc)** API，可能会收到订单不存在的响应，也可能不会收到支付失败的异步通知。建议采取以下措施：

对于您主动关闭的订单：
1. 如果收到支付宝的成功支付通知，无需进一步操作。
2. 如果收到支付宝的订单状态未知的通知，调用 **[取消](https://global.alipay.com/docs/ac/ams/paymentc)** API 取消对应的订单。

对于重复支付（一个商家订单对应多个支付宝订单）：
如果收到多个支付宝订单的成功支付通知，保留一个成功结果的支付宝订单，使用 **[取消](https://global.alipay.com/docs/ac/ams/paymentc)** API 取消其余的支付宝订单。

**事件代码**
SDK 提供以下状态代码：
1. `SDK_START_OF_LOADING`: 支付组件创建时加载动画开始播放。
2. `SDK_END_OF_LOADING`: 支付组件创建时加载动画结束。
3. `SDK_PAYMENT_CANCEL`: 用户在账户确认页或大额交易确认页取消支付。

SDK 提供以下错误代码：
1. `SDK_INTERNAL_ERROR`: SDK 内部错误。请联络支付宝技术支持解决。
2. `SDK_CREATEPAYMENT_PARAMETER_ERROR`: 传递给 `AMSEasyPay` 方法的参数不正确。确保参数传递正确并重新发送请求。
3. `SDK_CALL_URL_ERROR`: 支付方式客户端撤销失败。请联络支付宝技术支持解决。
*   `SDK_INTEGRATION_ERROR`: 未找到依赖项。请确保已正确添加依赖项，然后重试集成过程。
#### 本页面是否有帮助？
要查看文档的最新更新，请访问 [发行说明](https://global.alipay.com/docs/releasenotes)。
![图片 4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)