Create accessToken | Auto Debit | Alipay Docs
===============
                        

[![Image 1: Alipay, China's leading third-party online payment solution](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![Image 2: Alipay, China's leading third-party online payment solution](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[Log In](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fautodebitpay%2Fcreate_accesstoken)

[Go to Homepage](../../)

Auto Debit

[Overview](/docs/ac/autodebitpay/overview)

[User experience](/docs/ac/autodebitpay/user_ex)

Development

Obtain user authorization

[Create accessToken](/docs/ac/autodebitpay/create_accesstoken)

[Receive authorization notification](/docs/ac/autodebitpay/notify_auth)

[Redirect from merchant to payment method](/docs/ac/autodebitpay/redirect_merchant-wallet)

[Redirect from wallet to payment method](/docs/ac/autodebitpay/redirect_wallet-merchant)

[Refresh accessToken](/docs/ac/autodebitpay/refresh_accesstoken)

[Revoke accessToken](/docs/ac/autodebitpay/revoke_accesstoken)

Auto debit

Refund

[Best practice](/docs/ac/autodebitpay/best_practice)

Other resources

Create accessToken
==================

2024-04-10 03:12

The _accessToken_ is required to automatically deduct money from the userâ€™s account. To get _accessToken_, you must get _authUrl_ first and then get _authCode_.

To get the authUrl and then the _authCode_, complete the following steps:

1.  Configure the authorization notification receiving address: This ensures you can receive the authorization notification and get the _authCode_ from it even if the [reconstructed redirection URL](#5wBk5) is not returned.
2.  Consult for authUrl: Call the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API and get _authUrl_ from the corresponding response. _authUrl_ can be used only once during a single authorization process.
3.  Redirect the user: Redirect the user to _authUrl_ by launching the user's payment method app or redirecting to a WEB or WAP page.
4.  Get authCode: After the user agrees to authorize on the page specified by _authUrl_, the Alipay+ Mobile Payment Partner (MPP) returns a reconstructed redirection URL and Alipay sends you an authorization notification. You can get _authCode_ from the reconstructed redirection URL or authorization notification.
5.  Create accessToken: With the authCode, you can get an accessToken by calling the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API.

Step 1: Configure the authorization notification address
========================================================

To ensure that you can receive the authorization notification and get the authCode from it, provide the receiving address in [Antom Dashboard](https://global.alipay.com/docs/dashboard_en).

With the address submitted, Alipay sends the authorization result notification when the user authorization succeeds. Upon receipt of the notification, you must return a receipt acknowledgment message to Alipay. To learn how to provide the notification receiving address and return the receipt acknowledgment message to Alipay, see [Receive authorization notification](https://global.alipay.com/docs/ac/43trgzdfg/78e9h).

Step 2: Consult for _authUrl_
=============================

To obtain the authorization URL (_authUrl_), call the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API by making a POST request to the Alipay server with the correct request URL path. For example, if you use the domain name of `https://open-na-global.alipay.com`, the request URL path is: `https://<https://open-na-global.alipay.com>/ams/api/v1/authorizations/consult`. In the API request, you must specify these fields:

*   _authRedirectUrl_: The first part of the merchant page URL that the user is redirected to after authorization.
*   _authState_: A string provided by you that will be used later in the redirection URL. The user will be redirected to the redirection URL after authorization completes.
*   _customerBelongsTo_: Specify the target Alipay+ MPP that you are requesting authorization for.
*   _scopes_: Specify the authorization scope per your needs.
*   _terminalType_: indicates the terminal type of the merchant side.

**Request header**

Replace the _client-id_ value `T_111222333` with the client ID that is assigned to you. You can get the client ID in Antom Dashboard.

copy

    Content-Type:application/json; charset=UTF-8
    original_host:open-na.alipay.com
    Request-Time:2019-07-12T12:08:56+05:30
    client-id:T_111222333
    Signature:algorithm=RSA256,keyVersion=1,signature=TgpjpAzwmA7aWDloDEitOp

**Request body**

copy

    {
      "customerBelongsTo": "GCASH",
      "authRedirectUrl":"https://www.alipay.com/",
      "scopes": ["AGREEMENT_PAYMENT"],
      "authState": "663A8FA9-D836-48EE-8AA1-1FF682989DC7",
      "terminalType": "APP",
      "osType": "IOS",
      "osVersion": "11.0.2"
    }

If no response is returned after calling the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API, call the API again with the same fields as the previous request. If the response is received, _response.result_ represents the result of the API call:

*   When _resultStatus_ is `S`, the API is called successfully. Only in this case, the value of _authUrl_ is obtained from the response.
*   When _resultStatus_ is `U`, the API calling status is unknown. You need to call the API again without changing the value of _authState_.
*   When _resultStatus_ is `F`, check the reason for failure based on the value of _resultCode_ and take the corresponding action.

The following sample shows a response of a successfully called [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API:

copy

    {
        "result": {
            "resultStatus": "S",
            "resultCode": "SUCCESS",
            "resultMessage": "success."
        },
        "authUrl": "https://render.alipay.com/p/c/jzmcoal2?callback=https%3A%
        "resultInfo": {
            "resultStatus": "S",
            "resultCode": "SUCCESS",
            "resultMessage": "success." 
         }
    }

Step 3: Redirect the user
=========================

After getting the _authUrl_ successfully, you need to redirect the user to the _authUrl_ address where the user can agree to authorize. If the redirection process fails, you need to reinitiate the authorization process by calling the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API again with a new _authState_ value. To ensure the success of the redirection process, see [Redirect from merchant to payment method](https://global.alipay.com/docs/ac/43trgzdfg/56xgzfer).

If the user is redirected to _authUrl_ successfully, the user can agree to authorize on the corresponding page. After the user agrees to authorize, the corresponding Alipay+ MPP redirects the user back to the merchant side. The merchant address is composed of _authRedirectUrl_, _authCode_, and _authState_. In addition, Alipay simultaneously sends you the authorization notification, which also contains the _authCode_ and _authState_ fields. For more details about the redirection process to the merchant side, see [Redirect from payment method to merchant](https://global.alipay.com/docs/ac/autodebitpay/redirect_wallet-merchant).

Step 4: Get _authCode_
======================

You can get _authCode_ in one of the following ways if the user agrees to authorize:

*   Get _authCode_ from the reconstructed redirection URL returned by Alipay+ MPPs.
*   Get _authCode_ from the authorization notification.  
    

> **Note**: It is suggested to get _authCode_ from the authorization notification result because a failed redirection might occur. Therefore, you must integrate the [**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) SPI.

If the authorization process fails because the user does not agree to authorize or fails to authorize, the user will not be redirected to the merchant side or _authCode_ will not be contained in the redirection URL. Usually, if you cannot get _authCode_ within a certain period of time (a suggested time period is 15 minutes), you need to restart from [Step 2](#KbjCb) to get the _authCode_ again. When calling the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API again, use an updated value for the _authState_ field in the request.

The reconstructed redirection URL
---------------------------------

The reconstructed redirection URL returned by the Alipay+ MPP is the merchant page address composed of the following two parts:

*   The value of _authRedirectUrl_, which is specified in the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) request.
*   The value of _authCode_, which is provided by the Alipay+ MPP.
*   The value of _authState_, which is specified in the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) request.

An example of the redirection URL is given below:

copy

    https://www.alipay.com/?authCode=d2f60253-ecdc-e9bc-27d1- 566970191040&authState=663A8FA9-D836-48EE-8AA1-1FF682989DC7

After the user is redirected to the reconstructed redirection URL after authorization, you need to check:

*   Whether the value of _authState_ in the URL is consistent with the value of _authState_ specified in the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) request. If the value is inconsistent, the authorization fails and you need to restart the authorization process from [Step 2](#KbjCb) to get the authCode again.
*   Whether the _authCode_ field has a value. If the authCode field is empty, the authorization fails.

> **Note**: When you test this step in the sandbox, you can open _authUrl_ and use the test payment method and account to simulate a user's authorization.

Step 5. Create the accessToken
==============================

After getting the _authCode_ value, you need to call the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API immediately with the value of _authCode_ to obtain _accessToken_ within one minute after obtaining the authCode before _authCode_ expires. Only after getting a valid _accessToken_, you can directly deduct money from the user's account during the payment phase with no additional operations required for the user to conduct.

Call the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API by making a POST request to the Alipay server with the correct request URL path. For example, if you use the domain name of `https://open-na-global.alipay.com`, the request URL path is: `https://<https://open-na-global.alipay.com>/ams/api/v1/authorizations/applyToken`. Specify the following fields in the request:

*   _grantType_: Assign the `AUTHORIZATION_CODE` value to this field.
*   customerBelongsTo: Assign the target Alipay+ MPP to this field.
*   authCode: Assign the value of _authCode_ obtained after calling the [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API to this field.

The following sample shows a request body of the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API:

copy

    {
      "grantType": "AUTHORIZATION_CODE",
      "customerBelongsTo": "GCASH",
      "authCode": "d2f60253-ecdc-e9bc-27d1-566970191040"
    }

The following sample shows a response returned for a successfully called [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API. From the response, you can get the value of _accessToken_. At the same time, the _refreshToken_ used for updating the _accessToken_ is also returned.

copy

    {
        "accessTokenExpiryTime": "2019-09-04T13:41:39+0800",
        "result": {
            "resultStatus": "S",
            "resultCode": "SUCCESS",
            "resultMessage": "success."     
        },
        "accessToken": "20190828054139156697089972935735984402094237jmfUWaepj
        "refreshTokenExpiryTime": "2019-09-11T13:41:39+0800",
        "resultInfo": {
            "resultStatus": "S",
            "resultCode": "SUCCESS",
            "resultMessage": "success."      
        },
        "refreshToken": "20190828054139156697089972935735984402120180HYYGFvfs
    }

If no response is returned, call the API again with the same fields as the previous request. If the response is returned, take the following actions for each case:

*   When _result.resultStatus_ is `S`, the API is called successfully and the accessToken is returned. You can use the accessToken to deduct money from the user's account.
*   When _result.resultStatus_ is `U`, call the API again with the same fields as the previous request.
*   When _result.resultStatus_ is `F`, take corresponding actions according to _resultCode_. Because the _authCode_ can only be used once, if the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API call has failed, you need to restart from [Step 2](#U06iL) to get a new _authCode_ and call the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API again.

> **Note**: Each accessToken created by calling the [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API has a validity period that varies for different payment methods and users. To prevent transactions from failing due to _accessToken_ invalidation, you can extend the validity period of the accessToken by using the refreshToken before the accessToken expires. It is suggested to maintain a life-cycle table that contains information about the accessToken, periodically retrieve and refresh the accessToken that is about to expire.

To view the latest updates to the documentation, visit [Release notes](https://global.alipay.com/docs/releasenotes).

![Image 3](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![Image 4](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 Alipay [Legal Information](https://global.alipay.com/docs/ac/platform/membership)

#### Is this page helpful?

#### On this page

[Step 1: Configure the authorization notification address](#U06iL "Step 1: Configure the authorization notification address")

[Step 2: Consult for authUrl](#KbjCb "Step 2: Consult for authUrl")

[Step 3: Redirect the user](#FZplL "Step 3: Redirect the user")

[Step 4: Get authCode](#S8rJN "Step 4: Get authCode")

[The reconstructed redirection URL](#5wBk5 "The reconstructed redirection URL")

[Step 5. Create the accessToken](#yDNrC "Step 5. Create the accessToken")