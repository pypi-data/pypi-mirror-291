最佳实践 | 自动扣款 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fautodebitpay%2Fbest_practice)  
[返回首页](../../)

自动扣款
[概述](/docs/ac/autodebitpay/overview)  
[用户体验](/docs/ac/autodebitpay/user_ex)  
开发
[最佳实践](/docs/ac/autodebitpay/best_practice)  
其他资源
最佳实践
==================

2022-12-21 03:09

为了提高集成效率并避免支付纠纷，请阅读以下最佳实践，确保系统和所有相关方按照标准流程进行集成。

任务流程和API交互
==================

在自动扣款中，涉及以下角色：

*   **用户**：使用支付服务的个人或机构。
*   **商家**：销售商品或服务的公司或个人。在文档中，这个角色是“您”。
*   **支付宝**：提供自动扣款服务的支付宝。
*   **支付宝+ MPP**：支付宝+移动支付提供商。在自动扣款中，支付宝+移动支付提供商是一个数字钱包，如GCash。

所有API需要在正确的时间正确使用，以确保您的系统按预期运行：

*   在授权阶段，建议创建一个数据表，其中包含为每个账户创建的accessTokens信息。当需要刷新或失效_accessToken_时，该表将相应更新。
支付与退款阶段，建议创建一个包含交易数据的表格。当支付或退款操作进行时，该表格将相应更新。
![图片3：一般流程.png](https://yuque.antfin.com/images/lark/0/2021/png/134374/1615355994217-3473d47e-20f6-42b7-bee1-f50fde3d040f.png)
图1. 自动扣款集成的总体流程  
获取用户授权
-------------------------

在能够自动从用户账户扣款之前，需要获取用户的授权。获取用户授权需完成以下步骤：

1.  配置地址以接收授权结果通知。
2.  调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API 获取_authUrl_，然后将用户重定向到_authUrl_。
3.  用户同意授权后，获取_authCode_。
4.  使用_authCode_ 调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 获取_accessToken_。
5.  （可选）当_accessToken_ 即将过期时，使用对应的_refreshToken_ 调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 刷新_accessToken_。
6.  （可选）如果需要，通过调用[**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation) API 无效_accessToken_ 来撤销授权。
在之前的步骤中，_authUrl_ 和 _authCode_ 只能使用一次。如果授权过程失败，需要再次调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API，并在请求中更新_authState_字段的值。例如，可以将之前的值后面附加数字，如authstatexxxx\_1。此外，为了确保客户端重定向过程顺利，需遵循[从商户到钱包的重定向](https://global.alipay.com/docs/ac/43trgzdfg/56xgzfer)和[从钱包到商户的重定向](https://global.alipay.com/docs/ac/autodebitpay/redirect_wallet-merchant)的集成指南。

如果_accessToken_即将过期，可以使用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API并指定正确的字段来刷新_accessToken_。另外，当需要时，可以使用[**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation) API撤销_accessToken_。

以下图表展示了不同角色之间的整体授权流程。授权完成后，可以使用_accessToken_发起支付请求。

![Image 4: consult接口流程图-.jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/12884741/1643008492038-b603d272-56b2-464f-bd61-bd3cd3efed41.jpeg)
图2. 整体授权流程图

自动扣款
---------

授权完成后，只要_accessToken_有效，即可进行自动扣款，无需为每次支付重新授权。

1. 调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API 来发起自动扣款支付。如果API调用成功，自动扣款支付成功。如果API调用失败，自动扣款支付失败。
2. 获取支付结果：当自动扣款成功或失败时，支付宝会向您发送异步通知。如果调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API 的状态未知，您需要通过轮询方式调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API，直到获取支付结果：
   * 如果成功完成支付，您可以继续执行其他任务。
   * 如果支付未成功完成，您需要使用新的paymentRequestId再次调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API。

3. （可选）如果交易已成功支付且仍在可取消期内，或者交易未支付且需要在支付宝支付过期时间前提前取消，您可以调用[**cancel**](https://global.alipay.com/docs/ac/ams/paymentc_online) API 根据需要取消交易。商家和用户的支付状态将保持一致。

4. （可选）交易成功支付后且仍在退款期内，您可以调用[**refund**](https://global.alipay.com/docs/ac/ams/refund_online) API 根据需要发起退款。您可以使用[**inquiryRefund**](https://global.alipay.com/docs/ac/ams/ir_online) API 检查退款状态。

> **注意**：
>
> * 为了获取准确的支付结果，您必须同时集成异步通知和支付结果查询服务。因为某些钱包在支付失败时可能不会返回通知，集成这两项服务可以确保从任何钱包获取支付结果。
在不同的集成任务中，您可能会使用各种与交易相关的金额和货币。有关Amount对象的使用规则的详细信息，请参阅[Amount对象的使用规则](https://global.alipay.com/docs/ac/ref/cc)。

以下图表展示了支付流程以及支付后可以执行的其他操作：

![图5：图片](https://yuque.antfin.com/images/lark/0/2021/jpeg/134374/1640253345485-40ba8594-991e-4940-9f6c-af6124131027.jpeg)

图3. 整体支付流程图

获取准确的支付结果非常重要。因此，建议在数据库中维护一个订单表，至少包含两个字段：订单号和订单状态。并使用以下方式的异步通知和支付结果查询服务：

*   异步通知：监听支付宝的异步通知，并在接收到通知时做出响应。然后检查数据库中的订单状态：
    *   如果订单状态为`INIT`，根据异步通知更新订单状态。
    *   如果订单状态不是`INIT`，说明已经通过查询获取了最终支付结果，并相应地更新了订单状态。无需采取进一步行动。
*   支付查询：以轮询方式主动查询支付结果。在每次查询之前，需要检查数据库中的订单状态：
    *   如果订单状态为`INIT`，发起查询。如果获取到最终支付结果，更新数据库中的订单状态，否则继续轮询过程。
    *   如果订单状态不是`INIT`，说明已经进行了查询过程，获取了最终支付结果并用于更新订单状态。无需采取进一步行动。

![图6：图片](https://cdn.nlark.com/yuque/0/2021/png/561635/1619061903693-545f78ce-8cd7-4a54-8a83-763289bf7bbf.png)
图4. 使用异步通知和支付结果查询服务获取支付结果  
要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。  
![图片7](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片8](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 在这个页面上  
[任务流程和API交互](#bqnLy "任务流程和API交互")  
[获取用户授权](#Dch0r "获取用户授权")  
[自动扣款](#PBv2v "自动扣款")