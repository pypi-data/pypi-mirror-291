托管模式 | 结算支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fcardcollant)  
[返回首页](../../)

结算支付
[概览](/docs/ac/cashierpay/overview)  
接受支付  
SDK 集成  
仅 API 集成  
[APM 支付API](/docs/ac/cashierpay/apm_api)  
信用卡支付
[托管模式](/docs/ac/cashierpay/cardcollant)  
[服务器到服务器模式](/docs/ac/cashierpay/cardinfocallmerchant)  
支付后
支付方式  
其他资源  
高级功能  
[预前端解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡存储API](/docs/ac/cashierpay/cv)  
[卡存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API/SDK](/docs/ac/cashierpay/mf?pageVersion=7)  

托管模式
===========

2024-05-11 10:13

本文档描述了如何通过托管模式集成信用卡支付方法。托管模式保护您免受 PCI-DSS 限制，因为敏感数据不会通过您的服务器传递，您无需符合 PCI 认证要求。在这种模式下，Antom 提供了一个支付信息收集页面，用于捕获支付信息并将其存储为卡令牌（_cardToken_），以便在后续流程中使用。

用户体验
===============

以下图示展示了首次支付和已保存卡支付的用户体验。
### 首次支付  
**Web**  
**App**  
#### Web 用户体验  
![图片 3: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712890120683-f2a0debf-dcd1-44a4-ab82-ee3d3db06865.png)  
#### App 用户体验  
![图片 4: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712890136933-3a8fc02b-526c-4fbb-a1d0-4ec6a81826d2.png)  
**自动填充地址，姓名和电子邮件**  
**信用卡/借记卡**  
\[ \] **支付方式名称**  
**优惠信息：7美元优惠**  
**金额：42.00美元**  
**卡号**  
**检查或订单**  
**WNOMEN PLAID**  
**支付成功**  
**免费配送**  
**128.00 泰铢**  
**有效期**  
**U5D4200**  
**支付宝-**  
**商品**  
**验证信息**  
**金额：42.00美元**  
**4位数-月份**  
**金额：0.00美元**  
**结账**  
**全球支付**  
**支付宝**
### 保存的卡支付  
Web  
App  
#### Web用户体验  
![图5: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712890185981-5e9a4a8c-ef67-4b1e-84a7-1a9d4b1a46a8.png)  
#### App用户体验  
![图6: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712890207426-daac30d9-60e9-43de-a37e-df14e45fc94a.png)  
OREM1PSURACOIERSITAACTCONECSTAAURADIPISIC  
宁CREDITANDDEBITCARD  
\[\_JPAYMENTMETHODNA  
GPAGCECT  
USD42.00  
CHECKORDERS  
AOUTZEOTTE  
DEAL:7USDOFF  
MBER:540492""487  
D42.00  
USD42.00  
ISSUERPAGE  
O1P101ECE20  
USD0.00  
EWNEAOESEEEEEFE  
AIPAY中间页  
ENTMETHODS  
MEROHANT:T  
CALLCENTERTEL:0-2777-7777  
INTORMATIONPLEASECONTACTSCBCALLCENTERT  
ALIPAY!  
AMUNT  
USD42.00  
RREFESR  
ORDERREVIE  
支付流程
==========  
对于托管模式的卡支付，支付流程包括以下步骤：  
![图7: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1712890310938-382ba153-7d05-4be7-86b4-8bc90a8340e6.png)  
1.  **买家进入结账页面。**
2.  **创建** [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) **请求**
买家选择支付方式并提交订单后，调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 获取支付链接以完成支付。
3.  **处理支付继续URL**
将支付继续URL返回给客户端。需要将买家重定向到支付继续URL。支付继续URL根据支付方式的特性执行不同的操作，如收集信息、重定向用户、调用应用、显示二维码和进行验证。
4.  **获取支付结果**
使用以下两种方法之一获取支付结果：  
*   异步通知：在[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中设置 _paymentNotifyUrl_ 以接收异步通知。支付成功或超时时，Antom 会通过 [**notifyPayment**](https://global.alipay.com/docs/ac/cashierpay/overview) 发送异步通知。
*   同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 检查支付状态。  
5.  **获取扣款结果**
对于卡支付，需要使用以下两种方法之一获取扣款结果：  
*   异步通知：在[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中设置 _paymentNotifyUrl_ 以接收异步通知。支付请求成功或超时时，Antom 会通过 [**notifyCapture**](https://global.alipay.com/docs/ac/ams/notify_capture) 发送异步通知。
*   同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 检查支付请求状态。  
集成步骤
==========  
大多数卡支付遵循Antom提供的通用支付流程和集成过程。开始集成的步骤如下：  
1.  （可选）显示支付方式
2.  授权支付
3.  获取支付结果
4.  扣款
5.  获取扣款结果  
> **注意**：对于韩国卡片，存在发卡行认证和非认证两种支付类型。韩国卡片的非认证支付遵循通用的卡支付流程。但韩国卡片的发卡行认证支付涉及额外的操作。  
步骤1：（可选）在客户端显示支付方式
---------------------------------------------------------  
在支付页面的支付方式列表中添加要集成的支付方式的标志和名称，供买家选择。可以通过以下两种方式之一获取标志和名称：  
*   联系Antom技术支持获取。
*   调用 **consult** API 根据货币、交易发起终端类型、用户地区和已签约支付方式获取当前交易支持的支付方式和标志URL。  
添加支付方式后的页面效果如下图所示：  
![图8: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715414263607-4f899d0f-ae00-4546-a2c7-fd68e0cf3f32.png)  
> **注意**：对于需要发卡行认证的韩国卡片，需要显示卡片品牌供买家选择。  
步骤2：在服务器端授权支付
---------------------------------------  
当用户选择Antom提供的支付方式时，会显示用户填写卡信息的页面。在此过程中，需要收集用户的卡信息、环境信息和订单信息。调用 **pay** API，提交支付授权请求。
### 服务器端发起支付请求  
蚂蚁金服提供了多种语言的服务器端API库。以下以Java为例，您需要安装Java 6或更高版本。  
#### 安装API库  
您可以在[GitHub](https://github.com/alipay/global-open-sdk-java)上找到最新版本。  
```xml
<dependency>
  <groupId>com.alipay.global.sdk</groupId>
  <artifactId>global-open-sdk-java</artifactId>
  <version>2.0.21</version>
</dependency>
```  
#### 初始化请求实例  
```java
String merchantPrivateKey = "YOUR PRIVATE KEY";
String alipayPublicKey = "ALIPAY PUBLIC KEY";
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG, merchantPrivateKey, alipayPublicKey);
```  
#### 创建支付请求  
在调用**pay** API时，您可以根据业务需求选择以下功能：  
*   **启用3D验证**：通过设置**pay** API中的`is3DSAuthentication`参数来决定是否使用3D Secure进行交易验证。
*   **智能挽救交易**：如果发卡行要求，对非3D Secure交易自动发起3D Secure验证以挽救失败的交易。
*   **增值服务风险控制**：蚂蚁金服提供交易级别的升级风险控制服务，根据交易风险等级智能制定风险控制策略。
*   **地址验证服务（AVS）**：验证提供的账单地址是否与发卡行记录的持卡人地址匹配，帮助防止欺诈交易。
*   **存储卡信息**：在首次支付时获取买家同意存储卡信息，以便下次支付时无需再次输入。
*   **商户发起交易（MIT）**：在用户参与的情况下发起计划或非计划交易。
*   **指定卡品牌**：当买家选择联名卡支付时，可以指定卡品牌或授权支付的地区。
*   **MPI能力**：商户在交易发起前优先进行第三方验证，并在支付请求中传递验证结果信息，指定非3D验证，如果商户未捕获卡信息则不可用。
*   **分期付款**：支付时，买家可以选择分期付款方式，按每个分期期数定期付款。买家完成首期付款后，蚂蚁金服根据合同中指定的结算周期结算全额订单金额。  

支付请求包含以下参数：  
| 参数名 | 是否必需 | 描述 |
| --- | --- | --- |
| productCode | 是 | 合同中规定的正在使用的支付产品，对于收银台支付，值固定为 `CASHIER_PAYMENT`。 |
| paymentRequestId | 是 | 商家为识别支付请求分配的唯一ID。 |
| paymentAmount | 是 | 商家请求在订单货币中接收的支付金额。 |
| paymentMethod | 是 | 商家或收单方用于收集支付的支付方式。 |
| paymentRedirectUrl | 是 | 支付完成后用户重定向到的商家页面URL。 |
| settlementStrategy | 否 | 支付请求的结算策略。 |
| order | 是 | 买家、商家、商品、金额、配送信息和购买环境等订单信息。 |
| paymentExpiryTime | 否 | 支付会话过期的具体日期和时间。 |
| env | 是 | 环境信息：用于提高支付成功率。 |
| selectedCardBrand | 否 | 针对韩国卡片发卡行认证场景，需要指定`selectedCardBrand`参数为特定卡品牌，参见[卡品牌](https://global.alipay.com/docs/ac/ref/payment_method#ZfyuE)列表。 |
| requireIssuerAuthentication | 否 | 针对韩国卡片发卡行认证场景，需要设置`requireIssuerAuthentication`为`true`。 |

有关所有参数的更多信息，请参考[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API文档。  
#### 调用pay API的示例代码  
以下示例代码用于发起支付：  
```java
AlipayPayRequest alipayPayRequest = new AlipayPayRequest();
alipayPayRequest.setClientId(CLIENT_ID);
alipayPayRequest.setPath("/ams/sandbox/api/v1/payments/pay");
alipayPayRequest.setProductCode(ProductCodeType.CASHIER_PAYMENT);  
// 替换为您的paymentRequestId
alipayPayRequest.setPaymentRequestId("paymentRequestId01");  
// 设置金额
Amount amount = new Amount();
amount.setCurrency("SGD");
amount.setValue("4200");
alipayPayRequest.setPaymentAmount(amount);  
// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("CARD");
alipayPayRequest.setPaymentMethod(paymentMethod);  
// 设置支付因子
PaymentFactor paymentFactor = new PaymentFactor();
paymentFactor.setAuthorization(true);
alipayPayRequest.setPaymentFactor(paymentFactor);  
// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId01");
order.setOrderDescription("antom test order");
Buyer buyer = new Buyer();
buyer.setReferenceBuyerId("yourBuyerId");
order.setBuyer(buyer);
order.setOrderAmount(amount);
alipayPayRequest.setOrder(order);  
// 设置环境信息
Env env = new Env();
env.setTerminalType(TerminalType.WEB);
env.setClientIp("114.121.121.01");
alipayPayRequest.setEnv(env);  
// 替换为您的通知URL
alipayPayRequest.setPaymentNotifyUrl("http://www.yourNotifyUrl.com");  
// 替换为您的重定向URL
alipayPayRequest.setPaymentRedirectUrl("http://www.yourRedirectUrl.com");  
// 执行支付
AlipayPayResponse alipayPayResponse = null;
try {
    alipayPayResponse = defaultAlipayClient.execute(alipayPayRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误条件
}  
```  
#### 请求消息示例  
**普通卡支付请求**  
```json
{
  "paymentNotifyUrl": "http://www.yourNotifyUrl.com",
  "paymentRequestId": "paymentRequestId011",
  "env": {
    "terminalType": "WEB",
    "clientIp": "114.121.121.01"
  },
  "paymentAmount": {
    "currency": "SGD",
    "value": "4200"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentRedirectUrl": "http://www.yourRedirectUrl.com",
  "paymentFactor": {
    "isAuthorization": true
  },
  "paymentMethod": {
    "paymentMethodType": "CARD"
  },
  "order": {
    "orderAmount": {
      "currency": "SGD",
      "value": "4200"
    },
    "referenceOrderId": "referenceOrderId01",
    "orderDescription": "antom test order",
    "buyer": {
      "referenceBuyerId": "yourBuyerId"
    }
  }
}
```  
**韩国卡发卡行认证支付请求**  
```json
{
  "order": {
    "orderAmount": {
      "currency": "KRW",
      "value": "30000"
    },
    "orderDescription": "Cappuccino #grande (Mika's coffee shop)",
    "referenceOrderId": "ORDER_20221114141714891",
    "buyer": {
      "buyerEmail": "alipay@alipay.com",
      "referenceBuyerId": "test12345678"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMOzAKe",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "KRW",
    "value": "30000"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodMetaData": {
      "selectedCardBrand": "SAMSUNG", // 指定卡品牌
      "requireIssuerAuthentication": true // 指定认证支付
    }
  },
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "paymentNotifyUrl": "https://www.alipay.com/notify",
  "paymentRedirectUrl": "https://www.alipay.com",
  "paymentRequestId": "PAY_20221114141714891",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true,
    "captureMode": "MANUAL" // 如果指定，则为手动捕获，如果不指定，则为自动捕获。
  }
}
```  
#### 常见问题  
**如何设置`terminalType`的值？**  
如果用户从PC端发起交易，`terminalType`应设置为`WEB`。  
**请求中是否可以使用中文字符？**  
不要在请求字段中使用中文字符，以避免与QRIS和Mastercard等支付方式的兼容性问题。  
**如何设置支付结果通知地址？**  
蚂蚁金服会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)发送支付结果，您可以在**pay** API中通过`paymentNotifyUrl`参数指定。如果每个支付的地址相同，您也可以在蚂蚁金服控制台中配置。如果已配置地址并在API中设置了参数，蚂蚁金服将使用API中设置的地址。
### 接收支付响应  
返回的参数包含以下内容：  
*   _normalUrl_：支付继续的URL，用于重定向。
*   _paymentId_：订单ID。  
以下是示例响应：  
**成功授权支付**  
**失败授权支付**  
**处理中的授权**  
#### 成功授权  
```json
{
"paymentAmount": {
"currency": "SGD",
"value": "4200"
},
"paymentCreateTime": "2021-11-12T01:27:50-08:00",
"paymentId": "20211112194010800100188570271832381",
"paymentRequestId": "paymentRequestId01",
"paymentResultInfo": {
"avsResultRaw": "A",
"cvvResultRaw": "Y",
"networkTransactionId": "sampleNetworkTransactionId123456"
},
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}
```  
#### 失败授权  
```json
{
"paymentAmount": {
"currency": "SGD",
"value": "4200"
},
"paymentCreateTime": "2021-11-12T01:27:50-08:00",
"paymentId": "20211112194010800100188570271832381",
"paymentRequestId": "paymentRequestId01",
"paymentResultInfo": {
"avsResultRaw": "A",
"cvvResultRaw": "Y",
"networkTransactionId": "sampleNetworkTransactionId123456"
},
"result": {
"resultCode": "ACCESS_DENIED",
"resultMessage": "Access is denied.",
"resultStatus": "F"
}
}
```  
#### 处理中的授权  
```json
{
"result": {
"resultStatus": "U",
"resultCode": "PAYMENT_IN_PROCESS",
"resultMessage": "payment in process"
},
"normalUrl": "https://pgw-ui.2c2p.com/payment/4.1/ant/#/token/kSAops9Zwhos8hSTSeLTUchuUa9%2bFg0EHv0XtS%2bTyCt8%2f1qy%2fDZCW88dV9FH3Yh8pEobKvOj%2fsh6nbH95mDRORzWy%2bsBbFh541I7QzVolYBEzeYnLiTC6lP2hjCAwadc",
"paymentId": "20221111194010890100111650285726898",
"paymentRequestId": "paymentRequestId01",
"redirectActionForm": {
"redirectUrl": "https://pgw-ui.2c2p.com/payment/4.1/ant/#/token/kSAops9Zwhos8hSTSeLTUchuUa9%2bFg0EHv0XtS%2bTyCt8%2f1qy%2fDZCW88dV9FH3Yh8pEobKvOj%2fsh6nbH95mDRORzWy%2bsBbFh541I7QzVolYBEzeYnLiTC6lP2hjCAwadc",
"method": "GET"
},
"paymentAmount": {
"currency": "SGD",
"value": "4200"
},
"paymentCreateTime": "2022-11-10T18:47:20-08:00"
}
```  
#### 常见问题  
**什么是_normalUrl_？**  
对于网页交易，Antom会返回_normalUrl_，商家服务器需要将其传递给商家客户端进行重定向。当您为同一订单再次发起支付时，需要获取新的_normalUrl_进行重定向。  
**什么是_paymentId_？**  
如果您需要存储相应的订单号以备后续退款和对账，可以指定_paymentId_。
### 客户端重定向至支付继续URL  
商家服务器将_normalUrl_传递给客户端，由客户端页面处理重定向到_normalUrl_的过程。  
步骤3：服务器端获取支付结果  
--------------------------------------------  
当买家完成支付或支付超时，您可以通过蚂蚁金服的异步通知或主动查询支付结果来获取相应的支付状态。  
从异步通知响应和**查询支付**中获取的信息包含授权支付结果以及如下关键信息：

| **API** | **授权结果** | **AVS信息** | **CVV信息** | **3DS认证信息** |
| --- | --- | --- | --- | --- |
| **notifyPayment** | resultStatus | avsResultRaw | cvvResultRaw | threeDSResult（仅3DS认证授权时可用） |
| **inquiryPayment** | paymentStatus | avsResultRaw | cvvResultRaw | threeDSResult（仅3DS认证授权时可用） |

- `notifyPayment` API会返回`resultStatus`，表示授权结果。
- `avsResultRaw` 提供了地址验证服务（AVS）的原始信息。
- `cvvResultRaw` 提供了信用卡验证码（CVV）验证的原始信息。
- `threeDSResult` 仅在进行了3DS认证授权时返回，包含3DS认证的相关信息。

请注意，这些信息会帮助您确认支付是否成功以及验证过程的详细状态。
### 异步通知  
当支付成功或失败时，Antom（可能是指蚂蚁金服）会通过在`pay` API中指定的`paymentNotifyUrl`参数向您指定的地址发送异步通知（[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)）。如果每个支付的地址相同，您也可以在Antom控制台中配置该地址。  

以下是一个3D支付的通知示例：  
```json
{
"notifyType": "PAYMENT_RESULT",
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "success"
},
"paymentRequestId": "paymentRequestId01",
"paymentId": "2020010123456789XXXX",
"paymentAmount": {
"value": "4200",
"currency": "SGD"
},
"paymentCreateTime": "2020-01-01T12:01:00+08:30",
"paymentTime": "2020-01-01T12:01:01+08:30",
"paymentResultInfo": {
"avsResultRaw": "A",
"cvvResultRaw": "Y",
"networkTransactionId": "sampleNetworkTransactionId123456",
"threeDSResult": {
"eci": "02",
"threeDSVersion": "2.2.0",
"caav": "cavvSample",
"dsTransactionId": "sample_dsTranasctionId"
}
}
}
```
以下是一个非3D支付的通知示例：  
```json
{
"notifyType": "PAYMENT_RESULT",
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "success"
},
"paymentRequestId": "paymentRequestId01",
"paymentId": "2020010123456789XXXX",
"paymentAmount": {
"value": "4200",
"currency": "SGD"
},
"paymentCreateTime": "2020-01-01T12:01:00+08:30",
"paymentTime": "2020-01-01T12:01:01+08:30",
"paymentResultInfo": {
"avsResultRaw": "A",
"cvvResultRaw": "Y",
"networkTransactionId": "sampleNetworkTransactionId123456"
}
}
```
以下是一个验证签名并响应通知的示例代码：  
```java
@RequestMapping(path = "/payResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> paymentNotifyProcessor(HttpServletRequest request,
@RequestBody String body) {  
// 从请求头中获取所需参数。
String requestTime = request.getHeader("request-time");
String clientId = request.getHeader("client-id");
String rawSignature = request.getHeader("signature");
String signature = "";  
// 从原始签名中获取有效部分
if(rawSignature==null||rawSignature.isEmpty()){
throw new RuntimeException("empty notify signature");
}else {
String[] parts = rawSignature.split("signature=");
if (parts.length > 1) {
signature = parts[1];
}
}  
// 验证支付结果通知的签名
boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
clientId, requestTime, body, signature,
ALIPAY_PUBLIC_KEY);
if (!verifyResult) {
throw new RuntimeException("Invalid notify signature");
}  
// 根据通知结果更新记录状态  
// 响应服务器我们已接受通知
Result result = new Result("SUCCESS", "success", ResultStatusType.S);
AlipayResponse response = new AlipayResponse();
response.setResult(result);
return ResponseEntity.ok().body(response);
}
```
#### 常见问题  
##### 何时发送通知？  
支付完成后，Antom会在3~5秒内向您发送异步通知。如果支付未完成，您需要等待Antom关闭订单后才会发送异步通知。不同支付方式的订单关闭时间不同，一般默认为14分钟。  
##### 通知会重新发送吗？  
如果您收到Antom的异步通知，您需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应。如果您未按要求响应异步通知，或者由于网络原因通知未送达，通知将在24小时内自动重试发送，最多重试8次或直到收到正确的响应以终止发送。发送间隔为：0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时，15小时。  
##### 是否需要在响应中添加数字签名？  
如果您收到Antom的异步通知，您需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应，但您不需要在响应中添加数字签名。  
##### 如何理解以下关键字段的含义？  
*   `result`：表示订单的支付结果。
*   `paymentRequestId`：表示您为咨询、取消和对账生成的支付请求号。
*   `paymentId`：表示Antom生成的支付订单号，用于退款和对账。
*   `paymentAmout`：表示支付金额。
### 查询支付结果  
通过调用**inquiryPayment** API查询支付结果，需要指定以下参数：  
<table style="width:784px;outline:none;border-collapse:collapse;border:1px solid #D9EEFC" class="lake-table"><colgroup><col width="211" span="1"><col width="133" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td style="background-color:#D9EEFC;text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="ud2eea623" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><strong>参数名称</strong></p></td><td style="background-color:#D9EEFC;text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="uf17d3dbd" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><strong>是否必须</strong></p></td><td style="background-color:#D9EEFC;text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u7aa93d8a" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><strong>描述</strong></p></td></tr><tr style="height:33px"><td style="font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u8c7b1b2d" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><em>paymentRequestId</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u76f7c8a3" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><span>否</span></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u4793d7b4" style="text-align:center;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><span>商家生成的支付请求号</span></p></td></tr></tbody></table>  
以下示例代码展示了如何调用**inquiryPayment** API：  
```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/sandbox/api/v1/payments/inquiryPayment");
alipayPayQueryRequest.setPaymentRequstId("paymentRequestId01");  
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}  
```
以下是一个请求消息的示例：  
```json
{
  "paymentRequestId": "paymentRequestId01"
}
```
以下是一个3D支付响应消息的示例：  
```json
{
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "Success"
  },
  "paymentStatus": "SUCCESS",
  "paymentRequestId": "paymentRequestId01",
  "paymentId": "2019060811401080010018882020035XXXX",
  "paymentAmount": {
    "value": "4200",
    "currency": "SGD"
  },
  "paymentCreateTime": "2019-06-01T12:01:01+08:30",
  "paymentTime": "2019-06-01T12:01:01+08:30",
  "paymentResultInfo": {
    "avsResultRaw": "A",
    "cvvResultRaw": "Y",
    "networkTransactionId": "sampleNetworkTransactionId123456",
    "threeDSResult": {
      "eci": "02",
      "threeDSVersion": "2.2.0",
      "caav": "cavvSample",
      "dsTransactionId": "sample_dsTranasctionId"
    }
  }
}
```
以下是一个非3D支付响应消息的示例：  
```json
{
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "Success"
  },
  "paymentStatus": "SUCCESS",
  "paymentRequestId": "paymentRequestId01",
  "paymentId": "2019060811401080010018882020035XXXX",
  "paymentAmount": {
    "value": "4200",
    "currency": "SGD"
  },
  "paymentCreateTime": "2019-06-01T12:01:01+08:30",
  "paymentTime": "2019-06-01T12:01:01+08:30",
  "paymentResultInfo": {
    "avsResultRaw": "A",
    "cvvResultRaw": "Y",
    "networkTransactionId": "sampleNetworkTransactionId123456"
  }
}
```
#### 常见问题解答  
##### 如何理解以下关键字段的含义？  
*   _result_：表示**inquiryPayment** API调用的结果，订单状态需根据_paymentStatus_判断，`SUCCESS`和`FAIL`代表最终结果，`PROCESSING`表示处理中。
*   _paymentAmout_：表示支付金额。  
##### 应该多久发起一次？  
建议每2秒发起一次轮询查询，从调用**pay** API后，可以持续轮询直到查询到最终支付结果或收到异步支付结果通知。  
### 步骤4：服务器端捕获
默认情况下，蚂蚁金服会自动为您处理资金捕获。如果在调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API时将_paymentFactor.captureMode_设置为`MANUAL`，则必须通过调用[**capture**](https://global.alipay.com/docs/ac/ams/capture) API来捕获支付资金。  
*   **自动捕获**：用户授权支付后，蚂蚁金服会立即自动捕获资金。捕获结果会通过异步通知传达给您。以下情况会激活自动捕获：  
    *   在**pay** API中将_paymentFactor.captureMode_设置为`AUTOMATIC`。
    *   在**pay** API中未设置_paymentFactor.captureMode_或未传递此参数。  
*   **手动捕获**：您必须在授权成功后的7天内通过调用**capture** API发起资金捕获，否则蚂蚁金服会自动解冻支付的授权资金。总捕获金额必须等于总授权金额。  
> **注意**：对于卡支付，建议在发货前确认捕获成功。  
**capture** API中的主要请求参数如下表所示：  
<table style="width:671px;outline:none;border-collapse:collapse;border:1px solid #D9EEFC" class="lake-table"><colgroup><col width="198" span="1"><col width="473" span="1"></colgroup><tbody><tr style="height:33px"><td style="background-color:#D9EEFC;text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="ud8e2feba" style="font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><strong>参数</strong></p></td><td style="background-color:#D9EEFC;text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u507b914a" style="font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><strong>描述</strong></p></td></tr><tr style="height:33px"><td style="text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u8e9c9231" style="font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><em>captureRequestId</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u52f6c738" style="text-align:left;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em">您为捕获请求分配的唯一标识符。</p></td></tr><tr style="height:33px"><td style="text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u7ce94883" style="font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><em>paymentId</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="u52f6c738" style="text-align:left;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em">蚂蚁金服为订单分配的唯一标识符。</p></td></tr><tr style="height:33px"><td style="text-align:center;font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="ub118aa6a" style="font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em"><em>captureAmount</em></p></td><td style="font-size:14px;white-space:normal;border:1px solid #D9EEFC;padding:4px 8px;cursor:default"><p id="uc594543a" style="text-align:left;font-size:14px;color:#262626;line-height:1.74;letter-spacing:0.05em">捕获金额，必须等于总授权金额。</p></td></tr></tbody></table>  
以下示例代码用于发起捕获：  
```java
AlipayCaptureRequest alipayCaptureRequest = new AlipayCaptureRequest();
alipayCaptureRequest.setPath("/ams/sandbox/api/v1/payments/capture");
alipayCaptureRequest.setClientId(CLIENT_ID);  
Amount amount = new Amount();
amount.setCurrency("SGD");
amount.setValue("4200");
alipayCaptureRequest.setCaptureAmount(amount);  
alipayCaptureRequest.setCaptureRequestId("captureRequestId01");
alipayCaptureRequest.setPaymentId("2019060811401080010018882020035XXXX");  
AlipayCaptureResponse alipayCaptureResponse= null;  
try{
    alipayCaptureResponse = defaultAlipayClient.execute(alipayCaptureRequest);
}catch (AlipayApiException e){
    String errorMsg = e.getMessage();
}  
```
以下是一个响应消息的示例：  
```json
{
  "paymentId": "2019060811401080010018882020035XXXX",
  "captureRequestId": "captureRequestId01",
  "captureAmount": {
    "currency": "SGD",
    "value": "4200"
  }
}
```
### 步骤5：服务器端获取捕获结果
当买家完成捕获或捕获超时，您可以通过蚂蚁金服的异步通知或主动查询支付结果来获取相应的支付结果。
### 异步通知  
当扣款完成或失败时，Antom 会通过在 `pay` API 中设置的 `_paymentNotifyUrl` 参数指定的地址发送异步通知（[**notifyCapture**](https://global.alipay.com/docs/ac/ams/notify_capture)）。如果每个扣款通知的接收地址相同，您也可以在 Antom 控制台中配置该地址。  

以下是一个成功支付的通知示例：  
```
"captureAmount": {
  "currency": "SGD",
  "value": "4200"
},
"notifyType": "CAPTURE_RESULT",
"captureId": "2022XXXXXXX",
"captureRequestId": "captureRequestId01",
"captureTime": "2022-11-10T00:34:52-08:00",
"paymentId": "2022XXXXXXX",
"result": {
  "resultCode": "SUCCESS",
  "resultMessage": "success.",
  "resultStatus": "S"
}
```

以下是一个失败支付的通知示例：  
```
"captureAmount": {
  "currency": "SGD",
  "value": "4200"
},
"notifyType": "CAPTURE_RESULT",
"captureId": "2022XXXXXXX",
"captureRequestId": "captureRequestId01",
"captureTime": "2022-11-10T00:34:52-08:00",
"paymentId": "2022XXXXXXX",
"result": {
  "resultCode": "PROCESS_FAIL",
  "resultMessage": "fail.",
  "resultStatus": "F"
}
```

以下示例代码展示了验证签名和响应通知的过程：  
```java
@RequestMapping(path = "/captureResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> captureNotifyProcessor(HttpServletRequest request,
@RequestBody String body) {
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  String rawSignature = request.getHeader("signature");
  String signature = "";  

  // 从原始签名中获取有效部分
  if(rawSignature==null||rawSignature.isEmpty()){
    throw new RuntimeException("empty notify signature");
  } else {
    String[] parts = rawSignature.split("signature=");
    if (parts.length > 1) {
      signature = parts[1];
    }
  }  

  // 验证支付结果通知的签名
  boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
      clientId, requestTime, body, signature,
      ALIPAY_PUBLIC_KEY);
  if (!verifyResult) {
    throw new RuntimeException("Invalid notify signature");
  }  

  // 根据通知结果更新记录状态
  // 响应服务器我们已接受通知
  Result result = new Result("SUCCESS", "success", ResultStatusType.S);
  AlipayResponse response = new AlipayResponse();
  response.setResult(result);
  return ResponseEntity.ok().body(response);
}
```

#### 常见问题  
##### 何时发送通知？  
支付完成后，Antom 将在 3~5 秒内向您发送异步通知。如果支付未完成，您需要等待 Antom 关闭订单后再发送异步通知。不同支付方式的订单关闭时间不同，一般默认为 14 分钟。  

##### 通知会重新发送吗？  
如果您收到 Antom 的异步通知，您需要按照 [示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification) 的格式返回响应。如果您未按要求响应异步通知，或者由于网络原因通知未送达，通知将在 24 小时内自动重试发送，最多重试 8 次，或直到收到正确响应为止。重试发送间隔为：0 分钟、2 分钟、10 分钟、10 分钟、1 小时、2 小时、6 小时和 15 小时。  

##### 需要对响应进行签名吗？  
如果您收到 Antom 的异步通知，您需要按照 [示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification) 的格式返回响应，但不需要对响应进行签名。  

##### 如何理解以下关键字段的含义？  
*   `result`: 表示订单的支付结果。
*   `notifyType`: `CAPTURE_RESULT`
*   `paymentId`: 表示由 Antom 生成的支付订单号，用于退款和对账。
*   `acquirerReferenceNo`: 对于接入新加坡和香港卡支付的商家，通知中会提供具体的收单机构编号。
### 查询支付结果  
通过调用**inquiryPayment** API查询扣款结果，指定以下参数：  
| 参数名称 | 是否必须 | 描述 |
| --- | --- | --- |
| paymentRequestId | 否 | 商家生成的支付请求号 |

示例代码展示如何调用**inquiryPayment** API：  
```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/sandbox/api/v1/payments/inquiryPayment");
alipayPayQueryRequest.setPaymentRequestId("paymentRequestId01");  
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}  
```
请求消息示例：  
```json
{
  "paymentRequestId": "paymentRequestId01"
}
```
#### 扣款状态值  
API响应中的`transactions`字段表示扣款状态：  
| 参数 | 描述 |
| --- | --- |
| transactions.transactionType | 值为`CAPTURE`，表示扣款状态 |
| transactions.transactionResult | 扣款结果 |

扣款成功的示例响应：  
```json
{
  "transactions": [
    {
      "transactionType": "CAPTURE",
      "transactionStatus": "SUCCESS",
      "transactionRequestId": "test_test_test_XXXX",
      "transactionAmount": {
        "currency": "SGD",
        "value": "4200"
      },
      "transactionId": "2022XXXXXXXX",
      "transactionResult": {
        "resultStatus": "S",
        "resultCode": "SUCCESS",
        "resultMessage": "success"
      }
    }
  ]
}
```
扣款失败的示例响应：  
```json
{
  "transactions": [
    {
      "transactionType": "CAPTURE",
      "transactionStatus": "FAIL",
      "transactionRequestId": "test_test_test_XXXX",
      "transactionAmount": {
        "currency": "SGD",
        "value": "4200"
      },
      "transactionTime": "2022-09-29T07:13:50-07:00",
      "transactionId": "2022XXXXXXXX",
      "transactionResult": {
        "resultStatus": "F",
        "resultCode": "PROCESS_FAIL",
        "resultMessage": "General business failure. No retry."
      }
    }
  ]
}
```
扣款处理中的示例响应：  
```json
{
  "transactions": [
    {
      "transactionType": "CAPTURE",
      "transactionStatus": "PROCESSING",
      "transactionRequestId": "test_test_test_XXXX",
      "transactionAmount": {
        "currency": "SGD",
        "value": "4200"
      },
      "transactionId": "2022XXXXXXXX",
      "transactionResult": {
        "resultStatus": "U",
        "resultCode": "PAYMENT_IN_PROCESS",
        "resultMessage": "payment in process"
      }
    }
  ]
}
```
#### 常见问题解答  
##### 如何理解以下关键字段的含义？  
* `result`：表示**inquiryCapture** API调用的结果，订单状态需根据`transactionResult`判断，`SUCCESS`和`FAIL`代表最终结果，`PROCESSING`表示处理中。  
##### 应何时发起查询？  
建议每隔2秒轮询一次，从发起订单**咨询**API后持续轮询，直到查询到最终扣款结果或收到异步扣款结果通知。  
#### 最佳实践  
遵循以下最佳实践以提高集成效率。  
**自定义支付超时时间**  
在结账支付场景中，蚂蚁侧默认超时时间为14分钟，超时后买家无法继续支付。要定义超时时间，可以通过**pay** API的`paymentExpireTime`参数指定。超过指定时间后，买家无法扫码或登录结账页面。  
示例代码展示如何在**pay** API中指定`paymentExpireTime`参数：  
```json
{
  "env": {
    "osType": "ANDROID",
    "terminalType": "APP"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "1314"
    },
    "orderDescription": "Cappuccino #grande (Mika's coffee shop)",
    "referenceOrderId": "ORDER_0517884936248XXXX"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "1314"
  },
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "paymentExpiryTime":"2024-01-20T08:51:06+08:00",
  "paymentNotifyUrl": "https://www.gaga.com/notify",
  "paymentRedirectUrl": "imeituan://",
  "paymentRequestId": "iJ9lsVgTx8pX7qJpvW6rfqEE2Kdv9M3lgL8e1999ydfz52uMSqwvT3qXYw8IFBYt",
  "productCode": "CASHIER_PAYMENT",
  "settlementStrategy": {
    "settlementCurrency": "USD"
  }
}
```
建议将API超时设置为10秒，以确保获取响应的成功率。  
**商户结果页面处理逻辑建议**  
1. **前端重定向异常**  
如果买家支付成功，由于网络原因或支付方式本身限制，可能无法重定向到您指定的`paymentRedirectUrl`，此时应注意以下两点：  
   * 不能以前端跳转作为判断支付成功的依据。
   * 如果支付页面的`paymentRedirectUrl`无法重定向到商户页面，买家可能手动点击返回原商户页面。因此，为了避免原商户页面手动切回支付页面，导致买家再次发起订单支付，建议在原商户订单页面重定向后弹出查询交易结果的窗口，买家点击后显示订单结果，避免再次支付订单。  
2. **重定向后触发订单结果查询**  
如果在商户端触发调用**inquiryPayment** API后，建议针对以下不同结果进行处理：  
   * **支付成功**：页面显示与发货相关的内容；
   * **支付失败**：页面显示支付失败，建议引导重新支付；
   * **支付处理中**：页面显示加载效果，等待3-5秒，同时查询服务器端支付结果，如果仍未返回成功或失败的最终结果，建议显示“订单处理中”或“订单管理门户查看最终结果”，不建议显示“网络处理中”。如果仍然没有结果，建议显示“订单处理中”或前往“订单管理门户”查看最终结果。  
**支付失败后的重试**  
对于商户侧的同一订单，如果首次支付未完成且支持买家再次发起支付，建议遵循以下集成步骤：  
1. 在支付请求中，将`referenceOrderId`设置为订单ID，`paymentRequestId`设置为支付订单ID。
2. 对于同一订单再次发起支付时，优先检查订单状态，如果支付成功，向买家显示“支付完成”，如果未成功，再次调用**pay** API获取新的`normalUrl`进行重定向。注意，由于是同一订单，`referenceOrderId`可以保持不变，而新的支付订单需要更新`paymentRequestId`。
3. 商户端需要检查每个商户订单只能有一个成功的支付订单，如果有多个成功支付订单，需要调用**cancel** API退款给买家。
4. 对于不支持退款的支付方式，建议在发起新支付前取消第一个支付订单。  
**获取和检查支付结果的时机**  
为了确保稳定获取支付结果，避免买家支付完成但未获取到支付结果的情况，建议在以下阶段检查支付结果：  
1. 商户支付结果页面显示时。
2. 发货给买家之前。
3. 收到蚂蚁对账文件时。  
要查看文档的最新更新，请访问[版本更新日志](https://global.alipay.com/docs/releasenotes)。  
![Image 9](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![Image 10](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 本页内容  
[用户体验](#Ksw2W "用户体验")  
[首次支付](#IxaLO "首次支付")  
[已保存卡支付](#0Kk7s "已保存卡支付")  
[支付流程](#N7q25 "支付流程")  
[集成步骤](#nbBeY "集成步骤")  
[步骤1：（可选）显示支付方式](#VTOFD "步骤1：（可选）显示支付方式")  
[步骤2：授权支付](#jNATt "步骤2：授权支付")  
[发起支付请求](#vPvsX "发起支付请求")  
[安装API库](#4uRcc "安装API库")  
[初始化请求实例](#ME5sd "初始化请求实例")  
[创建支付请求](#FMTa3 "创建支付请求")  
[常见问题](#25A5Q "常见问题")  
[接收支付响应](#sZZMB "接收支付响应")  
[常见问题](#h4fLV "常见问题")  
[重定向到支付继续URL](#e3v5s "重定向到支付继续URL")  
[步骤3：获取支付结果](#R8LWX "步骤3：获取支付结果")  
[异步通知](#ytUhU "异步通知")  
[常见问题](#gnV70 "常见问题")  
[查询支付结果](#rWbYT "查询支付结果")  
[常见问题](#oqPyy "常见问题")  
[步骤4：扣款](#izoQV "步骤4：扣款")  
[步骤5：获取扣款结果](#YgG79 "步骤5：获取扣款结果")  
[异步通知](#o77OU "异步通知")  
[常见问题](#rY44t "常见问题")  
[查询支付结果](#lrw97 "查询支付结果")  
[扣款状态值](#q3e0A "扣款状态值")  
[常见问题](#sK2kp "常见问题")  
[最佳实践](#xKj3a "最佳实践")  
[自定义支付超时时间](#yGaRZ "自定义支付超时时间")  
[商户结果页面处理逻辑建议](#GdEle "商户结果页面处理逻辑建议")  
[支付失败重试](#hAeaV "支付失败重试")  
[获取和检查支付结果的时机](#o55cG "获取和检查支付结果的时机")