客户端与钱包集成 | 自动扣款 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fagreementpayment%2Fclientsideint)  
[返回首页](../../)  

自动扣款
[Introduction](/docs/ac/agreementpayment/intro)  
[开始使用](/docs/ac/agreementpayment/getting_started)  
[授权与支付](/docs/ac/agreementpayment/payment)  
[客户端与钱包集成](/docs/ac/agreementpayment/clientsideint)  
[支付后服务](/docs/ac/agreementpayment/post_payment)  
[报表与对账](/docs/ac/agreementpayment/report)  
[最佳实践](/docs/ac/agreementpayment/autodebit_bp)  
[幂等性](/docs/ac/agreementpayment/api_idemptcy)  

开发
[API 列表](/docs/ac/agreementpayment/apis)  

参考
[版本说明](/docs/ac/agreementpayment/releasenotes)  

客户端与钱包集成
===================

2021-11-15 02:45

本文档提供了一个商家与钱包之间无缝重定向的集成指南。为了实现商家与钱包之间的无缝重定向，您需要了解不同终端类型之间的差异，并遵循本文档提供的集成指南，以确保重定向成功。
商家终端类型为APP的重定向是最复杂的情况，因此本文档仅对此情况进行说明。商家需要通过调用[咨询](https://global.alipay.com/docs/ac/ams/authconsult)接口获取_auth_Url_，并确保从商家端成功重定向到钱包端，通过打开_auth_Url_来实现。本文档提供示例代码以协助重定向过程。示例代码适用于iOS 9.2及以上版本和Android 6.0及以上版本。

术语和定义
------------

以下术语和定义在本文档中使用。

| **术语** | **定义** |
| --- | --- |
| WAP | 客户端终端类型为由移动浏览器打开的HTML页面。 |
| APP | 客户端终端类型为移动应用程序。 |
| URL Schemes | URL Schemes允许用户通过点击自定义URL从其他应用打开商家的应用。但iOS和Android已不再推荐使用。关于Scheme的更多信息，参见[iOS中定义URL Scheme](https://developer.apple.com/documentation/xcode/allowing_apps_and_websites_to_link_to_your_content/defining_a_custom_url_scheme_for_your_app)和[Android中创建深度链接](https://developer.android.com/training/app-links/deep-linking)。 |
| 全局链接（iOS） | 全局链接允许您连接到iOS应用中的深度链接，支持iOS 9.2及以上版本。当访问全局链接时，iOS会直接将链接重定向到您应用中的深度链接。如果您的应用未安装，它将在浏览器中打开您的网站URL。关于全局链接的更多信息，参见[支持全局链接](https://developer.apple.com/library/content/documentation/General/Conceptual/AppSearch/UniversalLinks.html)。 |
| 应用链接（Android） | 应用链接允许您连接到Android应用中的深度链接，并在Android 6.0及以上版本中支持。当访问一个应用链接时，Android会直接将链接重定向到您应用中的深度链接。如果您的应用未安装，它将在浏览器中打开您的网站URL。有关应用链接的更多信息，请参阅[处理Android应用链接](https://developer.android.com/training/app-links/index.html)。 |  
表1. 术语和定义  
授权URL
==========  
要进入钱包的授权页面，将用户重定向到由_authUrl_指定的地址。_authUrl_的值从[咨询](https://global.alipay.com/docs/ac/ams/authconsult)接口的响应中获取。  
下表显示了每个数字钱包的_authUrl_类型以及后续重定向体验。  
*   如果钱包指定_authUrl_需由浏览器打开，包括默认浏览器、webview等，无论用户是否安装了钱包，重定向体验相同。
*   如果钱包未指定_authUrl_需由浏览器打开，重定向体验取决于用户是否已安装钱包。  
| **钱包** | **_authUrl_类型** | **钱包已安装** | | **钱包未安装** | **由浏览器打开** |
| --- | --- | --- | --- | --- | --- |
| Dana | WAP | WAP授权页面（用户在浏览器打开的授权页面中输入账户和密码，而不是在钱包应用中打开授权页面。） | | | |
| KaKaoPay | WAP-Scheme | 钱包应用（用户被重定向到由默认浏览器打开的中间页面，然后被引导到钱包应用完成授权。） | | 钱包下载WAP页面（用户被重定向到下载钱包应用的WAP页面。） | |
| 图标 | 图标 | 图标 | | | |
| GCash | UL/AL | 钱包应用（用户在钱包应用中打开授权页面） | | WAP授权页面（用户在浏览器打开的授权页面输入账号和密码，而不是在钱包应用中打开） | |
| --- | --- | --- | --- | --- |
| Touch'n go | 钱包应用（用户在钱包应用中打开授权页面） | | WAP授权页面（用户在浏览器打开的授权页面输入账号和密码，而不是在钱包应用中打开） | |
| TrueMoney | 钱包应用（用户在钱包应用中打开授权页面） | | 钱包下载WAP页面（用户被重定向到下载钱包应用的WAP页面） | |
| AlipayHK | 钱包应用（用户在钱包应用中打开授权页面） | | WAP授权页面（用户在浏览器打开的授权页面输入账号，而不是在钱包应用中打开） | |
**表2. 每个数字钱包的_authUrl_ 类型及其对应用户体验**

> **注释**：
>
> *   Universal Links（iOS）和App Links（Android）简称为UL/AL。
> *   重定向到钱包授权页面时可能遇到三种体验类型：
>
> *   钱包应用：用户在钱包应用中打开授权页面。此类型不被Dana支持。
> *   WAP授权页面：用户在浏览器打开的授权页面输入账号，而不是在钱包应用中打开。此类型不被TrueMoney和KakaoPay支持。
> *   钱包下载WAP页面：用户被重定向到下载钱包应用的WAP页面。当用户未安装钱包应用时，TrueMoney和KakaoPay会通过浏览器打开此类页面。  
**集成方法**
==================
有三种可能的方式从商家端重定向到钱包端：

1. **跳出并打开**：跳出商家应用并打开钱包应用
2. **留在内并打开**：在商家应用内打开钱包页面
3. **按情况判断**：检查用户是否已安装钱包应用，然后选择相应的解决方案：
   - 如果用户已安装钱包应用，使用**跳出并打开**方案。
   - 如果用户未安装钱包应用，使用**留在内并打开**方案。

每种方式都有其优点和缺点，应根据您的偏好明智选择。

### 跳出并打开（推荐）

为了以最低成本完成从商家应用到钱包的客户端集成，建议使用此方法进行重定向：跳出商家应用，并将`authUrl`提供给应用系统以打开钱包。

**优点：**
* 高兼容性。不同钱包提供的不同类型的`authUrl`可以兼容。例如，Dana的`authUrl`类型为WAP，KaKaoPay为WAP-Scheme，而其他钱包可能是UL/AL。
* 易于集成。重定向时无需考虑用户是否已安装钱包应用。
* 无需额外定制。兼容未来加入的新钱包。

**缺点：**
* 对于某些钱包，用户体验较差。授权过程需要在商家应用外部完成。例如，Dana只能提供通过外部浏览器打开的WAP授权页面，而不能在钱包应用内打开授权页面。
* 当用户未安装钱包应用时，如Gcash、Touch'n go和AlipayHK等钱包会显示WAP授权页面，该页面由默认浏览器打开，而不是在商家应用内。

此解决方案支持以下钱包：
| **数字钱包** | **支持的钱包** | **备注** |
| --- | --- | --- |
| GCash | ✅ | * 当钱包已安装，授权页面在钱包内打开。 * 当钱包未安装，授权页面由默认浏览器打开。 |
| Touch'n go | ✅ | * 当钱包已安装，授权页面在钱包内打开。 * 当钱包未安装，授权页面由默认浏览器打开。 |
| AlipayHK | ✅ | * 当钱包已安装，授权页面在钱包内打开。 * 当钱包未安装，授权页面由默认浏览器打开。 |
| TrueMoney | ✅ | * 当钱包已安装，授权页面在钱包内打开。 * 当钱包未安装，由默认浏览器打开钱包下载页面。 |
| KaKaoPay | ✅ | * 当钱包已安装，用户被重定向到由默认浏览器打开的中间页面，然后转到钱包应用完成授权。 * 当钱包未安装，用户被重定向到由默认浏览器打开的钱包下载页面。 |
| Dana | ✅ | 不论钱包是否已安装，授权页面均由默认浏览器打开。 |
**表3. 支持的钱包**
### 演示代码  
**在Android应用中**  
以下示例代码展示了如何在Android应用中从商户应用重定向到钱包应用：  
复制  
```java
try {
    Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(authUrl));
    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
    // 使用startActivity函数重定向到钱包应用
    startActivity(intent);
} catch (Exception e) {
    e.printStackTrace();
}
```
**在iOS应用中**  
以下示例代码展示了如何在iOS应用中从商户应用重定向到钱包应用：  
复制  
```swift
if ([UIDevice.currentDevice.systemVersion floatValue] >= 10.0) {
    // 使用openURL函数重定向到钱包应用
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:authUrl] options:@{} completionHandler:nil];
} else {
    // 使用openURL函数重定向到钱包应用
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:authUrl]];
}
```

这段代码用于在不同操作系统平台上启动一个URL（authUrl），通常是用于授权或支付的链接，从而将用户从商户应用引导到支付宝或其他钱包应用。在Android中，使用`Intent`启动一个新任务来打开URL；在iOS中，根据系统版本使用`openURL`函数进行重定向。
### 用户体验  
**用户已安装钱包应用**  
在这种情况下，会打开钱包应用。但Dana不支持直接打开钱包应用。  
| 类型 | WAP | WAP-方案 | AL/UL | | | |
| --- | --- | --- | --- | --- | --- | --- |
| 钱包 | Dana | KaKaoPay | GCash | AlipayHK | Touch 'n Go eWallet | TrueMoney Wallet |
| 体验 | 图片 | 图片 | 图片 | 图片 | 图片 | 图片 |
| 优势 | 无 | 如果用户已安装钱包应用，用户会跳出商家应用并重定向到加载钱包WAP页面的中间页面。用户需要点击按钮以重定向到钱包应用完成认证和授权。 | 如果用户已安装钱包应用，用户直接从商家应用重定向到钱包应用。用户在钱包应用中完成授权。 | | | |
| 缺点 | 钱包应用无法打开，因此用户会被重定向到商家应用之外，通过默认浏览器打开的授权页面完成授权，输入账户信息。 | 用户跳出商家应用，重定向到由默认浏览器打开的中间页面。用户需要点击按钮以重定向到钱包应用。 | * 用户被重定向出商家应用。 * 对于Android系统中的一些情况，当AL失效时，可能需要额外的开发，出现弹窗（或称为消歧对话框），让用户选择打开钱包的方式。有关消歧对话框的额外开发详情，请参阅[消歧对话框处理](#AlH2J)。 | | | |  
表4. 已安装钱包应用时的用户体验  
**用户未安装钱包应用**  
在这种情况下，通过默认浏览器打开授权页面或钱包下载页面。为不同钱包提供以下类型的WAP页面之一：
*   WAP钱包下载页面
*   WAP授权页面

以下是每种钱包的两种类型WAP页面的表格：

| **钱包下载页面（WAP）** | | **授权页面（WAP）** | | |
| --- | --- | --- | --- | --- |
| KakaoPay | TrueMoney | AlipayHK | Touch 'n Go eWallet | GCash |
| 图像 | 图像 | 图像 | 图像 | 图像 |

表5. 钱包应用未安装时的用户体验

**注释**：

*   对于每种钱包，用户在不同类型的移动电话、操作系统和用于打开WAP页面的浏览器上下载钱包应用的体验可能不同。例如，用户可能在选择下载钱包应用后被重定向到Google Play应用商店，或者被自动重定向到特定制造商的应用商店。
*   对于AlipayHK，当用户未安装钱包应用时，除Chrome浏览器外的所有浏览器都会打开钱包下载WAP页面。如果用户的默认手机浏览器是Chrome，系统会自动重定向到Google Play下载页面并同时关闭默认浏览器。在这种情况下，用户无法在WAP授权页面上通过输入账户选择发送验证代码。用户体验如下所示：
![](https://yuque.antfin.com/images/lark/0/2021/gif/306732/1632721635959-42dce41f-ef1f-408f-b51a-536d337952a8.gif)
### 解析歧义对话处理  
这部分仅适用于Android系统，并且用户已安装了钱包应用。  
App Links在安装应用时会向Google服务器请求验证。如果验证失败，App Links将变得无效。在这种情况下，当用户通过此类链接打开应用时，会出现一个解析歧义对话框，用户需要手动选择如何打开应用。

**注意**：iOS系统没有解析歧义对话框处理问题。

| 右侧的图像显示了一个解析歧义对话框的示例。这是用户点击地图链接后出现的对话框，用户可以选择在Google Maps或Chrome中打开链接。详细信息请参阅[验证Android App Links](https://developer.android.com/training/app-links/verify-site-associations)。 | 图像 |
| --- | --- |

当出现解析歧义对话框时，用户需要手动选择，这可能影响授权成功率。因此，建议采取以下措施来避免解析歧义对话框的出现：

1. 对于已安装钱包应用的用户，指定钱包的packageName来打开钱包URL。
2. 对于未安装钱包应用的用户，可以使用以下示例代码实现跳出并打开的重定向：

```java
Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(authUrl));
intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
// 设置钱包包名
intent.setPackage(walletPackageName);
PackageManager packageManager = MainActivity.this.getPackageManager();
// 获取可以执行给定意图的所有活动。
List<ResolveInfo> activities = packageManager.queryIntentActivities(intent, 0);
if (activities.size() <= 0) {
    // 钱包应用未安装。重新初始化Intent。使用系统方法打开应用。重定向到默认浏览器。
}
```

这段代码首先创建一个Intent来打开指定的URL，并设置钱包应用的包名。然后，它检查是否有任何活动能够处理这个Intent。如果没有找到，说明钱包应用未安装，因此需要重新初始化Intent，并使用系统默认的方式（通常是浏览器）来打开链接。
```java
Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(authUrl));
intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
if (/* 判断钱包应用是否已安装的条件 */) {
    startActivity(intent);
} else {
    // 钱包应用已安装。通过指定的钱包PackageName打开钱包URL。不会出现歧义对话框。
    intent.setPackage("指定的钱包包名");
    startActivity(intent);
}  
```

**注意**：以下列表显示了每个钱包的packageName值：

*   支付宝中国：`com.eg.android.AlipayGphone`
*   支付宝香港：`hk.alipay.wallet`
*   GCash：`com.globe.gcash.android`
*   TrueMoney：`th.co.truemoney.wallet`
*   KakaoPay：`com.kakao.talk`
*   Touch'n Go：`my.com.tngdigital.ewallet`
*   Dana：`id.dana`

以下表格以Touch'n Go为例，展示了有无歧义对话框的用户体验：

| **用户已安装钱包应用** | | **用户未安装钱包应用** |
| --- | --- | --- |
| 系统方法打开 | 指定钱包包名打开 | 系统方法打开 |
| 图像示例 | 图像示例 | 图像示例 |

表6. 有无歧义对话框的用户体验。
### 中间页面处理  
如果_authUrl_ 的类型是 WAP-Scheme，用户将首先被重定向到由默认浏览器打开的中间页面，然后被转发到钱包应用。以下是一个关于 KakaoPay 的示例：  
| 1. 启动授权 | 2. 重定向到中间页面并加载钱包页面 | 3. 重定向到钱包应用 |
| --- | --- | --- |
| 图像 | 图像 | 图像 |  
表7. KakaoPay 的中间页面  
为了提供更好的用户体验，建议在应用内嵌入的浏览器中首先加载 WAP 页面，然后通过 scheme 将用户重定向到钱包应用，这样用户可以直接被重定向到钱包应用，而无需通过默认浏览器。以下是详细示例代码。  

**在 iOS 应用中**  
以下示例代码展示了如何在 iOS 应用中使用 SFSafariViewController 来加载 WAP 页面：  
```swift
if (@available(iOS 11.0, *)) {
    SFSafariViewControllerConfiguration *configuration =  [[SFSafariViewControllerConfiguration alloc]init];
    configuration.barCollapsingEnabled = NO;
    configuration.entersReaderIfAvailable = NO;
    // 使用 SFSafariViewController 打开 url
    SFSafariViewController *safariVC = [[SFSafariViewController alloc] initWithURL:url configuration:configuration];
    safariVC.delegate = self;
    [self.navigationController presentViewController:safariVC animated:YES completion:nil];
} else {
    SFSafariViewController *safariVC = [[SFSafariViewController alloc] initWithURL:url entersReaderIfAvailable:NO];
    safariVC.delegate = self;
    [self.navigationController presentViewController:safariVC animated:YES completion:nil];
}
```  

**在 Android 应用中**  
以下示例代码展示了如何在 Android 应用的 webview 中重写 shouldOverrideUrlLoading：  
```java
WebView webView = findViewById(R.id.webview);
WebSettings webSettings = webView.getSettings();
// 启用 JavaScript
webSettings.setJavaScriptEnabled(true);
// 启用缩放
webSettings.setSupportZoom(true);
```

请注意，这些代码片段仅作为示例，实际应用中可能需要根据具体需求进行调整。
// 启用缩放控制（按钮）
webSettings.setBuiltInZoomControls(true);
// 2 种缓存模式，用于 WebView（Web 和 WAP）。这里加载无缓存内容。
webSettings.setCacheMode(WebSettings.LOAD_NO_CACHE);
// 允许 JavaScript 自动打开新窗口（默认为 false）。
webSettings.setJavaScriptCanOpenWindowsAutomatically(true);
// 允许 JavaScript 访问本地存储。
webSettings.setDomStorageEnabled(true);
// WAP 缓存大小（无需手动设置）
// webSettings.setAppCacheMaxSize(1024 * 1024 * 8);
// WAP 缓存路径
String absolutePath = getApplicationContext().getCacheDir().getAbsolutePath();
// WAP 缓存大小
webSettings.setAppCachePath(absolutePath);
// 是否允许 WebView 访问文件（默认为 true）
webSettings.setAllowFileAccess(true);
// 启用保存 WAP 缓存
webSettings.setAppCacheEnabled(true);
// 使用概览模式时，如果页面宽度超过 WebView 显示范围，缩放页面以适应 WebView（默认为 false）
webSettings.setLoadWithOverviewMode(true);
// 支持视口 HTML meta 标签
webSettings.setUseWideViewPort(true);
// 加载钱包授权 URL
webView.loadUrl(authUrl);
// 
webView.setWebViewClient(new WebViewClient() {
    @Override
    public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
        if (request.getUrl().toString().startsWith("http")) {
            view.loadUrl(request.getUrl().toString());
            return super.shouldOverrideUrlLoading(view, request);
        }
        Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(request.getUrl().toString()));
        intent.setPackage(packageName);
        PackageManager packageManager = WebViewActivity.this.getPackageManager();
        List<ResolveInfo> activities = packageManager.queryIntentActivities(intent, 0);
        if (activities.size() > 0) {
            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
            WebViewActivity.this.startActivity(intent);
        }
        return true;
    }
});
**用户体验**
在这种情况下，使用 WAP-Scheme 类型的 KakaoPay 默认浏览器打开一个钱包下载 WAP 页面。
| **钱包已安装** | | **钱包未安装** |
| --- | --- | --- |
| 标准解决方案 | 改进的解决方案 | 标准解决方案 |
| 图像 | 图像 | 图像 |
| 商户应用 - 默认浏览器 - 钱包应用 | 商户应用 - 钱包应用 | 商户应用 - 默认浏览器 |
表8. KakaoPay 用户体验  
停留并打开 不推荐
-----------------------------------------------------------
如果商户希望用户在整个授权过程中留在商户应用内，可以通过应用内嵌的浏览器打开授权页面。但这种方法不推荐使用。  
**优点：**  
* 用户在授权过程中不会离开商户应用。
* 对于仅支持WAP授权页面的Dana钱包，此解决方案可以避免用户离开商户应用并跳转到外部浏览器。  
**缺点：**  
* 对于不支持WAP授权页面的钱包，如KakaoPay和TrueMoney，如果商户使用应用内浏览器加载，会打开下载钱包应用的WAP页面，无法完成授权。
* 对于支持WAP授权页面的钱包，如GCash、Touch 'n Go和AlipayHK，授权成功率会降低。在内嵌浏览器中打开钱包后，用户需要在授权页面输入账户，而不是直接打开钱包应用并在钱包应用中确认授权，导致授权成功率下降。  
以下钱包支持此解决方案：  
| **数字钱包** | **支持的钱包** | **备注** |
| --- | --- | --- |
| GCash | ✅ | 内嵌浏览器打开WAP授权页面。 |
| Touch'n Go | ✅ |
| AlipayHK | ✅ |
| TrueMoney | 🔲 | 内嵌浏览器打开下载钱包应用的WAP页面。 |
| KakaoPay | 🔲 |
| Dana | ✅ | 内嵌浏览器打开WAP授权页面。 |
表9. 支持的钱包
### 演示代码  
**在iOS应用中**  
以下示例代码使用WKWebView在iOS应用中加载钱包。  
复制  
```swift
// 初始化webView配置
WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc]init];
// 初始化webView
WKWebView *webView = [[WKWebView alloc]initWithFrame:CGRectMake(0, 0, [UIScreen mainScreen].bounds.size.width, [UIScreen mainScreen].bounds.size.height) configuration:configuration];
webView.navigationDelegate = self;
// 加载钱包授权URL
[webView loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:authUrl]]];
[self.view addSubview:self.webView];
```
**在Android应用中**  
以下示例代码使用WebView在Android应用中加载钱包。  
复制  
```java
WebView webView = findViewById(R.id.webview);
// 设置webView客户端
webView.setWebViewClient(new WebViewClient() {
    @Override
    public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
        view.loadUrl(request.getUrl().toString());
        return super.shouldOverrideUrlLoading(view, request);
    }
});
// 启用JavaScript
WebSettings webSettings = webView.getSettings();
webSettings.setJavaScriptEnabled(true);
// 启用缩放
webSettings.setSupportZoom(true);
// 启用缩放控制（按钮）
webSettings.setBuiltInZoomControls(true);
// WebView的缓存模式（Web和WAP）。这里加载无缓存。
webSettings.setCacheMode(WebSettings.LOAD_NO_CACHE);
// 允许JavaScript自动打开新窗口（默认为false）
webSettings.setJavaScriptCanOpenWindowsAutomatically(true);
// 允许JavaScript加载本地缓存
webSettings.setDomStorageEnabled(true);
// WAP缓存大小（无需手动设置）
// webSettings.setAppCacheMaxSize(1024 * 1024 * 8);
// WAP缓存路径
String absolutePath = getApplicationContext().getCacheDir().getAbsolutePath();
// WAP缓存大小
webSettings.setAppCachePath(absolutePath);
// 是否允许WebView访问文件（默认为true）
webSettings.setAllowFileAccess(true);
// 启用保存WAP缓存
```

这段代码展示了如何在iOS和Android平台上使用相应的WebView组件加载特定的钱包授权URL。在iOS中使用WKWebView，在Android中使用WebView，并配置了相应的设置以支持JavaScript、缩放和缓存管理。
```java
// 启用应用程序缓存
webSettings.setAppCacheEnabled(true);
// 当使用概览模式时，如果页面宽度超过WebView显示范围，缩放页面以适应WebView（默认为false）
webSettings.setLoadWithOverviewMode(true);
// 支持HTML的视口元标签
webSettings.setUseWideViewPort(true);  
// 加载钱包授权URL
webView.loadUrl(authUrl);
```

这段代码是Java语言，用于配置一个WebView的设置。它使得WebView能够启用应用程序缓存，使用概览模式时自动缩放页面以适应WebView的大小，并支持HTML中的视口元标签，最后加载指定的钱包授权URL。
### 用户体验
无论用户是否安装了钱包应用，用户体验保持不变：

| 类型 | authUrl - WAP | authUrl - WAP-Scheme（降级为钱包下载WAP页面） | authUrl - AL/UL（降级为钱包下载WAP页面） | authUrl - AL/UL（降级为WAP授权页面） |
| --- | --- | --- | --- | --- |
| 钱包 | Dana | KakaoPay | TrueMoney | AlipayHK | Touch'n Go | GCash |
| 体验 | 图像 | 图像 | 图像 | 图像 | 图像 | 图像 |
| 优点 | 用户无需重定向即可在商户应用中完成授权。 |
| 缺点 | 无 | 由于监管原因，KakaoPay和TrueMoney不支持WAP授权页面，因此无法将用户重定向到WAP授权页面。 |  | 即使用户已安装钱包应用，仍需输入账户，影响用户体验并降低授权成功率。 |

表10. 用户体验  
具体情况决定
-----------------
商户还可以根据用户是否安装钱包应用来决定如何进行重定向：

*   如果用户已安装钱包应用：使用系统方法调起钱包应用，意味着用户将离开商户应用并打开钱包应用。
*   如果用户未安装钱包应用：使用内置浏览器加载WAP授权页面，意味着用户将留在商户应用内并在商户应用中打开钱包页面。

**优点**
*   高授权成功率。如果用户已安装应用，将被重定向到钱包应用进行授权。
*   更好的用户体验。当用户未安装钱包应用时，可以在商户应用内完成授权。

**缺点**
*   高开发成本。商家需要在配置文件中预先声明钱包方案（对于iOS系统）或应用包名（对于Android系统），以检查用户是否已安装钱包应用。
*   当用户未安装钱包应用时：
    *   对于不支持显示WAP授权页面的钱包，如KakaoPay和TrueMoney，不需要在内嵌浏览器中调用钱包，因为这些钱包不支持WAP授权页面。
    
此解决方案支持以下钱包：

| **数字钱包** | **支持的钱包** | **备注** |
| --- | --- | --- |
| GCash | ✅ | 当用户未安装钱包应用时，会显示WAP授权页面。 |
| Touch'n Go | ✅ |
| AlipayHK | ✅ |
| TrueMoney | 🔲 | 当用户未安装钱包应用时，会显示下载钱包应用的WAP页面。 |
| KakaoPay | 🔲 |
| Dana | 🔲 | 即使用户已安装，也无法调用钱包应用。 |

表11. 支持的钱包
### 演示代码  
**在iOS应用中**  
以下示例代码展示了如何使用_canOpenURL_检查用户是否已安装钱包应用。  
```swift
// 商家在info.plist中预先注册的钱包方案URL。以下以GCash为例。
NSString *walletSchemeUrl = @"gcash://";
// 钱包授权链接 authUrl
NSString *authUrl = @"";

// 使用canOpenURL检查是否已安装钱包应用。
if ([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:walletSchemeUrl]]) {
    // 已安装钱包应用，使用openUrl调用钱包应用。
    if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 10.0) {
        [[UIApplication sharedApplication] openURL:[NSURL URLWithString:authUrl] options:@{} completionHandler:nil];
    } else {
        [[UIApplication sharedApplication] openURL:[NSURL URLWithString:authUrl]];
    }
} else {
    // 未安装钱包应用，使用WebView加载钱包链接。
    WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc]init];
    // 初始化webView
    WKWebView *webView = [[WKWebView alloc]initWithFrame:CGRectMake(0, 0, [UIScreen mainScreen].bounds.size.width, [UIScreen mainScreen].bounds.size.height) configuration:configuration];
    webView.navigationDelegate = self;
    // 加载钱包授权URL
    [webView loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:authUrl]]];
    [self.view addSubview:self.webView];
}
```
**注意**：如果你的应用是在iOS 9.0或之后链接的，你必须在你的app的Info.plist文件中声明传递给此方法的URL方案。更多信息，请参阅[canOpenURL:](https://developer.apple.com/documentation/uikit/uiapplication/1622952-canopenurl?language=objc)。下图展示了该键的添加位置。  
![](https://yuque.antfin.com/images/lark/0/2021/png/306732/1632384261164-d56aab09-0560-4bad-befa-7f9212f7e86e.png)  
图1. 添加LSApplicationQueriesSchemes键
**注意**: 以下列表显示了每个钱包的URL方案:

*   支付宝中国: alipays://
*   支付宝香港: alipayhk://
*   GCash: gcash://
*   TrueMoney: ascendmoney://
*   KakaoPay: kakaotalk://
*   Touch'n Go: tngdwallet://

**在Android应用中**

以下示例代码展示了如何使用`PackageManager`检查用户是否已安装钱包应用。

```java
Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(walletLink));
intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
// 设置钱包包名
intent.setPackage(walletPackageName);
PackageManager packageManager = MainActivity.this.getPackageManager();
List<ResolveInfo> activities = packageManager.queryIntentActivities(intent, 0);
if (activities.size() <= 0) {
    // 钱包应用未安装，使用WebView加载钱包URL。
    WebView webView = findViewById(R.id.webview);
    // 设置WebView客户端
    webView.setWebViewClient(new WebViewClient() {
        @Override
        public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
            view.loadUrl(request.getUrl().toString());
            return super.shouldOverrideUrlLoading(view, request);
        }
    });
    webviewSettings(webView);
    // 加载钱包授权URL
    webView.loadUrl(authUrl);
} else {
    // 钱包应用已安装，使用startActivity重定向到钱包应用。
    startActivity(intent);
}
```

/**
* WebView设置
*
* @param webView
*/
private void webviewSettings(WebView webView) {
    WebSettings webSettings = webView.getSettings();
    // 启用JavaScript
    webSettings.setJavaScriptEnabled(true);
    // 启用缩放
    webSettings.setSupportZoom(true);
    // 启用缩放控制（按钮）
    webSettings.setBuiltInZoomControls(true);
    // WebView的2种缓存模式（网页和WAP）。这里加载无缓存。
    webSettings.setCacheMode(WebSettings.LOAD_NO_CACHE);
    // 允许JavaScript自动打开新窗口（默认为false）。
    webSettings.setJavaScriptCanOpenWindowsAutomatically(true);
    // 允许JavaScript加载本地缓存。
    webSettings.setDomStorageEnabled(true);
}
//WAP缓存大小（无需手动设置）
//webSettings.setAppCacheMaxSize(1024 * 1024 * 8);
//WAP缓存路径
String absolutePath = getApplicationContext().getCacheDir().getAbsolutePath();
//WAP缓存大小
webSettings.setAppCachePath(absolutePath);
//是否允许WebView访问文件（默认为true）
webSettings.setAllowFileAccess(true);
//启用WAP缓存保存
webSettings.setAppCacheEnabled(true);
//在使用概览模式时，如果页面宽度超过WebView显示范围，缩放页面以适应WebView（默认为false）
webSettings.setLoadWithOverviewMode(true);
//启用使用视口HTML元标签
webSettings.setUseWideViewPort(true);

**注意**：如果您的应用针对Android 11或更高版本，并且需要与自动显示之外的应用交互，请在应用的清单文件中添加`<queries>`元素。有关更多信息，请参阅[Android上的包可见性过滤](https://developer.android.com/training/package-visibility)。以下示例以AlipayHK为例：

```xml
<queries>
    <!-- 声明钱包包名 -->
    <package android:name="hk.alipay.wallet"/>
</queries>
```

> **注意**：以下列出了每个钱包的packageName值：
>
> *   AlipayHK: hk.alipay.wallet
> *   GCash: com.globe.gcash.android
> *   TrueMoney: th.co.truemoney.wallet
> *   KakaoPay: com.kakao.talk
> *   Touch'n Go: my.com.tngdigital.ewallet
> *   Dana: id.dana
### 用户体验  
如果用户已经安装了钱包应用，请参阅[跳出并打开 - 用户体验](#Aoql8) 以了解每个钱包的用户体验。如果用户未安装钱包应用，请参阅[停留并打开 - 用户体验](#yzWZz) 以了解每个钱包的用户体验。  
对于提供WAP授权页面的钱包，如GCash、Touch'n Go和AlipayHK，根据用户是否安装了钱包应用，可以使用不同的方法来调用钱包：  
*   如果安装了钱包应用，使用系统方法调用钱包。
*   如果未安装钱包应用，使用内嵌浏览器调用钱包。  
以GCash为例，下表展示了用户体验：  
| **钱包已安装** | **钱包未安装** | |
| --- | --- | --- |
| 通过系统方法打开 | 通过系统方法打开 | 通过webview打开 |
| 图片 | 图片 | 图片 |
| 用户被重定向到钱包应用进行授权。 | 打开默认浏览器加载WAP授权页面。 | 在商户应用中打开webview并加载WAP授权页面。 |  
表12. 用户体验  
要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。  
![图片47](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片48](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 在本页  
[术语和定义](#FZF6N "术语和定义")  
[授权URL](#KZp3g "授权URL")  
[集成方法](#UWtzO "集成方法")  
[跳出并打开](#OG40c "跳出并打开")  
[示例代码](#LxNiG "示例代码")  
[用户体验](#Aoql8 "用户体验")  
[歧义对话框处理](#AlH2J "歧义对话框处理")
**中间页面处理**  
**停留并打开**  
**演示代码**  
```markdown
// 这里将包含示例代码，用于演示如何处理中间页面和保持页面打开状态
```
**用户体验**  
在处理中间页面时，确保用户界面流畅，加载速度快，且用户能够清晰理解页面的作用和下一步操作。

**具体情况判断**  
**演示代码**  
```markdown
// 这里将展示根据具体情况判断如何处理页面的代码示例
```
**用户体验**  
根据用户行为和业务逻辑，动态调整中间页面的展示和交互，以提供更个性化的用户体验。例如，根据用户是否已登录、是否有权限等条件，显示不同的内容或操作选项。