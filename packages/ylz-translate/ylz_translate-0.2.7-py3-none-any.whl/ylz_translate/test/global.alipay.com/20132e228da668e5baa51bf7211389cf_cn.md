支付 | 扫码绑定 | 支付宝文档
===============

[![ 图片 1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)](/docs/) [![ 图片 2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[ 登录 ](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fscantopay_en%2Fpay)  
[ 返回首页 ](../../)  
扫码绑定  
[ 概览 ](/docs/ac/scantopay_en/overview)  
集成指南  
[ 获取授权 ](/docs/ac/scantopay_en/authorization)  
[ 支付 ](/docs/ac/scantopay_en/pay)  
支付后  
[ 对账 ](/docs/ac/scantopay_en/settle_reconcile)  
支付
===

2023-08-31 07:50

在获取买家授权后，您可以直接启动自动扣款服务，无需为每次支付再次进行授权流程。

要完成自动扣款支付，执行以下两个步骤：

1.  发起支付
2.  获取支付结果

步骤 1：发起支付
==========================

如果目标支付方式的余额足以支付买家的订单，您可以调用 [**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API 来发起自动扣款支付。在请求中正确传递以下参数：

*   _productCode_: 传入值 `AGREEMENT_PAYMENT`。
*   _paymentMethod.paymentMethodId_: 使用 [**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 获取的支付令牌 (_accessToken_) 的值。
*   _paymentExpiryTime_: 仅能指定参数限制扣款有效期不超过1分钟。此字段的值必须遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准。如果不指定此字段，自动扣款请求的过期时间是在支付请求发送后1分钟。
*   _paymentNotifyUrl_: 用于接收异步通知的地址，建议提供此参数。
在[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API的响应中，根据\_result.resultStatus\_的值判断扣款是否成功：
*   如果值为`S`，扣款成功。
*   如果值为`U`，交易仍在处理中。您需要使用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API查询交易状态，或等待异步通知获取交易结果。
*   如果值为`F`，扣款失败。您需要根据结果代码进行处理。
如果未能收到响应，建议您使用相同的参数再次调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement) API。
步骤2：获取支付结果
=================
由于网络问题，异步通知可能无法发送或延迟。为了获取准确的支付结果，您必须同时集成异步通知和支付结果查询服务。
1\. 接收异步通知
-----------------
除了通过重定向到支付结果页面来获取支付结果，您还可以在调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 时设置异步通知地址（_paymentNotifyUrl_）。当支付完成或超时时，支付宝会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API 向该地址发送异步通知。

当您收到支付宝的通知时，必须按照[代码示例](https://global.alipay.com/docs/ac/cashierpay/notifications#JtjSl)返回响应。如果未向支付宝返回响应，或者由于网络问题支付宝未接收到响应，支付宝会在24小时内自动重试发送异步通知，最多重试8次，直到收到正确的响应。重试发送间隔为：0秒、2分钟、10分钟、10分钟、1小时、2小时、6小时和15小时。

> **注意**：支付成功后，支付宝会立即发送支付成功的异步通知。支付失败时，支付宝会在支付订单关闭后发送支付失败的异步通知。默认订单超时时间为支付发起后的14分钟。

2. 查询支付状态
------------------

建议您通过调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来查询支付状态。您可以在发起支付请求后且订单未关闭前使用此 API。

在[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 返回的响应中，_paymentStatus_ 字段表示支付状态，具体如下：

| **paymentStatus** | **类型** | **描述** | **处理方式** |
| --- | --- | --- | --- |
| SUCCESS | 最终状态 | 支付成功。 | 可以显示支付成功的页面。 |
| 处理中 | 中间状态 | 支付正在处理中。 | 可以允许买家继续支付。 |
| --- | --- | --- | --- |
| 失败 | 最终状态 | 用户未支付或支付失败。 | 可以允许买家继续支付或关闭支付订单。 |
| 已取消 | 最终状态 | 支付已被您取消。 | 可以允许买家继续支付或关闭支付订单。 |
**表1. _paymentStatus_ 的详细信息**
有关支付状态的详细描述，请参阅[支付状态说明](https://global.alipay.com/docs/ac/cashierpay/payment_status_desc)。
**3. 最佳实践**
为了获取准确的支付结果，建议您在数据库中维护一个订单表，至少包括两个字段：订单号和订单状态。并使用以下方式的异步通知和支付结果查询服务：
*   **异步通知**：监听支付宝的异步通知，并在接收到异步通知时返回响应。然后检查数据库中的订单状态：
    *   如果订单状态为`INIT`，根据异步通知更新订单状态。
    *   如果订单状态不是`INIT`，说明已经通过查询服务获取了最终支付结果并已更新订单状态。无需进一步操作。
*   **支付查询**：查询支付状态。在每次查询之前，需要检查数据库中的订单状态：
    *   如果订单状态为`INIT`，发起查询。如果获取到最终支付结果，更新数据库中的订单状态，否则继续查询过程。
    *   如果订单状态不是`INIT`，说明已经进行了查询过程，获取了最终支付结果并用于更新订单状态。无需进一步操作。
![图片 3](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1619061903693-545f78ce-8cd7-4a54-8a83-763289bf7bbf.png)  
图1. 使用异步通知和支付结果查询服务的最佳实践  
要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。  
![图片 4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![图片 5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 在这个页面上  
[步骤1：发起支付](#SXydg "步骤1：发起支付")  
[步骤2：获取支付结果](#MXtRf "步骤2：获取支付结果")  
[1. 接收异步通知](#nNDuL "1. 接收异步通知")  
[2. 查询支付状态](#Z6H8I "2. 查询支付状态")  
[3. 最佳实践](#lKesn "3. 最佳实践")