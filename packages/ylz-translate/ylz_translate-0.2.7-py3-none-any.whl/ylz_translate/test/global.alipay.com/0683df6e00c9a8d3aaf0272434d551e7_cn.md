获取授权 | 扫码绑定 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fscantopay_en%2Fauthorization)  
[返回首页](../../)  
扫码绑定  
[概述](/docs/ac/scantopay_en/overview)  
集成指南  
[获取授权](/docs/ac/scantopay_en/authorization)  
[支付](/docs/ac/scantopay_en/pay)  
支付后  
[对账](/docs/ac/scantopay_en/settle_reconcile)  
获取授权
====================

2024-04-10 02:48

在进行自动扣款之前，需要获取买家的授权。授权成功后，需要使用授权码获取支付令牌。支付令牌用于执行后续的一键支付，以下情况需要妥善处理令牌：

*   当扫码绑定的支付方式的支付令牌即将过期时，需要刷新支付令牌。
*   如果买家取消授权，需要相应处理支付令牌。

先决条件
=============

开始之前，必须完成以下任务：

*   在[蚂蚁开放平台仪表盘](https://global.alipay.com/docs/dashboard_en)上注册。
*   在蚂蚁开放平台仪表盘上设置密钥。
*   配置接收异步[通知](https://global.alipay.com/docs/ac/scan_to_bind_en/notification)的地址。

详细信息请参阅[集成指南](https://global.alipay.com/docs/integration_guide_en)。

获取授权
========================
为了从买家那里获取授权，需要完成以下集成步骤：

1. 从支付宝获取二维码。
2. 显示二维码。
3. 获取授权码。
4. 申请支付令牌。
5. （可选）刷新支付令牌。

### 步骤1：从支付宝获取二维码

在签署支持所需支付方式的合同后，可以调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API。支付宝会在API响应中返回用于获取买家授权的二维码。二维码的值是`authCodeForm.codeDetails.codeValue`。它会以图片和文本两种形式提供，你可以根据需要选择其中一种。

调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API时，在请求中正确传递以下参数：

*   _authRedirectUrl_：授权完成后，将买家重定向到商户页面的URL。对于扫码绑定支付，授权完成后买家不会被重定向到移动客户端的商户页面。
*   _authState_：由你自己指定的字符串，用于标识一个授权请求。
*   _customerBelongsTo_：指定你请求授权的目标支付方式。
*   _scopes_：传入固定值`AGREEEMENT_PAY`。
*   _terminalType_：表示你的客户端类型，值固定为`WEB`。

### 步骤2：显示二维码

从支付宝获取到二维码值后，如果选择文本，根据文本生成二维码并在你的Web客户端上显示。如果选择图片，直接在Web客户端上渲染图片。买家扫描二维码进行授权。

### 步骤3：获取授权码

买家扫描二维码后，支付宝会返回一个授权码。这个授权码用于后续的支付流程。

接下来的步骤4和5涉及使用授权码申请支付令牌和刷新令牌，这些通常涉及与支付宝服务器的进一步交互，以确保支付的安全和有效性。
在获取买家授权后，你可以从支付宝发送的授权成功通知中获取授权码（_authCode_）。

1. 配置接收授权结果通知的地址。详情请参阅[通知](https://global.alipay.com/docs/ac/cashier_payment_cn/notification#oUAYb)。
2. 买家同意授权后，你会收到支付宝发送的[授权成功通知](https://global.alipay.com/docs/ac/ams/notifyauth)。
3. 收到异步通知后，按照[要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification#OqpVS)返回响应。否则，支付宝会重新发送异步通知。

授权结果可能成功或失败，这两种情况的后续重定向如下：

* **授权成功**：在Web客户端处理重定向到你的授权结果页面。
* **授权失败**：如果买家因授权超时或失败未能同意授权，建议引导买家重新发起授权。通常，如果15分钟后仍未收到授权成功通知，可认为授权失败。

由于授权URL只能使用一次，如果用户授权失败，你需要调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API并提供新的authState值。

步骤4：申请支付Token
----------------------
获取到授权码(_authCode_)后，调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API来获取支付Token(_accessToken_)。
### 获取支付令牌  
在获取授权码（_authCode_）后1分钟内调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 以申请支付令牌（_accessToken_）。否则，授权码（_authCode_）将过期并失效。只有拥有支付令牌（_accessToken_），才能实现对买家账户的自动扣款。  
调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 时，确保在请求中正确传递以下参数：  
*   _grantType_: 传入固定值 `AUTHORIZATION_CODE`。
*   _customerBelongsTo_: 指定你请求授权的支付方式。
*   _authCode_: 传入在[步骤3](#CvOoy)中获取的_authCode_的值。  
以下是一个申请支付令牌的示例请求：  
```json
{
"grantType": "AUTHORIZATION_CODE",
"customerBelongsTo": "GCASH",
"authCode": "d2f60253-ecdc-e9bc-27d1-566970191040"
}
```  
在响应中，你将收到以下关键参数：  
*   _accessToken_: 支付令牌。
*   _accessTokenExpiryTime_: 支付令牌的过期时间。
*   _refreshToken_: 用于刷新当前支付令牌的刷新令牌。
*   _refreshTokenExpiryTime_: 刷新令牌的过期时间。通常，_refreshTokenExpiryTime_ 的值大于 _accessTokenExpiryTime_ 的值，以确保支付方式可用。刷新令牌过期后，你需要从[步骤1](#qGhSj)开始重新获取授权码（_authCode_），然后调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API。  
> **注意**：
>
> *   如果调用 API 后没有收到响应，建议使用相同的参数和参数值重新发送请求。
如果您收到的响应中没有支付令牌（_accessToken_），建议按以下方式处理：

1. 如果_result.resultStatus_的值为`U`，请使用相同的参数和参数值重新发送请求。
2. 如果_result.resultStatus_的值为`F`，请根据结果代码排查问题。如果需要再次调用API获取支付令牌，由于authCode只能使用一次，您需要从步骤1开始重新获取新的授权码（_authCode_），然后调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API。
3. 如果您希望在客户端显示买家用于“扫一扫绑定”的关联账户，可以使用通过[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API响应返回的_userLoginId_值。这个字段的值已经脱敏，可以直接展示。
### 刷新支付令牌  
一旦支付令牌（_accessToken_）过期，就无法再用于扫码绑定支付。因此，您需要在令牌过期前调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 来刷新支付令牌（_accessToken_）。调用此 API 时，需要在请求中传递以下参数：  
*   _grantType_: 传入固定值 `REFRESH_TOKEN`。
*   _customerBelongsTo_: 指定您请求授权的目标支付方式。
*   _refreshToken_: 传入刷新令牌参数（refreshToken）的值。该参数值从先前步骤中用于获取支付令牌的[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 响应中获取。  
以下是一个刷新支付令牌的示例请求：  
```json
{
"grantType": "REFRESH_TOKEN",
"customerBelongsTo": "GCASH",
"refreshToken": "281xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx7811"
}
```
始终使用最新的 _refreshToken_ 值来延长访问令牌的有效期。这是因为某些支付方式在您调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 刷新令牌（在[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 请求中将 _grantType_ 参数设置为 `REFRESH_TOKEN`）时，可能会返回新的 _refreshToken_ 值。  

> **注意**：
>
> *   建议在支付令牌（_accessToken_）过期前至少10天进行刷新，以便支付宝技术支持团队有足够的时间处理。对于支付令牌（_accessToken_）有效期较长的支付方式，如 KakaoPay，也应遵循此规则。
> *   对于支付令牌（_accessToken_）有效期较长的支付方式，如 KakaoPay，可能不会提供 _refreshToken_ 和 _refreshTokenExpiryTime_ 参数。
### 支付令牌生命周期表  
由于不同国家的风险控制要求，支付方式的访问令牌有效期各不相同，最短有效期为一年。以下表格列出了各种支付方式的有效期：

| **支付方式** | **访问令牌有效期** | **可刷新令牌？** | **applyToken API 的响应字段** |
| --- | --- | --- | --- |
| DANA | 10 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| AlipayHK | 至 2038 年 1 月 1 日 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |

表 1. 不同支付方式的访问令牌有效期  
建议您维护一个包含所有支付方式支付令牌（_accessToken_）生命周期信息的表格，以便定期检查即将过期的支付令牌（_accessToken_）并进行刷新。例如：

![图 3: 图像](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673864558983-8d64973b-1fd4-40c1-8270-61f86514c3cf.png)

### 取消授权
当买家希望停用扫码绑定服务时，他们可以在您的客户端或支付方式客户端内取消服务。取消服务的方式决定了您需要采取的行动：

* 如果买家在您的客户端内取消服务，使用 [**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation) API 使支付方式的支付令牌（_accessToken_）失效。在 API 请求中，传递用于发起扫码绑定支付的访问令牌（_accessToken_）。API 调用成功后，支付令牌（_accessToken_）将变得无效。
*   一些支付方式允许用户在支付客户端内取消“扫一扫绑定”服务。在这种情况下，您需要配置接收[授权取消通知](https://global.alipay.com/docs/ac/ams/notifyauth)的地址。当用户在支付客户端内取消“扫一扫绑定”时，您将收到一个[授权取消通知](https://global.alipay.com/docs/ac/ams/notifyauth)。通知会包含被取消的“扫一扫绑定”服务对应的支付令牌（_accessToken_）。以下是一个授权取消的异步通知示例：
    ```
    {
    "authorizationNotifyType": "TOKEN_CANCELED",
    "accessToken": "28100103_20215703001538122119",
    "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success",
    "resultStatus": "S"
    }
    }
    ```
    在接收到异步通知后，按照[要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification#OqpVS)返回响应。否则，支付宝会重新发送异步通知。

*   查看文档的最新更新，请访问[版本更新日志](https://global.alipay.com/docs/releasenotes)。
    
    ![图片4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)
    
*   © 2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)
    
#### 这个页面是否有帮助？
#### 本页内容
[前提条件](#cXNt1 "前提条件")  
[获取授权](#2BiKE "获取授权")  
[步骤1：从支付宝获取二维码](#qGhSj "步骤1：从支付宝获取二维码")  
[步骤2：显示二维码](#ziJ3z "步骤2：显示二维码")  
[步骤3：获取授权码](#CvOoy "步骤3：获取授权码")  
[步骤4：申请支付Token](#rLErG "步骤4：申请支付Token")
**获取支付令牌**

[获取支付令牌](#ECpYN "获取支付令牌")

**刷新支付令牌**

[刷新支付令牌](#tN3SV "刷新支付令牌")

**支付令牌生命周期表**

[支付令牌生命周期表](#HiHdb "支付令牌生命周期表")

**取消授权**

[取消授权](#eNTbh "取消授权")