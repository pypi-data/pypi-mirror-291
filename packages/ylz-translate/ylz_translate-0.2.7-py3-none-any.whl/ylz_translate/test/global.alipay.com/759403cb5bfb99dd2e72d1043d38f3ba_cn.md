银行及钱包支付 | 结账支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fnoncard_payment)  
[返回首页](../../)

结账支付
[概述](/docs/ac/cashierpay/overview)  
接收支付  
支付后操作  
支付方式  
其他资源  
高级功能  
[预前端解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡存储API](/docs/ac/cashierpay/cv)  
[卡存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API/SDK](/docs/ac/cashierpay/mf)  
银行及钱包支付
================================  
2023-12-28 08:32  
本集成指南适用于以下非信用卡支付方式：  
*   支付宝+支付方式
*   钱包
*   手机银行应用
*   银行转账
*   网上银行  

前提条件
=============  
在开始之前，您需要完成以下任务：  
*   在支付宝开发者中心注册。
*   设置您的密钥。
*   在沙箱环境中进行测试。  

详细信息请参考[支付宝集成指南](https://global.alipay.com/docs/integration)。  

用户体验
===============  
以下图表展示了用户在购物网站上支付的流程：  
Web  
WAP  
App  
![图片3：银行及钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673426444201-40b38646-358d-4baf-a0c2-9b8c185f175d.png)  
图1. Web端用户体验  
1.  用户确认订单信息后，点击**下单**进入支付方式页面。
2. 用户选择支付方式，点击**确认支付**，会被重定向到支付方式的中间页面。
3. 在中间页面，用户可以通过登录账户或扫描屏幕上的二维码进行支付。
4. 用户完成支付后，会被重定向到支付结果页面。
**注意**：除了将用户重定向到预建的支付方式中间页面，您还可以将用户重定向到自定义的结账页面，以提供更好的用户体验。有关如何实现自定义页面的更多信息，请参阅[自定义结账解决方案](https://global.alipay.com/docs/ac/cashierpay/custom_checkout?version=v1.37)。
![图片4：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673429429762-cadb251c-1dfe-4018-bbed-0007c5b5d326.png)
图1. WAP用户体验
1. 用户确认订单信息后，点击**下单**进入支付方式页面。
2. 用户选择支付方式，点击**支付**，会调起支付方式的应用或被重定向到应用的移动页面。
3. 用户可以在应用内支付或按照移动页面上的指示进行支付。
4. 用户完成支付后，会被重定向到支付结果页面。
**注意**：除了将用户重定向到预建的支付方式中间页面，您还可以将用户重定向到自定义的结账页面，以提供更好的用户体验。有关如何实现自定义页面的更多信息，请参阅[自定义结账解决方案](https://global.alipay.com/docs/ac/cashierpay/custom_checkout)。
![图片5：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673428498387-0a88b3c7-99e6-47c2-a439-82a4225ae214.png)
图1. App用户体验
1. 用户确认订单信息后，点击**下单**，进入支付方式页面。
2. 用户选择支付方式，并点击**支付**以继续支付流程。
3. 通过调用支付方式的应用或Wap页面来启动支付过程。在支付应用或页面中，用户验证身份并输入支付密码以完成支付。
4. 用户支付完成后，会被重定向到支付结果页面。
**注意**：除了将用户重定向到支付方式的预建中间页面，您还可以将用户重定向到自定义的结账页面，以提供更好的用户体验。关于如何实现自定义页面的更多信息，请参阅[自定义结账解决方案](https://global.alipay.com/docs/ac/cashierpay/custom_checkout)。

**集成过程**
---------------

在集成过程中，您需要专注于开发支付方式页面。该页面有以下功能：

*   **显示可用支付方式**：根据支付金额和用户所在地区等支付信息对支付方式排序。
*   **管理支付状态**：页面显示支付倒计时并监控支付状态，以决定是否重定向用户。
*   **引导用户去结账**：使用支付宝提供的支付继续URL将用户重定向到结账页面。
*   **接收支付回调（可选）**：通过监听页面调用或使用生命周期函数接收支付回调。然后根据支付状态，将用户重定向到支付结果页面。

步骤1：获取并显示可用支付方式
--------------------------------
### 1. 获取支付方式  
您可以调用[**consult**](https://global.alipay.com/docs/ac/ams/consult) API 来获取支付方式列表：  
- 网页版
- 移动网页版
- 应用版

![图片6：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1663905287349-64d473e2-9b72-4f15-9434-cf4b806d98f3.png)  
图2. 网页版支付方式查询  
![图片7：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1663905376929-dab12d28-da6e-4bcd-8d0f-a50b2dbe0d58.png)  
图2. 移动网页版支付方式查询  
![图片8：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1663905595170-0d6c539f-a06d-4980-aa58-7cedcf955f27.png)  
图2. 应用版支付方式查询  

在请求中，您需要指定以下参数：  
| **请求参数** | **是否必需** | **描述** |
| --- | --- | --- |
| paymentAmount | 必需 | 交易的货币和金额。 |
| env | 必需 | 支付所使用的客户端类型，如桌面浏览器、移动浏览器或移动应用。 |
| allowedPspRegions | 可选 | 国家或地区。用于过滤支付方式。 |
| userRegion | 可选 | 用户所在地区。用于排序返回的支付方式。 |  
表1. **consult** API 的请求参数  

发送请求后，支付宝会返回以下参数，通知您支付方式的相关信息：  
| **响应参数** | **描述** |
| --- | --- |
| paymentOptions.paymentMethodType | 您合同中指定的支付方式。 |
| paymentOptions.enabled | 表示支付方式是否可用。 |
| paymentOptions.logo | 支付方式的图标。 |
| paymentOptions.promoNames | 支付方式的促销信息。 |
| 支付方式类别 | 支付方式类型 |
| --- | --- |
| paymentOptions.paymentMethodCategory | 支付方式的类型。 |

| 禁用原因 | 表示支付方式不可用的原因。当 *paymentOptions.enabled* 为 `false` 时，返回此参数。 |
| --- | --- |
| paymentOptions.disableReason | 支付方式不可用的原因。 |

**咨询** API 的响应参数  
结账页面上长长的支付方式列表可能影响用户体验。_paymentMethodCategory_ 用于对支付方式进行分类并在结账页面上展示。详情如下表所示：

| **参数** | **支付方式类型** | **描述** |
| --- | --- | --- |
| paymentMethodCategory | ALIPAY\_PLUS | 支付宝+支付方式。 |
| WALLET | 电子钱包。 |
| BANK\_TRANSFER | 银行转账。允许用户通过银行应用或柜台使用参考代码支付。 |
| ONLINE\_BANKING | 在线银行。用户通过身份验证后在银行网站上支付。 |
| MOBILE\_BANKING\_APP | 移动银行应用。用户通过身份验证后在银行应用中支付。如果 *terminalType* 为 `WEB`，则不返回此值。 |

**paymentMethodCategory 参数描述**
### 2. 过滤支付方式  
在显示从支付宝获取的支付方式之前，建议根据以下条件过滤支付方式，以避免支付失败：

*   **支付方式是否可用**：调用[**consult**](https://global.alipay.com/docs/ac/ams/consult) API 或联系支付宝技术支持，了解可用的支付方式。
*   **最低支付金额**：关于每种支付方式的最低支付金额，需联系支付宝技术支持获取。
*   **最高支付金额**：关于每种支付方式的最高支付金额，也需联系支付宝技术支持。这可能受到用户设置的支付限额影响。即使支付方式的最高金额未达到，也可能因为用户的设置导致支付失败。

> **注意**：建议不显示或灰显不可用的支付方式。
### 3. 显示支付方式  
为了防止显示过长的支付方式列表，我们建议您使用多级菜单来提供更好的用户体验。具体来说，您可以将支付方式折叠在支付方式类型的菜单中。当用户点击或触摸支付方式类型后，显示相应的支付方式。同时，为了提高支付成功率，您还可以根据支付成功率、促销活动和用户偏好对支付方式进行排序。  

对于Alipay+支付方式，您必须以以下方式之一显示Alipay+合作伙伴的标志。确保每个支付方式的名称和标志使用正确：  

**Web**  
**WAP**  
**App**  
![图片9：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673513837096-8a2e36cc-4774-403e-a39f-625d8f6c5a91.png)  
图3. Web端支付方式的显示  
![图片10：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673514050377-54840abc-5c4d-4b5d-b92b-cd1d3e2573f2.png)  
图3. WAP端支付方式的显示  
![图片11：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673514050377-54840abc-5c4d-4b5d-b92b-cd1d3e2573f2.png)  
图3. App端支付方式的显示
### 4. 收集或显示额外信息  
对于某些支付方式，需要从用户那里获取额外信息以完成支付，或者需要显示关于支付方式的特定信息。建议您在自己的页面上收集这些信息，或显示支付方式所需的信息，以减少重定向，从而提高支付成功率。详情如下：

*   **从用户收集额外信息**：某些支付方式需要支付的额外信息。您可以在您的页面上提供一个输入框来收集这些信息，并通过调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 将信息传递给支付宝。如果您不提供输入框，支付宝会提供一个额外的页面来收集信息。
> **注意**：您必须通过[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 传递收集到的信息，以防止支付宝再次收集信息。

*   **显示支付方式的额外信息**：对于某些支付方式，您可以在支付方式选择页面上显示支持的银行，让用户进行选择。如果您不显示银行选项，用户在您的支付方式选择页面选择支付方式后，会被重定向到特定支付方式的页面来选择可用银行。

以下表格列出了需要额外信息的支付方式，以及默认方案和推荐方案的用户体验：

| **支付方式** | **BLIK** | **Przelewy24** | **iDEAL** | **Mercado Pago（巴西）** | **Mercado Pago（巴西、墨西哥、智利、秘鲁）** |
| --- | --- | --- | --- | --- | --- |
| **参数** | blikCode, clientIp, userAgent | payerEmail | bankIdentifierCode | cpf | payerEmail |
| **参数描述** | 六位动态PIN码，IP地址，用于标识用户设备环境**注意**：* 收集*blikCode*时，同时收集*clientIp*和*userAgent*信息。* IP地址不能设置为本地IP。 | 用户的电子邮件 | 银行的标识代码 | 巴西个人纳税人的税号 | 收款人的电子邮件地址 |
| --- | --- | --- | --- | --- | --- |
| **请求示例** | *blikCode*请求示例：```"paymentMethod": {    "paymentMethodType": "BLIK",    "paymentMethodMetaData": {        "blikCode": "123456"    }}```*clientIp*和*userAgent*请求示例：```"env": {    "terminalType": "WEB",    "clientIp": "1.178.216.0",    "userAgent": "Mozilla/5.0"}``` | *P24*请求示例：```"paymentMethod": {    "paymentMethodType": "P24",    "paymentMethodMetaData": {        "payerEmail": "123456@alipay.com"    }}``` | *IDEAL*请求示例：```"paymentMethod": {    "paymentMethodType": "IDEAL",    "paymentMethodMetaData": {        "bankIdentifierCode": "ABNANL2A"    }}``` | *MERCADOPAGO_BR*请求示例：```"paymentMethod": {    "paymentMethodType": "MERCADOPAGO_BR",    "paymentMethodMetaData": {        "cpf": "0298765XXXX"    }}``` | *MERCADOPAGO_MX*请求示例：```"paymentMethod": {    "paymentMethodType": "MERCADOPAGO_MX",    "paymentMethodMetaData": {        "payerEmail": "email@example.com"    }}``` |
| **用户体验（默认方案）** | Alipay收集BLIK动态码：<image> | Alipay收集用户电子邮件：<image> | iDEAL显示特定银行：<image> | Mercado Pago收集用户cpf信息：<image> | Mercado Pago收集用户电子邮件：<image> |
| **用户体验（推荐方案）** | 您收集BLIK动态码：<image> | 您收集用户电子邮件：<image> | 您显示特定银行：<image> | 您收集用户cpf信息：<image> | 您收集用户电子邮件：<image> |
**表4. 收集或显示额外信息的参数描述和用户体验**
步骤2：获取支付继续URL并调用支付流程
### 1. 拦截无效支付  
为了避免重复支付或支付过期，建议用户点击或触摸“支付”后，您检查支付的状态和有效期。  
**Web**  
**WAP**  
**App**  
![图片22：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1677222520472-bfe8a69c-9973-42ac-a46a-ae17eb7f4aac.png)  
图4. Web支付状态验证  
![图片23：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1677222684761-e192acd3-35a9-4c19-8796-c469ff0f5170.png)  
图4. WAP支付状态验证  
![图片24：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1677222768201-6bf027dc-5182-4392-8083-2d51a9e59002.png)  
图4. App支付状态验证  
为了拦截过期支付，您可以在支付请求中设置`paymentExpiryTime`参数来设定支付有效期。如果用户在支付有效期后付款，系统会报告错误或自动退款。设置支付有效期还可以防止用户在被重定向到支付页面后长时间未支付而产生的重复支付问题。  
服务器的时间偏移也可能导致重复支付。建议用户支付后，您检查订单的支付状态。如果订单之前已支付，您可以调用[**cancel**](https://global.alipay.com/docs/ac/ams/paymentc_online) API取消支付，或调用[**refund**](https://global.alipay.com/docs/ac/ams/refund_online) API向用户全额退款，并相应地提示用户。
### 2. 发起支付请求并获取支付继续URL  
当用户点击或触摸“确认支付”后，客户端应向服务器请求支付继续URL，然后服务器调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 获取支付继续URL，并将其返回给客户端。在发送请求获取支付继续URL期间，应将“确认支付”按钮灰显，以防用户重复操作。  

如果客户端向服务器请求支付继续URL时支付失败，服务器可以调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 使用新的_paymentRequestId_ 重新发起支付请求。然而，由于网络问题，重试请求可能再次失败。建议为请求设置过期时间，避免用户等待，并在服务器无法获取支付继续URL时让用户能够重新支付。遵循以下流程图所示的工作流程：  

**Web**  
**WAP**  
**App**  
![图片25：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673852829776-a868180c-6f42-4ee7-a881-a37ae56d4fbd.png)  
图5. 获取Web支付继续URL  
![图片26：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673852574668-e6643b67-1980-46b2-af21-1bf9951a9630.png)  
图5. 获取WAP支付继续URL  
![图片27：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673853211722-f0dc8646-c643-4359-aeea-6411b69ebc9b.png)  
图5. 获取App支付继续URL  

在请求中，您需要指定以下参数。详细信息请参阅[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API：  
| **参数名称** | **描述** |
| --- | --- |
| 支付请求ID | 标识一个请求的独特标识符。 |
| 环境 | 根据客户端类型指定*终端类型*：* 网页：将*终端类型*设为WEB。 * 移动网页：将*终端类型*设为WAP，并指定*操作系统类型*。 * 应用：将*终端类型*设为APP，并指定*操作系统类型*。 |
| 参考订单ID/支付请求ID | *参考订单ID*通常指的是订单号，而*支付请求ID*通常指的是交易号。支付宝允许一个订单号对应多个交易号，也可以建立一对一的对应关系。 |
| 支付重定向URL | 网页：提供桌面网站的重定向URL。 * 移动网页：提供网页的重定向URL。 * 应用：提供深度链接URL。 |
| 支付通知URL | 将*支付通知URL*设为HTTPS URL。 |
表5. pay API的关键请求参数
### 3. 调起支付流程  
在调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 时，根据指定的 _terminalType_ 值，支付宝会返回以下URLs：
*   normalUrl
*   orderCodeForm
*   schemeUrl
*   applinkUrl  
不同终端类型的URL返回类型，请参考[支付重定向URL](https://global.alipay.com/docs/ac/cashierpay/urls)。对于在应用中调起支付的URL，请参阅[移动支付重定向URL](https://global.alipay.com/docs/ac/cashierpay/redirection)。  
支付宝返回以下参数以调起支付流程：

**Web**  
**WAP**  
**App**  

| **响应参数** | **描述** | **使用** |
| --- | --- | --- |
| normalUrl | 移动支付继续URL | 移动支付继续的URL。用户会被重定向到网页URL或在新标签页中打开URL以完成支付。 |
| orderCodeForm.codeDetails.codeValue | 支付代码值 | 支付二维码或支付密码。对于某些支付方式，可以在自己的页面上显示二维码或密码，而不是将用户重定向到支付方式提供的结账页面，从而减少重定向次数，提升支付体验。 |

**表6. 调起支付流程的响应参数**  
对于使用不同支付方式的支付，我们建议如下使用 _codeValue_：

| **支付方式** | **codeValue** | **处理方式** |
| --- | --- | --- |
| AlipayHK, TrueMoney, Touch 'n Go, AlipayCN, GCash, KaKaoPay, Rabbit LINE Pay, Akulaku PayLater, Dolfin, GrabPay, Naver Pay | 二维码 (*displayType* = `SMALLIMAGE`/`MIDDLEIMAGE`/`BIGIMAGE`) | 可以在页面上显示二维码，无需将用户重定向到支付方式的结账页面。 |
| 银行转账支付方式 | * 支付密码（*displayType* = `TEXT`） * 二维码（*displayType* = `SMALLIMAGE`/`MIDDLEIMAGE`/`BIGIMAGE`） | 您可以在页面上显示二维码、支付密码或两者（如果都返回），而无需将用户重定向到支付方法的结账页面。 |  
表7. 不同支付方式的_codeValue_ 处理  
对于在桌面网站上发起的支付，需要将用户重定向到重定向URL或在新标签页中打开URL。  
![图片28：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673869978097-1d7592dc-9377-4eae-bccc-60a6bdbb8663.png)  
图6. 桌面网站支付的结账体验  
**注意事项**：  
*   调用支付流程时，使用try-catch语句捕获错误并相应地提示用户。在集成项目上线前进行完整性验收。
*   某些支付方法的重定向URL只能打开一次。如果未能调用结账页面，请使用新的_paymentRequestId_ 重新发送请求以获取重定向URL并再次调用页面。
*   对于银行转账支付方式和某些钱包支付方式，您可以按照常规方式通过_normalURL_ 将用户重定向到结账页面。或者您也可以在您的页面上显示通过_codeValue_ 获取的二维码和支付密码。  
| **响应参数** | **描述** | **用法** |
| --- | --- | --- |
| normalUrl | 移动支付继续URL | 移动支付继续的URL。用户被重定向到网页URL或在新标签页中打开以完成支付。 |
| appUrl | 应用链接或通用链接。可以在WebView中加载为网页URL。 | 可以调起支付方式应用，也可以作为网页URL打开。 |
| schemeUrl | 深度链接 | 用于调起支付方式应用。这种URL由移动银行应用支付方法提供。 |
表6. 调用支付流程的响应参数  
为了确保能够调用支付流程，建议您按照以下方式打开URL：  
复制  
//您可以按照以下方式将用户重定向到URL。
window.location.href = URL;
//您可以按照以下方式调用应用程序。
if (response.schemeUrl) {
window.location.href = response.schemeUrl;
} else if (response.applinkUrl) {
window.location.href = response.applinkUrl;
}  
对于在网页URL上发起的支付，需要将用户重定向到重定向URL或在新标签页中打开URL。  
![图片29：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673937799239-fa70e328-566b-4ec3-8615-b631f652999d.png)  
图6. 移动网站支付的结账体验  
**注意事项**：  
*   调用支付流程时，使用try-catch语句捕获错误并相应地提示用户。在集成项目上线前进行完整性验收。
*   若某些支付方式的重定向URL只能打开一次，如果未能调起结账页面，请使用新的_paymentRequestId_重新发送请求以获取重定向URL并再次调起页面。
*   对于银行转账支付方式和某些钱包支付方式，您可以按照常规做法通过_normalURL_将用户重定向到结账页面。或者您也可以在您的页面上显示通过_codeValue_获取的二维码和支付密码。  

| **响应参数** | **描述** | **使用** |
| --- | --- | --- |
| appIdentifier | 支付方式的包名。 | 用于确定是否已安装支付方式应用，以便在应用内进行支付，而不是显示解决歧义对话框。 |
| applinkUrl | App Link或Universal Link。可以在WebView中加载为网页URL。 | 用于调用支付方式应用，也可作为网页URL打开。 |
| schemeUrl | 深度链接 | 用于调起支付方式应用，让用户完成支付。 |
| normalUrl | 移动支付继续URL | 用户完成支付的移动支付继续URL。 |
  
**表6. 调起支付流程的响应参数**

对于应用内的支付，需要了解处理支付宝返回URL的以下三种方式：

| **处理方式** | **描述** |
| --- | --- |
| 调起支付方式应用支付 | 从你的应用中调起支付方式应用进行支付。 |
| 在WebView中加载URL支付 | 在你的应用中使用WebView加载URL进行支付。 |
| 在默认浏览器中加载URL支付 | 从你的应用中重定向用户到网页URL进行支付。 |

**表7. 应用内支付的URL处理方式**

某些支付方式，如银行支付方式，仅支持在网页URL上支付，而其他支付方式仅支持在支付方式应用内支付。因此，支付场景分为以下五种类型：

![图片30：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673941800566-511286f2-e4b5-4677-9e41-28915f455e77.png)

**图6. 移动应用支付的用户体验**

*   **支付方式应用支付**：用户选择支付方式后，通过_schemeURL_或_applinkURL_调起的支付方式应用中完成支付。
*   **WebView中的网页URL支付**：用户选择支付方式后，在你的应用中通过WebView加载的_normalUrl_或_applinkUrl_上的网页URL完成支付。
*   **WebView中的支付方式应用支付**：用户选择支付方式后，首先重定向到应用内的中间页面，然后通过_normalUrl_或_applinkUrl_调起支付方式应用完成支付。
*   **默认浏览器中的Web URL支付**：用户选择支付方式后，通过_normalUrl_或_applinkUrl_加载的网页URL进行支付。
*   **默认浏览器中的支付方式应用支付**：用户选择支付方式后，首先在默认浏览器中重定向到一个中间页面，然后通过_normalUrl_或_applinkUrl_调用的支付方式应用中完成支付。
建议预先配置针对不同支付方式的路由，或者根据实际使用的支付方式、返回的URL以及用于打开URL的客户端进行路由配置：
![图片31: 图像](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673947321273-d7cc838a-3420-4993-ba6a-bccd28d4a4d0.png)  
![图片32: 图像](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1673948488869-8c1f9c33-91bd-4578-964e-ecf0e8cabbd3.png)  
图7. 支付流程调用方案  
**注意**：
>
> *   调用支付流程时，使用try-catch语句捕获错误并适当地提示用户。在集成项目上线前进行完整性验收。
> *   若某些支付方式的支付继续URL只能打开一次，如果未能调起支付页面，使用新的_paymentRequestId_重新发送请求以获取支付继续URL并再次调起页面。  
步骤3：获取支付结果
----------------------
### 1. 重定向到结果页面  
您可以通过在 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中设置 _paymentRedirectUrl_ 来指定支付完成后跳转的 URL。  
*   对于在桌面浏览器中发起的支付，建议传递一个网页 URL。
*   对于在移动浏览器中发起的支付，建议传递一个深度链接。
*   对于在应用中发起的支付，必须传递一个深度链接。  
对于在桌面浏览器中发起的支付，用户完成支付后，首先会被重定向到支付宝的支付结果页面，然后在短暂倒计时后跳转到支付继续的 URL。对于在移动设备上发起的支付，用户完成支付后，会被重定向到支付方式的首页。  
> **注意**：由于网络问题或用户操作不当，重定向可能会失败。
>
> *   对于在桌面或移动浏览器中发起的支付，如果网页 URL 在新标签页中打开，建议您在自己的页面上监控支付状态，以确保支付流程顺畅。
> *   对于在应用中发起的支付，如果网页 URL 在默认浏览器中加载，支付可能会因手机型号而失败。此时，浏览器会弹出对话框询问用户是否启动您的应用，用户可能选择 **否** 并手动打开您的应用。因此，建议您监控支付结果页面的调用以及用户手动打开应用的行为。  
对于在不同客户端发起的支付，用户完成支付后，将通过以下方式重定向：  
- 网页
- 移动网页（WAP）
- 应用（APP）  
![图片 33：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1674010269547-28fca833-5202-4f55-be2b-7ddee9896858.png)  
图 8. 重定向到支付结果页面
**图8. 跳转至支付结果页面**

在完成银行相关或钱包支付后，用户将被重定向到支付结果页面。这个页面显示了支付是否成功，以及相关的交易详情。第一张图片和第二张图片都展示了这一过程，尽管图片相同，但它们强调了支付完成后用户界面的关键部分，即确认支付状态和交易信息。在实际操作中，这个页面可能还包括订单号、支付金额、时间戳等详细信息，以便用户跟踪和核实他们的交易。
### 2. 获取异步通知  
除了通过重定向到支付结果页面来获取支付结果，您还可以在[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中设置异步通知地址（_paymentNotifyUrl_）。当支付完成或超时时，支付宝会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API 向该地址发送异步通知。  

当您接收到支付宝的通知时，必须按照[代码示例](https://global.alipay.com/docs/ac/cashierpay/notifications#JtjSl)返回响应。如果您没有向支付宝返回响应，或者由于网络问题支付宝未接收到响应，支付宝会在24小时内自动重试发送异步通知，最多重试8次，直到收到正确的响应。发送间隔如下：0秒，2分钟，10分钟，10分钟，1小时，2小时，6小时，15小时。  

> **注意事项**：
>
> *   通常，支付成功后，支付宝会立即发送支付成功的异步通知。支付失败时，支付宝会在支付订单关闭后发送支付失败的异步通知。默认订单超时时间为支付发起后的14分钟。
> *   对于Sofort支付方式，当用户完成支付后，支付状态首先变为`PENDING`，支付宝通过_paymentNotifyUrl_发送支付处理中的异步通知。Sofort确认支付结果（通常需要1-3天，最多7天）后，支付状态将变为`SUCCESS`或`FAIL`，支付宝会再次通过_paymentNotifyUrl_发送支付成功或失败的异步通知。
*   对于泰国的银行转账支付方式，默认订单有效期为支付发起后的48小时。因此，如果支付失败，支付宝最迟会在支付开始后的48小时内发送异步通知给您。
*   对于巴西、墨西哥、智利和秘鲁的Mercado Pago支付方式，默认订单有效期为支付发起后的七天。因此，如果支付失败，支付宝最迟会在支付开始后的七天内发送异步通知给您。
*   对于日本的LINE Pay支付方式，默认订单有效期为支付发起后的20分钟。因此，如果支付失败，支付宝最迟会在支付开始后的20分钟内发送异步通知给您。
*   对于日本的Pay-easy和Konbini支付方式，默认订单有效期为支付发起后的七天。因此，如果支付失败，支付宝最迟会在支付开始后的七天内发送异步通知给您。
### 3. 查询支付状态  
异步通知和同步重定向都可能无法接收到或执行成功。原因如下表所示：

|  | **原因** | | **处理** |
| --- | --- | --- | --- |
| **异步通知** | 由于网络问题无法接收到通知。 | | 支付宝会自动重发通知。 |
| **同步重定向** | Web/WAP | App |  |
| * 网络问题导致重定向失败。 * 用户完成支付后手动关闭浏览器。 | * 支付方式不支持重定向。 * 支付方式应用或您的应用崩溃。 * 弹出询问是否打开应用的对话框，用户点击**否**。 * 用户完成支付后手动关闭应用或让应用在后台运行。 |

表8. 无法获取支付结果的原因

建议您通过调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来查询支付状态。您可以在以下场景中使用此 API：

- Web & WAP
- App

**在调起支付结果页之前**：当在支付方式页面发起支付时，可以自动触发调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 进行后续重定向。

**当用户查询支付结果**：当用户在您的页面上点击或点击**我已经支付**或具有相同含义的按钮时，可以调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来检查支付状态。

**当支付超时**：当支付达到超时时，可以调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来检查支付状态。
**在调起支付结果页之前及用户手动打开你的应用时**: 当支付在支付方式的 app 或页面启动时，你可以自动调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 以实现后续的重定向。

**用户查询支付结果时**: 当用户在你的应用中点击“已支付”或具有相同含义的按钮时，你可以调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来检查支付状态。

**支付超时时**: 当支付达到超时时间，你可以调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来检查支付状态。

在通过 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 返回的响应中，_paymentStatus_ 指示支付状态。详情如下表所示：

| **paymentStatus** | **类型** | **描述** | **处理方式** |
| --- | --- | --- | --- |
| SUCCESS | 最终状态 | 支付成功。 | 可以显示支付成功页面。 |
| PROCESSING | 中间状态 | 支付正在处理中。 | 可以让用户继续支付。 |
| PENDING | 中间状态 | 用户完成支付，等待支付方式提供者确认支付状态。 | 可以提示用户支付状态需要由支付方式提供者确认。 |
| FAIL | 最终状态 | 用户未支付或支付失败。 | 可以让用户继续支付或关闭支付订单。 |
| CANCELLED | 最终状态 | 支付被你取消。 | 可以让用户继续支付或关闭支付订单。 |

**表9. paymentStatus 的详细说明**

关于支付状态的详细描述，请参阅 [支付状态描述](https://global.alipay.com/docs/ac/cashierpay/payment_status_desc)。
我们建议您在服务器端维护支付状态，客户端根据服务器提供的信息进行支付流程。处理逻辑如下图所示：

**Web、WAP、APP**

![图片36：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1674041174636-e77aa0ef-58d6-4bde-b289-512d82e3d9a3.png)

**图9. 根据支付状态的处理逻辑**

![图片37：25aaed494904e91da72ddd8639353c50.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1683705066430-8a719a33-98b4-417a-a8e1-708e1597e5ce.png)

**图9. 根据支付状态的处理逻辑**

![图片38：银行相关和钱包支付](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1674042049985-dcfff237-a2e8-4a59-9019-2e9e70aa4c12.png)

**图9. 根据支付状态的处理逻辑**

要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。

![图片39](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片40](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面是否有帮助？

#### 本页面内容

[前提条件](#cXNt1 "前提条件")  
[用户体验](#wZXRY "用户体验")  
[集成过程](#L8XEk "集成过程")  
[步骤1：获取并显示可用支付方式](#GJ2Qc "步骤1：获取并显示可用支付方式")  
[1. 获取支付方式](#ngWo9 "1. 获取支付方式")  
[2. 过滤支付方式](#rFruV "2. 过滤支付方式")  
[3. 显示支付方式](#pIZTg "3. 显示支付方式")  
[4. 收集或显示额外信息](#fCDj2 "4. 收集或显示额外信息")
**步骤2：获取支付继续URL并启动支付流程**

1. **拦截无效支付**
   在用户尝试支付但出现问题时，需要捕获并处理无效的支付请求。

2. **发送支付请求并获取支付继续URL**
   向支付服务发送请求，以获取一个用于继续支付过程的URL。

3. **启动支付过程**
   使用获取到的支付继续URL，引导用户进入支付流程。

**步骤3：获取支付结果**

1. **重定向到结果页面**
   支付完成后，将用户重定向到你的应用或网站上的支付结果页面。

2. **接收异步通知**
   通过后台接收支付服务发送的异步通知，以获取实时的支付状态更新。

3. **查询支付状态**
   如果需要进一步确认，可以通过调用支付服务的API来查询支付的具体状态。