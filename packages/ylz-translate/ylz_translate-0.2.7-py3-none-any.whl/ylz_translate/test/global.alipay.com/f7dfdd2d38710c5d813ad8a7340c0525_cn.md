整合 | 电子票务 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Ftickets%2Fticketintegration)  
[返回首页](../../)

电子票务
----------------

[简介](/docs/ac/tickets/ticketintroduction)  
[整合](/docs/ac/tickets/ticketintegration)  
[API 列表](/docs/ac/tickets/ticketapi)  

整合
==========

2021-03-04 02:38

以下部分解释如何设计你的系统并集成支付宝。

系统架构
------------

实现支付宝电子票务购买解决方案通常需要两个模块：前端和后端。每个模块包含几个负责相应服务的功能。

你可以参考以下示例来设计整个解决方案架构，但你的系统不必完全相同：

![图片3：ticketarchi2.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1587541815807-71b0918c-a468-4599-adc8-894dc58cd582.png)

**前端：** 建议的前端设计有两种实现方式。

1. **集成方案：** 采用EFT POS（销售点电子资金转账）和Cashier POS（收银员销售点）。
2. **独立方案：** 仅采用mPOS（移动销售点）。

上述任何解决方案都可以完成获取交易信息的任务，这些信息由后端服务器用于构建支付请求并提交给支付宝网关。
**后端：** 后端由一个伙伴服务器组成，负责处理交易生命周期，包括交易支付、交易取消、交易退款和对账。伙伴服务器还可以提供与景点系统的深度集成，以实现如订票、电子票务等增强功能。

**支付宝可以提供以下模块的技术支持：** 在整个购票流程中，支付宝扮演处理支付请求并返回同步响应的角色。

**与支付宝的集成：**
在集成之前，您需要创建一个支付宝账户和一个支付宝应用。此外，还需要配置开发环境和密钥。在正式上线前，您可以使用沙箱环境进行集成测试。以下内容提供了一些集成过程中的关键信息。如需了解更多集成详情，请联系全球商户技术支持：[overseas_support@service.alibaba.com](mailto:overseas_support@service.alibaba.com)。
### 准备密钥  
生成数字签名通常需要一个密钥来签署数据。您必须准备MD5私钥，或者RSA/RSA2的私钥和公钥对，以便生成和验证数字签名。
### 实现API接口

为了与支付宝系统集成以提供特定服务，可以通过向支付宝发送HTTP/HTTPS请求调用支付宝API，并在发送请求前使用密钥对请求进行签名。以下序列图概述了商家、机构和支付宝如何通过相互集成其系统来协同工作：

![图片4：Tickets.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1596510889341-ce2fccd3-2361-4da0-a48a-dc5fc12833a2.png)

**离线模式**：

1. 顾客下单并看到支付提示屏幕。
2. 顾客展示条形码，由扫描器扫描以完成支付。
3. 电子收银机（ECR）/销售点（POS）/App调用合作伙伴API，然后合作伙伴调用支付宝支付API。当支付过程返回结果码为`SUCCESS`或`FAILED`时，返回支付结果。
4. ECR/POS/App完成支付并生成收据。
5. 顾客收到收据。

**离线转在线模式**：

1. 顾客下单并看到支付提示屏幕。
2. 顾客展示条形码，由扫描器扫描以完成支付。
3. ECR/POS/App调用合作伙伴API，然后合作伙伴调用支付宝支付API。当支付过程返回结果码为`UNKNOWN`或`TIMEOUT`时，需要调用查询API来检查支付结果。如果支付成功，成功结果将返回给ECR/POS/App并生成收据；如果支付失败，可以调用取消API来取消交易。

**支付过程**

顾客的支付条形码被扫描后，会提交支付请求。使用的API是：[**alipay.acquire.overseas.spot.pay**](https://global.alipay.com/doc/global/spot_pay)（海外即时支付接口）
### 在沙箱环境中测试
沙箱是一个环境，允许您模拟生产环境的特性，并在应用程序上线前对所有依赖的API创建模拟响应。您可以根据自己的需求进行API测试，包括发起交易、取消交易或退款交易等。
### 正式上线
当您在沙箱环境中完成测试并准备正式上线时，可以通过更换网关、PID和密钥为实际值来切换到生产环境。

#### 注意事项
1. 为了确保支付宝解决方案的正确实施，强烈建议使用iValidate工具进行测试和验证您的实现。以下图形显示了由iValidate工具生成的验证结果：
   ![图片5：note.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1587541816224-b54ceb0b-d0f0-4c60-b6f5-1b1bffbea101.png)
2. 在某些情况下，支付宝应用程序用户可能需要输入支付PIN来完成交易。交易流程需要添加相关逻辑来处理此类事件。在对支付宝请求的响应中，可能会返回两种状态类型：

| **返回参数** | **描述** |
| --- | --- |
| `<is_success>T` | 请求结果为接受(`T`)或拒绝(`F`) |
| `<result_code>SUCCESS` | 使用`SUCCESS`、`FAILED`或`UNKNOW`描述请求的响应状态 |

对于支付请求，如果返回的`<result_code>`为`UNKNOW`，您需要发送查询请求来获取特定交易的状态，并检查返回的`<alipay_trans_status>`参数。如果返回的结果是`WAIT_BUYER_PAY`，这表示交易正在等待支付宝应用用户输入支付PIN来完成。由于难以预测用户输入PIN的时间，因此您需要持续调用查询API，直到在`<Alipay_trans_status>`中得到`TRADE_SUCCESS`的结果。
执行查询以确认支付交易状态是关键操作。建议在发送`spot.pay`请求后3到4秒开始发送查询请求，每次查询之间间隔3到4秒，直到收到非`WAIT_BUYER_PAY`的结果，或者交易超时。

如果整个过程达到您设定的超时时间，应发送取消请求。

### 异常处理

所有API请求都具有重试机制。当收到`SYSTEM_ERROR`响应时，可以重新提交请求。

例如，如果交易超时，触发取消API但收到`SYSTEM_ERROR`响应，那么需要再次提交取消请求。如果错误持续，应将交易纳入系统进行人工干预。

要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。

![图片6](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片7](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

- [系统架构](#6e35d18f "系统架构")
- [集成支付宝](#2dcdb0ad "集成支付宝")
- [准备密钥](#593eaf6b "准备密钥")
- [实现API](#b5b168ba "实现API")
- [在沙箱环境测试](#2480d56a "在沙箱环境测试")
- [上线](#c41c7a16 "上线")
- [注意事项](#Notes "注意事项")
- [异常处理](#8fe3bb19 "异常处理")