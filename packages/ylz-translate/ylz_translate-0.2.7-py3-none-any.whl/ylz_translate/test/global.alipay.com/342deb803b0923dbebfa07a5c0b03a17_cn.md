支付卡功能 | 结账支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fmf)  
[返回首页](../../)  

结账支付
[概述](/docs/ac/cashierpay/overview)  
接收支付  
支付后处理  
支付方式  
其他资源  
高级功能  
[预前台解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡存储API](/docs/ac/cashierpay/cv)  
[卡存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API SDK](/docs/ac/cashierpay/mf)  
卡支付功能
=====================  
2024-05-22 07:39  
在发起授权支付时，您可以根据服务需求选择是否使用更多功能。本主题将解释这些附加功能及其使用方法。  

设置3D验证
===================  
您可以通过指定参数 _is3DSAuthentication_ 来选择是否对支付进行3D验证。

*   **不设置** **_is3DSAuthentication_** **参数**：结果与设置为 `false` 相同。支付不启用3D验证。如果支付宝识别此支付为高风险，该支付将被拒绝。
*   **将** **_is3DSAuthentication_** **设置为** **`false`**：支付不启用3D验证。如果支付宝识别此支付为高风险，该支付将被拒绝。
*   **将** **_is3DSAuthentication_** **设置为** **`true`**：支付启用3D验证。如果支付宝识别此支付为高风险，该支付将被拒绝。  

> **注意**：
### API 整合
在 [**pay (结账支付)**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中指定此参数，用于 API 整合。在 SDK 整合中，此参数应在 [**createPaymentSession (收银台支付)**](https://global.alipay.com/docs/ac/ams/session_cashier) API 中指定。

### 智能交易挽救
交易挽救功能允许在需要 3D 验证的卡组织交易中自动启动 3D 验证流程，即使之前未选择 3D 验证，也能尝试挽救交易。

要启用交易挽救功能，需将 `_enableAuthenticationUpgrade` 参数设置为 `true`。如果未启用此功能，且交易的卡组织要求 3D 验证，卡组织会将此交易视为高风险并拒绝支付。

**注意**:

*   对于 API 整合，此参数在 [**pay (结账支付)**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 中设置。对于 SDK 整合，设置在 [**createPaymentSession (收银台支付)**](https://global.alipay.com/docs/ac/ams/session_cashier) API 中。
*   此功能不适用于某些特定本地卡组织的支付，包括巴西卡、韩国卡、新加坡卡和香港卡。

3D 验证设置和自动交易挽救共同决定了交易的风险控制验证流程。下表显示了这两个功能设置如何影响风险控制结果：
| **设置3D验证：** **is3DSAuthentication** | **设置自动交易挽救：** **enableAuthenticationUpgrade** | **风险控制结果** |
| --- | --- | --- |
| false/留空 | true/留空 | 如果没有3D验证的支付失败，该支付会自动触发3D验证，Antom返回用于渲染3D验证页面的URL。 |
| false/留空 | false | 如果没有3D验证的支付失败，Antom返回支付失败的结果。 |
| true | true/false/留空 | 该支付将进行3D验证，Antom返回用于渲染3D验证页面的URL。 |
  
**表1.** 受两个功能设置影响的风险控制结果  
对于SDK集成，SDK会处理重定向到3D验证页面，您无需额外操作。对于API集成，当Antom返回3D验证页面的渲染URL后，您需要显示验证页面并引导买家完成验证过程。以下代码示例展示了如何通过[**pay (结账支付)**](https://global.alipay.com/docs/ac/ams/payment_cashier) API的响应返回URL：

```json
{
"result": {
"resultStatus": "U",
"resultCode": "PAYMENT_IN_PROCESS",
"resultMessage": "payment in process"
},
"normalUrl": "https://centinelapi.cardinalcommerce.com/V1/Cruise/Collect/...",
"paymentId": "20221111194010890100111650285726898",
"paymentRequestId": "amsdmpay_cangxi_lj_20221111_104718_672",
"redirectActionForm": {
"redirectUrl": "https://centinelapi.cardinalcommerce.com/V1/Cruise/Collect/...",
"method": "GET"
},
"paymentAmount": {
"currency": "HKD",
"value": "100"
},
"paymentCreateTime": "2022-11-10T18:47:20-08:00"
}
```
**增值风险控制服务**
----------------------
如果您需要升级的支付风险控制服务，可以购买Antom提供的增值服务型风险控制服务。这项服务基于支付的风险等级提供智能风险控制策略。

设置3D验证、自动交易挽救，这些功能将共同决定交易的风险控制验证流程。下表展示了这三个功能的设置如何影响风险控制结果：

| **增值服务型风险控制服务** | **设置3D验证：** **is3DSAuthentication** | **设置自动交易挽救：** **enableAuthenticationUpgrade** | **风险控制结果** |
| --- | --- | --- | --- |
| 开启 | false/留空 | false | 风险控制服务决定是否执行3D验证。 |
| 开启 | Antom | true/留空 | 风险控制服务决定是否执行3D验证。如果服务决定不执行3D验证，但卡组织要求3D验证，Antom将返回3D验证页面的渲染URL。 |
| 开启 | true | true/false/留空 | 即使风险控制服务决定不执行3D验证，Antom也会返回3D验证页面的渲染URL。 |

**表2.** 三个功能设置影响的风险控制结果

> **注意**：
>
> * 如果您已购买增值服务型风险控制服务，无需指定_is3DSAuthentication_参数。风险控制服务将为您提供风险控制策略。
> * 对于某些受当地卡组织监管的特定卡片发起的支付，此功能可能不可用。这些卡片包括巴西卡、韩国卡、新加坡卡和香港卡。
> 
> AVS检查
> ===========

请注意，AVS检查通常是指Address Verification System（地址验证系统），用于验证持卡人提供的账单地址与发卡银行记录的地址是否匹配，以增强支付的安全性。在不同的支付环境中，其具体应用和规则可能会有所不同。
地址验证系统（AVS）检查会对比交易中使用的账单地址与发卡银行记录中的持卡人地址信息，以检测欺诈行为。通过启用AVS检查，系统会自动将买家输入的账单地址和电子邮件地址与发卡行存储的信息进行比较。如果这些信息不匹配，可能会导致支付被拒绝或需要额外的身份验证。

### 发起支付

在启用AVS检查服务后，你可以根据你的集成模式发起AVS检查：

1. **API集成**  
   参考[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)或[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API的响应中的`request.paymentResultInfo.avsResultRaw`参数获取AVS检查的结果。

2. **SDK集成**  
   请参考相应的SDK文档进行集成。

> **注意事项**：
>
> * AVS检查的结果可以通过调用[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)或[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API时返回的`request.paymentResultInfo.avsResultRaw`参数获取。
> * 此功能仅适用于在美国卡组织监管下的美国卡发起的支付。
### API 集成  
#### 服务器到服务器模式  
在服务器到服务器模式下，您需要收集买家的卡信息和账单地址信息，并通过 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 指定 _billingAddress_ 参数来发起 AVS 检查。  

以下是一个带有账单地址的支付请求调用示例：  
```json
{
  "order": {
    "orderAmount": {
      "currency": "USD",
      "value": "100"
    },
    "orderDescription": "《Bad Romance》-Lady Gaga",
    "referenceOrderId": "ORDER_20231208164745347",
    "goods": [
      {
        "goodsCategory": "Digital Goods",
        "goodsName": "《Bad Romance》",
        "goodsQuantity": "1",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "100"
        },
        "goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
        "referenceGoodsId": "GOODS_20231208164745347"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "shippingPhoneNo": "123456789"
    },
    "buyer": {
      "buyerEmail": "gaga@gaga.com",
      "buyerName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "buyerPhoneNo": "123456789",
      "referenceBuyerId": "88888888"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodMetaData": {
      "cardholderName": {
        "firstName": "Lady",
        "lastName": "Gaga"
      },
      "billingAddress": {
        "zipCode": "94043",
        "address2": "gongzhuan Road",
        "city": "Sunnyvale",
        "address1": "mountain view Road",
        "state": "CA",
        "region": "US"
      },
      "cvv": "850",
      "expiryMonth": "12",
      "expiryYear": "29",
      "cardNo": "4294097400915107"
    }
  },
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
}
```

#### 托管模式  
（这部分文档未提供具体内容，需要补充）
"paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
"paymentRequestId": "PAY_20231208164745347",
"productCode": "CASHIER_PAYMENT",
"paymentFactor": {
"isAuthorization": true
}
}  
#### 托管模式  
在托管模式下，蚂蚁金服提供支付信息收集页面，供买家输入卡信息和账单地址，您无需进行额外的开发工作。  
以下是一个调用**pay** API 且不包含账单地址的示例：  
复制  
{
"order": {
"orderAmount": {
"currency": "USD",
"value": "100"
},
"orderDescription": "《Bad Romance》-Lady Gaga",
"referenceOrderId": "ORDER_20231208152528327",
"goods": [
{
"goodsCategory": "Digital Goods",
"goodsName": "《Bad Romance》",
"goodsQuantity": "1",
"goodsUnitAmount": {
"currency": "USD",
"value": "100"
},
"goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
"referenceGoodsId": "GOODS_20231208152528327"
}
],
"shipping": {
"shippingName": {
"firstName": "lady",
"fullName": "lady gaga",
"lastName": "gaga"
},
"shippingPhoneNo": "123456789"
},
"buyer": {
"buyerEmail": "gaga@gaga.com",
"buyerName": {
"firstName": "lady",
"fullName": "lady gaga",
"lastName": "gaga"
},
"buyerPhoneNo": "123456789",
"referenceBuyerId": "88888888"
}
},
"env": {
"terminalType": "WEB",
"clientIp": "112.80.248.78",
"deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
"deviceLanguage": "zh_CN"
},
"paymentAmount": {
"currency": "USD",
"value": "100"
},
"paymentMethod": {
"paymentMethodType": "CARD"
},
"settlementStrategy": {
"settlementCurrency": "USD"
},
"paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
"paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
"paymentRequestId": "PAY_2023120uuu54400oo4854327",
"productCode": "CASHIER_PAYMENT",
"paymentFactor": {
"isAuthorization": true
}
}
Antom 返回一个中间页面，其地址为 _normalUrl_，这是一个支付信息收集页面。将买家重定向到这个支付信息收集页面，买家将在该页面上输入支付和账单信息。
![图1：image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713856891470-62d84e25-4e38-4922-a225-619e2d514d20.png)
图1. 支付信息收集页面（API）
### SDK 集成  
对于SDK集成，Antom提供了支付信息收集页面，买家可以在此输入支付和账单信息，无需您进行额外的开发工作。  

以下是一个调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/session_cashier) API（不包含账单地址）的示例：  
复制  
```json
{
  "order": {
    "orderAmount": {
      "currency": "USD",
      "value": "100"
    },
    "orderDescription": "《Bad Romance》-Lady Gaga",
    "referenceOrderId": "ORDER_20231106113345977",
    "goods": [
      {
        "goodsCategory": "Digital Goods",
        "goodsName": "《Bad Romance》",
        "goodsQuantity": "1",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "100"
        },
        "goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
        "referenceGoodsId": "GOODS_20231106113345977"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "shippingPhoneNo": "123456789"
    },
    "buyer": {
      "buyerEmail": "gaga@gaga.com",
      "buyerName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "buyerPhoneNo": "123456789",
      "referenceBuyerId": "88888888"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD"
  },
  "enableInstallmentCollection": true,
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
  "paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
  "paymentRequestId": "PAY_20234411061ooo133459707",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```
Antom为您的买家提供了以下信息收集页面：  
![图片4: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713858048965-099252c0-1dbf-4d49-b2f1-4e9860c53426.png)
图2. 支付信息收集页面（SDK）
---------------------------

### 接收支付结果通知
以下代码示例展示了支付结果通知中的AVS（地址验证系统）检查结果。

```json
{
  "actualPaymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "cardInfo": {
    "avsResultRaw": "Y",
    "cardBrand": "JCB",
    "cardNo": "************3566",
    "cvvResultRaw": "X",
    "funding": "CREDIT",
    "issuingCountry": "US",
    "networkTransactionId": "200719820486071",
    "paymentMethodRegion": "GLOBAL",
    "threeDSResult": {
      "cavv": "",
      "eci": ""
    }
  },
  "notifyType": "PAYMENT_RESULT",
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentCreateTime": "2024-03-28T20:35:23-07:00",
  "paymentId": "20240329114010800100181570206917730",
  "paymentRequestId": "2024032938401734456237",
  "paymentResultInfo": {
    "avsResultRaw": "Y",
    "cardBrand": "JCB",
    "cardNo": "************3566",
    "cvvResultRaw": "X",
    "funding": "CREDIT",
    "issuingCountry": "US",
    "networkTransactionId": "200719820486071",
    "paymentMethodRegion": "GLOBAL",
    "threeDSResult": {
      "cavv": "",
      "eci": ""
    }
  },
  "paymentTime": "2024-03-28T20:35:29-07:00",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```

**常见问题解答 (FAQs)**
-----------------------

#### 1. 当为`billingAddress`指定错误值时，交易会失败吗？

当`billingAddress`的值指定不正确时，以下情况可能导致交易失败：

*   **参数值异常**：如果指定了`billingAddress`参数，那么需要`region`值。如果缺少必需的值，或者`region`值与指定的`state`值不匹配，调用`pay` API时会出现异常并返回错误代码。发生此错误时，支付会失败，Antom不会发送支付失败的异步通知。
*   **信息不匹配**：如果地址信息存在不一致，可能会导致交易失败。例如，买家在银行账户注册时提供的账单地址为`CA`，但在请求中指定的`billingAddress`值为`FL`，则存在地址信息的不匹配。在这种情况下，你可以根据`avsResultRaw`的值来判断是否继续发货。
#### 2\. 如何理解`avsResultRaw`中不同枚举值的含义？
详情请参考[AVS结果代码](https://global.alipay.com/docs/ac/ref/risk_methods#uk0zA)。
#### 3\. 如果我已经存储了支付和账单地址信息，是否还需要在信息收集页面上再次收集？
*   **在API集成的托管模式下**：如果你已经存储了买家的支付和账单地址信息，将**pay** API的`billingAddress`参数设置为存储的值。这样，支付和账单地址信息将在蚂蚁中间页上显示，以避免买家重复填写，提升支付体验。
*   **对于SDK集成**：如果你已经存储了买家的支付和账单地址信息，将**createPaymentSession** API的`billingAddress`参数设置为存储的值。同样，支付和账单地址信息将在蚂蚁中间页上显示，以避免买家重复填写，提升支付体验。
**卡片信息存储**
==================
允许买家添加卡片功能，意味着消费者在首次支付时可以选择保存他们的卡信息，这样在后续支付时就无需再次输入信息。以下是一个买家在首次支付时保存卡信息后，进行后续支付的结账页面示例：

![图5：图片](https://idocs-assets-marmot-cloud-com.storage.idocs87c36dc8dac653c1/1682045853015-85909c07-b240-4d1f-ae65-a8b8e49d4594.png)

图3. 使用之前保存的卡信息进行后续支付的结账页面

API 集成
------------

添加买家卡片的方式取决于集成模式。对于服务器到服务器模式和托管模式，请按照以下步骤操作：

服务器到服务器模式
托管模式
### 服务器到服务器模式  
在服务器到服务器模式下，收集买家的卡信息后，您可以选择自己存储卡信息，或者让蚂蚁金服为您存储。  
*   **蚂蚁金服存储卡信息（推荐）**  
当买家在您的页面上存储卡信息时，通过 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 传递卡信息，并将 `_tokenize` 字段设置为 `true`。蚂蚁金服将为卡信息生成对应的卡令牌（_cardToken_）。支付授权成功后，您可以通过接收异步通知或调用 **inquiryPayment** API 获取卡令牌（_cardToken_）和部分隐藏的卡号（_cardNo_）。为了处理后续支付，您必须存储并关联获取到的卡令牌、部分隐藏的卡号以及买家的其他相关信息。  

以下代码示例展示了在收集卡信息后，蚂蚁金服存储卡信息时调用 **pay** API 的请求：  
```json
{
"settlementStrategy": {
"settlementCurrency": "EUR"
},
"productCode": "CASHIER_PAYMENT",
"paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_GROUP&paymentMethodType=CARD",
"paymentRequestId": "2****************2",
"paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=2023070458941025622196",
"paymentFactor": {
"isAuthorization": true
},
"paymentMethod": {
"paymentMethodMetaData": {
"recurringType": "",
"cvv": "123",
"is3DSAuthentication": false,
"isCardOnFile": false,
"expiryMonth": "05",
"tokenize": true,
"expiryYear": "26",
"billingAddress": {
"zipCode": "310000",
"address2": "gongzhuan Road",
"city": "hangzhou",
"state": "zhejiang",
"region": "CN"
},
"cardNo": "****1846"
},
"paymentMethodType": "CARD"
},
"paymentExpiryTime": "2025-11-27T12:00:01+08:30",
"paymentAmount": {
"currency": "EUR",
"value": "8204"
},
"merchantRegion": "",
"order": {
"orderAmount": {
"currency": "EUR",
```

请注意，文档中提到的“Antom”可能是指“蚂蚁金服”（Ant Financial）的笔误。
当买家使用已保存的卡进行支付时，执行以下操作：

1. 在结账页面上向买家显示部分屏蔽的卡信息。
2. 通过 **pay** API 传递以下参数：
   1. `_paymentMethodId_`: 值应与 `_cardToken_` 参数相同（从 **notifyPayment** 和 **inquiryPayment** 的 `paymentResultInfo` 中获取）。
   2. 额外验证参数（例如，对于巴西卡的 `_cpf_` 参数）。
   3. `_isCardOnFile_`: 设置为 `true`。此参数用于标识使用已保存卡的后续支付。

以下代码示例展示了买家使用已保存卡支付时 **pay** API 调用请求的示例：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "EUR"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_GROUP&paymentMethodType=CARD",
  "paymentRequestId": "2****************2",
  "paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=2023070471913565376977",
}
```

请注意，这是一段示例 JSON 数据，用于演示如何在调用支付 API 时处理已保存的卡支付。实际的 API 调用可能需要根据具体的服务提供商和实现进行调整。
"支付因子": {
"是否授权": true
},
"支付方式": {
"支付方式ID": "A********************************************************************************************=",
"支付方式元数据": {
"循环类型": "计划",
"是否3DS验证": false,
"是否保存卡信息": true,
"网络交易ID": "2*************5"
},
"支付方式类型": "信用卡"
},
"支付有效期": "2025-11-27T12:00:01+08:30",
"支付金额": {
"货币": "EUR",
"值": "3063"
},
"商家地区": "",
"订单": {
"订单金额": {
"货币": "EUR",
"值": "3063"
},
"参考订单号": "2****************1",
"配送": {
"配送姓名": {
"名": "Li",
"姓": "Kyle",
"全名": "Kyle Li"
},
"配送公司": "DHL",
"配送电话": "**********119",
"收货邮箱": "exam***@163.com",
"配送地址": {
"邮政编码": "310000",
"地址2": " Gongzhuan Road",
"城市": "杭州",
"州": "浙江",
"地区": "CN"
}
},
"商品": [
{
"参考商品ID": "2********************9",
"商品链接": "qinghailipipeng",
"商品类别": "化学",
"商品单位金额": {
"货币": "EUR",
"值": "3063"
},
"商品数量": "1",
"商品名称": "boom",
"商品SKU名称": "boom boom room",
"商品品牌": "antom boom"
}
],
"环境": {
"客户端IP": "1.1.1.1",
"操作系统类型": "IOS",
"终端类型": "WAP"
},
"订单描述": "ANTOM_ZZ",
"买家": {
"参考买家ID": "K*****************3",
"买家姓名": {
"名": "Li",
"姓": "Kyle",
"全名": "Kyle Li"
}
}
}
}  
*   **自行存储卡信息**  
当买家在您的页面上保存卡信息时，您需要在服务器上存储并关联买家信息和相应的卡信息。当买家再次发起支付时，您需要通过 **pay** API 传递卡信息，并将 _isCardOnFile_ 的值设为 `true`。_isCardOnFile_ 用于标识使用已保存的卡进行的后续支付。设置此参数可以提高支付成功率。
以下代码示例展示了当买家使用保存的卡片支付时的**支付**API调用请求：

```markdown
{
"env": {
"terminalType": "APP",
"clientIp": "112.80.248.78",
"deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
"osType": "IOS",
"deviceLanguage": "zh_CN",
"colorDepth": 48,
"screenHeight": 768,
"screenWidth": 1024,
"timeZoneOffset": 1
},
"order": {
"orderAmount": {
"currency": "EUR",
"value": "30000"
},
"orderDescription": "Cappuccino #grande (Mika's coffee shop)",
"referenceOrderId": "ORDER_2022111414171****",
"goods": [
{
"referenceGoodsId": "383382011_SGAMZ-90452****",
"goodsName": "[3 Boxes] Starbucks Cappuccino Milk Coffee Pods / Coffee Capsules by Nescafe Dolce Gusto",
"goodsUrl": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
"goodsCategory": "Digital Goods/Digital Vouchers/Food and Beverages",
"goodsUnitAmount": {
"currency": "EUR",
"value": "30000"
},
"goodsQuantity": "10"
}
],
"shipping": {
"shippingName": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
},
"shippingAddress": {
"zipCode": "310000",
"address2": "Xihu",
"city": "Hangzhou",
"address1": "Wuchang road",
"state": "Zhejiang",
"region": "CN"
},
"shippingCarrier": "FedEx",
"shippingPhoneNo": "1234567****",
"shipToEmail": "test@gmail.com"
},
"buyer": {
"referenceBuyerId": "test12345678",
"buyerPhoneNo": "1234567****",
"buyerEmail": "alipay@alipay.com",
"buyerName": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
}
}
},
"paymentAmount": {
"currency": "EUR",
"value": "30000"
},
"paymentMethod": {
"paymentMethodType": "CARD",
"paymentMethodMetaData": {
"isCardOnFile": true,
"enableAuthenticationUpgrade": false,
"is3DSAuthentication": false,
"cardholderName": {
"firstName": "Tom",
"lastName": "Jay"
},
```

请注意，这是一个不完整的请求，缺少了`paymentMethodMetaData`字段的闭合括号和整个JSON对象的结束括号。在实际使用中，确保提供完整的有效JSON数据。
"过期月份": "12",
"账单地址": {
"邮政编码": "310000",
"地址2": "西湖",
"城市": "杭州",
"地址1": "武昌路",
"州/省": "浙江",
"地区": "CN"
},
"过期年份": "29",
"卡号": "411734780615****"
},
"结算策略": {
"结算货币": "EUR"
},
"支付通知URL": "https://www.alipay.com/notify",
"支付重定向URL": "https://www.alipay.com",
"支付请求ID": "PAY_2022111414171****",
"产品代码": "CASHIER_PAYMENT",
"支付因素": {
"是否授权": true
}
}
### 托管模式  
在这种模式下，Antom（可能是蚂蚁金服的某项服务）提供一个支付信息收集页面。当买家在页面上选择保存他们的卡片信息时，Antom 会存储买家的卡片信息并生成对应的卡片令牌（_cardToken_）。在授权支付完成后，您可以通过接收异步通知或调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/card/inquiry) API 来获取买家的卡片信息（_cardInfo_）。卡片信息包括卡片令牌（_cardToken_）和脱敏后的卡片信息。

以下代码示例展示了当买家选择保存卡片信息并完成授权支付时，Antom 发送的异步通知。通知包含了买家的支付信息：

```json
{
"notifyType": "PAYMENT_RESULT",
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "success"
},
"paymentRequestId": "2020010123456789****",
"paymentId": "2020010123456789****",
"paymentAmount": {
"value": "8000",
"currency": "EUR"
},
"paymentCreateTime": "2020-01-01T12:01:00+08:30",
"paymentTime": "2020-01-01T12:01:01+08:30",
"paymentResultInfo": {
"cardBrand": "VISA",
"cardNo": "123456789000****",
"cardToken": "ALIPAY6GPhBXfyvUva6BJziioYucDM00zCwoZckNuxyxYIp4Ti/tsGntq/+EmWT4nVF5BqCAo/b1OjVTvtl1zspyMG****",
"funding": "DEBIT",
"issuingCountry": "FR",
"paymentMethodRegion": "FR",
"avsResultRaw": "A",
"cvvResultRaw": "Y",
"networkTransactionId": "sampleNetworkTransactionId12****",
"threeDSResult": {
"eci": "02",
"threeDSVersion": "2.2.0",
"caav": "cavvSample",
"dsTransactionId": "sample_dsTranascti****"
}
}
}
```

以下代码示例展示了当买家选择保存卡片信息并完成授权支付时，通过调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/card/inquiry) API，Antom 返回的响应。响应包含了买家的支付信息：

```json
{
"result": {
"resultCode": "SUCCESS",
```
"resultStatus": "成功",
"resultMessage": "成功"
},
"支付状态": "成功",
"支付请求ID": "pay_1089760038715669_10277574507XXXX",
"支付ID": "2019060811401080010018882020035XXXX",
"支付金额": {
"值": "500",
"货币": "USD"
},
"支付创建时间": "2019-06-01T12:01:01+08:30",
"支付时间": "2019-06-01T12:01:01+08:30",
"支付结果信息": {
"卡品牌": "VISA",
"卡号": "123456789000****",
"卡令牌": "ALIPAY6GPhBXfyvUva6BJziioYucDM00zCwoZckNuxyxYIp4Ti/tsGntq/+EmWT4nVF5BqCAo/b1OjVTvtl1zspyMG****",
"资金来源": "借记",
"发卡国家": "FR",
"支付方式区域": "FR",
"AVS原始结果": "A",
"CVV原始结果": "Y",
"网络交易ID": "sampleNetworkTransactionId123456",
"3DS结果": {
"eci": "02",
"3DS版本": "2.2.0",
"cavv": "cavvSample",
"dsTransactionId": "sample_dsTranasctionId"
}
}
}

当买家使用已保存的卡进行后续支付时，执行以下步骤：
1. 在结账页面上显示脱敏的卡信息。
2. 通过[**pay**](https://global.alipay.com/docs/ac/card/pay) API 传递以下参数：
*   _paymentMethodId_: 值应与_cardToken_ 参数相同。
*   额外验证参数（如巴西卡的_CPF_ 参数）
*   _isCardOnFile_: 值设为`true`，表示这是一个使用已保存卡的后续支付，有助于提高支付成功率。

以下代码示例展示了当买家使用已保存的卡进行后续支付时，服务器如何调用[**pay**](https://global.alipay.com/docs/ac/card/pay) API：

```json
{
"env": {
"browserInfo": {
"acceptHeader": "*/*",
"javaEnabled": true,
"javaScriptEnabled": true,
"language": "zh_CN",
"userAgent": "Chrome/100"
},
"terminalType": "APP",
"clientIp": "112.80.248.78",
"deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMOzAKe",
"osType": "IOS",
"deviceLanguage": "zh_CN",
"colorDepth": 48,
"screenHeight": 768,
"screenWidth": 1024,
```

请注意，以上代码片段并未完整展示，通常还会包含其他必要的请求参数。
```json
{
  "timeZoneOffset": 1,
  "order": {
    "orderAmount": {
      "currency": "EUR",
      "value": "30000"
    },
    "orderDescription": "Cappuccino #grande (Mika's coffee shop)",
    "referenceOrderId": "ORDER_20221114141714891",
    "merchant": {
      "referenceMerchantId": "SM_001"
    },
    "goods": [
      {
        "referenceGoodsId": "383382011_SGAMZ-904520356",
        "goodsName": "[3 盒] 星巴克Cappuccino牛奶咖啡胶囊 / Nescafe Dolce Gusto咖啡胶囊",
        "goodsUrl": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
        "goodsCategory": "数字商品/电子凭证/食品饮料",
        "goodsUnitAmount": {
          "currency": "EUR",
          "value": "30000"
        },
        "goodsQuantity": "10"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      },
      "shippingAddress": {
        "zipCode": "310000",
        "address2": "西湖",
        "city": "杭州",
        "address1": "武昌路",
        "state": "浙江",
        "region": "CN"
      },
      "shippingCarrier": "FedEx",
      "shippingPhoneNo": "12345678912",
      "shipToEmail": "test@gmail.com"
    },
    "buyer": {
      "referenceBuyerId": "test12345678",
      "buyerPhoneNo": "12345678912",
      "buyerEmail": "alipay@alipay.com",
      "buyerName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      }
    }
  },
  "paymentAmount": {
    "currency": "EUR",
    "value": "30000"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodId": "paymentToken123456",
    "paymentMethodMetaData": {
      "isCardOnFile": true,
      "enableAuthenticationUpgrade": false,
      "is3DSAuthentication": true
    }
  },
  "settlementStrategy": {
    "settlementCurrency": "EUR"
  },
  "paymentNotifyUrl": "https://www.alipay.com/notify",
  "paymentRedirectUrl": "https://www.alipay.com",
  "paymentRequestId": "PAY_20221114141714891",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```

SDK 集成
------------
在这种集成模式下，SDK 提供了一个支付信息收集页面。买家输入他们的卡信息，并可以选择保存这些信息，以便在后续支付时无需再次输入。当买家选择保存卡信息时，Antom（可能是指蚂蚁金服）会存储这些信息并生成对应的卡令牌（_cardToken_）。在支付授权后，您可以通过接收异步通知或调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 来获取买家的卡信息（_cardInfo_）。卡信息包括卡令牌（_cardToken_）和脱敏的卡详细信息。

当买家使用已保存的卡进行后续支付时，您需要在调用 [**createPaymentSession (Checkout Payment)**](https://global.alipay.com/docs/ac/ams/session_cashier) API 时将 _paymentMethodId_ 设置为 _cardToken_ 的值。以下代码示例展示了当买家使用已保存的卡进行后续支付时，您的服务器如何调用 **createPaymentSession (Checkout Payment)** API：

```json
{
  "productCode": "CASHIER_PAYMENT",
  "paymentRequestId": "55bf93a6-71a1-4ca9-b014-53273bd674eb",
  "order": {
    "referenceOrderId": "926e1c32-4a6c-442e-b5ce-8ec5b902e18c",
    "orderDescription": "xxxxx",
    "orderAmount": {
      "currency": "BRL",
      "value": "100"
    },
    "buyer": {
      "referenceBuyerId": "yeiasdasda",
      "buyerPhoneNo": "134******71"
    }
  },
  "paymentAmount": {
    "currency": "BRL",
    "value": "100"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodId": "alipayCardToken"
  },
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentFactor": {
    "isAuthorization": true
  },
  "settlementStrategy": {
    "settlementCurrency": "EUR"
  }
}
```

MIT
===

（注：MIT 是软件许可协议，表示该代码遵循 MIT 许可协议。）
商家发起交易（Merchant-Initiated Transaction, MIT）是指一种预先授权的卡支付交易方式，即在没有买家参与的情况下进行的定期或不定期交易。

**注意**：

1. MIT 类型的交易不需要3D验证。
2. 在发起MIT之前，必须获得买家的授权，这需要买家在首次授权支付时完成3D验证。
3. 对于特定的本地卡方案，某些卡片不支持此功能。这些卡片包括巴西卡、韩国卡、新加坡卡和香港卡。

要发起MIT，您需要调用[**pay (Checkout Payment)**](https://global.alipay.com/docs/ac/ams/payment_cashier) API。请注意以下参数的设置：

*   _isCardOnFile_: 值设为`true`，表示该支付是使用已保存的卡片进行的后续支付。
*   _recurringType_: 值设为`SCHEDULED`或`UNSCHEDULED`，用于指定这是定期还是不定期支付。
*   _networkTransactionId_: Antom 需要确认已获得买家授权完成MIT，因此必须向此参数传递一个唯一标识符。该标识符由卡组织分配，用于识别首次授权的支付。当买家完成首次授权支付时，您可以通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API或[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API的响应获取该标识符。

服务器到服务器模式和托管模式支持自动扣款。以下代码示例展示了服务器如何在服务器到服务器模式下调用**pay (Checkout Payment)** API来发起MIT：

```json
{
  "env": {
    "browserInfo": {
      "acceptHeader": "*/*",
      ...
    },
    ...
  },
  ...
}
```

请根据您的实际需求和上下文环境，将上述代码和说明应用到您的应用中。
"javaEnabled": true,
"javaScriptEnabled": true,
"language": "中文（中国）",
"userAgent": "Chrome/100"
},
"终端类型": "APP",
"客户端IP": "112.80.248.78",
"设备ID": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMOzAKe",
"操作系统类型": "IOS",
"设备语言": "中文（中国）",
"颜色深度": 48,
"屏幕高度": 768,
"屏幕宽度": 1024,
"时区偏移": 1
},
"订单": {
"订单金额": {
"货币": "EUR",
"值": "30000"
},
"订单描述": "大杯卡布奇诺（Mika's咖啡店）",
"参考订单号": "ORDER_20221114141714891",
"商品": [
{
"参考商品ID": "383382011_SGAMZ-904520356",
"商品名称": "[3盒]星巴克卡布奇诺牛奶咖啡胶囊/nescafe dolce gusto咖啡胶囊",
"商品链接": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
"商品类别": "数字商品/电子券/食品和饮料",
"商品单价": {
"货币": "EUR",
"值": "30000"
},
"商品数量": "10"
}
],
"配送": {
"收件人姓名": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
},
"配送地址": {
"邮政编码": "310000",
"地址2": "西湖",
"城市": "杭州",
"地址1": "武昌路",
"州": "浙江",
"地区": "CN"
},
"配送公司": "FedEx",
"配送电话": "12345678912",
"收件人邮箱": "test@gmail.com"
},
"买家": {
"参考买家ID": "test12345678",
"买家电话": "12345678912",
"买家邮箱": "alipay@alipay.com",
"买家姓名": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
}
}
},
"支付金额": {
"货币": "EUR",
"值": "30000"
},
"支付方式": {
"支付方式类型": "CARD",
"支付方式元数据": {
"是否已存储卡": true,
"重复支付类型": "定期",
"网络交易ID": "referenceNetworkTransactionId12345",
"是否启用认证升级": false,
"是否进行3DS认证": false,
"cvv": "850",
"持卡人姓名": {
"firstName": "Tom",
"lastName": "Jay"
},
"过期月份": "12",
"账单地址": {
"邮政编码": "310000",
"地址2": "西湖",
"城市": "杭州",
"地址1": "武昌路",
"州": "浙江",
"区域": "CN"
},
"过期年份": "29",
"卡号": "4117347806156383"
}
},
"结算策略": {
"结算货币": "EUR"
},
"支付通知URL": "https://www.alipay.com/notify",
"支付重定向URL": "https://www.alipay.com",
"支付请求ID": "PAY_20221114141714891",
"产品代码": "CASHIER_PAYMENT",
"支付因子": {
"是否授权": true
}
}  
指定卡品牌
==========

商家端收集卡片明文信息，并通过API集成卡支付。如果买家选择使用联名卡进行授权支付，可以通过`selectedCardBrands`参数指定交易中使用的卡品牌区域。

> **注意事项**:
>
> *   若未设置`selectedCardBrands`，Antom会为您自动选择一个卡品牌进行授权支付。
> *   如果您接受欧洲联名卡，需要向买家提供清晰的支付方案。详细信息请参考[联名卡合规性](https://global.alipay.com/docs/ac/cashierpay/co-badged_cards_compliance)。

联名卡支付处理的工作流程如下图所示：

![图片6: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1710403069255-c0ed35b8-d26f-4a73-9de3-3cccd2d382a9.png)

图4. 联名卡支付工作流程

对应的请求示例如下：

```json
{
"order": {
"orderAmount": {
"currency": "EUR",
"value": "30000"
},
"orderDescription": "《Bad Romance》-Lady Gaga",
"referenceOrderId": "ORDER_20231208111545328",
"goods": [
{
"goodsCategory": "Digital Goods",
"goodsName": "《Bad Romance》",
"goodsQuantity": "1",
"goodsUnitAmount": {
"currency": "HKD",
"value": "30000"
},
"goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
```
```json
{
  "order": {
    "referenceOrderId": "ORDER_20231208111545328",
    "referenceGoodsId": "GOODS_20231208111545328",
    "shipping": {
      "shippingName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "shippingPhoneNo": "123456789"
    },
    "buyer": {
      "buyerEmail": "gaga@gaga.com",
      "buyerName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "buyerPhoneNo": "123456789",
      "referenceBuyerId": "88888888"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "EUR",
    "value": "30000"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodMetaData": {
      "cardholderName": {
        "firstName": "Lady",
        "lastName": "Gaga"
      },
      "billingAddress": {
        "zipCode": "310000",
        "address2": "Xihu",
        "city": "Hangzhou",
        "address1": "Wuchang road",
        "state": "Zhejiang",
        "region": "CN"
      },
      "cvv": "850",
      "expiryMonth": "12",
      "expiryYear": "29",
      "cardNo": "4390807888888888",
      "selectedCardBrand": "VISA"
    }
  },
  "settlementStrategy": {
    "settlementCurrency": "SGD"
  },
  "paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
  "paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
  "paymentRequestId": "PAY_2023154445445328",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```

**MPI**

如果在发起授权支付前，您让买家通过第三方完成了3D Secure验证，那么在调用**pay** API时，通过`mpiData`传递3D Secure验证结果，并指定此支付为非3D Secure验证。

| **字段** | **描述** |
| --- | --- |
| `mpiData.threeDSVersion` | 第三方认证机构返回的3D Secure协议版本。 |
| `mpiData.caav` | 第三方认证机构返回的持卡人认证值。 |
| `mpiData.dsTransactionId` | 第三方认证机构返回的唯一交易标识。 |
| mpiData.eci | 电子商业指示器（ECI），由第三方认证机构返回。 |
| is3DSAuthentication | 设置为`false`。买方已完成3D Secure认证。指定交易为非3D认证。 |
| enableAuthenticationUpgrade | 设置为`false`。买方已完成3D Secure认证。无需将交易升级为3D Secure认证。 |  
表3. MPI信息  
**注意**：使用韩国任何卡组织发行的韩国银行卡进行的支付不支持MPI功能。  
以下代码示例展示了调用**pay** API时包含_mpiData_的请求：  
```json
{
"env": {
"browserInfo": {
"acceptHeader": "*/*",
"javaEnabled": true,
"javaScriptEnabled": true,
"language": "zh_CN",
"userAgent": "Chrome/100"
},
"terminalType": "APP",
"clientIp": "112.80.248.78",
"deviceId": "e******************************************1",
"osType": "IOS",
"deviceLanguage": "zh_CN",
"colorDepth": 48,
"screenHeight": 768,
"screenWidth": 1024,
"timeZoneOffset": 1
},
"order": {
"orderAmount": {
"currency": "EUR",
"value": "30000"
},
"orderDescription": "Cappuccino #grande (Mika's coffee shop)",
"referenceOrderId": "O*******************1",
"goods": [
{
"referenceGoodsId": "383382011_SGAMZ-90452****",
"goodsName": "[3 盒] 星巴克Cappuccino牛奶咖啡胶囊/咖啡胶囊，由Nescafe Dolce Gusto提供",
"goodsUrl": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
"goodsCategory": "数字商品/数字礼券/食品饮料",
"goodsUnitAmount": {
"currency": "EUR",
"value": "30000"
},
"goodsQuantity": "10"
}
],
"shipping": {
"shippingName": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
},
"shippingAddress": {
"zipCode": "310000",
"address2": "西湖",
"city": "杭州",
```
"address1": "武昌路",
"state": "浙江",
"region": "中国"
},
"shippingCarrier": "FedEx",
"shippingPhoneNo": "1234567****",
"shipToEmail": "test***@gmail.com"
},
"buyer": {
"referenceBuyerId": "t**********4",
"buyerPhoneNo": "********567",
"buyerEmail": "exam***@alipay.com",
"buyerName": {
"firstName": "D****",
"lastName": "L****",
"fullName": "Dehua Skr****",
"middleName": "S****"
}
}
},
"paymentAmount": {
"currency": "EUR",
"value": "30000"
},
"paymentMethod": {
"paymentMethodType": "CARD",
"paymentMethodMetaData": {
"isCardOnFile": false,
"enableAuthenticationUpgrade": false,
"is3DSAuthentication": false,
"mpiData": {
"eci": "02",
"threeDSVersion": "2.2.0",
"caav": "cavvSample",
"dsTransactionId": "sample_dsTranascti****"
},
"cvv": "850",
"cardholderName": {
"firstName": "Tom",
"lastName": "Jay"
},
"expiryMonth": "12",
"billingAddress": {
"zipCode": "310000",
"address2": "西湖",
"city": "杭州",
"address1": "武昌路",
"state": "浙江",
"region": "中国"
},
"expiryYear": "29",
"cardNo": "****0615"
}
},
"settlementStrategy": {
"settlementCurrency": "EUR"
},
"paymentNotifyUrl": "https://www.alipay.com/notify",
"paymentRedirectUrl": "https://www.alipay.com",
"paymentRequestId": "P*******************1",
"productCode": "CASHIER_PAYMENT",
"paymentFactor": {
"isAuthorization": true
}
}

以下代码示例展示了调用**createPaymentSession** API 的请求，其中包含 _mpiData_ 参数：

```
{
"env": {
"clientIp": "112.80.248.78"
},
"order": {
"orderAmount": {
"currency": "EUR",
"value": "30000"
},
"orderDescription": "Cappuccino #grande (Mika's coffee shop)",
"referenceOrderId": "O********************1",
"goods": [
{
"referenceGoodsId": "3********************2",
"goodsName": "[3 盒] 星巴克卡布奇诺牛奶咖啡胶囊 / 咖啡胶囊，由Nescafe Dolce Gusto提供"
```

请注意，由于Markdown格式限制，商品信息部分未完全展示，但结构和内容应与原始文档一致。
"商品链接": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
"商品类别": "数字商品/数字礼券/食品饮料",
"商品单价": {
"货币": "EUR",
"金额": "30000"
},
"商品数量": "10"
}
],
"配送": {
"收件人姓名": {
"firstName": "Dehua",
"lastName": "Liu",
"全名": "Dehua Skr Liu",
"中间名": "Skr"
},
"配送地址": {
"邮政编码": "310000",
"地址2": "西湖",
"城市": "杭州",
"地址1": "武昌路",
"州": "浙江",
"地区": "CN"
},
"配送公司": "FedEx",
"联系电话": "1234567****",
"收件邮箱": "test@gmail.com"
},
"买家": {
"参考买家ID": "test1234****",
"买家电话": "1234567****",
"买家邮箱": "example@alipay.com",
"买家姓名": {
"firstName": "D****",
"lastName": "L****",
"全名": "Dehua Skr****",
"中间名": "S****"
}
}
},
"支付金额": {
"货币": "EUR",
"金额": "30000"
},
"支付方式": {
"支付方式类型": "CARD",
"支付方式元数据": {
"是否已存卡": false,
"是否启用认证升级": false,
"是否进行3DS认证": false,
"MPI数据": {
"eci": "02",
"3DS版本": "2.2.0",
"caav": "cavvSample",
"dsTransactionId": "sample_dsTranascti****"
},
"cvv": "850",
"持卡人姓名": {
"firstName": "Tom",
"lastName": "Jay"
},
"到期月": "12",
"账单地址": {
"邮政编码": "310000",
"地址2": "西湖",
"城市": "杭州",
"地址1": "武昌路",
"州": "浙江",
"地区": "CN"
},
"到期年": "29",
"卡号": "****0615"
}
},  
分期付款
--------

您可以为买家提供分期付款的选项，让他们有能力分期支付。下图展示了分期付款的用户体验：
图5. 分期付款的用户体验  
在上述图中，当买家选择信用卡分期付款方式后，会显示相关的分期计划信息，如分期数和每期的金额。然后买家会进行首期付款。

买家完成首期付款后，Antom（蚂蚁金服的简称）会根据合同中指定的结算周期结算全订单金额。

> **注意**：在使用分期服务时，您无需为买家提供任何资金。因此，建议您不要向买家收取分期费用。

获取信用卡品牌分期信息
---------------------------

您可以调用[**consult**](https://global.alipay.com/docs/ac/ams/consult) API 来获取支付方式的分期信息。返回的分期信息包括支持的信用卡品牌、可用的分期数以及可分期的最高和最低总金额。

以下表格列出了支持分期付款的信用卡类型：

| **卡类型** | **分期功能** | **支持** |
| --- | --- | --- |
| 巴西卡 | 2至12期 | 只支持信用卡 |
| 韩国卡 | 2至12期 | 只支持信用卡 |

表4. 分期付款

以下代码示例展示了**consult** API 返回的信用卡分期信息：

```json
{
"result": {
"resultStatus": "S",
"resultCode": "SUCCESS",
"resultMessage": "success."
},
"paymentOptions": [
{
"paymentMethodRegion": [
"BR"
],
"paymentMethodCategory": "CARD",
"installment": {
"plans": [
{
"interestRate": "0.00",
"installmentNum": "2",
"interval": "MONTH",
"minInstallmentAmount": {
```

请注意，以上代码示例只展示了部分信息，完整的JSON响应将包含更多分期计划的详细数据，如每期的利息率、分期数、间隔（如按月）以及每期的最低金额等。
"利息率": "0.00",
"分期数": "11",
"间隔": "月",
"最低分期金额": {
"货币": "BRL",
"值": "500"
},
"启用": true,
"最高分期金额": {
"货币": "BRL",
"值": "6000000"
}
}
]

这段Markdown格式的文档描述了一系列的分期付款选项，适用于巴西雷亚尔（BRL）货币。每个选项包括以下信息：

1. `currency`: 货币类型，这里是巴西雷亚尔（BRL）。
2. `value`: 与货币相关的金额，例如最低和最高分期金额。
3. `installmentNum`: 分期数，表示可以分几个月支付。
4. `interval`: 分期间隔，这里都是“MONTH”，表示按月分期。
5. `minInstallmentAmount`: 最低分期金额，至少需要支付500 BRL。
6. `enabled`: 是否启用该分期选项，所有选项都是启用的。
7. `maxInstallmentAmount`: 最高分期金额，最高可分期6,000,000 BRL。

文档中列出了从3个月到11个月的分期付款选项，且所有选项的利息率为0.00%，并且每个选项的最低分期金额为500 BRL，最高分期金额为6,000,000 BRL。
"interestRate": "0.00",
"installmentNum": "9",
"interval": "MONTH",
"minInstallmentAmount": {
"currency": "BRL",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "BRL",
"value": "999999999900"
}
},
{
"interestRate": "0.00",
"installmentNum": "10",
"interval": "MONTH",
"minInstallmentAmount": {
"currency": "BRL",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "BRL",
"value": "999999999900"
}
},
{
"interestRate": "0.00",
"installmentNum": "11",
"interval": "MONTH",
"minInstallmentAmount": {
"currency": "BRL",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "BRL",
"value": "999999999900"
}
},
{
"interestRate": "0.00",
"installmentNum": "12",
"interval": "MONTH",
"minInstallmentAmount": {
"currency": "BRL",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "BRL",
"value": "999999999900"
}
}
]

这段Markdown格式的文档表示了一组分期付款计划的详细信息，所有计划均以巴西雷亚尔（BRL）为货币单位，且无利息（interestRate为0.00）。每个计划包括以下要素：

1. 分期数（installmentNum）：从12个月到2个月不等。
2. 付款间隔（interval）：均为月（MONTH）。
3. 最低分期金额（minInstallmentAmount）：4000巴西雷亚尔。
4. 是否启用（enabled）：所有计划均启用。
5. 最高分期金额（maxInstallmentAmount）：999,999,999,900巴西雷亚尔。

请注意，这些计划可能适用于某种金融产品或服务，如信用卡分期或贷款，允许用户在一定范围内选择不同的分期数和金额进行支付。
"currency": "巴西雷亚尔",
"value": "999999999900"
}
},
{
"interestRate": "0.00%",
"installmentCount": "10",
"interval": "月",
"minInstallmentAmount": {
"currency": "巴西雷亚尔",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "巴西雷亚尔",
"value": "999999999900"
}
},
{
"interestRate": "0.00%",
"installmentCount": "11",
"interval": "月",
"minInstallmentAmount": {
"currency": "巴西雷亚尔",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "巴西雷亚尔",
"value": "999999999900"
}
},
{
"interestRate": "0.00%",
"installmentCount": "12",
"interval": "月",
"minInstallmentAmount": {
"currency": "巴西雷亚尔",
"value": "4000"
},
"enabled": true,
"maxInstallmentAmount": {
"currency": "巴西雷亚尔",
"value": "999999999900"
}
}
],
"supportedCardBrands": [
{
"logo": {
"logoName": "AMEX",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/7a0284b0-7577-493b-bc96-6809ec2f7f79.svg"
},
"cardBrand": "美国运通"
},
{
"logo": {
"logoName": "HIPERCARD",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/42079be8-2bdd-48a5-9da9-eb7e0917f349.svg"
},
"cardBrand": "Hipercard"
},
{
"logo": {
"logoName": "MASTERCARD",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/bc7cb991-c8e2-4379-945f-aadae2bdf932.svg"
},
"cardBrand": "万事达卡"
},
{
"logo": {
"logoName": "VISA",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/9/26/dfd471f3-da7d-4ef1-8486-cfa4301045c6.svg"
},
"cardBrand": "维萨卡"
},
{
"logo": {
"logoName": "ELO",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/b252dbb2-1da4-41a1-b796-21eea0d20d75.svg"
},
"cardBrand": "ELO"
}
]
},
"paymentOptionDetail": {
"fundingSource": [
"信用卡"
],
"supportedCardBrands": [
{
"logo": {
"logoName": "AMEX",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/7a0284b0-7577-493b-bc96-6809ec2f7f79.svg"
},
"cardBrand": "美国运通"
},
{
"logo": {
"logoName": "HIPERCARD",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/42079be8-2bdd-48a5-9da9-eb7e0917f349.svg"
},
"cardBrand": "Hipercard"
},
{
"logo": {
"logoName": "万事达卡",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/bc7cb991-c8e2-4379-945f-aadae2bdf932.svg"
},
"cardBrand": "万事达卡"
},
{
"logo": {
"logoName": "VISA",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/9/26/dfd471f3-da7d-4ef1-8486-cfa4301045c6.svg"
},
"cardBrand": "VISA"
},
{
"logo": {
"logoName": "ELO",
"logoUrl": "https://cdn.marmot-cloud.com/storage/2022/8/2/b252dbb2-1da4-41a1-b796-21eea0d20d75.svg"
},
"cardBrand": "ELO"
}
]
},
"logo": {
"logoName": "信用卡与借记卡",
"logoUrl": "https://gw.alipay.com/icon/medium/default/ALIPAY_GENERAL_CARD.svg"
},
"paymentMethodType": "CARD",
"enabled": true
},
{
"paymentMethodRegion": [
"BR"
],
"paymentMethodCategory": "结账",
"logo": {
"logoName": "Mercado Pago",
"logoUrl": "https://gw.alipay.com/antom/icon/medium/default/MercadoPagoCheckout.svg"
},
"paymentMethodType": "MERCADOPAGO_BR",
"enabled": true
},
{
"disableReason": "CURRENT_CHANNEL_NOT_EXIST",
"paymentMethodRegion": [
"CL"
],
"paymentMethodCategory": "结账",
"logo": {
"logoName": "Mercado Pago",
"logoUrl": "https://gw.alipay.com/antom/icon/medium/default/MercadoPagoCheckout.svg"
},
"paymentMethodType": "MERCADOPAGO_CL",
"enabled": false
},
{
"disableReason": "CURRENT_CHANNEL_NOT_EXIST",
"paymentMethodRegion": [
"MX"
],
"paymentMethodCategory": "结账",
"logo": {
"logoName": "Mercado Pago",
"logoUrl": "https://gw.alipay.com/antom/icon/medium/default/MercadoPagoCheckout.svg"
},
"paymentMethodType": "MERCADOPAGO_MX",
"enabled": false
},
{
"disableReason": "CURRENT_CHANNEL_NOT_EXIST",
"paymentMethodRegion": [
"PE"
],
"paymentMethodCategory": "结账",
"logo": {
"logoName": "Mercado Pago",
"logoUrl": "https://gw.alipay.com/antom/icon/medium/default/MercadoPagoCheckout.svg"
},
"paymentMethodType": "MERCADOPAGO_PE",
"enabled": false
}
]
}  
获取分期付款营销信息
------------------------
以下表格展示了免息分期付款的规则：
**卡片类型** | **分期付款能力** | **手续费收取方式** |
| --- | --- | --- |
| 巴西卡片 | 2到12期免息 | 不收取额外手续费 |
| 韩国卡片 | 免息规则每月更新 | 非免息时，买家在完成支付后可查看相应手续费。 |
  
**表5. 分期付款规则**

你可以通过以下两种方式获取韩国卡片的分期营销信息：

1. 通过官方网站检查免息分期信息，每月可以定期查看最新的[免息分期营销信息](https://global.alipay.com/docs/ac/antomop/koreancards#k6S6P)。
2. 调用[**咨询**](https://global.alipay.com/docs/ac/ams/consult) API 获取支付方式支持的分期免息规则。返回的分期信息包括支持的卡种（_bankName_），营销活动截止时间（_expireTime_）以及支持的免息分期数（_installmentFreeNums_）。

以下为**咨询** API 的代码示例：

```json
{
"result": {
"resultStatus": "S",
"resultCode": "SUCCESS",
"resultMessage": "success."
},
"paymentOptions": [
{
"paymentMethodRegion": [
"KR"
],
"paymentMethodCategory": "",
"logo": {
"logoName": "alipayHK",
"logoUrl": "https://resourcecenter-v2-internet-site-dev-s29001109997.alipay.net/antom/icon/medium/default/pix.svg"
},
"paymentMethodType": "alipayHK",
"enabled": true,
"promotionInfos": [{
"promotionType": "DISCOUNT",
"discount": {
"promotionName": "默认语言的营销文案",
"promotionTag": "即时优惠",
"estimateSavingsAmount": {
"currecny": "HKD",
"value": "500"
},
"cardInterestFree": null
},
{
"promotionType": "CARD_INTEREST_FREE",
"discount": null,
"cardInterestFree": {
"bankName": "HYUNDAI",
"expireTime": "2023-04-27T23:33:09-07:00",
"installmentFreeNums": [2,3,4],
```
分期付款初始化
-------------------

通过API或SDK集成分期付款的关键点如下：

### 分期间隔
分期间隔：**月(MONTH)**

### 支持货币
支持货币：**韩元(KRW)**

### 最低支付金额
- 货币：**韩元(KRW)**
- 值：**50000**

### 最高支付金额
- 货币：**韩元(KRW)**
- 值：**9999999**

### 禁用原因
禁用原因：**当前渠道不存在(CURRENT_CHANNEL_NOT_EXIST)**

### 支付方法区域
支付方法适用地区：**香港(HK)、泰国(TH)、韩国(KR)、菲律宾(PH)、印度尼西亚>ID)、中国(CN)、马来西亚(MY)**

### 支付方式标识
- 标志名称：**Alipay+**
- 标志URL：[https://cdn.marmot-cloud.com/storage/aplus-checkout-prod/icon/prod/CONNECT_WALLET.png](https://cdn.marmot-cloud.com/storage/aplus-checkout-prod/icon/prod/CONNECT_WALLET.png)

### 支付方法类型
支付方法类型：**连接钱包(CONNECT_WALLET)**

### 是否启用
是否启用：**否(false)**

### 初始化分期支付
通过API或SDK启动分期支付时，需要考虑以下步骤和要求：（此处应提供具体步骤和要求，但原文档中未给出详细信息）
### API 集成  
如果买家选择分期付款方式，您需要在开始支付前收集相关的分期信息，例如分期期数。然后在调用 **pay** API 时，通过 _creditPayPlan_ 对象传递分期信息。在 _creditPayPlan_ 对象中，关键字段是 _creditPayPlan.installmentNum_，它表示分期期数。该字段的值范围为 `2` 到 `12`。  
有关字段描述的更多信息，请参阅 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 文档。  
以下代码示例展示了调用 **pay** API 时的分期付款请求：  
复制  
```json
{
"settlementStrategy": {
"settlementCurrency": "USD"
},
"productCode": "CASHIER_PAYMENT",
"paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_online&paymentMethodType=CARD",
"paymentRequestId": "amsdmpay_zy236564_20231016_100559_577",
"paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_zy236564_20231016_100559_577",
"paymentFactor": {
"isAuthorization": true,
"asyncPay": false,
"captureMode": "MANUAL"
},
"paymentMethod": {
"paymentMethodMetaData": {
"cvv": "540",
"cardholderName": {
"firstName": "Tom",
"lastName": "Jerry"
},
"expiryMonth": "01",
"useStringType": false,
"billingAddress": {
"zipCode": "310000",
"address2": "Huanglong",
"city": "Hangzhou",
"address1": "Gongzhuan road",
"state": "Zhejiang",
"region": "CN"
},
"expiryYear": "28",
"cardNo": "4293380420642881"
},
"paymentMethodType": "CARD"
},
"creditPayPlan": {
"installmentNum": 2
},
"enableInstallmentCollection": true,
"paymentAmount": {
"currency": "BRL",
"value": "600"
},
"order": {
"orderAmount": {
"currency": "BRL",
"value": "600"
},
"referenceOrderId": "amsdmorder_zy236564_20231016_100559_577",
"goods": [
{
"referenceGoodsId": "amsdm_good_zy236564_20231016_100559_577",
"goodsUrl": "HangZhou LeiFenTa",
"goodsCategory": "card/ssr/adc",
```

请注意，以上代码示例并未完整显示，通常还会包含更多关于商品的详细信息。
"商品单位金额": {
"货币": "美元",
"值": "10000"
},
"商品数量": "1",
"商品名称": "商品1",
"商品SKU名称": "SKU1",
"商品品牌": "AMSDM"
}
],
"环境": {
"客户端IP": "1.1.1.1",
"操作系统类型": "IOS",
"终端类型": "WEB"
},
"扩展信息": "{}",
"订单描述": "AMSDM_GIFT",
"买方": {
"参考买家ID": "zy236564",
"买家注册时间": "2022-01-01T09:30:00+08:00",
"买家姓名": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
}
}
}
}  
> **注意**: 如果未通过字段`creditPayPlan`指定分期付款信息，付款将默认为非分期付款。
### SDK 集成
如果买家选择分期付款方式，您可以自行收集分期信息，也可以将收集工作委托给SDK。

#### 自行收集分期信息
如果您选择自行收集分期信息，需要在发起支付前从买家那里获取相关详细信息，例如分期数。然后在调用 **createPaymentSession** API 时，通过 `_creditPayPlan` 字段传递分期信息。在 `_creditPayPlan` 对象中，关键字段是 `_creditPayPlan.installmentNum`，它表示分期数。该字段的值范围为 `2` 到 `12`。

有关字段描述的更多信息，请参阅 [**createPaymentSession**](https://global.alipay.com/docs/ac/ams/session_cashier) API 文档。

当您自行收集分期信息时，发起支付请求的代码示例如下：

```json
{
"settlementStrategy": {
"settlementCurrency": "USD"
},
"productCode": "CASHIER_PAYMENT",
"paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_online&paymentMethodType=CARD",
"paymentRequestId": "amsdmpay20231016_100927_794",
"agreementInfo": {
"authState": "amsdemo_authState_zy236564_20231016_100927_794"
},
"paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_zy236564_20231016_100927_794",
"paymentFactor": {
"isAuthorization": true,
"asyncPay": false,
"captureMode": "MANUAL"
},
"paymentMethod": {
"paymentMethodType": "CARD"
},
"creditPayPlan": {
"installmentNum": 2
},
"enableInstallmentCollection":true,
"paymentAmount": {
"currency": "BRL",
"value": "6000"
},
"order": {
"orderAmount": {
"currency": "BRL",
"value": "6000"
},
"referenceOrderId": "amsdmorder_zy236564_20231016_100927_794",
"goods": [
{
"referenceGoodsId": "amsdm_good_zy236564_20231016_100927_794",
"goodsUrl": "HangZhou LeiFenTa",
```

请注意，以上代码示例中的 `goodsUrl` 后面的内容被省略了，通常会包含商品的详细信息或链接。
"商品类别": "卡片/SSR/ADC",
"商品单位金额": {
"货币": "USD",
"值": "10000"
},
"商品数量": "1",
"商品名称": "商品1",
"商品SKU名称": "SKU1",
"商品品牌": "AMSDM"
}
],
"环境": {
"客户端IP": "1.1.1.1",
"操作系统类型": "IOS",
"终端类型": "WEB"
},
"扩展信息": "{}",
"订单描述": "AMSDM_GIFT",
"买家": {
"参考买家ID": "zy236564",
"买家注册时间": "2022-01-01T09:30:00+08:00",
"买家姓名": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
}
}
}
}
如果您需要SDK收集分期付款信息，您在调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/session_cashier) API时需要将字段`_enableInstallmentCollection`设置为`true`。如果将`_enableInstallmentCollection`字段的值设置为`false`或留空，SDK默认不会收集分期信息。

当SDK收集分期信息时，发起支付请求的代码示例如下：
```json
{
"结算策略": {
"结算货币": "USD"
},
"产品代码": "CASHIER_PAYMENT",
"支付通知URL": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_online&paymentMethodType=CARD",
"支付请求ID": "amsdmpay20231016_100927_794",
"协议信息": {
"授权状态": "amsdemo_authState_zy236564_20231016_100927_794"
},
"支付重定向URL": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_zy236564_20231016_100927_794",
"支付因素": {
"是否授权": true,
"异步支付": false,
"捕获模式": "MANUAL"
},
"支付方式": {
"支付方式类型": "CARD"
},
"启用分期收集": true,
"支付金额": {
"货币": "BRL",
"值": "6000"
},
"订单": {
"订单金额": {
"货币": "BRL",
"值": "6000"
},
"参考订单ID": "amsdmorder_zy236564_20231016_100927_794",
"商品": [
{
"参考商品ID": "amsdm_good_zy236564_20231016_100927_794",
"商品链接": "杭州雷峰塔"
```
商品分类: "卡片/SSR/ADC"
商品单位金额: { 币种: "USD", 价值: "10000" }
商品数量: "1"
商品名称: "商品1"
商品SKU名称: "SKU1"
商品品牌: "AMSDM"
}
环境信息: { 客户端IP: "1.1.1.1", 操作系统类型: "IOS", 终端类型: "WEB" }
扩展信息: "{}"
订单描述: "AMSDM_GIFT"
购买者: { 引用买家ID: "zy236564", 买家注册时间: "2022-01-01T09:30:00+08:00", 买家姓名: { 名: "Dehua", 姓: "Liu", 全名: "Dehua Skr Liu", 中间名: "Skr" } }
}
在3D交易中提前收集设备和浏览器信息
======================================

在3D交易中提前收集设备和浏览器信息可以提升用户体验和支付成功率，通过增加无摩擦3D安全认证的可能性。

无论支付过程中使用哪种认证方法，您都需要收集设备和浏览器信息。这个收集过程会让用户等待，可能影响支付体验。通过此功能，用户在选择卡号后但在提交支付前，这些信息将被收集。这样就避免了用户在支付过程中等待，从而改善支付体验。

集成指南
------------

目前，此功能仅适用于API集成模式，并适用于以下场景之一：

1. 作为商家，您自己收集卡信息。
2. 作为商家，您使用卡令牌来接受支付。
### 步骤1：获取设备数据收集URL（服务器端）
在用户选择卡号但尚未提交支付时，调用**initializeAuthentication** API 来获取设备数据收集URL。由于收集信息需要时间，建议在用户选择支付方式时进行收集。
以下是一个请求消息的示例代码：
```json
{
  "authenticationRequestId": "202401abcdefg_sda_202404287_yf_gogo_23",
  "identityType": "CARD_PAN",
  "paymentRedirectUrl": "http://www.merchantsite.com",
  "authenticationType": "THREEDS",
  "identityValue": {
    "cardBrand": "VISA",
    "cardBin": "412408",
    "cardClass": "D"
  }
}
```
请求体中使用的键参数说明：
| **参数** | **描述** |
| --- | --- |
| authenticationRequestId | 用于与**initializeAuthentication**和**pay** API关联的唯一请求ID。 |
| identityType | 身份类型。有效值为：* `CARD_TOKEN`：使用Antom提供的卡令牌进行支付。 * `CARD_NT`：使用网络令牌进行支付。 * `CARD_PAN`：通过收集卡号进行支付。 |
| identityValue.cardToken | 当*identityType*的值为`CARD_TOKEN`时，指定相应的令牌。 |
| identityValue.cardBin | 当*identityType*的值为`CARD_NT`或`CARD_PAN`时，指定卡bin。 |
| identityValue.cardBrand | 当*identityType*的值为`CARD_NT`或`CARD_PAN`时，指定卡品牌。 |
| identityValue.funding | 当*identityType*的值为`CARD_NT`或`CARD_PAN`时，指定资金类型。 |

以下是一个响应消息的示例代码：
```json
{
  "authenticationId": "2024050716031241000190000162360",
  "authenticationRequestId": "202401abcdefg_sda_202404287_yf_gogo_24",
  "redirectActionForm": {
    "method": "POST",
```
响应体中的关键参数如下：

| **参数** | **描述** |
| --- | --- |
| actionForm.redirectUrl | 用于通过POST方式收集设备数据的URL。 |
| actionForm.parameters.ddcReferenceId | 支付方式ID。 |
| actionForm.parameters.JWT | 密码。 |
| actionForm.parameters.BIN | 卡片前缀（BIN号）。 |
### 步骤2: 收集设备数据 - 客户端  
在上一步的**initializeAuthentication** API响应中返回的 `_redirectUrl`，客户端通过发起POST请求来开始访问。  
以下是一个请求消息的示例代码：  
```markdown
Request request = new Request();
request.setMethod("POST");
request.setParameters("{\"ddcReferenceId\":\"af39d8b9-ff19-4013-a097-c54c8375efe2\",\"Bin\":\"412408\",\"JWT\":\"eyJraWQiOiJDQVJESU5BTF9KV1RfYWxpcGF5IiwiY3R5IjoiQ0FSRElOQUxfSldUX2FsaXBheSIsImFsZyI6IkhTMjU2In0.eyJPcmdVbml0SWQiOiI1ZDA5NDJmNmJiODc2ODE5NmMzMTYzYTciLCJSZWZlcmVuY2VJZCI6ImFmMzlkOGI5LWZmMTktNDAxMy1hMDk3LWM1NGM4Mzc1ZWZlMiIsIlJldHVyblVybCI6Im9wZW4tdGVzdC1kZS1ncm91cDIwMjQwNDE4MTQxNDEyLmRsLmFsaXBheWRldi5jb20vYXBpL29wZW4vdXJsX2NhbGxiYWNrX2dldC9jYXJkaW5hbC9jYXJkaW5hbDAwNy5odG0_c2lnbkRhdGE9UGJMendDMk9qYnJIRzNwJTJGOSUyRm1qV2ZCSE5WZmVObzRwJTJCR1NvV3JYNXJFZDY2T3RWVUI0VmNuaE1WcVdTQnZmR2NNdDRRV3pNbUFvek90UjgzRTlYNkVTZEpaRVdiQkQlMkZKS1ZjZHYlMkJpQlcxUHVmR0EzQWZtMGQ3M2lGWFZXNjlqT0ZzOTBqTCUyQm5qb0ZXQTRZWEklMkZ3UExwRVN3T2YlMkJscXhjbUNUVXlETFg2U3hJY0x3ZEF0Y2NZeG5oc0FaVmclMkZCMVFTdHl6diUyQk1sVEtXVUpzdmlYR0c4MDBFa3E5Q29YJTJGWjVNSnQlMkJZRG11WHBHZ0l6OUhKUmxrY0RxRGpySXUlMkY5VSUyRmpMa01VWWNoelJWYXNvdDZDY25uWG5FaktjSW1VeWw1ekxNdlE0Y2M1WGlPWElKdG5SdDdmNlZ3MnRacDNJWVVqMkM1Mld0bWh0JTJGejB4Z05abWlnJTNEJTNEJmluU2VyaWFsTm89MjAyNDA1MDcxNjAzMTM0MTAwMDE5MDAwMDE0NDU3MyZvdXRPcmRlck5vPTIwMjQwNTA3MTYwMzEzNDEwMDAxOTAwMDAxNDQ1NzMiLCJleHAiOjE3MTUwODE3MzgsImlhdCI6MTcxNTA4MDgzOCwiaXNzIjoiNWQwOTQ4MDlhZmE4MGQyMjUwMDQyODBkIiwianRpIjoiMjAyNDA1MDcxNjAzMTM0MTAwMDE5MDAwMDE0NDU3MyJ9.upNHVxubLYrAGzRWUhIM19v9kZ6yPyrR_JG4H54BWAU\"}");
request.setRedirectUrl("https://centinelapistag.cardinalcommerce.com/V1/Cruise/Collect");
request.process();
```
为了提供更好的用户体验，建议您执行以下操作：
*   通过iframe在当前页面生成一个像素点页面，用于加载信息收集链接，提供无缝且优化的支付体验。
*   将收集过程延长至两秒以上，以获取更多信息。
### 步骤3：收集浏览器信息（客户端）
下表列出了信息收集的关键参数：

| **参数** | **描述** |
| --- | --- |
| colorDepth | 购物者浏览器的颜色深度，以每像素位数表示。需要通过浏览器的screen.colorDepth属性获取。接受的值：1, 4, 8, 15, 16, 24, 30, 32 或 48 位颜色深度。 |
| screenHeight | 购物者设备屏幕的总高度（像素）。 |
| screenWidth | 购物者设备屏幕的总宽度（像素）。 |
| timeZoneOffset | 与协调世界时（UTC）之间的时差，以分钟为单位。 |
| acceptHeader | 购物者浏览器的接受头值。 |
| javaEnabled | 布尔值，表示购物者的浏览器是否能够执行Java。 |
| javaScriptEnabled | 布尔值，表示购物者的浏览器是否能够执行JavaScript。如果字段未提供，则默认为'true'。 |
| language | 购物者浏览器的navigator.language值（根据IETF BCP 47定义）。 |
| userAgent | 购物者浏览器的用户代理值。 |
### 步骤4：发起支付 - 服务器端
在**pay** API中指定初始化认证请求的`initializeAuthentication.request.authenticationRequestId`，以关联步骤1，并提供9项浏览器信息。以下是请求消息的示例：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "EUR"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_dev&paymentMethodType=CARD",
  "paymentRequestId": "amsdmpay_yanfei_wzh_20240428_191505_xx_022",
  "paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_yanfei_wzh_20240111_191505_666",
  "paymentFactor": {
    "isAuthorization": true
  },
  "paymentMethod": {
    "paymentMethodMetaData": {
      "authenticationRequestId": "2024051419401080010018896022321932",
      "identityType": "CARD_PAN",
      "cvv": "682",
      "cardholderName": {
        "firstName": "Tom",
        "lastName": "Jerry"
      },
      "expiryMonth": "11",
      "expiryYear": "28",
      "billingAddress": {
        "zipCode": "310000",
        "address2": "Huanglong",
        "city": "Hangzhou",
        "address1": "Gongzhuan road",
        "state": "Zhejiang",
        "region": "CN"
      },
      "cardNo": "4124085486814126"
    },
    "paymentMethodType": "CARD"
  },
  "paymentAmount": {
    "currency": "EUR",
    "value": "7000"
  },
  "order": {
    "orderAmount": {
      "currency": "EUR",
      "value": "7000"
    },
    "referenceOrderId": "amsdmorder_yanfei_wzh_20240111_191505_666",
    "goods": [
      {
        "referenceGoodsId": "amsdm_good_yanfei_wzh_20240111_191505_666",
        "goodsUrl": "HangZhou LeiFenTa",
        "goodsCategory": "card/ssr/adc",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "10000"
        },
        "goodsQuantity": "1",
        "goodsName": "商品1",
        "goodsSkuName": "SKU1",
        "goodsBrand": "AMSDM"
      }
    ],
    "env": {
      "clientIp": "1.1.1.1",
      "terminalType": "WEB",
      "osType": "IOS",
      "browserInfo": {
        "acceptHeader": "AcceptHeaded111",
        "javaEnabled": true,
        "javaScriptEnabled": false,
        "language": "EN",
        "userAgent": "agentagentagentagentagent"
      },
      "colorDepth": "12",
      "screenHeight": "50",
      "screenWidth": "50",
      "timeZoneOffset": "8"
    }
  }
}
```

这段JSON数据表示了一个支付请求，包括结算策略、产品代码、支付通知URL、支付请求ID、重定向URL、支付方式、支付金额、订单详情（包括商品信息）以及环境信息（如客户端IP、操作系统类型、浏览器信息等）。
请求体中的关键参数：

| **参数** | **描述** |
| --- | --- |
| paymentMethod.paymentMethodMateData.authenticationRequestId | 与步骤1关联的唯一请求ID。 |
| pay.env.browserInfo | 浏览器信息。 |
| pay.env.colorDepth | 颜色深度。 |
| pay.env.screenHeight | 屏幕高度。 |
| pay.env.screenWidth | 屏幕宽度。 |
| pay.env.timeZoneOffset | 时区偏移量。 |

以下是一个响应消息的示例：

```json
{
  "normalUrl": "https://iopensandbox-sea.alipay.com/xmock.json?xmockUrl=/api/Shadow/Channel/CHECKOUT/threeDS.htm/20240514890313000045C6835316965/false",
  "paymentActionForm": "{\"method\":\"POST\",\"paymentActionFormType\":\"RedirectActionForm\",\"redirectUrl\":\"https://iopensandbox-sea.alipay.com/xmock.json?xmockUrl=/api/Shadow/Channel/CHECKOUT/threeDS.htm/20240514890313000045C6835316965/false\"}",
  "paymentAmount": {
    "currency": "EUR",
    "value": "30000"
  },
  "paymentCreateTime": "2024-05-14T01:47:22-07:00",
  "paymentId": "202405141940108001001885C0204760163",
  "paymentRequestId": "PAY_2023154767445445328",
  "paymentResultInfo": {
    "avsResultRaw": "",
    "cardBrand": "VISA",
    "cardNo": "************8888",
    "cvvResultRaw": "",
    "networkTransactionId": "20240514890313000045C6835316965",
    "threeDSResult": {
      "cavv": "",
      "eci": ""
    }
  },
  "redirectActionForm": {
    "method": "POST",
    "redirectUrl": "https://iopensandbox-sea.alipay.com/xmock.json?xmockUrl=/api/Shadow/Channel/CHECKOUT/threeDS.htm/20240514890313000045C6835316965/false"
  },
  "result": {
    "resultCode": "PAYMENT_IN_PROCESS",
    "resultMessage": "处理中",
    "resultStatus": "U"
  }
}
```

这个响应包含了支付的相关信息，如支付金额、创建时间、支付ID、支付请求ID、支付结果信息（包括卡品牌、卡号、3DS结果等），以及重定向信息，表明支付正在处理中。
**注意：** 提前收集设备数据和浏览器信息可以提高3D Secure验证无摩擦的可能性，但并不能确保生成的3D Secure链接始终无摩擦。用户可能仍需要进行3D Secure验证。  
**适用范围：**  
* 适用模式：通过API集成。
* 适用地区：欧洲、英国、新加坡、香港、巴西、秘鲁、墨西哥和智利  
要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。  
![图片8](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片9](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 本页面内容  
[设置3D验证](#AopvT "设置3D验证")  
[智能交易挽救](#wSSDx "智能交易挽救")  
[增值风险控制服务](#VHeax "增值风险控制服务")  
[AVS检查](#AQlWl "AVS检查")  
[发起支付](#UMPDE "发起支付")  
[API集成](#kanW0 "API集成")  
[SDK集成](#k85nA "SDK集成")  
[接收支付结果通知](#lh7Rh "接收支付结果通知")  
[常见问题](#5CSHw "常见问题")  
[1. 如果为billingAddress指定错误的值，交易会失败吗？](#N86oC "1. 如果为billingAddress指定错误的值，交易会失败吗？")  
[2. 如何理解avsResultRaw中不同枚举值的含义？](#jo16j "2. 如何理解avsResultRaw中不同枚举值的含义？")
**如果我已经存储了支付和账单地址信息，是否还需要在信息收集页面上收集这些信息？**

**卡片信息存储**

**API集成**

**SDK集成**

**MIT**

**指定卡片品牌**

**MPI**

**分期付款**

**获取卡片品牌的分期信息**

**获取分期营销信息**

**发起分期付款**

**API集成**

**SDK集成**

**在3D交易中提前收集设备和浏览器信息**

**集成指南**

**步骤1：获取设备数据收集URL**

**步骤2：收集设备数据**

**步骤3：收集浏览器信息**

**步骤4：发起支付**

**适用范围**