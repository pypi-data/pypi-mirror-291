Android | EasySafePay | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Feasypay_en%2Fandroid_en)  
[返回首页](../../)  
EasySafePay  
[概述](/docs/ac/easypay_en/overview_en)  
接收支付  
支付后操作  
Android
=======

在这个主题中，你将学习如何在Android客户端集成SDK，以便在移动应用中渲染收银台页面。无缝体验和重定向体验的集成过程相同。

先决条件
在集成SDK之前，请确保已完成以下任务：

1. 安装最新版本的Android Studio。
2. 目标至少为Android 4.4（API级别19）或更高。
3. 使用Gradle 4.1或更早版本。
4. 配置物理设备或模拟器以运行你的应用程序。

关键集成步骤
无论是首次支付还是后续支付，按照以下步骤集成SDK：

1. 集成SDK包
   客户端
   请参考[Integrate the SDK Package](https://global.alipay.com/docs/ac/antom_sdk/android_en?expiry=1711418202657&preview=page&signature=K2pOH%2FM0us2EKhhHBnlhonUSbCU%3D)来集成SDK包。
2. 显示可用支付方式
   客户端
   使用[工具](https://global.alipay.com/docs/ac/ref/brandasset)获取可用的支付方式，自定义其图标，并在你的收银台页面上显示它们。
对于首次支付，建议展示可用支付方式的名称和图标。对于后续支付，建议显示这些支付方式的名称和图标，以及脱敏的买家账户信息。

![图片3：Android](https://mdn.alipayobjects.com/huamei_1vxa1o/afts/img/A*MgHwQL2O1NUAAAAAAAAAAAAADjeBAQ/original)

3. 使用`AMSEasyPay`创建SDK实例：

客户端操作：
创建SDK实例的步骤如下：

1. 创建一个`配置`对象：这是必需的。对象必须包含以下所有配置参数：
   * `setLocale`：可选字符串，商户客户端用以识别买家浏览器的语言。设置此参数以确保SDK以正确语言显示页面。有效值如下。如果传递其他值，将默认使用英语。
   * `locale("en", "US")`：英语
   * `locale("in", "ID")`：印度尼西亚语
   * `locale("th", "TH")`：泰语
   * `locale("ms", "MY")`：马来西亚语
   * `locale("tl", "PH")`：菲律宾语
   * `locale("ko", "KR")`：韩语
   * `locale("vi", "VN")`：越南语
   * `locale("zh", "HK")`：繁体中文（中国香港）
   * `setOption`：可选，用于指定是否使用默认加载模式和沙盒环境。有效值为：
     * `"sandbox", "true"`：沙盒环境
     * `"sandbox", "false"`：生产环境
     * `"showLoading", "true"`：使用默认加载模式。
     * `"showLoading", "false"`：不使用默认加载模式。
     * `"windowGravity","LANDSCAPE_CENTER"`：横屏模式下居中窗口。
     * `"windowGravity","LANDSCAPE_RIGHT"`：横屏模式下窗口靠右对齐。

2. 创建一个`onCheckoutListener`接口的实例，用于后续过程中的事件处理。该接口包含以下方法：
*   `onEventCallback`：必需。一个回调函数，用于监听结账页面上的支付事件，返回`eventCode`和`eventResult`。

3.  将**onCheckoutListener**接口的实例设置到配置对象中，以执行事件回调。

4.  实例化`AMSEasyPay`方法。  
**注意：** 为了提高组件性能和用户体验，您可以在调用**createPaymentSession** API之前预先创建组件实例。  
创建实例：  
Java  
1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
// 步骤1：创建  
AMSEasyPayConfiguration  
类型的实例。  
AMSEasyPayConfiguration  
configuration = new  
AMSEasyPayConfiguration();  
configuration.setLocale(new  
Locale("en", "US"));  
// 设置showLoading为true  
（默认值）以使用默认加载模式。  
设置为false以根据  
onEventCallback自定义加载  
动画。  
configuration.setOption  
("showLoading", "true");  
// 设置沙盒环境。  
如果不设置，将默认使用  
生产环境。  
configuration.setOption  
("sandbox", "true");  
// 横屏模式下居中显示，  
否则不设置时靠右显示。  
configuration.setOption  
("windowGravity",  
"LANDSCAPE_CENTER");  
// 设置监听结账页面支付  
事件的回调。  
configuration  
.setOnCheckoutListener(new  
OnCheckoutListener() {  
@Override  
public void onEventCallback  
(String eventCode,  
AMSEventResult  
eventResult) {  
if("SDK_PAYMENT_CANCEL"  
.equals(eventCode  
)){  
// 添加交互提示。  
}  
Toast.makeText(activity  
, "eventCode=" +  
eventCode + "  
message=" + eventResult.getMessage()  
, Toast.LENGTH_SHORT).show();  
}  
});  
// 实例化AMSEasyPay。  
在每次调用  
createPaymentSession API请求之前，  
创建一个新的AMSEasyPay组件。  
AMSEasyPay checkout = new  
AMSEasyPay.Builder(activity  
, configuration).build();
请注意：
1. 不要遗漏任何内容
2. 翻译要简洁明了

---

创建支付会话
向支付宝服务器发送一个[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)请求。

服务器端
在用户选择支付方式并触发支付按钮点击事件后，您的服务器应发送一个[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)请求。从createPaymentSession响应中获取paymentSesssionData值，用于步骤5。

首次支付与后续支付：
调用**createPaymentSession** API时，根据是首次支付还是后续支付，需要提供不同的参数：

**首次支付：**
*   _paymentRedirectUrl_：商家结果页面的URL。建议使用scheme URL或H5-scheme URL。
*   _authState_：商家生成的用于启动EasySafePay授权的唯一ID。指定此参数以获取未来免密支付的访问令牌。
*   _paymentNotifyUrl_：接收支付结果通知的URL。必须是HTTPS URL。
*   _paymentSessionExpiryTime_：支付会话过期的日期和时间。默认为1小时，但不能超过1小时。值遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式，例如："2019-11-27T12:01:01+08:00"。
*   _userLoginId_：用户在钱包中注册时使用的登录ID。登录ID可以是用户的电子邮件地址或电话号码。
**订单信息与买家信息**

*   `_order.buyer.referenceBuyerId/buyerPhoneNo/buyerEmail_`: 用于提供支付宝进行风险控制策略的买家信息。请传入三个参数之一：`_referenceBuyerId_`, `_buyerPhoneNo_`, 或 `_buyerEmail_`。

**后续支付**

*   `_paymentMethod.paymentMethodId:` 对于首次支付，传入从**notifyAuthorization** API 获取的`_accessToken_`。
*   `_paymentRedirectUrl_`: 商家结果页面的URL，建议使用scheme URL或H5-scheme URL。
*   `_paymentNotifyUrl_`: 接收支付结果通知的URL，必须是HTTPS URL。
*   `_paymentSessionExpiryTime_`: 支付会话过期的时间。默认为1小时，但不能超过1小时。遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准格式，例如 "2019-11-27T12:01:01+08:00"。
*   `_order.buyer.referenceBuyerId/buyerPhoneNo/buyerEmail_`: 用于提供支付宝进行风险控制策略的买家信息。请传入三个参数之一：`_referenceBuyerId_`, `_buyerPhoneNo_`, 或 `_buyerEmail_`。

**首次支付**

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId001",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "agreementInfo": {
    "authState": "authState001",
    "userLoginId": "userLoginId001"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "100"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "100"
    },
    "referenceOrderId": "referenceOrderId001",
    // ...其他订单相关参数
  }
}
```

请注意，上述JSON示例可能不完整，实际使用时需要根据具体业务需求添加其他必要的参数。
订单描述：
订单描述001

买家信息：
参考买家ID：referenceBuyerId001

以下内容为后续支付的JSON格式：

结算策略：
结算货币：USD

产品代码：AGREEMENT_PAYMENT
产品场景：EASY_PAY
支付通知URL：https://www.yourNotifyUrl
支付请求ID：paymentRequestId002
支付重定向URL：https://www.yourMerchantWeb.com
支付方式：
支付方式ID：************（星号表示隐藏的具体ID）
支付方式类型：ALIPAY_CN

支付金额：
货币：CNY
金额：30000

订单信息：
订单金额：
货币：CNY
金额：30000
参考订单ID：referenceOrderId002
订单描述：订单描述002
买家：
参考买家ID：referenceBuyerId002

请注意，上述内容是示例JSON格式，用于描述一个支付交易的详细信息。在实际应用中，星号(*) 部分通常代表敏感信息，如用户ID或支付方式ID，需要在实际处理时进行加密或隐藏。
呈现支付页面

客户端

AMSEasyPay 组件不可复用。在每次调用 **createPaymentSession** API 之前，都需要创建一个新的 AMSEasyPay 组件。

在配置对象中调用 `createComponent()` 方法，并传入以下参数：

*   _activity_：必需的对象，属于 _Activity_ 类型。用于包含当前页面上下文参数的信息。
*   _sessionData_：必需的字符串。将步骤 4 中获取的 _paymentSessionData_ 值传递给 `createComponent` 方法的 _sessionData_ 参数。

在以下情况下调用 `onDestroy()` 方法以释放 SDK 组件资源：

*   当用户离开结账页面时，释放 **createPaymentSession** 中创建的组件资源。
*   当用户发起多次支付时，释放之前 **createPaymentSession** 中创建的组件资源。

重新创建 AMSEasyPay：

Java
```java
// 实例化 AMSEasyPay。
// 在每次调用 createPaymentSession API 请求之前创建新的 AMSEasyPay 组件。
if (checkout != null) {
    // 释放 SDK 组件资源。
    checkout.onDestroy();
}
checkout = new AMSEasyPay.Builder(activity, configuration).build();
```
请注意，由于原文档中存在非英文字符，它们可能是由于复制粘贴过程中的格式错误。在上述翻译中，这些字符已被忽略，因为它们看起来像是重复的分隔符。如果这些字符在原始文档中有特定含义，请提供更多信息以便进行准确翻译。
调用创建组件方法：  
Java  
1  
checkout.createComponent  
(activity, sessionData);  

获取授权或支付结果  
服务器端  
无论是无缝体验还是重定向体验，对于首次支付，您可以获取授权结果和支付结果；对于后续支付，仅获取支付结果：  
*   **获取授权结果**
当授权成功时，支付宝会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth)通知向您发送异步消息。收到通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。同时，您需要在您的系统中更新买家的授权状态，并在授权管理页面上显示从通知中获取的买家脱敏账户信息。
*   **获取支付结果**
当支付达到最终的成功或失败状态时，支付宝会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API 向您通过[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay) API 传递的_paymentNotifyUrl_ 发送异步通知。当您收到支付宝的通知时，必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。

**注意**：如果买家放弃支付后，您调用了**[inquiryPayment](https://global.alipay.com/docs/ac/ams/paymentri_online)** API 和 **[cancel](https://global.alipay.com/docs/ac/ams/paymentc)** API，可能会收到订单不存在的响应，并且可能不会收到支付失败的异步通知。我们建议您采取以下行动：

对于您主动关闭的订单：
* 如果收到支付宝的成功支付通知，无需进一步操作。
* 如果收到支付宝的订单状态未知的通知，调用 **[cancel](https://global.alipay.com/docs/ac/ams/paymentc)** API 取消相应的订单。

对于重复支付（一个商家订单对应多个支付宝订单），如果您已收到多个支付宝订单的成功支付通知，保留一个成功结果的支付宝订单，使用 **[cancel](https://global.alipay.com/docs/ac/ams/paymentc)** API 取消其余的支付宝订单。

事件代码
SDK 提供以下状态代码：
* `SDK_START_OF_LOADING`：在创建支付组件时，加载动画开始播放。
* `SDK_END_OF_LOADING`：在创建支付组件时，加载动画结束。
* `SDK_PAYMENT_CANCEL`：用户在账户确认页面或大额交易确认页面上取消支付。
SDK 提供以下错误代码：

*   `SDK_INTERNAL_ERROR`: SDK 内部错误发生。请联系支付宝技术支持以解决问题。
*   `SDK_CREATEPAYMENT_PARAMETER_ERROR`: 传递给 `AMSEasyPay` 方法的参数不正确。确保参数传递正确并重新发送请求。
*   `SDK_CALL_URL_ERROR`: 支付方式客户端撤销失败。请联系支付宝技术支持以解决问题。
*   `SDK_INTEGRATION_ERROR`: 未找到依赖项。确保正确添加依赖项并重新尝试集成过程。

集成关键步骤代码示例

以下代码示例展示了集成过程中的关键步骤：

```java
// 步骤 1: 创建 AMSEasyPayConfiguration 类型
AMSEasyPayConfiguration configuration = new AMSEasyPayConfiguration();
configuration.setLocale(new Locale("en", "US"));

// 设置 showLoading 为 true（默认值）以使用默认加载模式。
// 设置为 false 以根据 onEventCallback 自定义加载动画。
configuration.setOption("showLoading", "true");

// 设置沙箱环境。如果不设置，将默认使用生产环境。
configuration.setOption("sandbox", "true");

// 设置监听结账页面支付事件的回调。
configuration.setOnCheckoutListener(new OnCheckoutListener() {
    @Override
    public void onEventCallback(String eventCode, AMSEventResult eventResult) {
        if ("SDK_PAYMENT_CANCEL".equals(eventCode)) {
            // 添加交互提示
        }
        Toast.makeText(activity, "eventCode=" + eventCode + " message=" + eventResult.getMessage(), Toast.LENGTH_SHORT).show();
    }
});

// 实例化 AMSEasyPay。在每次调用 createPaymentSession API 请求之前创建一个新的 AMSEasyPay 组件。
```

请注意，这段代码是 Java 语言，用于展示与支付宝 SDK 集成的关键步骤，包括设置环境、回调监听和实例化 `AMSEasyPay`。
AMSEasyPay 支付实例 = new AMSEasyPay.Builder(  
活动,  
配置).build();  
// 步骤 2：后端处理：调用创建支付会话 API。  
String 会话数据 = 创建会话数据()  
// 步骤 3：启动支付并将 sessionData 传递给前端组件。  
checkout.createComponent(  
活动,  
会话数据);  
// 步骤 4：当用户退出商家页面时调用 onDestroy() 方法。  
checkout.onDestroy(  
活动,  
会话数据);  

#######################################################

此页面是否有帮助？  
要查看文档的最新更新，请访问 [发行说明](https://global.alipay.com/docs/releasenotes)。  
![图片 4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)