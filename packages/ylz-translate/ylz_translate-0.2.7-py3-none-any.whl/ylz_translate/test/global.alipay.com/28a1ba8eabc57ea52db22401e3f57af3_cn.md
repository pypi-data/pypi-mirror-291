签署请求和验证签名 | 产品API | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fams%2Fdigital_signature)  
[返回首页](../../)

产品API
[支付宝API](/docs/ac/ams/api)  
[概览](/docs/ac/ams/api_fund)  
[幂等性](/docs/ac/ams/idempotency)  
[消息编码](/docs/ac/ams/me)  
[签署请求和验证签名](/docs/ac/ams/digital_signature)  
[API变更历史](/docs/ac/ams/changehistory)  
在线支付
店内支付
签署请求和验证签名
=======================================

2024-05-13 07:49

为了确保数据传输后的真实性与完整性，支付宝要求所有请求必须签名，并验证签名：

*   调用API时，必须对发送给支付宝的请求进行签名，并相应地验证支付宝响应的签名。详情见[调用API](#wPgXI)。
*   接收到通知时，必须验证支付宝请求的签名。但不需要对通知的响应进行签名。详情见[接收通知](#WMRu5)。

调用API
==========

前提条件
------------

要签署请求，需要使用RSA2方法生成一对非对称公钥和私钥。您可以在[蚂蚁开放平台仪表盘](https://global.alipay.com/docs/dashboard_en)上下载工具来获取一对非对称密钥。
私钥用于生成请求的签名，您需要在**集成设置**下的**设置公钥**部分提交非对称的公钥。支付宝使用公钥来验证您的请求签名。

签署请求
----------

以下图示展示了如何签署请求：

![图3: image.png](https://idocs-assets-marmot-cloud-com-storage-idocs87c36dc8dac653c1/1664440939174-81dee3b9-1fe5-426c-ae5f-1ef47e716c00.png)

图2. 请求签名流程
### 步骤1：构建待签名内容  
`Content_To_Be_Signed` 的语法如下：  
复制  
`<HTTP-方法> <HTTP-URI>`  
`<Client-Id>.<请求时间>.<请求正文>`  
*   `HTTP-方法`: POST
*   `HTTP-URI`: 例如，如果HTTP URL是 [https://open-na-global.alipay.com/ams/api/v1/payments/pay](https://open-na-global.alipay.com/ams/api/v1/payments/pay)，此字段为 `/ams/api/v1/payments/pay`。
*   `Client-Id`: 用于标识客户端。例如，`TEST_5X00000000000000`。你可以从请求头中获取此字段。
*   `请求时间`: 指定请求发送的时间戳。此字段的值必须精确到毫秒。例如，`1685599933871`。你可以从请求头中获取时间戳。
*   `请求正文`: 请求的数据体。例如：  
复制  
```json
{
  "order": {
    "orderId": "OrderID_0101010101",
    "orderDescription": "sample_order",
    "orderAmount": {
      "value": "100",
      "currency": "JPY"
    }
  }
}
```
按照 `Content_To_Be_Signed` 的语法，上述请求正文将构建为：  
复制  
`POST /ams/api/v1/payments/pay`  
`TEST_5X00000000000000.2019-05-28T12:12:12+08:00.`  
```json
{
  "order": {
    "orderId": "OrderID_0101010101",
    "orderDescription": "sample_order",
    "orderAmount": {
      "value": "100",
      "currency": "JPY"
    }
  }
}
```
### 步骤2：生成签名  
生成签名的语法如下：  
复制  
generatedSignature=base64UrlEncode(sha256withrsa(<待签名内容>), <私钥>)  
*   `sha256withrsa`：用于对提供的内容生成数字签名的方法
*   `base64UrlEncode`：对生成的数字签名进行编码的方法
*   `Content_To_Be_Signed`：从[步骤1](#Adgbs)获取的内容
*   `privateKey`：从[前提条件](#ebihb)获取的私钥值  
生成签名的一个示例如下：  
复制  
KrwDE9tAPJYBb4cUZU6ALJxGIZgwDXn5UkFPMip09n%2FkYKPhEIII%2Fki2rYY2lPtuKVgMNz%2BtuCU%
2FjzRpohDbrOd8zYriiukpGAxBQDIVbatGI7WYOcc9YVQwdCR6ROuRQvr%2FD1AfdhHd6waAASu5Xugow9
w1OW7Ti93LTd0tcyEWQYd2S7c3A73sHOJNYl8DC1PjasiBozZ%2FADgb7ONsqHo%2B8fKHsLygX9cuMkQY
TGIRBQsvfgICnJhh%2BzXV8AQoecJBTrv6p%xxxx  

以下代码示例展示了如何使用Java对请求进行签名：  
复制  
```java
/**
*
* @param requestURI // 域名部分不包含，示例：/ams/api/v1/payments/pay
* @param clientId
* @param requestTime
* @param privateKey
* @param requestBody
* @return
*/
public static String sign(String requestURI, String clientId, String requestTime,
String privateKey, String requestBody) {  
String content = String.format("POST %s\n%s.%s.%s", requestURI, clientId, requestTime,
requestBody);  
try {
java.security.Signature signature = java.security.Signature
.getInstance("SHA256withRSA");  
PrivateKey priKey = KeyFactory.getInstance("RSA").generatePrivate(
new PKCS8EncodedKeySpec(Base64.decodeBase64(privateKey.getBytes("UTF-8"))));  
signature.initSign(priKey);
signature.update(content.getBytes("UTF-8"));  
byte[] signed = signature.sign();  
return URLEncoder.encode(new String(Base64.encodeBase64(signed), "UTF-8"), "UTF-8");
} catch (Exception e) {
throw new RuntimeException(e);
}
}
```
请注意，这里的代码示例使用了Java的内置库来实现签名过程，包括对私钥的解码、签名的生成和编码。
### 步骤3：将生成的签名添加到请求头中  
1. 根据以下语法组装签名字符串：  
   复制  
   `'Signature: algorithm=<算法>, keyVersion=<密钥版本>, signature=<生成的签名>'`  
   *   `algorithm`, `keyVersion`: 查看[消息结构](https://global.alipay.com/docs/ac/ams/api_fund#ML5ur)章节的头部信息。
   *   `generatedSignature`: 在[步骤2](#gNWs0)中生成的签名。  
   例如：  
   复制  
   `'Signature: algorithm=RSA256, keyVersion=1, signature=KrwDE9tAPJYBb4cUZU6ALJxGIZgwDXn5UkFPMip09n%2FkYKPhEIII%2Fki2rYY2lPtuKVgMNz%2BtuCU%2FjzRpohDbrOd8zYriiukpGAxBQDIVbatGI7WYOcc9YVQwdCR6ROuRQvr%2FD1AfdhHd6waAASu5Xugow9w1OW7Ti93LTd0tcyEWQYd2S7c3A73sHOJNYl8DC1PjasiBozZ%2FADgb7ONsqHo%2B8fKHsLygX9cuMkQYTGIRBQsvfgICnJhh%2BzXV8AQoecJBTrv6p%****'`  
2. 将签名字符串添加到请求头中。关于请求头的详细信息，请参阅[消息结构](https://global.alipay.com/docs/ac/ams/api_fund#ML5ur)章节。  

### 发送请求
----------------  
通过在请求头中添加`Client-Id`, `Request-Time`, 和 `Signature` 属性来构建请求。构建好请求后，可以使用常见的工具，如cURL或Postman来发送请求。以下是一个使用cURL的例子：  
复制  
```bash
curl -X POST \
https://www.example.com/ams/api/v1/payments/pay \
-H 'Content-Type: application/json' \
-H 'Client-Id: TEST_5X00000000000000' \
-H 'Request-Time: 1685599933871' \
-H 'Signature: algorithm=RSA256, keyVersion=0, signature=KrwDE9tAPJYBb4cUZU6ALJxGIZgwDXn5UkFPMip09n%2FkYKPhEIII%2Fki2rYY2lPtuKVgMNz%2BtuCU%2FjzRpohDbrOd8zYriiukpGAxBQDIVbatGI7WYOcc9YVQwdCR6ROuRQvr%2FD1AfdhHd6waAASu5Xugow9w1OW7Ti93LTd0tcyEWQYd2S7c3A73sHOJNYl8DC1PjasiBozZ%2FADgb7ONsqHo%2B8fKHsLygX9cuMkQYTGIRBQsvfgICnJhh%2BzXV8AQoecJBTrv6p%xxxx' \
-d '{
"order":{
"orderId":"OrderID_0101010101",
"orderDescription":"sample_order",
"orderAmount":{
"value":"100",
"currency":"JPY"
}
},
"paymentAmount":{
"value":"100",
"currency":"JPY"
},
```

请注意，请求体中的内容被截断了，通常会继续包含支付金额的详细信息。
"支付因子": { "是否店内支付": "true" }
}  
处理响应
-----------------
在收到支付宝的响应后，需要验证响应的签名。以下图示展示了如何验证签名：  
![图片 4: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1664441017739-e31cc973-7ae2-4028-b819-d90c8df65bd8.png)  
图3. 验证签名的步骤  
响应由响应头和响应体两部分组成。例如：  
*   响应头的代码示例：  
```  
Client-Id: 5X00000000000000 Response-Time: 2019-05-28T12:12:14+08:00 signature: algorithm=RSA256, keyVersion=0, signature=p9T2hXxIjek0UOLw3fwlthNsV6ATaioIvu8X1uFx8a9tE87d2XEhqylnf0KjifJ3WhCoMoklGwwlDS3tsSenwnL0Ha6BsXbJvUHRC5qcVlNy5Oq%2FpNqx2%2BKdwbw4eY7tZBDQhMKoaMVSbqbCb3eRBXsw9ZwOO%2FFCyq1zICzllOd4pbhpvES3gcw2X%2B0Ye4hQJBghcLCJxCizSv9lMyTmV%2BYA39B9gRouhaN0dM2aeAXMlVJAWtJdcL%2Bdub%2F3LrzxBnY%****  
```  
*   响应体的代码示例：  
```  
{ "result": { "resultCode":"SUCCESS", "resultStatus":"S", "resultMessage":"success" } }  
```  
以下步骤展示了如何使用上述示例处理支付宝的响应。
### 步骤1：获取支付宝公钥  
通过[Antom仪表板](https://global.alipay.com/docs/dashboard_en) > **开发者** > **快速入门** > **集成资源和工具** > **集成资源** 来获取支付宝公钥。  
> **注意：** 只有当你在Antom仪表板上上传你的非对称公钥后，你才能获取用于验证支付宝相应响应的支付宝公钥。
### 步骤2：构建验证内容  
`Content_To_Be_Validate` 的语法如下：  
复制  
<HTTP-方法> <HTTP-URI>  
<Client-Id>.<响应时间>.<响应正文>  
*   `HTTP-方法`：POST
*   `HTTP-URI`：例如，如果HTTP URL是[https://open-na-global.alipay.com/ams/api/v1/payments/pay](https://open-na-global.alipay.com/ams/api/v1/payments/pay)，则此字段为`/ams/api/v1/payments/pay`。
*   `Client-Id`：用于标识客户端。您可以从响应头中获取此字段。
*   `响应时间`：指定返回响应的时间，按照[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)定义。此字段必须精确到毫秒，例如`2019-05-28T12:12:14+08:00`。您可以从响应头中获取此字段。
*   `响应正文`：响应的数据体。  

按照 `Content_To_Be_Validated` 的语法，构建上述响应如下：  
复制  
POST /ams/api/v1/payments/pay  
TEST_5X00000000000000.2019-05-28T12:12:14+08:00.{
"result": {
"resultCode":"SUCCESS",
"resultStatus":"S",
"resultMessage":"success"
}
}
### 步骤3：从响应头获取签名  
目标签名字符串（`target_signature`）可以从响应头中的`Signature`字段提取。有关响应头的详细信息，请参阅[消息结构](https://global.alipay.com/docs/ac/ams/api_fund#WWH90)。  
`Signature`的代码示例：  
`Signature: algorithm=RSA256, signature=<目标签名>`
### 步骤4：验证签名  
验证签名的语法如下：  
```markdown
IS_SIGNATURE_VALID=sha256withrsa_verify(base64UrlDecode(<目标签名>), <待验证内容>, <服务器公钥>)
```
*   `sha256withrsa_verify`：验证签名的方法
*   `base64UrlDecode`：解码签名的方法
*   `目标签名`：从[步骤3](#FJhqP)获取的目标签名
*   `待验证内容`：从[步骤2](#hvhQp)创建的待验证内容
*   `服务器公钥`：从[步骤1](#eK2mk)获取的支付宝公钥
*   `IS_SIGNATURE_VALID`：一个布尔值，表示签名是否有效
    *   `true`：签名有效
    *   `false`：签名无效，可能是私钥和公钥不匹配，或者`待验证内容`构建不正确

以下示例代码展示了如何使用Java验证签名：
```java
/**
*
* @param requestURI // 域名部分不包括，示例：/ams/api/v1/payments/pay
* @param clientId
* @param reponseTime
* @param alipayPublicKey
* @param responseBody
* @param signatureToBeVerified
* @return
*/
public static boolean verify(String requestURI, String clientId, String reponseTime,
                           String alipayPublicKey, String responseBody,
                           String signatureToBeVerified) {
    // 当AMS返回SIGNATURE_INVALID时，签名ToBeVerified在响应中不会出现
    if (StringUtil.isBlank(signatureToBeVerified)) {
        return false;
    }
    String content = String.format("POST %s\n%s.%s.%s", requestURI, clientId, reponseTime,
            responseBody);
    try {
        java.security.Signature signature = java.security.Signature
                .getInstance("SHA256withRSA");
        PublicKey pubKey = KeyFactory.getInstance("RSA").generatePublic(
                new X509EncodedKeySpec(Base64.decodeBase64(alipayPublicKey.getBytes("UTF-8"))));
        signature.initVerify(pubKey);
        signature.update(content.getBytes("UTF-8"));
    // ... 其他错误处理和验证完成的代码
    } catch (Exception e) {
        // 处理异常
    }
}
```
请注意，上述代码中省略了异常处理和验证完成的代码，实际使用时需要根据具体情况进行补充。
```java
// 验证签名
try {
    boolean isVerified = signature.verify(Base64.decodeBase64(URLDecoder.decode(signatureToBeVerified, "UTF-8").getBytes("UTF-8")));
    if (isVerified) {
        // 签名验证成功
    } else {
        // 签名验证失败
    }
} catch (Exception e) {
    throw new RuntimeException(e);
}
```

接收通知
========

处理请求
--------

收到支付宝的通知后，需要验证请求的签名。验证请求签名的过程与[处理响应](#J8HGf)部分介绍的类似。验证签名的步骤如下：

1. 获取用于验证签名的支付宝公钥。
2. 按照`Content_To_Be_Validated`的语法构建待验证的请求：
   ```
   <HTTP-METHOD> <Request-URI>
   <Client-Id>.<Request-Time>.<Request-Body>
   ```
3. 从请求头中获取签名。
4. 验证签名。

要查看文档的最新更新，请访问[版本发布说明](https://global.alipay.com/docs/releasenotes)。

![图片5](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片6](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面是否有帮助？

#### 本页内容

[调用API](#wPgXI "调用API")  
[前提条件](#pxKpP "前提条件")  
[签署请求](#H42wU "签署请求")  
[步骤1：构建待签名内容](#Adgbs "步骤1：构建待签名内容")  
[步骤2：生成签名](#gNWs0 "步骤2：生成签名")  
[步骤3：将生成的签名添加到请求头](#TLEDk "步骤3：将生成的签名添加到请求头")  
[发送请求](#OQsiG "发送请求")  
[处理响应](#J8HGf "处理响应")  
[步骤1：获取支付宝公钥](#eK2mk "步骤1：获取支付宝公钥")
```
**步骤2：构建验证内容**

在这一阶段，你需要创建一个包含所有必要参数的字符串，这些参数通常包括请求的时间戳、请求方法、URL路径、查询参数以及（在某些情况下）请求体。确保按照API提供者的指定顺序排列这些元素，并且不要遗漏任何签名所依赖的字段。

**步骤3：从响应头获取签名**

当从蚂蚁金服的API接口收到响应时，注意查看响应头。其中应包含一个签名（通常称为`Signature`或`X-Ant-Financial-Signature`），这是基于你之前构造的内容生成的哈希值。复制这个签名以进行后续验证。

**步骤4：验证签名**

使用你自己的密钥（通常是API密钥或私钥）和相同的哈希算法，按照相同的规则对步骤2中构建的内容生成一个新的签名。然后，将这个新生成的签名与从响应头获取的签名进行比较。如果两者匹配，那么签名验证成功，说明请求是来自蚂蚁金服的可信来源。如果不匹配，那么可能存在安全问题，应拒绝该请求。

**接收通知**

蚂蚁金服可能会通过HTTP POST请求发送通知到你指定的回调URL。这些通知可能包含交易状态更新或其他重要信息。确保你的服务器能够接收并处理这些POST请求。

**处理请求**

在接收到蚂蚁金服的通知或API请求后，你的服务器需要正确解析请求体，验证签名（如上述步骤），然后根据请求的类型和内容采取相应的行动。这可能包括更新数据库、处理支付、发送确认信息等。

**反馈**

如果你在处理过程中遇到任何问题，或者需要进一步的指导，可以向蚂蚁金服的技术支持或开发者社区寻求帮助。确保详细记录错误信息，以便于问题的诊断和解决。