Integration | Tickets | Alipay Docs
===============
                        

[![Image 1: Alipay, China's leading third-party online payment solution](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![Image 2: Alipay, China's leading third-party online payment solution](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[Log In](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Ftickets%2Fticketintegration)

[Go to Homepage](../../)

Tickets

[Introduction](/docs/ac/tickets/ticketintroduction)

[Integration](/docs/ac/tickets/ticketintegration)

[API list](/docs/ac/tickets/ticketapi)

Integration
===========

2021-03-04 02:38

The following sections explain how to design your system and integrate with Alipay.

System architecture
-------------------

The implementation of Alipay ticket purchase solution usually needs two modules: the front end and the back end. Each module contains several functions that are responsible for corresponding services.

You can refer to the following sample to design the whole solution architecture, but your system does not need to be exactly the same:

![Image 3: ticketarchi2.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1587541815807-71b0918c-a468-4599-adc8-894dc58cd582.png)

**Front end:** There are two types of implementation are suggested for the front end design.

*   Integrated solution: adopt the EFT POS (electronic funds transfer at point of sale) and Cashier POS (cashier point of sale).
*   Standalone solution: adopt the mPOS (mobile point of sale) only.

Any of the solutions above is able to perform the task of obtaining transaction information, which is needed by the backend server to construct payment request and submit Alipay gateway.

**Back end:** The back end is made of a partner server that manages a transaction lifecycle of transaction payment, transaction cancel, transaction refund, and reconciliation. Partner server might also offer deep integration to attraction system for further enhancement such as ticket booking, e-ticketing.

**Alipay can provide technical support for the following** **modules**: Alipay plays the role of processing payment requests and returning synchronous response in the whole ticket purchase process.

Integration with Alipay
-----------------------

Before integration, you need to create an Alipay account and an Alipay application. Besides, the development environment and keys also need to be configured. You can use the sandbox environment to test the integration before going live. The following content provides some key information about the integration process. For more details about integration, contact Global Merchant Technical Support at [overseas\_support@service.alibaba.com](mailto:overseas_support@service.alibaba.com).

### Prepare keys

To generate a digital signature, normally a key is required to sign the data. You must prepare the MD5 private key or the RSA/RSA2 private and public key pair to generate and verify a digital signature.

### Implement APIs

To integrate with the Alipay system for a specific service, you can call the Alipay APIs by sending an HTTP/HTTPS request to Alipay and use keys to sign the request before you send them. The following sequence diagram provides a big-picture of how the merchant, institution, and Alipay work together by integrating their systems to each other:

![Image 4: Tickets.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1596510889341-ce2fccd3-2361-4da0-a48a-dc5fc12833a2.png)

Offline mode:

1.  Customers place an order and see a screen prompt for payment.
2.  Customers show their barcode to be scanned by a scanner for payment.
3.  ECR (electronic cash register)/POS (point of sale)/App calls partner API, then the partner calls Alipay payment API. When the payment process returns a result code of `SUCCESS` or `FAILED`, a payment result is returned.
4.  ECR/POS/App completes the payment and generates the receipt.
5.  Customers receive the receipt.

Offline-to-online mode:

1.  Customers place an order and see a screen prompt for payment.
2.  Customers show their barcode to be scanned by a scanner for payment.
3.  ECR/POS/App calls partner API, then the partner calls Alipay payment API. When the payment process returns a result code of `UNKNOWN` or `TIMEOUT`, the query API is to be called to check the payment result. If the payment succeeds, the successful result will be returned to ECR/POS/App and a receipt will be generated; if the payment fails, you can call the cancel API to cancel the transaction.

**Payment** **process**

After the customer's payment barcode is scanned, a payment request is submitted. API used: [**alipay.acquire.overseas.spot.pay**](https://global.alipay.com/doc/global/spot_pay)

### Test in sandbox environment

Sandbox is an environment where you can mimic the characteristics of the production environment and create simulated responses from all APIs the application relies on before going live. You can make API tests based on your own requirements including making a transaction, cancel, or refund a transaction, and so on.

### Go Live

When you completed tests in the sandbox environment and get ready for going live, you can turn to the production environment by changing the gateway, PID, and keys to real ones.

Notes
-----

*   To ensure a proper implementation of Alipay solution, it is highly recommended to use the iValidate tool to perform testing and validate your implementation. The following graphic shows a validation result generated by the iValidate tool:

![Image 5: note.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1587541816224-b54ceb0b-d0f0-4c60-b6f5-1b1bffbea101.png)

*   In some cases, Alipay app users need to enter a payment PIN to complete the transaction. The transaction flow need to add relevant logic to manage such event. In responses for Alipay requests, two types of status might be returned:



| **Return parameter** | **Description** |
| --- | --- |
| <is\_success>T</is\_success> | Result of the request is Accepted (`T`) or Rejected (`F`) |
| <result\_code>SUCCESS</result\_code> | Describe the response status of a request withÂ `SUCCESS`, `FAILED`, or `UNKNOW` |



For the payment request, if a _result\_code_ of `UNKNOW` is returned, you need to send a query request for that particular transaction and check the returning parameter on _alipay\_trans\_status_. If the returned result is `WAIT_BUYER_PAY`, it indicates that the transaction is expecting the Alipay app user to enter payment PIN to complete the transaction. It is difficult to predict the time that the Alipay user enters the PIN, therefore, you need to perform the query API continuously until you get a result of `TRADE_SUCCESS` in _Alipay\_trans\_status_.

*   Performing query after each transaction is a critical action to confirm payment transaction status. It is recommended that you start to send the query request 3 to 4 seconds after the spot.pay request being sent, with an interval of 3 to 4 seconds between each query until you get a result other than `WAIT_BUYER_PAY`, or time out for your transaction.  
      
    
*   The cancel request needs to be sent if the whole process is reaching your designed timeout.

Exception handling
------------------

The retry mechanism exists for all API requests. You can resubmit the request when a `SYSTEM_ERROR` response is returned.

For example, when the transaction timed out, the cancel API is triggered but a response of `SYSTEM_ERROR` is returned. In this case, you need to submit the cancel request again. If the error persists, take the transaction into your system for manual intervention.

To view the latest updates to the documentation, visit [Release notes](https://global.alipay.com/docs/releasenotes).

![Image 6](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![Image 7](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 Alipay [Legal Information](https://global.alipay.com/docs/ac/platform/membership)

#### Is this page helpful?

#### On this page

[System architecture](#6e35d18f "System architecture")

[Integration with Alipay](#2dcdb0ad "Integration with Alipay")

[Prepare keys](#593eaf6b "Prepare keys")

[Implement APIs](#b5b168ba "Implement APIs")

[Test in sandbox environment](#2480d56a "Test in sandbox environment")

[Go Live](#c41c7a16 "Go Live")

[Notes](#Notes "Notes")

[Exception handling](#8fe3bb19 "Exception handling")