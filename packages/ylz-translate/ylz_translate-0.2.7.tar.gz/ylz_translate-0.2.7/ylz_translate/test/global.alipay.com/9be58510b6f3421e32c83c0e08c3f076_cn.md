获取授权 | 自动扣款 | 支付宝文档
===============

[![图片 1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片 2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fautodebit_en%2Fauth)  
[返回首页](../../)  
自动扣款  
[概述](/docs/ac/autodebit_en/overview)  
接受支付  
支付后操作  
其他资源  
获取授权
====================  
2024-04-10 02:53  
在进行自动扣款之前，需要获取买家的授权。授权成功后，需要使用授权码获取支付令牌。支付令牌用于执行后续的一键支付，以下情况必须妥善处理令牌：

*   当授权的自动扣款支付方式的支付令牌即将过期时，需要刷新支付令牌。
*   如果买家取消授权，需要相应地处理支付令牌。

先决条件
=============  
开始之前，必须完成以下任务：

*   在 [Antom 控制台](https://global.alipay.com/docs/dashboard_en) 注册。
*   在 Antom 控制台设置您的密钥。
*   配置接收异步 [通知](https://global.alipay.com/docs/ac/autodebit_en/notifications) 的地址。

详情请参阅 [集成指南](https://global.alipay.com/docs/integration_guide_en)。  
获取授权
========================  
要从买家获取授权，请完成以下集成步骤：

1.  从支付宝查询授权 URL。
2. 将买家重定向到支付方式授权页面。建议根据买家所在地区动态渲染支持的支付方式。
3. 获取授权码。
4. 申请支付令牌。
5. （可选）刷新支付令牌。

步骤1：从支付宝查询授权URL
---------------------------

在签署支持所需支付方式的合同后，您可以调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API。支付宝会在API响应中返回获取买家授权的授权URL。URL值如下：

*   normalUrl
*   schemeUrl
*   applinkUrl

> **注意**：在授权过程中，授权URL只能使用一次。也就是说，如果返回了三个URL，只能使用其中一个。

返回的授权URL因支付方式而异，意味着每种支付方式可能会返回这三个参数中的一个或全部。

调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API时，在请求中正确传递以下参数：

*   _authRedirectUrl_：授权完成后将买家重定向回商户页面的URL。这个URL将用于步骤3中构建重建的URL。
*   _authState_：由您自己指定的字符串，用于标识授权请求。这个字符串将用于步骤3中构建重建的URL。
*   _customerBelongsTo_：指定您请求授权的目标支付方式。
*   _scopes_：传入固定值`AGREEEMENT_PAY`。
*   terminalType：指示您的客户端类型。

步骤2：将买家重定向到支付方式授权页面
--------------------------------------
将买家从您的应用程序重定向到支付方式授权页面。在重定向过程中，您需要根据买家的应用环境选择合适的URL来继续重定向流程：

*   对于在桌面浏览器中进行的重定向，使用`normalUrl`进行重定向流程。
*   对于在移动浏览器中进行的重定向，建议参考[授权URL的最佳配置实践](https://global.alipay.com/docs/ac/autodebit_en/best_practice)。
*   对于在移动应用中进行的重定向，建议参考[授权URL的最佳配置实践](https://global.alipay.com/docs/ac/autodebit_en/best_practice)。

授权可以成功或失败，这两种情况下的后续重定向如下：

*   **授权成功**：买家将被重定向回商户页面，页面地址将是一个由`_authRedirectUrl`、`_authCode`和`_authState`值组成的重建URL。
*   **授权失败**：
    *   如果买家退出了授权页面，某些支付方式允许买家被重定向回商户页面，商户页面的地址是`_authRedirectUrl`的值。
    *   如果由于授权超时或失败，买家无法从支付方式应用重定向到商户客户端，建议引导买家重新发起授权。通常，如果买家在15分钟后仍无法从支付方式应用重定向到商户客户端，授权失败。

由于授权URL只能使用一次，如果用户授权失败，您需要使用新的`authState`值调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API。

步骤3：获取授权码
------------------
在获取买家授权后，可以通过以下方式获取授权码（_authCode_）：

1. 从支付方式返回的重构URL中获取
2. 从支付宝发送的授权成功通知中获取
### 从重构的URL中获取
在获取买家授权后，他们会被重定向到支付方式返回的重构URL。这个URL由三个部分组成：
1. 你在[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API中传递的`authRedirectUrl`参数的值
2. 支付方式返回的`authCode`
3. 你在[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API中传递的`authState`参数的值

以下是一个重构URL的示例：
```text
https://www.alipay.com/?authCode=d2f60253-ecdc-e9bc-27d1-566970191040&authState=663A8FA9-D836-48EE-8AA1-1FF682989DC7
```
你可以从重构的URL中获取`authCode`的值。但在使用这个`authCode`之前，需要检查重构URL中的`authState`值是否与你在[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API中传递的`authState`参数值一致。如果不一致，可能是因为重定向过程中发生了恶意事件，如攻击，导致URL不可靠。因此，重构URL中的`authCode`不能使用。
### 从授权通知中获取  
由于网络问题或其他原因，您可能无法获取重建的URL。因此，您也可以按照以下步骤从支付宝提供的授权通知中获取授权码（_authCode_）。

1. 配置接收授权结果通知的地址。详情请参阅[通知](https://global.alipay.com/docs/ac/cashier_payment_cn/notification#oUAYb)。
2. 买家同意授权后，您将收到支付宝发送的[授权成功通知](https://global.alipay.com/docs/ac/ams/notifyauth)。
3. 收到异步通知后，按照[要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification#OqpVS)返回响应。否则，支付宝将重新发送异步通知。
> **注意**：您可以通过重建的URL和授权通知两种方式获取_authCode_。如果获取了多个authCode，使用最先到达的那个，并且不要多次使用相同的_authCode_值来申请支付令牌。

步骤4：申请支付Token
----------------------
获取授权码(_authCode_)后，调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API来获取支付Token(_accessToken_)。为了避免因支付Token(_accessToken_)过期导致的交易失败，当支付Token即将过期时，通过调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API使用_refreshToken_获取新的访问令牌(_accessToken_)。
### 获取支付令牌  
在获取授权码（_authCode_）后1分钟内调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 申请支付令牌（_accessToken_）。否则，授权码（_authCode_）将过期并失效。只有拥有支付令牌（_accessToken_）才能实现对买家账户的自动扣款。

调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API时，在请求中正确传递以下参数：
*   _grantType_: 传入固定值 `AUTHORIZATION_CODE`。
*   _customerBelongsTo_: 指定你请求授权的支付方式。
*   _authCode_: 传入在[步骤3](#CvOoy)中获取的_authCode_值。

以下是一个申请支付令牌的示例请求：
```json
{
"grantType": "AUTHORIZATION_CODE",
"customerBelongsTo": "GCASH",
"authCode": "d2f60253-ecdc-e9bc-27d1-566970191040"
}
```
在响应中，你将收到以下关键参数：
*   _accessToken_: 支付令牌。
*   _accessTokenExpiryTime_: 支付令牌的过期时间。
*   _refreshToken_: 用于刷新当前支付令牌的刷新令牌。
*   _refreshTokenExpiryTime_: 刷新令牌的过期时间。通常，_refreshTokenExpiryTime_ 的值大于 _accessTokenExpiryTime_，以确保支付方式可用。刷新令牌过期后，你需要从[步骤1](#qGhSj)重新获取新的授权码（_authCode_），然后调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API。

> **注意**：
>
> *   如果调用API后没有收到响应，建议使用相同的参数和参数值重新发送请求。
如果您收到的响应中没有支付令牌（_accessToken_），建议您按以下方式处理：

1. 如果_result.resultStatus_的值为U，使用相同的参数和参数值重新发送请求。
2. 如果_result.resultStatus_的值为F，根据结果代码排查问题。如果需要再次调用API获取支付令牌，由于authCode只能使用一次，您需要从步骤1开始重新获取新的授权码(_authCode_)，然后调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API。
3. 如果您希望在客户端显示买家用于自动扣款的关联账户，可以使用通过[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API响应返回的_userLoginId_值。这个字段的值已经脱敏，可以直接显示。
### 刷新支付令牌  
一旦支付令牌（_accessToken_）过期，就无法再用于自动扣款支付。因此，您需要在令牌过期前调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 来刷新支付令牌（_accessToken_）。调用此 API 时，在请求中传递以下参数：  
*   _grantType_: 传入固定值 `REFRESH_TOKEN`。
*   _customerBelongsTo_: 指定您请求授权的目标支付方式。
*   _refreshToken_: 传入刷新令牌参数（refreshToken）的值。该参数值从之前步骤中用于获取支付令牌的[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 响应中获取。  
以下是一个刷新支付令牌的示例请求：  
```json
{
"grantType": "REFRESH_TOKEN",
"customerBelongsTo": "GCASH",
"refreshToken": "281xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx7811"
}
```
始终使用最新的 _refreshToken_ 值来延长访问令牌的有效期。这是因为某些支付方式在您调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 刷新令牌（在[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 请求中将 _grantType_ 参数值设为 `REFRESH_TOKEN`）时，可能会返回新的 _refreshToken_ 值。  
> **注意**：
>
> *   建议在支付令牌（_accessToken_）过期前至少10天进行刷新，以便支付宝技术支持团队有足够的时间处理。这条规则也适用于支付令牌（_accessToken_）有效期较长的支付方式，如 KakaoPay。
> *   对于支付令牌（_accessToken_）有效期较长的支付方式，如 KakaoPay，可能不会提供 _refreshToken_ 和 _refreshTokenExpiryTime_ 参数。
### 支付令牌生命周期表  
由于不同国家的风险控制要求，支付方式的访问令牌的有效期各不相同，最短有效期为一年。以下表格列出了各种支付方式的有效期：

| **支付方式** | **访问令牌有效期** | **可刷新令牌？** | **applyToken API 的响应字段** |
| --- | --- | --- | --- |
| DANA | 10 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| GCash | 2 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| Touch'n Go | 2 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| TrueMoney | 2 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| AlipayHK | 至 2038 年 1 月 1 日 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| MAYA | 1 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| BOOST | 1 年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| Rabbit LINE Pay | 至 2050 年 7 月 19 日 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| bKash | 至 2099 年 12 月 31 日 | 是 | accessToken, accessTokenExpiryTime |
| Alipay | 至 2115 年 2 月 1 日 | 否 | accessToken, accessTokenExpiryTime |
| KakaoPay | 至 2120 年 8 月 25 日 | 否 | accessToken, accessTokenExpiryTime |
| Naver Pay | 从用户最后一次支付日期起一年内 | 否 | accessToken, accessTokenExpiryTime |

表 1. 不同支付方式的访问令牌有效期  
建议您维护一个包含所有支付方式支付令牌（_accessToken_）生命周期信息的表格，以便定期检索即将过期的支付令牌（_accessToken_）并进行刷新。例如：
取消授权
==========

当买家想要停用自动扣款服务时，他们可以在您的客户端或支付方式客户端内取消服务。取消服务的方式决定了您需要采取的行动：

1. 如果买家在您的客户端内取消服务，使用[**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation) API 使支付令牌（_accessToken_）失效。在 API 请求中，传递用于发起自动扣款支付的支付令牌（_accessToken_）。API 调用成功后，支付令牌（_accessToken_）将变得无效。

2. 一些支付方式支持买家在支付方式客户端内取消自动扣款服务。在这种情况下，您需要配置接收[授权取消通知](https://global.alipay.com/docs/ac/ams/notifyauth)的地址。当买家在支付方式客户端内取消自动扣款授权时，您将收到一个[授权取消通知](https://global.alipay.com/docs/ac/ams/notifyauth)。通知将指出因取消自动扣款服务而失效的支付令牌（_accessToken_）。以下是一个授权取消的异步通知示例：

```json
{
"authorizationNotifyType": "TOKEN_CANCELED",
"accessToken": "28100103_20215703001538122119",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success",
"resultStatus": "S"
}
}
```

收到异步通知后，按照[要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification#OqpVS)返回响应。否则，支付宝会重新发送异步通知。

要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。
![图片 4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 在此页面上  
[前提条件](#cXNt1 "前提条件")  
[获取授权](#2BiKE "获取授权")  
[步骤1：从支付宝查询授权URL](#qGhSj "步骤1：从支付宝查询授权URL")  
[步骤2：将买家重定向到支付方式授权页面](#ziJ3z "步骤2：将买家重定向到支付方式授权页面")  
[步骤3：获取授权码](#CvOoy "步骤3：获取授权码")  
[从重建的URL中获取](#yaov6 "从重建的URL中获取")  
[从授权通知中获取](#2qNBn "从授权通知中获取")  
[步骤4：申请支付Token](#rLErG "步骤4：申请支付Token")  
[获取支付Token](#ECpYN "获取支付Token")  
[刷新支付Token](#tN3SV "刷新支付Token")  
[支付Token生命周期表](#HiHdb "支付Token生命周期表")  
[取消授权](#eNTbh "取消授权")