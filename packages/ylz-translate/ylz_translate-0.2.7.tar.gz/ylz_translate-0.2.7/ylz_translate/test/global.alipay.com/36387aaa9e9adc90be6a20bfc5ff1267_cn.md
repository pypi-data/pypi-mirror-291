最佳实践 | 入口码支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)
[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fams_ec%2Fbp)
[返回首页](../../)

入口码支付
[Introduction](/docs/ac/ams_ec/introduction)
[开始使用](/docs/ac/ams_ec/start)
[接收支付](/docs/ac/ams_ec/acceptpayment)
[支付后服务](/docs/ac/ams_ec/postpayment)
[最佳实践](/docs/ac/ams_ec/bp)
开发
[API 列表](/docs/ac/ams_ec/apilist)
[对账](/docs/ac/ams_ec/reconcile)
附录
[版本发布说明](/docs/ac/ams_ec/releasenotes)
[旧版](/docs/ac/ams_ec/cvgicc)

最佳实践
===============

2021-08-04 09:32
遵循以下集成最佳实践，为您的客户提供优质的支付体验。这些最佳实践需要在服务器端与支付宝之间以及支付终端的流程中实施。

准备您的设备
===================

需要为入口码支付服务准备一个能够提供外部网络服务的设备。

正确使用支付宝接口
==============================

建议至少集成以下接口：**pay**、**inquiryPayment**、**refund**、**cancel** 和 **notifyPayment**。

*   **pay** 接口：
    - 在支付请求中指定支付通知URL。调用 **pay** 接口后，支付宝可能会返回以下结果，或者商家未收到任何结果：
    - 若支付宝返回的 `_result.resultStatus_` 为 `S`，表示交易成功，资金已成功扣除。
*   当支付宝返回_result.resultStatus_为`F`时，商家需要根据_result.resultCode_中的错误信息采取进一步行动。
*   若支付宝返回_result.resultStatus_为`U`，商家需使用**查询支付**接口来查询支付结果。查询请求可以发送10到20次，每次间隔3秒。
*   若在发送支付请求后15秒内，支付宝既没有返回异步通知也没有返回支付结果，商家需使用**查询支付**接口查询结果。查询请求可发送10到20次，每次间隔3秒。若网络状况不佳，支付处理可能会延迟，因此等待时间可适当延长至25秒。
*   调用查询接口时，如果超过最大查询次数仍无法获取支付结果，商家需要调用**取消**接口取消交易。如果超出可取消期限，商家无法使用**取消**接口，可改用**退款**接口进行退款。
*   **查询支付**接口：
    *   调用**查询支付**接口后，支付宝可能会返回以下结果，或者商家未收到任何结果：
        *   若支付宝返回_result.resultStatus_为`S`，表示查询成功，商家可以通过_paymentStatus_的值获取支付状态：
            *   _paymentStatus_值为`SUCCESS`，表示支付成功。
            *   _paymentStatus_值为`FAIL`，表示支付失败，商家可以重新发起支付请求。
*   `_paymentStatus_` 的值为 `PROCESSING`，表示支付正在进行中。商家可以稍后查询最终状态。
*   `_paymentStatus_` 的值为 `CANCELLED`，意味着支付已取消。商家可以重新发起支付请求。
*   若支付宝返回 `_result.resultStatus_` 为 `F`，商家需要根据 `_result.resultCode_` 中的错误信息采取进一步行动。
*   若支付宝返回 `_result.resultStatus_` 为 `U`，商家需使用 **inquiryPayment** 接口查询支付结果。查询请求可发送10至20次，每次间隔3秒。
*   如因网络问题在3秒内未从支付宝收到结果，商家需使用 **inquiryPayment** 接口查询支付结果。查询请求可发送10至20次，每次间隔3秒。
*   调用 **inquiryPayment** 接口时，若超过最大查询次数仍无法获取支付结果，商家需调用 **cancel** 接口取消交易。
*   **cancel** 接口：
    *   调用 **cancel** 接口后，支付宝可能会返回以下结果，或商家未收到任何结果：
        *   支付宝返回 `_result.resultStatus_` 为 `S`，表示交易已成功取消。商家可以再次发起支付请求。
        *   支付宝返回 `_result.resultStatus_` 为 `F`，商家需根据 `_result.resultCode_` 中的错误信息采取进一步行动。
        *   支付宝返回 `_result.resultStatus_` 为 `U`，商家需使用相同参数重试取消请求。取消操作可重试60秒，每次间隔5至10秒。
*   如果由于网络问题，支付宝在3秒内没有返回结果，商家需要使用相同的参数重试取消请求。取消操作可以在60秒内重试，每次重试间隔5到10秒。
*   若多次尝试取消后仍无法获取结果，商家需联系支付宝技术支持团队。
  
以下图表清晰地展示了**支付**、**查询支付**和**取消**接口之间的关系：
  
  ![Image 3: entrycodebp.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1608177395892-1ae14f4d-f0b9-4c70-ae2c-ac0be781dcea.png)
  
  图1. 调用支付、查询支付和取消接口流程图。
  
*   **退款**接口：
    *   调用**退款**接口后，支付宝可能会返回以下结果，或者商家未收到任何结果：
        *   支付宝返回`result.resultStatus`为`S`，表示交易退款成功。
        *   支付宝返回`result.resultStatus`为`F`，商家需要根据`result.resultCode`中的错误信息采取进一步行动。
        *   支付宝返回`result.resultStatus`为`U`，商家需要使用相同的参数重试退款请求。退款操作可以在60秒内重试，每次重试间隔5到10秒。
        *   如果由于网络问题，支付宝在3秒内没有返回结果，商家需要使用相同的参数重试退款请求。退款操作可以在60秒内重试，每次重试间隔5到10秒。
        *   若多次尝试退款后仍无法获取结果，商家需联系支付宝技术支持团队。
  
以下图表展示了如何使用**退款**接口：
  
  ![Image 4: image.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1592971586564-820b2100-1e24-4e77-a576-36fe485b7e8b.png)
  
  图2. 调用退款接口流程图。
*   **notifyPayment** 接口：
    *   当订单状态到达最终状态时收到通知，商家可以忽略该通知。
    *   商家发起取消请求后收到通知，可忽略通知并根据取消请求的结果确定支付状态。

**取消重试解决方案**
--------------------

为了防止重复扣款，需要确保取消消息的可靠传递。虽然重试**cancel**接口可以达到很高的成功率，但仍然建议在可能的情况下使用消息队列。以下是使用消息队列的三个步骤：

1.  如果调用**inquiryPayment**接口未能获取结果，启动取消流程。如果无法发出取消请求，需要将取消请求保存到本地队列中，定期或在网络恢复时进行重试。
2.  接收到取消请求后，接收队列确认请求，并在原始交易到达后发起取消请求。
3.  如果在向支付宝发送取消请求时出现网络异常或系统错误，将取消请求保存到发送队列并尝试重试。

![](https://cdn.nlark.com/yuque/0/2020/png/561635/1595214755892-9b7ec8c0-bc99-408d-8c63-3eb56ce906e8.png)
图3. 使用消息队列的三个步骤

**获取代理令牌**
----------------

此操作仅适用于ISV集成模式，即由商家或收单机构授权的ISV进行的集成过程，允许ISV代表他们进行实施。
为了代表商家集成支付宝，ISV（独立软件供应商）需要在请求头中使用授权令牌。授权令牌的通知由商家触发，并从支付宝发送。以下流程图展示了获取代理令牌的过程：

![图片2.png](https://cdn.nlark.com/yuque/0/2021/png/12884741/1627971330282-835b7235-c3d9-4879-916c-8075dc9f8dfe.png)  
图4. 获取代理令牌的过程  

**注意事项：**

1. 支付宝指定通过通知发送的数据。
2. 在支付宝让ISV上线之前，ISV需要提供通知URL。
3. ISV需要实现后端逻辑以接收令牌并返回正确的信息。

正确创建支付请求ID
------------------

当同一笔业务订单因之前的支付失败或撤销而需要多次支付时，确保每个**pay**接口的`paymentRequestId`值不重复是必要的。因此，不能直接将业务订单号用作商家支付请求ID，而应为每次支付请求生成独立的支付请求ID。此外，应在商家服务器上建立业务订单号与商家支付请求ID之间的关系。

支付请求ID必须唯一，不可重置，且不能是连续数字。建议以下列方式创建支付请求ID：

```
时间戳（精确到秒）+ 终端号 + 交易金额 + 终端交易序列号 + 随机数。
```

确认支付结果
------------

必须正确确认支付结果。请注意以下事项：
*   必须验证支付异步通知的签名，并检查返回的支付金额及其货币单位是否与支付请求一致。确保接收到的通知没有被篡改。
*   收到异步通知或支付结果后，首先要确认通知是否已处理。只有对于未处理且未被取消的原始交易，才能继续完成支付。如果从终端收到取消请求，应完成取消流程。
*   使用数据锁进行并发控制，以避免同时从查询请求和异步通知获取支付结果，这可能导致数据库中重复记录相同交易信息时的数据混乱。

对于收单机构与商户的集成
========================

支付宝交易是实时结算的，这在客户、商户、收单机构和支付宝之间保持交易状态一致性方面带来了挑战。由于客户可以立即在手机上查看交易，任何不一致都可能导致现场投诉。为了保持交易状态的一致性，收单机构不仅需要遵循与支付宝的最佳集成实践，还需要遵循与商户的最佳集成实践。本文档阐述了确保收单机构与商户高质量集成的原则。这些原则适用于采用用户出示模式支付、订单码支付和入口码支付产品的商户和收单机构。
### 1. 原则
由于商家与收单机构之间的集成方式多样，支付宝建议商家与收单机构的集成遵循以下原则，以确保集成质量：

*   保持所有参与者之间的交易状态一致。
*   如遇到任何不确定状态，如果可能，应启动撤销流程。
*   如果由于数据包丢失或其他异常情况未能执行撤销操作，您需要自行或通过重试队列重新尝试撤销流程。
### 2. 应用各种集成模型的原则：
以下部分讨论了多种集成模型及其相应的集成原则，以说明商家和收单机构之间的各种集成。如果您的集成模型不在以下任何一种情况中，可以联系支付宝技术支持寻求帮助。

#### 前置网关
这是一种集成模型，收单机构网关简单地将下游（商家）的消息转发给支付宝。转发的消息包括支付、查询、取消和退款请求。

所有请求由下游发起并由网关转发，可能涉及协议转换。尽管商家和收单机构之间使用的协议细节或数据字段可能与收单机构和支付宝之间使用的不同，但处理逻辑和交易流程相似。因此，商家和收单机构之间的集成也需要遵循支付宝发布的最佳实践。

以典型的支付宝条码交易为例，以下图形展示了发起请求和转发请求的过程：
![Image 7: 1.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624530328385-36a27dc2-73b4-41ba-89f9-16d9099c312e.jpeg)  
图5. 发起请求和转发请求的过程

在任何不确定的状态下，建议主动发起取消过程或使用存储转发队列。

**主动取消**
在收单机构网关简单转发下游（商家）消息到支付宝的集成模型中，商家与网关之间的连接问题经常发生。当连接问题发生时，建议转发网关向支付宝发送取消请求，以避免交易状态不一致。
例如，在用户授权交易的过程中，下游与网关之间的连接在查询过程中突然断开。然而，用户与支付宝之间的授权过程正常完成。因此，商家将超时视为交易被拒绝，而支付宝则扣除了用户的资金。这就导致了交易状态不一致，需要避免这种情况。

为了避免交易状态不一致，建议在满足以下条件时，转发网关代表下游主动向支付宝发起取消请求：

1. 达成一致的交易超时，即交易无法进一步处理。
2. 支付宝对网关的先前查询没有返回授权批准的响应。
3. 超时后，网关未收到下游的取消请求。

以下图表展示了从转发网关向支付宝发起主动取消的过程：

![](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624530336184-8a5970fd-8849-42c8-b482-b57e813747c0.jpeg)
图6. 主动取消发起过程

**注意**：
网关的超时设置必须大于商家的超时设置。否则交易可能会过早被撤销，影响成功率。

**存储转发队列**

关于取消请求的重传，实现取消的存储转发队列可以降低取消请求未送达的可能性。
实现存储转发队列可以帮助收银员在后台办公室发送取消请求直到成功。因此，建议在商家端和网关端都实现存储转发队列。如果不想在两端都实现，至少要在商家端实现。

#### RESTful API 网关

这是一种集成模型，利用了收单方现有的支付基础设施。例如，将收单方的RESTful API与商家连接，以实现与支付宝的集成。虽然这种集成模型增加了服务器端的集成复杂性，但商家端的集成变得更简单，因为大部分查询和取消逻辑可以在服务器端实现。

对于这种集成，必须谨慎考虑保持所有参与者之间的交易状态一致性原则。

以典型的支付宝条码交易为例。在商家初始化交易后，网关遵循我们的集成最佳实践启动支付宝交易，包括查询和重试。商家使用收单方的API异步检查交易结果。商家和收单方各自独立维护超时值。以下图表展示了使用收单方API检查交易结果的过程。

![Image 9: 3.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624530344184-e9c987df-12f0-44a9-b4d2-058a8518cd57.jpeg)
图7. 使用收单方API检查交易结果的过程

在遇到任何不确定状态时，建议采取以下行动以确保所有参与者之间的交易状态一致性：
*   网关负责确定交易的关闭时间，并向支付宝发起最终的取消请求，以关闭与支付宝的交易。
*   网关需要能够通过设置比商户端更短的超时值，向商户提供最终的交易状态。
*   商户向网关发起取消请求，以减少交易状态不一致的可能性。

为了在收单方和支付宝之间关闭交易，当满足以下条件之一时，网关需要主动发送取消请求：
*   网关超时后，支付宝未返回授权批准的响应。
*   支付宝返回了授权批准，但网关无法将批准信息下游传递，超时后需要发起取消请求以逆转交易。

以下图表展示了向支付宝发起取消请求的过程：
![图片10: 4.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624530351918-97e8719c-1727-4445-82d1-ff7b99d8e798.jpeg)
图8. 向支付宝发起取消请求的过程

尽管网关需要能够将最终交易状态传递给商户，但可能由于某些原因商户未收到消息。在这种情况下，商户需要以某种方式通知网关，而网关需要能够将其解释为向支付宝的取消请求。此外，建议商户启动取消流程作为安全措施，以减少交易状态不一致的可能性。

#### 请求和响应切换
这是一种集成模型，其中收单方使用现有的支付切换系统。
在这种情况下，下游（通常是商家）负责在超时后发起撤销操作。开关（支付系统中的中间件）将撤销建议存储在存储转发队列中，并将这些建议转换为对支付宝的取消请求。开关需要通过存储转发队列来确保取消请求成功送达至支付宝。

以下图示展示了商家发起撤销建议的过程。商家向开关发送撤销建议，开关立即向商家返回响应，并负责成功向支付宝发送取消请求。

![图片11: 5.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624530360358-54effc10-de43-4a6c-8783-707f002f17af.jpeg)
图9. 向支付宝发起撤销建议的过程

要查看文档的最新更新，请访问[发布说明](https://global.alipay.com/docs/releasenotes)。

![图片12](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片13](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

[准备设备](#Pd1S9 "准备设备")  
[正确使用支付宝接口](#mzEJp "正确使用支付宝接口")  
[取消请求重试解决方案](#rvFaw "取消请求重试解决方案")  
[获取代理令牌](#rHLYA "获取代理令牌")  
[正确创建支付请求ID](#6sYEl "正确创建支付请求ID")  
[确认支付结果](#Ju5Tz "确认支付结果")  
[对于收单机构与商家的集成](#ULVTT "对于收单机构与商家的集成")  
[1\. 原则](#JY3gZ "1. 原则")  
[2\. 将原则应用于各种集成模型：](#qKZsb "2. 将原则应用于各种集成模型：")
[转发网关](#hu2n5 "转发网关")  
[RESTful API 网关](#2mSAj "RESTful API 网关")  
[请求和响应切换器](#udByP "请求和响应切换器")