支付卡功能 | 结账支付 | 支付宝文档
===============  
![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)  
[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fmf%3FpageVersion%3D7)  
[返回首页](../../)  
结账支付  
[概述](/docs/ac/cashierpay/overview)  
接收支付  
支付后  
支付方式  
其他资源  
高级功能  
[预前端解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡存储API](/docs/ac/cashierpay/cv)  
[卡存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API SDK](/docs/ac/cashierpay/mf?pageVersion=7)  
卡支付功能
=====================  
2024年5月15日 10:46  
在发起授权支付时，您可以根据服务需求选择是否使用更多功能。本主题解释了这些附加功能及其使用方法。  
设置3D验证
===================  
您可以通过指定\_is3DSAuthentication\_\_参数来选择是否对支付进行3D验证。  
*   **不设置** **\_is3DSAuthentication\_\_** **：** 结果与设置为`false`相同。3D验证将被禁用。如果蚂蚁金服认为此支付为高风险，此支付将被拒绝。
*   **将** **\_is3DSAuthentication\_\_** **设置为** **`false`** **：** 3D验证被禁用。如果蚂蚁金服认为此支付为高风险，此支付将被拒绝。
*   **将** **\_is3DSAuthentication\_\_** **设置为** **`true`** **：** 3D验证被启用。如果蚂蚁金服认为此支付为高风险，此支付将被拒绝。  
> **注意**：
>
> *   对于API集成，请在[**pay（结账支付）**](https://global.alipay.com/docs/ac/ams/payment_cashier)API中指定此参数。对于SDK集成，请在[**createPaymentSession（收银台支付）**](https://global.alipay.com/docs/ac/ams/session_cashier)API中指定此参数。
> *   此功能不适用于使用任何韩国卡组织的韩国卡发起的支付。  
**智能交易挽救**
===================================  
交易挽救功能允许在卡组织要求3D验证的交易中自动启动3D验证流程，从而使您能够挽救无论之前是否选择3D验证的交易。  
通过将\_enableAuthenticationUpgrade\_\_设置为`true`，可以为交易启用交易挽救功能。如果您未启用此功能，且交易需要3D验证，卡组织将认为此交易为高风险并拒绝支付。  
> **注意**：
>
> *   对于API集成，请在[**pay（结账支付）**](https://global.alipay.com/docs/ac/ams/payment_cashier)API中指定此参数。对于SDK集成，请在[**createPaymentSession（收银台支付）**](https://global.alipay.com/docs/ac/ams/session_cashier)API中指定此参数。
> *   此功能不适用于使用特定本地卡组织的卡片，包括巴西卡、韩国卡、新加坡卡和香港卡。  
设置3D验证和自动交易挽救将共同决定交易的风险控制验证流程。下表显示了这两个功能设置如何影响风险控制结果：  
| 设置3D验证： | is3DSAuthentication | 设置自动交易挽救： | enableAuthenticationUpgrade | 风险控制结果 |
| --- | --- | --- | --- | --- |
| 不设置/留空 | false | 不设置/留空 | true | 无3D验证的支付失败后，此支付自动触发3D验证，蚂蚁金服返回3D验证页面的渲染URL。 |
| 不设置/留空 | false | 不设置/留空 | false | 如果无3D验证的支付失败，蚂蚁金服返回支付失败的结果。 |
| true | true/false/留空 | true | 这笔支付将进行3D验证，蚂蚁金服返回3D验证页面的渲染URL。 |
表1. 两个功能设置影响的风险控制结果  
对于SDK集成，SDK会处理重定向到3D验证页面，您无需额外操作。对于API集成，蚂蚁金服返回3D验证页面的URL后，您需要显示验证页面并指导买家完成验证过程。以下代码示例展示了[**pay（结账支付）**](https://global.alipay.com/docs/ac/ams/payment_cashier)API中通过响应返回URL的方式：  
```json
{
  "result": {
    "resultStatus": "U",
    "resultCode": "PAYMENT_IN_PROCESS",
    "resultMessage": "payment in process"
  },
  "normalUrl": "https://centinelapi.cardinalcommerce.com/V1/Cruise/Collect/...",
  "paymentId": "20221111194010890100111650285726898",
  "paymentRequestId": "amsdmpay_cangxi_lj_20221111_104718_672",
  "redirectActionForm": {
    "redirectUrl": "https://centinelapi.cardinalcommerce.com/V1/Cruise/Collect/...",
    "method": "GET"
  },
  "paymentAmount": {
    "currency": "HKD",
    "value": "100"
  },
  "paymentCreateTime": "2022-11-10T18:47:20-08:00"
}
```  
**增值服务风险控制**
====================================  
如果您需要支付的升级风险控制服务，可以购买蚂蚁金服提供的增值服务风险控制。此服务根据支付的风险级别提供智能风险控制策略。  
设置3D验证、自动交易挽救和此功能将共同决定交易的风险控制验证流程。下表显示了这三个功能设置如何影响风险控制结果：  
| 增值服务风险控制 | 设置3D验证： | is3DSAuthentication | 设置自动交易挽救： | enableAuthenticationUpgrade | 风险控制结果 |
| --- | --- | --- | --- | --- | --- |
| 开启 | 不设置/留空 | false | 不设置/留空 | false | 风险控制服务决定是否执行3D验证。 |
| 开启 | 不设置/留空 | Antom | true/留空 | 风险控制服务决定是否执行3D验证。如果服务决定不执行3D验证，且卡组织要求3D验证，蚂蚁金服返回3D验证页面的渲染URL。 |
| 开启 | true | true/false/留空 | true | 即使风险控制服务决定不执行3D验证，蚂蚁金服也会返回3D验证页面的渲染URL。 |
表2. 三个功能设置影响的风险控制结果  
> **注意**：
>
> *   如果您购买了增值服务风险控制，无需设置\_is3DSAuthentication\_\_参数。风险控制服务为您提供风险控制策略。
> *   此功能不适用于使用特定本地卡组织的卡片，包括巴西卡、韩国卡、新加坡卡和香港卡。  
AVS检查
============  
地址验证系统（AVS）检查将交易中使用的账单地址与发卡行记录的持卡人地址信息进行比较，以检测欺诈行为。通过启用AVS检查，系统会自动比较买家输入的账单地址和电子邮件地址与发卡行存储的信息。如果这些信息不匹配，可能会导致支付被拒绝或需要额外的身份验证。  
发起支付
------------  
启用AVS检查服务后，您可以根据集成模式发起AVS检查：  
*   [API集成](#kanW0)
*   [SDK集成](#k85nA)  
> **注意**：
>
> *   您可以通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)或[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)API响应中的\_request.paymentResultInfo.avsResultRaw\_\_参数获取AVS检查的结果。
> *   此功能仅适用于使用美国卡组织监管的美国卡发起的支付。
### API 集成  
#### 服务器到服务器模式  
在服务器到服务器模式下，您需要收集买家的卡片信息和账单地址信息，并通过 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 指定 _billingAddress_ 参数来发起 AVS 检查。  
以下是一个带有账单地址的支付请求示例：  
```json
{
  "order": {
    "orderAmount": {
      "currency": "USD",
      "value": "100"
    },
    "orderDescription": "《Bad Romance》-Lady Gaga",
    "referenceOrderId": "ORDER_20231208164745347",
    "goods": [
      {
        "goodsCategory": "Digital Goods",
        "goodsName": "《Bad Romance》",
        "goodsQuantity": "1",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "100"
        },
        "goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
        "referenceGoodsId": "GOODS_20231208164745347"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "shippingPhoneNo": "123456789"
    },
    "buyer": {
      "buyerEmail": "gaga@gaga.com",
      "buyerName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "buyerPhoneNo": "123456789",
      "referenceBuyerId": "88888888"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodMetaData": {
      "cardholderName": {
        "firstName": "Lady",
        "lastName": "Gaga"
      },
      "billingAddress": {
        "zipCode": "94043",
        "address2": "gongzhuan Road",
        "city": "Sunnyvale",
        "address1": "mountain view Road",
        "state": "CA",
        "region": "US"
      },
      "cvv": "850",
      "expiryMonth": "12",
      "expiryYear": "29",
      "cardNo": "4294097400915107"
    }
  },
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
  "paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
  "paymentRequestId": "PAY_20231208164745347",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```
#### 托管模式  
在托管模式下，Antom 为买家提供填写卡片信息和账单地址的支付信息收集页面，您无需进行额外的开发工作。  
以下是一个不包含账单地址的 **pay** API 调用示例：  
```json
{
  "order": {
    "orderAmount": {
      "currency": "USD",
      "value": "100"
    },
    "orderDescription": "《Bad Romance》-Lady Gaga",
    "referenceOrderId": "ORDER_20231208152528327",
    "goods": [
      {
        "goodsCategory": "Digital Goods",
        "goodsName": "《Bad Romance》",
        "goodsQuantity": "1",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "100"
        },
        "goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
        "referenceGoodsId": "GOODS_20231208152528327"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "shippingPhoneNo": "123456789"
    },
    "buyer": {
      "buyerEmail": "gaga@gaga.com",
      "buyerName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "buyerPhoneNo": "123456789",
      "referenceBuyerId": "88888888"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD"
  },
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
  "paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
  "paymentRequestId": "PAY_2023120uuu54400oo4854327",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```
Antom 将返回一个中间页面，其地址为 _normalUrl_，即支付信息收集页面。将买家重定向到这个页面，买家将在该页面上输入支付和账单信息。  
![图片 3: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713856891470-62d84e25-4e38-4922-a225-619e2d514d20.png)  
图 1. 支付信息收集页面（API）
### SDK 集成  
Antom 提供了支付信息收集页面，供买家输入支付和账单信息，无需您进行额外的开发工作。  
以下是一个不包含账单地址的调用 [**createPaymentSession**](https://global.alipay.com/docs/ac/ams/session_cashier) API 的示例：  
```json
{
  "order": {
    "orderAmount": {
      "currency": "USD",
      "value": "100"
    },
    "orderDescription": "《Bad Romance》-Lady Gaga",
    "referenceOrderId": "ORDER_20231106113345977",
    "goods": [
      {
        "goodsCategory": "Digital Goods",
        "goodsName": "《Bad Romance》",
        "goodsQuantity": "1",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "100"
        },
        "goodsUrl": "https://www.youtube.com/watch?v=QdaG6pDOz5A",
        "referenceGoodsId": "GOODS_20231106113345977"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "shippingPhoneNo": "123456789"
    },
    "buyer": {
      "buyerEmail": "gaga@gaga.com",
      "buyerName": {
        "firstName": "lady",
        "fullName": "lady gaga",
        "lastName": "gaga"
      },
      "buyerPhoneNo": "123456789",
      "referenceBuyerId": "88888888"
    }
  },
  "env": {
    "terminalType": "WEB",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
    "deviceLanguage": "zh_CN"
  },
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD"
  },
  "enableInstallmentCollection": true,
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",
  "paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test_114.html",
  "paymentRequestId": "PAY_20234411061ooo133459707",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```
Antom 为您的买家提供了以下信息收集页面：  
![Image 4: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713858048965-099252c0-1dbf-4d49-b2f1-4e9860c53426.png)  
图2. 支付信息收集页面（SDK）  
接收支付结果通知
----------------------
以下代码示例展示了支付结果通知中的 AVS 检查结果：  
```json
{
  "actualPaymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "cardInfo": {
    "avsResultRaw": "Y",
    "cardBrand": "JCB",
    "cardNo": "************3566",
    "cvvResultRaw": "X",
    "funding": "CREDIT",
    "issuingCountry": "US",
    "networkTransactionId": "200719820486071",
    "paymentMethodRegion": "GLOBAL",
    "threeDSResult": {
      "cavv": "",
      "eci": ""
    }
  },
  "notifyType": "PAYMENT_RESULT",
  "paymentAmount": {
    "currency": "USD",
    "value": "100"
  },
  "paymentCreateTime": "2024-03-28T20:35:23-07:00",
  "paymentId": "20240329114010800100181570206917730",
  "paymentRequestId": "2024032938401734456237",
  "paymentResultInfo": {
    "avsResultRaw": "Y",
    "cardBrand": "JCB",
    "cardNo": "************3566",
    "cvvResultRaw": "X",
    "funding": "CREDIT",
    "issuingCountry": "US",
    "networkTransactionId": "200719820486071",
    "paymentMethodRegion": "GLOBAL",
    "threeDSResult": {
      "cavv": "",
      "eci": ""
    }
  },
  "paymentTime": "2024-03-28T20:35:29-07:00",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```
常见问题
----------
#### 1. 如果为 _billingAddress_ 指定错误的值，交易会失败吗？
当 _billingAddress_ 的值指定不正确时，以下情况可能导致交易失败：
*   **参数值异常**：如果指定了 _billingAddress_ 参数，_region_ 值是必需的。如果缺少必需的值或 _region_ 值与指定的 _state_ 值不匹配，调用 **pay** API 时会出现异常并返回错误代码。发生此错误时，支付会失败，Antom 不会发送支付失败的异步通知。
*   **信息不匹配**：如果地址信息存在不一致，可能导致交易失败。例如，如果买家在银行账户注册时提供的账单地址为 `CA`，但在请求中指定的 _billingAddress_ 值为 `FL`，则地址信息存在不一致。在这种情况下，您可以根据 _avsResultRaw_ 的值来决定是否继续发货。
#### 2. 如何理解 _avsResultRaw_ 中不同枚举值的含义？
请参考 [AVS 结果代码](https://global.alipay.com/docs/ac/ref/risk_methods#uk0zA) 了解更多详情。
#### 3. 如果我已经存储了支付和账单地址信息，是否还需要在信息收集页面上收集这些信息？
*   **API 集成的托管模式**：如果您已经存储了买家的支付和账单地址信息，在调用 **pay** API 的 _billingAddress_ 参数中使用存储的值。支付和账单地址信息将在 Antom 中间页面上显示，以避免买家重复填写信息，提高支付体验。
*   **SDK 集成**：如果您已经存储了买家的支付和账单地址信息，在调用 **createPaymentSession** API 的 _billingAddress_ 参数中使用存储的值。支付和账单地址信息将在 Antom 中间页面上显示，以避免买家重复填写信息，提高支付体验。
信用卡信息存储
================
您可以允许买家添加他们的卡片。也就是说，买家可以选择在首次支付时保存他们的卡信息，以便在后续支付时无需重新输入信息。以下是一个买家在首次支付时保存了卡信息后，后续支付的结账页面示例：  
![Image 5: image](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1682045853015-85909c07-b240-4d1f-ae65-a8b8e49d4594.png)  
图3. 使用之前保存的卡信息进行后续支付的结账页面  
API 集成
----------
如何添加买家的卡片取决于集成模式。对于服务器到服务器模式和托管模式，请按照以下步骤操作：  
服务器到服务器模式  
托管模式
### 服务器间模式  
在服务器间模式下，收集买家的卡信息后，您可以选择自己存储卡信息，或者让蚂蚁金服（Antom）为您存储。  
*   **蚂蚁金服存储卡信息（推荐）**  
当买家在您的页面上存储卡信息时，通过[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 将卡信息传递给蚂蚁金服，并将 `_tokenize` 字段设置为 `true`。蚂蚁金服将为卡信息生成对应的卡令牌（_cardToken_）。支付授权成功后，您可以通过接收异步通知或调用 **inquiryPayment** API 获取卡令牌（_cardToken_）和部分隐藏的卡号（_cardNo_）。为了处理后续支付，您必须存储并关联获取到的卡令牌、部分隐藏的卡号以及买家的其他信息。  
以下代码示例展示了在收集卡信息后，蚂蚁金服存储卡信息时调用 **pay** API 的请求：  
```json
{
"settlementStrategy": {
"settlementCurrency": "EUR"
},
"productCode": "CASHIER_PAYMENT",
"paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_GROUP&paymentMethodType=CARD",
"paymentRequestId": "2****************2",
"paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=2023070458941025622196",
"paymentFactor": {
"isAuthorization": true
},
"paymentMethod": {
"paymentMethodMetaData": {
"recurringType": "",
"cvv": "123",
"is3DSAuthentication": false,
"isCardOnFile": false,
"expiryMonth": "05",
"tokenize": true,
"expiryYear": "26",
"billingAddress": {
"zipCode": "310000",
"address2": "gongzhuan Road",
"city": "hangzhou",
"state": "zhejiang",
"region": "CN"
},
"cardNo": "****1846"
},
"paymentMethodType": "CARD"
},
"paymentExpiryTime": "2025-11-27T12:00:01+08:30",
"paymentAmount": {
"currency": "EUR",
"value": "8204"
},
"merchantRegion": "",
"order": {
"orderAmount": {
"currency": "EUR",
"value": "8204"
},
"referenceOrderId": "2********************0",
"shipping": {
"shippingName": {
"firstName": "Li",
"lastName": "Kyle",
"fullName": "Kyle Li"
},
"shippingCarrier": "DHL",
"shippingPhoneNo": "**********19",
"shipToEmail": "exam***@163.com",
"shippingAddress": {
"zipCode": "310000",
"address2": "gongzhuan Road",
"city": "hangzhou",
"state": "zhejiang",
"region": "CN"
}
},
"goods": [
{
"referenceGoodsId": "2******************7",
"goodsUrl": "qinghailipipeng",
"goodsCategory": "chemical",
"goodsUnitAmount": {
"currency": "EUR",
"value": "8204"
},
"goodsQuantity": "1",
"goodsName": "boom",
"goodsSkuName": "boom boom room",
"goodsBrand": "antom boom"
}
],
"env": {
"clientIp": "1.1.1.1",
"osType": "IOS",
"terminalType": "WAP"
},
"orderDescription": "ANTOM_ZZ",
"buyer": {
"referenceBuyerId": "2******************7",
"buyerName": {
"firstName": "Li",
"lastName": "Kyle",
"fullName": "Kyle Li"
}
}
}
}
```
当买家使用已保存的卡进行支付时，执行以下操作：  
1.  在结账页面上显示部分隐藏的卡信息给买家。
2.  通过 **pay** API 传递以下参数：  
    1.  `_paymentMethodId_`: 值与 `_cardToken_` 参数相同（从 **notifyPayment** 和 **inquiryPayment** 的 `paymentResultInfo` 中获取）。
    2.  额外的验证参数（如巴西卡的 `_cpf_` 参数）。
    3.  `_isCardOnFile_`: 设置为 `true`。此参数用于标识使用已保存卡的后续支付。  
以下代码示例展示了买家使用已保存卡支付时调用 **pay** API 的请求，使用卡令牌：  
```json
{
"settlementStrategy": {
"settlementCurrency": "EUR"
},
"productCode": "CASHIER_PAYMENT",
"paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_GROUP&paymentMethodType=CARD",
"paymentRequestId": "2****************2",
"paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=2023070471913565376977",
"paymentFactor": {
"isAuthorization": true
},
"paymentMethod": {
"paymentMethodId": "A********************************************************************************************=",
"paymentMethodMetaData": {
"recurringType": "SCHEDULED",
"is3DSAuthentication": false,
"isCardOnFile": true,
"networkTransactionId": "2*************5"
},
"paymentMethodType": "CARD"
},
"paymentExpiryTime": "2025-11-27T12:00:01+08:30",
"paymentAmount": {
"currency": "EUR",
"value": "3063"
},
"merchantRegion": "",
"order": {
"orderAmount": {
"currency": "EUR",
"value": "3063"
},
"referenceOrderId": "2****************1",
"shipping": {
"shippingName": {
"firstName": "Li",
"lastName": "Kyle",
"fullName": "Kyle Li"
},
"shippingCarrier": "DHL",
"shippingPhoneNo": "**********119",
"shipToEmail": "exam***@163.com",
"shippingAddress": {
"zipCode": "310000",
"address2": "gongzhuan Road",
"city": "hangzhou",
"state": "zhejiang",
"region": "CN"
}
},
"goods": [
{
"referenceGoodsId": "2********************9",
"goodsUrl": "qinghailipipeng",
"goodsCategory": "chemical",
"goodsUnitAmount": {
"currency": "EUR",
"value": "3063"
},
"goodsQuantity": "1",
"goodsName": "boom",
"goodsSkuName": "boom boom room",
"goodsBrand": "antom boom"
}
],
"env": {
"clientIp": "1.1.1.1",
"osType": "IOS",
"terminalType": "WAP"
},
"orderDescription": "ANTOM_ZZ",
"buyer": {
"referenceBuyerId": "K*****************3",
"buyerName": {
"firstName": "Li",
"lastName": "Kyle",
"fullName": "Kyle Li"
}
}
}
}
```
*   **自行存储卡信息**  
当买家在您的页面上保存卡信息时，您需要在自己的服务器上存储并关联买家信息和相应的卡信息。当买家再次发起支付时，您需要通过 **pay** API 传递卡信息，并将 `_isCardOnFile_` 的值设置为 `true`。`_isCardOnFile_` 用于标识使用已保存卡的后续支付，设置此参数可以提高支付成功率。  
以下代码示例展示了买家使用已保存卡支付时调用 **pay** API 的请求：  
```json
{
"env": {
"terminalType": "APP",
"clientIp": "112.80.248.78",
"deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMO****",
"osType": "IOS",
"deviceLanguage": "zh_CN",
"colorDepth": 48,
"screenHeight": 768,
"screenWidth": 1024,
"timeZoneOffset": 1
},
"order": {
"orderAmount": {
"currency": "EUR",
"value": "30000"
},
"orderDescription": "Cappuccino #grande (Mika's coffee shop)",
"referenceOrderId": "ORDER_2022111414171****",
"goods": [
{
"referenceGoodsId": "383382011_SGAMZ-90452****",
"goodsName": "[3 Boxes] Starbucks Cappuccino Milk Coffee Pods / Coffee Capsules by Nescafe Dolce Gusto",
"goodsUrl": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
"goodsCategory": "Digital  Goods/Digital  Vouchers/Food  and Beverages",
"goodsUnitAmount": {
"currency": "EUR",
"value": "30000"
},
"goodsQuantity": "10"
}
],
"shipping": {
"shippingName": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
},
"shippingAddress": {
"zipCode": "310000",
"address2": "Xihu",
"city": "Hangzhou",
"address1": "Wuchang road",
"state": "Zhejiang",
"region": "CN"
},
"shippingCarrier": "FedEx",
"shippingPhoneNo": "1234567****",
"shipToEmail": "test@gmail.com"
},
"buyer": {
"referenceBuyerId": "test12345678",
"buyerPhoneNo": "1234567****",
"buyerEmail": "alipay@alipay.com",
"buyerName": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
}
}
},
"paymentAmount": {
"currency": "EUR",
"value": "30000"
},
"paymentMethod": {
"paymentMethodType": "CARD",
"paymentMethodMetaData": {
"isCardOnFile": true,
"enableAuthenticationUpgrade": false,
"is3DSAuthentication": false,
"cardholderName": {
"firstName": "Tom",
"lastName": "Jay"
},
"expiryMonth": "12",
"billingAddress": {
"zipCode": "310000",
"address2": "Xihu",
"city": "Hangzhou",
"address1": "Wuchang road",
"state": "Zhejiang",
"region": "CN"
},
"expiryYear": "29",
"cardNo": "411734780615****"
}
},
"settlementStrategy": {
"settlementCurrency": "EUR"
},
"paymentNotifyUrl": "https://www.alipay.com/notify",
"paymentRedirectUrl": "https://www.alipay.com",
"paymentRequestId": "PAY_2022111414171****",
"productCode": "CASHIER_PAYMENT",
"paymentFactor": {
"isAuthorization": true
}
}
}
```
### Hosted模式  
在托管模式下，Antom（蚂蚁金服的前身）提供一个支付信息收集页面。当买家选择保存卡片信息并完成授权支付时，Antom会存储买家的卡片信息并生成对应的卡片令牌（_cardToken_）。支付授权后，您可以通过接收异步通知或调用[**inquiryPayment**](https://global.alipay.com/docs/ac/card/inquiry) API 获取买家的卡片信息（_cardInfo_）。卡片信息包括卡片令牌（_cardToken_）和脱敏的卡片详情。

以下代码示例展示了买家选择保存卡片信息并完成授权支付时，Antom 发送的异步通知示例，其中包含了买家的支付信息：

```json
{
  "notifyType": "PAYMENT_RESULT",
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "success"
  },
  "paymentRequestId": "2020010123456789****",
  "paymentId": "2020010123456789****",
  "paymentAmount": {
    "value": "8000",
    "currency": "EUR"
  },
  "paymentCreateTime": "2020-01-01T12:01:00+08:30",
  "paymentTime": "2020-01-01T12:01:01+08:30",
  "paymentResultInfo": {
    "cardBrand": "VISA",
    "cardNo": "123456789000****",
    "cardToken": "ALIPAY6GPhBXfyvUva6BJziioYucDM00zCwoZckNuxyxYIp4Ti/tsGntq/+EmWT4nVF5BqCAo/b1OjVTvtl1zspyMG****",
    "funding": "DEBIT",
    "issuingCountry": "FR",
    "paymentMethodRegion": "FR",
    "avsResultRaw": "A",
    "cvvResultRaw": "Y",
    "networkTransactionId": "sampleNetworkTransactionId12****",
    "threeDSResult": {
      "eci": "02",
      "threeDSVersion": "2.2.0",
      "caav": "cavvSample",
      "dsTransactionId": "sample_dsTranascti****"
    }
  }
}
```

当买家使用已保存的卡片进行后续支付时，您需要在调用[**pay**](https://global.alipay.com/docs/ac/card/pay) API 时传入以下参数：
1.  _paymentMethodId_：值应与_cardToken_ 参数相同。
2.  可选验证参数（如巴西卡片的_CPF_ 参数）。
3.  _isCardOnFile_：值设为 `true`，表示这是使用已保存卡片的后续支付，有助于提高支付成功率。

以下代码示例展示了服务器调用**pay (Checkout Payment)** API 进行后续支付的示例：

```json
{
  "env": {
    "browserInfo": {
      "acceptHeader": "*/*",
      "javaEnabled": true,
      "javaScriptEnabled": true,
      "language": "zh_CN",
      "userAgent": "Chrome/100"
    },
    "terminalType": "APP",
    "clientIp": "112.80.248.78",
    "deviceId": "eYOIkvFpZzztgO0Yu6USdprBQZCWxDhiUAHCiK8K/cH9mT6wMaMOzAKe",
    "osType": "IOS",
    "deviceLanguage": "zh_CN",
    "colorDepth": 48,
    "screenHeight": 768,
    "screenWidth": 1024,
    "timeZoneOffset": 1
  },
  "order": {
    "orderAmount": {
      "currency": "EUR",
      "value": "30000"
    },
    "orderDescription": "Cappuccino #grande (Mika's coffee shop)",
    "referenceOrderId": "ORDER_20221114141714891",
    "goods": [
      {
        "referenceGoodsId": "383382011_SGAMZ-904520356",
        "goodsName": "[3 Boxes] Starbucks Cappuccino Milk Coffee Pods / Coffee Capsules by Nescafe Dolce Gusto",
        "goodsUrl": "https://www.lazada.sg/products/3-boxes-starbucks-cappuccino-milk-coffee-pods-coffee-capsules-by-nescafe-dolce-gusto-i383382011-s904520356.html?clickTrackInfo=undefined&search=1&source=search&spm=a2o42.searchlist.list.3",
        "goodsCategory": "Digital Goods/Digital Vouchers/Food and Beverages",
        "goodsUnitAmount": {
          "currency": "EUR",
          "value": "30000"
        },
        "goodsQuantity": "10"
      }
    ],
    "shipping": {
      "shippingName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      },
      "shippingAddress": {
        "zipCode": "310000",
        "address2": "Xihu",
        "city": "Hangzhou",
        "address1": "Wuchang road",
        "state": "Zhejiang",
        "region": "CN"
      },
      "shippingCarrier": "FedEx",
      "shippingPhoneNo": "12345678912",
      "shipToEmail": "test@gmail.com"
    },
    "buyer": {
      "referenceBuyerId": "test12345678",
      "buyerPhoneNo": "12345678912",
      "buyerEmail": "alipay@alipay.com",
      "buyerName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      }
    }
  },
  "paymentAmount": {
    "currency": "EUR",
    "value": "30000"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD",
    "paymentMethodMetaData": {
      "isCardOnFile": true,
      "enableAuthenticationUpgrade": false,
      "is3DSAuthentication": true
    }
  },
  "settlementStrategy": {
    "settlementCurrency": "EUR"
  },
  "paymentNotifyUrl": "https://www.alipay.com/notify",
  "paymentRedirectUrl": "https://www.alipay.com",
  "paymentRequestId": "PAY_20221114141714891",
  "productCode": "CASHIER_PAYMENT",
  "paymentFactor": {
    "isAuthorization": true
  }
}
```

### SDK 集成  
在 SDK 集成模式下，SDK 提供支付信息收集页面。买家输入卡片信息并选择保存，以便后续支付时无需重新输入。当买家选择保存卡片信息时，Antom 会存储信息并生成相应的卡片令牌（_cardToken_）。支付授权后，您可以通过接收异步通知或调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 获取买家的卡片信息（_cardInfo_），包括卡片令牌（_cardToken_）和脱敏的卡片详情。

### MPI（商户发起交易）
MPI 模式下，Antom 提供一个支付信息收集页面。买家在页面上输入卡片信息并选择保存，Antom 存储买家的卡片信息并生成卡片令牌（_cardToken_）。支付授权后，您可以通过接收异步通知或调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 获取买家的卡片信息（_cardInfo_）。

### 分期付款
您可以提供分期付款选项，让买家选择分期支付。买家在选择分期支付时，会看到分期计划的相关信息，如分期数和每期金额。完成首期支付后，Antom 将根据合同约定的结算周期结算全款。巴西和韩国的卡片支持分期付款，具体分期规则见表。

### 获取卡片分期营销信息
您可以调用[**consult**](https://global.alipay.com/docs/ac/ams/consult) API 获取关于支付方法的分期营销信息，包括支持的卡片品牌（_bankName_）、营销活动的过期时间（_expireTime_）和免息分期数（_installmentFreeNums_）。

### 发起分期付款
通过 API 或 SDK 集成分期付款的关键点包括在调用支付 API 时设置相关参数，如`isCardOnFile`、`selectedCardBrands`等，以及处理分期规则。
### API 整合  
如果买家选择了分期付款方式，您需要在开始支付前收集相关的分期信息，例如分期期数。然后在调用 **pay** API 时，通过 _creditPayPlan_ 对象传递分期信息。在 _creditPayPlan_ 对象中，关键字段是 _creditPayPlan.installmentNum_，它表示分期期数。该字段的值范围为 `2` 到 `12`。  
有关字段描述的更多信息，请参阅 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 文档。  
以下代码示例展示了调用 **pay** API 时的分期付款请求：  
```json
{
"settlementStrategy": {
"settlementCurrency": "USD"
},
"productCode": "CASHIER_PAYMENT",
"paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_online&paymentMethodType=CARD",
"paymentRequestId": "amsdmpay_zy236564_20231016_100559_577",
"paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_zy236564_20231016_100559_577",
"paymentFactor": {
"isAuthorization": true,
"asyncPay": false,
"captureMode": "MANUAL"
},
"paymentMethod": {
"paymentMethodMetaData": {
"cvv": "540",
"cardholderName": {
"firstName": "Tom",
"lastName": "Jerry"
},
"expiryMonth": "01",
"useStringType": false,
"billingAddress": {
"zipCode": "310000",
"address2": "Huanglong",
"city": "Hangzhou",
"address1": "Gongzhuan road",
"state": "Zhejiang",
"region": "CN"
},
"expiryYear": "28",
"cardNo": "4293380420642881"
},
"paymentMethodType": "CARD"
},
"creditPayPlan": {
"installmentNum": 2
},
"enableInstallmentCollection":true,
"paymentAmount": {
"currency": "BRL",
"value": "600"
},
"order": {
"orderAmount": {
"currency": "BRL",
"value": "600"
},
"referenceOrderId": "amsdmorder_zy236564_20231016_100559_577",
"goods": [
{
"referenceGoodsId": "amsdm_good_zy236564_20231016_100559_577",
"goodsUrl": "HangZhou LeiFenTa",
"goodsCategory": "card/ssr/adc",
"goodsUnitAmount": {
"currency": "USD",
"value": "10000"
},
"goodsQuantity": "1",
"goodsName": "商品1",
"goodsSkuName": "SKU1",
"goodsBrand": "AMSDM"
}
],
"env": {
"clientIp": "1.1.1.1",
"osType": "IOS",
"terminalType": "WEB"
},
"extendInfo": "{}",
"orderDescription": "AMSDM_GIFT",
"buyer": {
"referenceBuyerId": "zy236564",
"buyerRegistrationTime": "2022-01-01T09:30:00+08:00",
"buyerName": {
"firstName": "Dehua",
"lastName": "Liu",
"fullName": "Dehua Skr Liu",
"middleName": "Skr"
}
}
}
}
```
> **注意**：如果您不通过 _creditPayPlan_ 字段指定分期信息，支付将默认为非分期付款。
### SDK 集成
如果买家选择分期付款方式，您可以自己收集分期信息，也可以将收集工作委托给SDK。

#### 自行收集分期信息
如果您选择自行收集分期信息，需要在发起支付前从买家那里获取分期数等详细信息。然后在调用 **createPaymentSession** API 时，通过 `_creditPayPlan` 字段传递分期信息。在 `_creditPayPlan` 对象中，关键字段是 `_creditPayPlan.installmentNum`，表示分期数。该字段的值范围为 `2` 到 `12`。

有关字段描述的更多信息，请参阅 [**createPaymentSession**](https://global.alipay.com/docs/ac/ams/session_cashier) API 文档。

当您自行收集分期信息时，发起支付请求的代码示例如下：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_online&paymentMethodType=CARD",
  "paymentRequestId": "amsdmpay20231016_100927_794",
  "agreementInfo": {
    "authState": "amsdemo_authState_zy236564_20231016_100927_794"
  },
  "paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_zy236564_20231016_100927_794",
  "paymentFactor": {
    "isAuthorization": true,
    "asyncPay": false,
    "captureMode": "MANUAL"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD"
  },
  "creditPayPlan": {
    "installmentNum": 2
  },
  "enableInstallmentCollection":true,
  "paymentAmount": {
    "currency": "BRL",
    "value": "6000"
  },
  "order": {
    "orderAmount": {
      "currency": "BRL",
      "value": "6000"
    },
    "referenceOrderId": "amsdmorder_zy236564_20231016_100927_794",
    "goods": [
      {
        "referenceGoodsId": "amsdm_good_zy236564_20231016_100927_794",
        "goodsUrl": "HangZhou LeiFenTa",
        "goodsCategory": "card/ssr/adc",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "10000"
        },
        "goodsQuantity": "1",
        "goodsName": "Goods No.1",
        "goodsSkuName": "SKU1",
        "goodsBrand": "AMSDM"
      }
    ],
    "env": {
      "clientIp": "1.1.1.1",
      "osType": "IOS",
      "terminalType": "WEB"
    },
    "extendInfo": "{}",
    "orderDescription": "AMSDM_GIFT",
    "buyer": {
      "referenceBuyerId": "zy236564",
      "buyerRegistrationTime": "2022-01-01T09:30:00+08:00",
      "buyerName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      }
    }
  }
}
```

#### 委托SDK收集分期信息
如果需要SDK收集分期付款信息，调用 [**createPaymentSession**](https://global.alipay.com/docs/ac/ams/session_cashier) API 时，需将 `enableInstallmentCollection` 字段设置为 `true`。如果将 `enableInstallmentCollection` 字段设置为 `false` 或者不设置，SDK 默认不会收集分期信息。

SDK 收集分期信息时，发起支付请求的代码示例如下：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_online&paymentMethodType=CARD",
  "paymentRequestId": "amsdmpay20231016_100927_794",
  "agreementInfo": {
    "authState": "amsdemo_authState_zy236564_20231016_100927_794"
  },
  "paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_zy236564_20231016_100927_794",
  "paymentFactor": {
    "isAuthorization": true,
    "asyncPay": false,
    "captureMode": "MANUAL"
  },
  "paymentMethod": {
    "paymentMethodType": "CARD"
  },
  "enableInstallmentCollection":true,
  "paymentAmount": {
    "currency": "BRL",
    "value": "6000"
  },
  "order": {
    "orderAmount": {
      "currency": "BRL",
      "value": "6000"
    },
    "referenceOrderId": "amsdmorder_zy236564_20231016_100927_794",
    "goods": [
      {
        "referenceGoodsId": "amsdm_good_zy236564_20231016_100927_794",
        "goodsUrl": "HangZhou LeiFenTa",
        "goodsCategory": "card/ssr/adc",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "10000"
        },
        "goodsQuantity": "1",
        "goodsName": "Goods No.1",
        "goodsSkuName": "SKU1",
        "goodsBrand": "AMSDM"
      }
    ],
    "env": {
      "clientIp": "1.1.1.1",
      "osType": "IOS",
      "terminalType": "WEB"
    },
    "extendInfo": "{}",
    "orderDescription": "AMSDM_GIFT",
    "buyer": {
      "referenceBuyerId": "zy236564",
      "buyerRegistrationTime": "2022-01-01T09:30:00+08:00",
      "buyerName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      }
    }
  }
}
```

### 3D交易中提前收集设备和浏览器信息
在3D交易中提前收集设备和浏览器信息可以提高用户体验和支付成功率，通过增加无摩擦3D Secure认证的可能性。

无论支付时使用哪种认证方法，都需要收集设备和浏览器信息。这个收集过程可能会让用户等待，影响支付体验。通过此功能，这些信息将在用户选择卡号但提交支付之前收集，从而避免用户在支付过程中等待，提升支付体验。

#### 集成指南
目前，此功能仅适用于API集成模式，并且适用于以下场景之一：
1. 您作为商家自行收集卡信息。
2. 您作为商家使用卡令牌接受支付。
### 步骤1：获取设备数据收集URL（服务器端）

在用户选择卡号但尚未提交支付后，调用**initializeAuthentication** API获取设备数据收集URL。考虑到收集信息需要时间，建议在用户选择支付方式时进行收集。

以下是一个请求消息的示例：

```json
{
  "authenticationRequestId": "202401abcdefg_sda_202404287_yf_gogo_23",
  "identityType": "CARD_PAN",
  "paymentRedirectUrl": "http://www.merchantsite.com",
  "authenticationType": "THREEDS",
  "identityValue": {
    "cardBrand": "VISA",
    "cardBin": "412408",
    "cardClass": "D"
  }
}
```

请求体中的关键参数：

| 参数 | 描述 |
| --- | --- |
| authenticationRequestId | 用于与`initializeAuthentication`和`pay` API关联的唯一请求ID。 |
| identityType | 身份类型。有效值为：`CARD_TOKEN`（使用Antom提供的卡令牌支付），`CARD_NT`（使用网络令牌支付），`CARD_PAN`（通过收集卡号支付）。 |
| identityValue.cardToken | 当`identityType`为`CARD_TOKEN`时指定相应的令牌。 |
| identityValue.cardBin | 当`identityType`为`CARD_NT`或`CARD_PAN`时指定卡bin。 |
| identityValue.cardBrand | 当`identityType`为`CARD_NT`或`CARD_PAN`时指定卡品牌。 |
| identityValue.funding | 当`identityType`为`CARD_NT`或`CARD_PAN`时指定资金类型。 |

以下是一个响应消息的示例：

```json
{
  "authenticationId": "2024050716031241000190000162360",
  "authenticationRequestId": "202401abcdefg_sda_202404287_yf_gogo_24",
  "redirectActionForm": {
    "method": "POST",
    "parameters": "{\"ddcReferenceId\":\"af39d8b9-ff19-4013-a097-c54c8375efe2\",\"Bin\":\"412408\",\"JWT\":\"eyJraWQiOiJDQVJESU5BTF9KV1RfYWxpcGF5IiwiY3R5IjoiQ0FSRElOQUxfSldUX2FsaXBheSIsImFsZyI6IkhTMjU2In0.eyJPcmdVbml0SWQiOiI1ZDA5NDJmNmJiODc2ODE5NmMzMTYzYTciLCJSZWZlcmVuY2VJZCI6ImFmMzlkOGI5LWZmMTktNDAxMy1hMDk3LWM1NGM4Mzc1ZWZlMiIsIlJldHVyblVybCI6Im9wZW4tdGVzdC1kZS1ncm91cDIwMjQwNDE4MTQxNDEyLmRsLmFsaXBheWRldi5jb20vYXBpL29wZW4vdXJsX2NhbGxiYWNrX2dldC9jYXJkaW5hbC9jYXJkaW5hbDAwNy5odG0_c2lnbkRhdGE9UGJMendDMk9qYnJIRzNwJTJGOSUyRm1qV2ZCSE5WZmVObzRwJTJCR1NvV3JYNXJFZDY2T3RWVUI0VmNuaE1WcVdTQnZmR2NNdDRRV3pNbUFvek90UjgzRTlYNkVTZEpaRVdiQkQlMkZKS1ZjZHYlMkJpQlcxUHVmR0EzQWZtMGQ3M2lGWFZXNjlqT0ZzOTBqTCUyQm5qb0ZXQTRZWEklMkZ3UExwRVN3T2YlMkJscXhjbUNUVXlETFg2U3hJY0x3ZEF0Y2NZeG5oc0FaVmclMkZCMVFTdHl6diUyQk1sVEtXVUpzdmlYR0c4MDBFa3E5Q29YJTJGWjVNSnQlMkJZRG11WHBHZ0l6OUhKUmxrY0RxRGpySXUlMkY5VSUyRmpMa01VWWNoelJWYXNvdDZDY25uWG5FaktjSW1VeWw1ekxNdlE0Y2M1WGlPWElKdG5SdDdmNlZ3MnRacDNJWVVqMkM1Mld0bWh0JTJGejB4Z05abWlnJTNEJTNEJmluU2VyaWFsTm89MjAyNDA1MDcxNjAzMTM0MTAwMDE5MDAwMDE0NDU3MyZvdXRPcmRlck5vPTIwMjQwNTA3MTYwMzEzNDEwMDAxOTAwMDAxNDQ1NzMiLCJleHAiOjE3MTUwODE3MzgsImlhdCI6MTcxNTA4MDgzOCwiaXNzIjoiNWQwOTQ4MDlhZmE4MGQyMjUwMDQyODBkIiwianRpIjoiMjAyNDA1MDcxNjAzMTM0MTAwMDE5MDAwMDE0NDU3MyJ9.upNHVxubLYrAGzRWUhIM19v9kZ6yPyrR_JG4H54BWAU\"",
    "redirectUrl": "https://centinelapistag.cardinalcommerce.com/V1/Cruise/Collect"
  },
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```

响应体中的关键参数：

| 参数 | 描述 |
| --- | --- |
| actionForm.redirectUrl | 用于通过POST收集设备数据的URL。 |
| actionForm.parameters.ddcReferenceId | 支付方式ID。 |
| actionForm.parameters.JWT | 密码。 |
| actionForm.parameters.BIN | 卡bin。 |

请注意，这里的示例是针对特定的支付和身份验证流程，可能需要根据实际的API文档和实现进行调整。
### 步骤2: 收集设备数据（客户端）
客户端通过发起POST请求来访问上一步**initializeAuthentication** API返回的 `_redirectUrl`。

以下是一个请求消息的示例：

```markdown
Request request = new Request();
request.setMethod("POST");
request.setParameters("{\"ddcReferenceId\":\"af39d8b9-ff19-4013-a097-c54c8375efe2\",\"Bin\":\"412408\",\"JWT\":\"eyJraWQiOiJDQVJESU5BTF9KV1RfYWxpcGF5IiwiY3R5IjoiQ0FSRElOQUxfSldUX2FsaXBheSIsImFsZyI6IkhTMjU2In0.eyJPcmdVbml0SWQiOiI1ZDA5NDJmNmJiODc2ODE5NmMzMTYzYTciLCJSZWZlcmVuY2VJZCI6ImFmMzlkOGI5LWZmMTktNDAxMy1hMDk3LWM1NGM4Mzc1ZWZlMiIsIlJldHVyblVybCI6Im9wZW4tdGVzdC1kZS1ncm91cDIwMjQwNDE4MTQxNDEyLmRsLmFsaXBheWRldi5jb20vYXBpL29wZW4vdXJsX2NhbGxiYWNrX2dldC9jYXJkaW5hbC9jYXJkaW5hbDAwNy5odG0_c2lnbkRhdGE9UGJMendDMk9qYnJIRzNwJTJGOSUyRm1qV2ZCSE5WZmVObzRwJTJCR1NvV3JYNXJFZDY2T3RWVUI0VmNuaE1WcVdTQnZmR2NNdDRRV3pNbUFvek90UjgzRTlYNkVTZEpaRVdiQkQlMkZKS1ZjZHYlMkJpQlcxUHVmR0EzQWZtMGQ3M2lGWFZXNjlqT0ZzOTBqTCUyQm5qb0ZXQTRZWEklMkZ3UExwRVN3T2YlMkJscXhjbUNUVXlETFg2U3hJY0x3ZEF0Y2NZeG5oc0FaVmclMkZCMVFTdHl6diUyQk1sVEtXVUpzdmlYR0c4MDBFa3E5Q29YJTJGWjVNSnQlMkJZRG11WHBHZ0l6OUhKUmxrY0RxRGpySXUlMkY5VSUyRmpMa01VWWNoelJWYXNvdDZDY25uWG5FaktjSW1VeWw1ekxNdlE0Y2M1WGlPWElKdG5SdDdmNlZ3MnRacDNJWVVqMkM1Mld0bWh0JTJGejB4Z05abWlnJTNEJTNEJmluU2VyaWFsTm89MjAyNDA1MDcxNjAzMTM0MTAwMDE5MDAwMDE0NDU3MyZvdXRPcmRlck5vPTIwMjQwNTA3MTYwMzEzNDEwMDAxOTAwMDAxNDQ1NzMiLCJleHAiOjE3MTUwODE3MzgsImlhdCI6MTcxNTA4MDgzOCwiaXNzIjoiNWQwOTQ4MDlhZmE4MGQyMjUwMDQyODBkIiwianRpIjoiMjAyNDA1MDcxNjAzMTM0MTAwMDE5MDAwMDE0NDU3MyJ9.upNHVxubLYrAGzRWUhIM19v9kZ6yPyrR_JG4H54BWAU\"}");
request.setRedirectUrl("https://centinelapistag.cardinalcommerce.com/V1/Cruise/Collect");
request.process();
```

为了提供更好的用户体验，建议采取以下措施：

1. 通过iframe在当前页面生成一个单像素点页面，加载信息收集链接，以实现无缝且优化的支付体验。
2. 将收集过程延长至两秒以上，以便收集更多信息。
### 步骤3：收集浏览器信息（客户端）

下表列出了收集信息的关键参数：

| 参数 | 描述 |
| --- | --- |
| colorDepth | 购物者浏览器的颜色深度，以每像素位数表示。需要通过浏览器的`screen.colorDepth`属性获取。可接受的值：1, 4, 8, 15, 16, 24, 30, 32 或 48 位颜色深度。 |
| screenHeight | 购物者设备屏幕的总高度，以像素为单位。 |
| screenWidth | 购物者设备屏幕的总宽度，以像素为单位。 |
| timeZoneOffset | 与协调世界时（UTC）的时差，以分钟为单位。 |
| acceptHeader | 购物者浏览器的`Accept`头值。 |
| javaEnabled | 一个布尔值，表示购物者的浏览器是否能够执行Java。 |
| javaScriptEnabled | 一个布尔值，表示购物者的浏览器是否能够执行JavaScript。如果字段未提供，默认假设为`true`。 |
| language | 购物者浏览器的`navigator.language`值（根据IETF BCP 47定义）。 |
| userAgent | 购物者浏览器的用户代理值。 |
### 步骤4：发起支付 - 服务器端  
在**pay** API中指定初始化认证请求的`_initializeAuthentication.request.authenticationRequestId_`，以关联步骤1，并提供9项浏览器信息。  
以下是一个请求消息的示例：  
```json
{
  "settlementStrategy": {
    "settlementCurrency": "EUR"
  },
  "productCode": "CASHIER_PAYMENT",
  "paymentNotifyUrl": "http://gol.alipay.net:8080/amsdemo/record/notify?env=main_dev&paymentMethodType=CARD",
  "paymentRequestId": "amsdmpay_yanfei_wzh_20240428_191505_xx_022",
  "paymentRedirectUrl": "http://gol.alipay.net:8080/amsdemo/result?paymentRequestId=amsdmpay_yanfei_wzh_20240111_191505_666",
  "paymentFactor": {
    "isAuthorization": true
  },
  "paymentMethod": {
    "paymentMethodMetaData": {
      "authenticationRequestId": "2024051419401080010018896022321932",
      "identityType": "CARD_PAN",
      "cvv": "682",
      "cardholderName": {
        "firstName": "Tom",
        "lastName": "Jerry"
      },
      "expiryMonth": "11",
      "expiryYear": "28",
      "billingAddress": {
        "zipCode": "310000",
        "address2": "Huanglong",
        "city": "Hangzhou",
        "address1": "Gongzhuan road",
        "state": "Zhejiang",
        "region": "CN"
      },
      "cardNo": "4124085486814126"
    },
    "paymentMethodType": "CARD"
  },
  "paymentAmount": {
    "currency": "EUR",
    "value": "7000"
  },
  "order": {
    "orderAmount": {
      "currency": "EUR",
      "value": "7000"
    },
    "referenceOrderId": "amsdmorder_yanfei_wzh_20240111_191505_666",
    "goods": [
      {
        "referenceGoodsId": "amsdm_good_yanfei_wzh_20240111_191505_666",
        "goodsUrl": "HangZhou LeiFenTa",
        "goodsCategory": "card/ssr/adc",
        "goodsUnitAmount": {
          "currency": "USD",
          "value": "10000"
        },
        "goodsQuantity": "1",
        "goodsName": "Goods No.1",
        "goodsSkuName": "SKU1",
        "goodsBrand": "AMSDM"
      }
    ],
    "env": {
      "clientIp": "1.1.1.1",
      "terminalType": "WEB",
      "osType": "IOS",
      "browserInfo": {
        "acceptHeader": "AcceptHeaded111",
        "javaEnabled": true,
        "javaScriptEnabled": false,
        "language": "EN",
        "userAgent": "agentagentagentagentagent"
      },
      "colorDepth": "12",
      "screenHeight": "50",
      "screenWidth": "50",
      "timeZoneOffset": "8"
    },
    "orderDescription": "AMSDM_GIFT",
    "buyer": {
      "referenceBuyerId": "yanfei.wzh",
      "buyerRegistrationTime": "2022-01-01T09:30:00+08:00",
      "buyerName": {
        "firstName": "Dehua",
        "lastName": "Liu",
        "fullName": "Dehua Skr Liu",
        "middleName": "Skr"
      }
    }
  }
}
```
请求体中的关键参数：  
| 参数 | 描述 |
| --- | --- |
| paymentMethod.paymentMethodMateData.authenticationRequestId | 与步骤1关联的唯一请求ID。 |
| pay.env.browserInfo | 浏览器信息。 |
| pay.env.colorDepth | 颜色深度。 |
| pay.env.screenHeight | 屏幕高度。 |
| pay.env.screenWidth | 屏幕宽度。 |
| pay.env.timeZoneOffset | 时区偏移。 |

以下是一个响应消息的示例：  
```json
{
  "normalUrl": "https://iopensandbox-sea.alipay.com/xmock.json?xmockUrl=/api/Shadow/Channel/CHECKOUT/threeDS.htm/20240514890313000045C6835316965/false",
  "paymentActionForm": "{\"method\":\"POST\",\"paymentActionFormType\":\"RedirectActionForm\",\"redirectUrl\":\"https://iopensandbox-sea.alipay.com/xmock.json?xmockUrl=/api/Shadow/Channel/CHECKOUT/threeDS.htm/20240514890313000045C6835316965/false\"}",
  "paymentAmount": {
    "currency": "EUR",
    "value": "30000"
  },
  "paymentCreateTime": "2024-05-14T01:47:22-07:00",
  "paymentId": "202405141940108001001885C0204760163",
  "paymentRequestId": "PAY_2023154767445445328",
  "paymentResultInfo": {
    "avsResultRaw": "",
    "cardBrand": "VISA",
    "cardNo": "************8888",
    "cvvResultRaw": "",
    "networkTransactionId": "20240514890313000045C6835316965",
    "threeDSResult": {
      "cavv": "",
      "eci": ""
    }
  },
  "redirectActionForm": {
    "method": "POST",
    "redirectUrl": "https://iopensandbox-sea.alipay.com/xmock.json?xmockUrl=/api/Shadow/Channel/CHECKOUT/threeDS.htm/20240514890313000045C6835316965/false"
  },
  "result": {
    "resultCode": "PAYMENT_IN_PROCESS",
    "resultMessage": "payment in process",
    "resultStatus": "U"
  }
}
```
**注意：** 提前收集设备数据和浏览器信息可以提高无摩擦3D Secure认证的可能性，但并不能保证生成的3D Secure链接始终无摩擦。用户可能仍需要进行3D Secure认证。

**适用范围：**
* 适用模式：API集成。
* 适用地区：欧洲、英国、新加坡、香港、巴西、秘鲁、墨西哥和智利  
查看文档的最新更新，请访问[版本更新日志](https://global.alipay.com/docs/releasenotes)。  
![Image 8](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![Image 9](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 本页内容  
[设置3D验证](#AopvT "设置3D验证")  
[智能交易挽救](#wSSDx "智能交易挽救")  
[增值服务风险控制](#VHeax "增值服务风险控制")  
[AVS检查](#AQlWl "AVS检查")  
[发起支付](#UMPDE "发起支付")  
[API集成](#kanW0 "API集成")  
[SDK集成](#k85nA "SDK集成")  
[接收支付结果通知](#lh7Rh "接收支付结果通知")  
[常见问题](#5CSHw "常见问题")  
[1. 如果对billingAddress指定错误值，交易会失败吗？](#N86oC "1. 如果对billingAddress指定错误值，交易会失败吗？")  
[2. 如何理解avsResultRaw中不同枚举值的含义？](#jo16j "2. 如何理解avsResultRaw中不同枚举值的含义？")  
[3. 如果我已经存储了支付和账单地址信息，是否还需要在信息收集页面上收集这些信息？](#N7Imz "3. 如果我已经存储了支付和账单地址信息，是否还需要在信息收集页面上收集这些信息？")  
[卡信息存储](#k81bt "卡信息存储")  
[API集成](#idTh1 "API集成")  
[SDK集成](#ccUst "SDK集成")  
[MIT](#eFFmc "MIT")  
[指定卡品牌](#1zi5Q "指定卡品牌")  
[MPI](#C5v5U "MPI")  
[分期付款](#ySn9I "分期付款")  
[获取卡品牌分期信息](#LGWtZ "获取卡品牌分期信息")  
[获取分期营销信息](#JMG19 "获取分期营销信息")  
[发起分期付款](#So99n "发起分期付款")  
[API集成](#rSq8N "API集成")  
[SDK集成](#GJOW6 "SDK集成")  
[3D交易中提前收集设备和浏览器信息](#t3JZg "3D交易中提前收集设备和浏览器信息")  
[集成指南](#R6Xge "集成指南")  
[步骤1：获取设备数据收集URL](#IxFET "步骤1：获取设备数据收集URL")  
[步骤2：收集设备数据](#1iNpn "步骤2：收集设备数据")  
[步骤3：收集浏览器信息](#1MPvd "步骤3：收集浏览器信息")  
[步骤4：发起支付](#FeGMH "步骤4：发起支付")  
[适用范围](#DVLTN "适用范围")