易安宝支付（Android） | 易安宝 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Feasypay_en%2Fandroid)  
[返回首页](../../)

易安宝支付
[概述](/docs/ac/easypay_en/overview_en)  
接收支付  
[易安宝支付（Web/WAP）](/docs/ac/easypay_en/WW)  
[易安宝支付（Android）](/docs/ac/easypay_en/android)  
[易安宝支付（iOS）](/docs/ac/easypay_en/ios)  
支付后  
易安宝支付（Android）
=====================  
2024-05-16 03:26

本文档介绍了支持从桌面浏览器或移动浏览器接收支付的集成解决方案。集成后，您可以提供数字钱包、银行卡和银行转账等多种支付方式。

用户体验
==========

以下截图展示了钱包支付和银行转账的用户体验。首次支付时，买家可以启用免密支付，以便后续支付时无需输入支付密码。后续支付的整个过程将在您的网站或应用内完成。

钱包
----

买家可以在您的网站或应用内完成整个支付流程，首次支付时可以启用免密支付，后续支付无需输入支付密码。

**首次支付**

**后续支付**
### 首次支付  
在首次支付时，买家会完成授权流程，以便后续可以无密码支付。  
![图片3: Android.webp](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715066141268-925d42d4-0b0f-4bdf-9fa8-2dc94b506a23.webp)
### 后续支付  
后续支付无需密码即可完成。对于较大金额的支付，您可以设定一个最低支付金额，当支付金额超过这个值时，需要额外的验证步骤以增强安全性。  

**小额支付**  
对于小额订单，买家可以直接提交订单并进行支付，无需额外确认。  
![图片4: Android1.webp](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715066206219-f337a73f-609d-4418-8497-b489ce81a73c.webp)  

**大额支付**  
为了提高支付安全性，您可以要求买家对超过预设金额的支付进行确认。  
![图片5: Android2.webp](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715066225750-7713f324-6c67-48f7-9bd7-5ed9f680ac5d.webp)  

银行转账
------------  
对于银行转账支付方式，以下图形展示了首次支付和后续支付的用户体验。  

**首次支付**  
**后续支付**
### 首次支付
在首次支付时，用户需要输入支付密码和验证码。
![图片6: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715069804934-925728a4-ba26-47eb-9454-d34689b29116.png)
### 后续支付  
后续支付无需验证号码即可进行。  
![图片7: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715069845024-5cde5fb3-5c1b-4d95-829c-9b9ab9a273e5.png)  
支付流程
========  
首次支付
--------  
当买家选择蚂蚁金服提供的支付方式时，您需要收集支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL等关键信息。调用**createPaymentSession** API创建订单并通过SDK弹出页面。  
![图片8: Easy Pay 首次支付流程图@3x.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715579445358-24330701-5ace-4c1c-ace5-f08522f4de4b.png)  
1.  **买家进入结账页面。**
2.  **创建** [**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay) **请求**
买家选择支付方式并提交订单后，您可以通过调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口获取支付会话。
3.  **调用客户端SDK**
在客户端，通过支付会话调用SDK。SDK会根据支付方式的特性收集支付要素，显示代码信息，重定向，调用并引导买家完成支付。
4.  **获取授权结果**  
    *   异步通知：授权成功后，蚂蚁金服会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API发送异步通知给您。
    *   同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口查询授权状态。  
5.  **获取支付结果**
通过以下两种方法之一获取支付结果：  
    *   异步通知：在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口中设置_paymentNotifyUrl_，指定接收异步通知的地址。支付成功或超时时，蚂蚁金服会使用[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)发送异步通知给您。
    *   同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口查询支付状态。  
后续支付
--------  
当买家选择蚂蚁金服提供的支付方式时，您需要收集支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL等关键信息。调用**createPaymentSession** API创建订单并通过SDK弹出页面。  
![图片9: Easy Pay 再次支付流程图@3x.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715579477973-ea1eb575-af1a-4918-a9ae-8ef6b56e7251.png)  
1.  **买家进入结账页面。**
2.  **创建** [**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay) **请求**
买家选择支付方式并提交订单后，您可以通过调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口获取支付会话。
3.  **调用客户端SDK**
在客户端，通过支付会话调用SDK。SDK会根据支付方式的特性收集支付要素，显示代码信息，重定向，调用并引导买家完成支付。
4.  **获取支付结果**
通过以下两种方法之一获取支付结果：  
    *   异步通知：在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口中设置_paymentNotifyUrl_，指定接收异步通知的地址。支付成功或超时时，蚂蚁金服会使用[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)发送异步通知给您。
    *   同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口查询支付状态。  
集成步骤
========  
要获取买家的授权并进行EasySafePay支付，需要完成以下集成步骤：  
1.  创建支付会话
2.  调用SDK  
3.  获取授权或支付结果  
步骤1：创建支付会话 服务器端
--------------------------------------------  
当买家选择蚂蚁金服提供的支付方式时，您需要收集支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL等关键信息。调用**createPaymentSession** API创建支付会话，并将支付会话返回给客户端。  
蚂蚁金服提供了多种语言的服务器端API库。以下代码以Java为例，需要安装Java 6或更高版本。
### 安装API库  
您可以在[GitHub](https://github.com/alipay/global-open-sdk-java)上找到最新版本。  
复制以下内容：  
```xml
<dependency>
    <groupId>com.alipay.global.sdk</groupId>
    <artifactId>global-open-sdk-java</artifactId>
    <version>2.0.21</version>
</dependency>
```

这段文档是关于在Java项目中安装蚂蚁金服的全球开放SDK的说明。通过在项目的Maven依赖中添加这段代码，可以引入版本为2.0.21的SDK库。
### 初始化请求实例  
创建一个单例资源以向Antom发起请求。  
复制  
```java
import com.alipay.global.api.AlipayClient;
import com.alipay.global.api.DefaultAlipayClient;

String merchantPrivateKey = "您的私钥";
String alipayPublicKey = "支付宝公钥";
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
```

这里的代码是Java语言，用于初始化一个`AlipayClient`实例，这是蚂蚁金服API调用的基础。`merchantPrivateKey`是商户的私钥，`alipayPublicKey`是支付宝的公钥。`EndPointConstants.SG`代表请求的 endpoint，可能是指新加坡地区的服务器。这个`DefaultAlipayClient`实例将用于后续的支付或其他相关业务操作。
### 创建支付会话  
#### 首次支付  
创建支付会话涉及以下参数：  
<table style="width:748px" class="lake-table"><colgroup><col width="211" span="1"><col width="97" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td><p><span>参数名称</span></p></td><td><p><span>是否必需</span></p></td><td><p><span>描述</span></p></td></tr><tr style="height:33px"><td><p><span>paymentRedirectUrl</span></p></td><td><p><span>是</span></p></td><td><p><span>支付完成后买家被重定向到的商户页面URL。</span></p></td></tr><tr style="height:33px"><td><p><span>authState</span></p></td><td><p><span>是</span></p></td><td><p><span>由您分配的用于启动授权的唯一标识，用于后续免密支付获取令牌。此参数仅在首次支付时传递，后续支付不需要传递。</span></p></td></tr><tr style="height:37px"><td><p><span>paymentNotifyUrl</span></p></td><td><p><span>是</span></p></td><td><p><span>支付结果通知地址，必须为HTTPS。</span></p></td></tr><tr style="height:33px"><td><p><span>paymentSessionExpiryTime</span></p></td><td><p><span>是</span></p></td><td><p><span>支付会话超时时间，默认为1小时，可设置为1小时内超时，值的格式遵循<a href="https://www.iso.org/iso-8601-date-and-time-format.html" target="_blank"><span>ISO 8601</span></a>标准。例如，2019-11-27T12:01:01+08:00。</span></p></td></tr><tr style="height:33px"><td><p><span>userLoginId</span></p></td><td><p><span>是</span></p></td><td><p><span>买家钱包侧的登录账号，可以是买家的电子邮件地址或电话号码。</span></p></td></tr><tr style="height:33px"><td><p><span>order.buyer: referenceBuyerId/buyerPhoneNo/buyerEmail</span></p></td><td><p><span>是</span></p></td><td><p><span>为风险决策提供买家信息。传递referenceBuyerId、buyerPhoneNo、buyerEmail中的一个参数即可。</span></p></td></tr></tbody></table>  
以上参数是创建支付会话的基本参数。完整的参数列表和支付方式的额外要求，请参阅[**createPaymentSession (EasySafePay)**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**。**  
以下示例代码展示了如何调用**createPaymentSession** API：  
```java
AlipayPaymentSessionRequest alipayPaymentSessionRequest = new AlipayPaymentSessionRequest();
alipayPaymentSessionRequest.setClientId(clientId);
alipayPaymentSessionRequest.setPath("/ams/sandbox/api/v1/payments/createPaymentSession");
alipayPaymentSessionRequest.setProductCode(ProductCodeType.AGREEMENT_PAYMENT);
alipayPaymentSessionRequest.setProductScene(ProductSceneConstants.EASY_PAY);  
// 替换为你的paymentRequestId
alipayPaymentSessionRequest.setPaymentRequestId("paymentRequestId001");  
Amount amount = new Amount();
// 设置金额
amount.setCurrency("CNY");
amount.setValue("100");
alipayPaymentSessionRequest.setPaymentAmount(amount);  
// 设置结算货币
SettlementStrategy settlementStrategy = new SettlementStrategy();
settlementStrategy.setSettlementCurrency("USD");
alipayPaymentSessionRequest.setSettlementStrategy(settlementStrategy);  
// 设置协议信息
AgreementInfo agreementInfo = new AgreementInfo();
agreementInfo.setAuthState("authState001");
agreementInfo.setUserLoginId("userLoginId001");
alipayPaymentSessionRequest.setAgreementInfo(agreementInfo);  
// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("ALIPAY_CN");  
// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId001");
order.setOrderDescription("orderDescription001");
order.setOrderAmount(amount);
Buyer buyer = new Buyer();
buyer.setReferenceBuyerId("referenceBuyerId001");
order.setBuyer(buyer);
order.setOrderAmount(amount);
alipayPaymentSessionRequest.setOrder(order);  
// 替换为你的通知URL
alipayPaymentSessionRequest.setPaymentNotifyUrl("https://www.yourNotifyUrl");
alipayPaymentSessionRequest.setPaymentRedirectUrl("https://www.yourMerchantWeb.com");  
AlipayPaymentSessionResponse alipayPaymentSessionResponse = defaultAlipayClient
.execute(alipayPaymentSessionRequest);  
```
以下代码展示了请求消息的示例：  
```json
{
"settlementStrategy": {
"settlementCurrency": "USD"
},
"productCode": "AGREEMENT_PAYMENT",
"productScene": "EASY_PAY",
"paymentNotifyUrl": "https://www.yourNotifyUrl",
"paymentRequestId": "paymentRequestId001",
"paymentRedirectUrl": "https://www.yourMerchantWeb.com",
"paymentMethod": {
"paymentMethodType": "ALIPAY_CN"
},
"agreementInfo": {
"authState": "authState001",
"userLoginId":"userLoginId001"
},
"paymentAmount": {
"currency": "CNY",
"value": "100"
},
"order": {
"orderAmount": {
"currency": "CNY",
"value": "100"
},
"referenceOrderId": "referenceOrderId001",
"orderDescription": "orderDescription001",
"buyer":{
"referenceBuyerId":"referenceBuyerId001"
}  
}
}
```
以下代码展示了响应的示例，其中包含以下参数：  
*   _paymentSessionData_: 用于返回给前端的支付会话数据
*   _paymentSessionExpiryTime_: 支付会话的过期时间  
```json
{
"paymentSessionData": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Kvvmsdk+akdLvoShW5avHX8e8J15P8uNVEf/PcCMyXg==&&SG&&111",
"paymentSessionExpiryTime": "2023-04-06T03:28:49+08:00",
"paymentSessionId": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Ikyj9FPVUOpv+DjiIZqMe",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}
```
#### 后续支付  
创建支付会话涉及以下参数：  
<table style="width:738px" class="lake-table"><colgroup><col width="211" span="1"><col width="87" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td><p><span>参数名称</span></p></td><td><p><span>是否必需</span></p></td><td><p><span>描述</span></p></td></tr><tr style="height:33px"><td><p><span>paymentMethod.paymentMethodId</span></p></td><td><p><span>是</span></p></td><td><p><span>传递首次支付后在<a href="https://global.alipay.com/docs/ac/ams/notifyauth" target="_blank"><strong>notifyAuthorization</strong></a> API中收到的<em><span>accessToken</span></em>的值。</span></p></td></tr><tr style="height:33px"><td><p><span>paymentRedirectUrl</span></p></td><td><p><span>是</span></p></td><td><p><span>支付完成后买家被重定向到的商户页面URL。</span></p></td></tr><tr style="height:37px"><td><p><span>paymentNotifyUrl</span></p></td><td><p><span>是</span></p></td><td><p><span>支付结果通知地址，必须为HTTPS。</span></p></td></tr><tr style="height:33px"><td><p><span>paymentSessionExpiryTime</span></p></td><td><p><span>是</span></p></td><td><p><span>支付会话超时时间，默认为1小时，可设置为1小时内超时，值的格式遵循<a href="https://www.iso.org/iso-8601-date-and-time-format.html" target="_blank"><span>ISO 8601</span></a>标准。例如，2019-11-27T12:01:01+08:00。</span></p></td></tr><tr style="height:33px"><td><p><span>order.buyer: referenceBuyerId/buyerPhoneNo/buyerEmail</span></p></td><td><p><span>是</span></p></td><td><p><span>为风险决策提供买家信息。传递referenceBuyerId、buyerPhoneNo、buyerEmail中的一个参数即可。</span></p></td></tr></tbody></table>  
以上参数是创建支付会话的基本参数。完整的参数列表和支付方式的额外要求，请参阅[**createPaymentSession (Easy Pay)**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**。**  
以下示例代码展示了如何调用**createPaymentSession** API：  
```java
AlipayPaymentSessionRequest alipayPaymentSessionRequest = new AlipayPaymentSessionRequest();
alipayPaymentSessionRequest.setClientId(clientId);
alipayPaymentSessionRequest.setPath("/ams/sandbox/api/v1/payments/createPaymentSession");
alipayPaymentSessionRequest.setProductCode(ProductCodeType.AGREEMENT_PAYMENT);
alipayPaymentSessionRequest.setProductScene(ProductSceneConstants.EASY_PAY);  
// 替换为你的paymentRequestId
alipayPaymentSessionRequest.setPaymentRequestId("paymentRequestId002");  
Amount amount = new Amount();
// 设置金额
amount.setCurrency("CNY");
amount.setValue("100");
alipayPaymentSessionRequest.setPaymentAmount(amount);  
// 设置结算货币
SettlementStrategy settlementStrategy = new SettlementStrategy();
settlementStrategy.setSettlementCurrency("USD");
alipayPaymentSessionRequest.setSettlementStrategy(settlementStrategy);  
// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("ALIPAY_CN");
paymentMethod.setPaymentMethodId("*****************************");  
// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId002");
order.setOrderDescription("orderDescription001");
order.setOrderAmount(amount);
Buyer buyer = new Buyer();
buyer.setReferenceBuyerId("referenceBuyerId001");
order.setBuyer(buyer);
order.setOrderAmount(amount);
alipayPaymentSessionRequest.setOrder(order);  
// 替换为你的通知URL
alipayPaymentSessionRequest.setPaymentNotifyUrl("https://www.yourNotifyUrl");
alipayPaymentSessionRequest.setPaymentRedirectUrl("https://www.yourMerchantWeb.com");  
AlipayPaymentSessionResponse alipayPaymentSessionResponse = defaultAlipayClient
.execute(alipayPaymentSessionRequest);  
```
以下代码展示了请求消息的示例：  
```json
{
"settlementStrategy": {
"settlementCurrency": "USD"
},
"productCode": "AGREEMENT_PAYMENT",
"productScene": "EASY_PAY",
"paymentNotifyUrl": "https://www.yourNotifyUrl",
"paymentRequestId": "paymentRequestId002",
"paymentRedirectUrl": "https://www.yourMerchantWeb.com",
"paymentMethod": {
"paymentMethodId": "*****************************",
"paymentMethodType": "ALIPAY_CN"
},
"paymentAmount": {
"currency": "CNY",
"value": "30000"
},
"order": {
"orderAmount": {
"currency": "CNY",
"value": "30000"
},
"referenceOrderId": "referenceOrderId002",
"orderDescription": "orderDescription002",
"buyer":{
"referenceBuyerId":"referenceBuyerId002"
}
}
}
```
以下代码展示了响应的示例，其中包含以下参数：  
*   _paymentSessionData_: 用于返回给前端的支付会话数据
*   _paymentSessionExpiryTime_: 支付会话的过期时间  
```json
{
"paymentSessionData": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Kvvmsdk+akdLvoShW5avHX8e8J15P8uNVEf/PcCMyXg==&&SG&&111",
"paymentSessionExpiryTime": "2023-04-06T03:28:49+08:00",
"paymentSessionId": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Ikyj9FPVUOpv+DjiIZqMe",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}
```
### 常见问题
#### 请求中可以使用中文字符吗？
请勿在请求中的字段，包括`paymentRequestId`、`referenceOrderId`、`orderDescription`和`goods`使用中文字符，以避免与QRIS和Mastercard等不兼容的支付方式产生问题。

#### 如何设置支付结果通知地址？
Antom会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)接口发送支付结果。您可以在`createPaymentSession` API中通过`paymentNotifyUrl`参数指定这个通知地址。如果每个支付的地址都相同，您也可以在Antom控制台上进行配置。如果您同时在控制台配置了地址并在API中设置了参数，Antom将使用API中设置的地址。

步骤2：调用SDK 客户端
----------------------
### 安装  
版本要求：目标至少为Android 4.4（API级别19）或更高。  
要集成SDK包，请参考[集成SDK包](https://global.alipay.com/docs/ac/antom_sdk/android_en)。
### 初始化SDK  
创建SDK实例并指定基础配置。创建配置对象包括以下方法：

| 参数名称 | 是否必需 | 描述 |
| --- | --- | --- |
| setLocale | 否 | 用于传入语言信息。有效值如下，根据支付方式所在地区选择传入的值。如果传入其他值，默认使用本地语言： |
| en_US |  | 英语 |
| in_ID |  | 印尼语 |
| th_TH |  | 泰语 |
| ms_MY |  | 马来语 |
| tl_PH |  | 菲律宾语 |
| ko_KR |  | 韩语 |
| vi_VN |  | 越南语 |
| zh_HK |  | 繁体中文 |

| setOption | 否 | 用于指定是否使用默认加载模式和沙箱环境。有效值为： |
| sandbox, "true" |  | 沙箱环境 |
| sandbox, "false" |  | 生产环境 |
| showLoading, "true" |  | 使用默认加载模式 |
| showLoading, "false" |  | 不使用默认加载模式 |
| windowGravity, "LANDSCAPE_CENTER" |  | 横屏模式下居中窗口 |
| windowGravity, "LANDSCAPE_RIGHT" |  | 横屏模式下窗口靠右 |

以下示例代码展示了如何初始化SDK：

```java
// 步骤1：创建AMSEasyPayConfiguration类型
AMSEasyPayConfiguration configuration = new AMSEasyPayConfiguration();
configuration.setLocale(new Locale("en", "US"));
// 设置showLoading为true（默认值）以使用默认加载模式，设置为false以自定义加载动画（基于onEventCallback）
configuration.setOption("showLoading", "true");
// 设置沙箱环境。如果不设置，默认使用生产环境
configuration.setOption("sandbox", "true");
// 设置监听结账页面支付事件的回调
configuration.setOnCheckoutListener(new OnCheckoutListener() {
    @Override
    public void onEventCallback(String eventCode, AMSEventResult eventResult) {
        if ("SDK_PAYMENT_CANCEL".equals(eventCode)) {
            // 添加交互提示
        }
        Toast.makeText(activity, "eventCode=" + eventCode + " message=" + eventResult.getMessage(), Toast.LENGTH_SHORT).show();
    }
});

// 初始化AMSEasyPay。在每次调用createPaymentSession API请求之前创建一个新的AMSEasyPay组件。
AMSEasyPay checkout = new AMSEasyPay.Builder(activity, configuration).build();
```

请注意，此代码示例是基于Java的，如果你需要其他编程语言的版本，例如Python或JavaScript，请提供相应的上下文。
### 调用SDK  
调用`createComponent`方法：  
<table style="width:748px;outline:none;border-collapse:collapse;border:1px solid rgb(217, 217, 217)" class="lake-table"><colgroup><col width="211" span="1"><col width="97" span="1"><col width="440" span="1"></colgroup><tbody><tr style="height:33px"><td style="background-color:rgb(212, 238, 252);min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="8b1d868b17b54a35e4c658f04e7e9b21" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong><span class="lake-fontsize-11" style="color:rgb(32, 48, 76);font-size:14px" data-mce-style="font-size: 11px">参数名</span></strong></p></td><td style="background-color:rgb(212, 238, 252);min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="19b8adfde9759549213d7fa9d759abdb" id="u31c41301" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong><span class="lake-fontsize-11" style="color:rgb(32, 48, 76);font-size:14px" data-mce-style="font-size: 11px">必需</span></strong></p></td><td style="background-color:rgb(212, 238, 252);min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="ba87030ee8aee2ccc6f7ac156e521595" id="u85a3aa96" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><strong><span class="lake-fontsize-11" style="color:rgb(32, 48, 76);font-size:14px" data-mce-style="font-size: 11px">描述</span></strong></p></td></tr><tr style="height:33px"><td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="83f2eecdc13037bc55dcddc2c7ff14b3" id="ue98caa71" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><em><span class="lake-fontsize-11" style="color:rgba(4, 15, 36, 0.85);font-size:14px" data-mce-style="font-size: 11px">sessionData</span></em></p></td><td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="4ee446b852b3a3fa1cde1ee3bdd76194" id="ucda7a3a1" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>是</span><span style="color:#20304C"></span></p></td><td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="b894b733b23fbdbe238659c70350d81a" id="u73d19127" style="font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>使用</span><em><span>sessionData</span></em><span>参数创建配置对象：将通过</span><strong><span>createpaymentSession（结账支付）</span></strong><span>API响应中获取的完整</span><em><span>paymentSessionData</span></em><span>参数传递给</span><em><span>sessionData</span></em><span>参数。</span></p></td></tr></tbody></table>  
在以下情况下调用`onDestroy`方法释放SDK组件资源：  
*   当买家退出结账页面时，释放**createPaymentSession**中创建的组件资源。
*   当买家发起多次支付时，释放之前**createPaymentSession**中创建的组件资源。  
以下示例代码展示了如何调用SDK：  
```java
checkout.createComponent(activity, sessionData);  
// 释放SDK组件资源
checkout.onDestroy();  
```
步骤3：在服务器端获取授权或支付结果
--------------------------------
对于首次支付，您可以获取授权和支付结果；对于后续支付，仅获取支付结果。可以通过以下方法之一获取授权或支付结果：  
*   接收异步通知
*   查询结果
### **接收异步通知**  
获取授权结果  
获取支付结果  
#### 获取授权结果  
当授权成功时，蚂蚁金服会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API 向您发送异步通知。收到通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。同时，您需要在您的系统中更新买家的授权状态，并在授权管理页面上显示从通知中获取的买家脱敏账户。  
以下是一个通知请求的示例：  
```json
{
  "accessToken": "2810123456789012345678901234567890",
  "authState": "AUTHSTATE_SAMPLE_1234567890",
  "authorizationNotifyType": "TOKEN_CREATED",
  "userLoginId": "852-52***184",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```  
以下示例代码展示了如何验证通知的签名并做出响应：  
```java
@RequestMapping(path = "/authResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> authNotifyProcessor(HttpServletRequest request,
    @RequestBody String body) {
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  String rawSignature = request.getHeader("signature");
  String signature = "";  

  // 从原始签名中获取有效部分
  if(rawSignature==null||rawSignature.isEmpty()){
    throw new RuntimeException("empty notify signature");
  } else {
    String[] parts = rawSignature.split("signature=");
    if (parts.length > 1) {
      signature = parts[1];
    }
  }  

  // 验证授权结果通知的签名
  boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
      clientId, requestTime, body, signature,
      ALIPAY_PUBLIC_KEY);
  if (!verifyResult) {
    throw new RuntimeException("Invalid notify signature");
  }  

  // 根据通知结果更新记录状态
  // 响应服务器我们已接受通知
  Result result = new Result("SUCCESS", "success", ResultStatusType.S);
  AlipayResponse response = new AlipayResponse();
  response.setResult(result);
  return ResponseEntity.ok().body(response);
}
```  
#### 获取支付结果  
当支付达到最终的成功或失败状态时，蚂蚁金服会通过[notifyPayment](https://global.alipay.com/docs/ac/ams/paymentrn_online) API 向在 **createPaymentSession** API 中指定的 _paymentNotifyUrl_ 发送异步通知。收到蚂蚁金服的通知后，您需要按照[要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)返回响应。  
以下是一个通知请求的示例：  
```json
{
  "notifyType": "PAYMENT_RESULT",
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "success"
  },
  "paymentRequestId": "2020010123456789XXXX",
  "paymentId": "2020010123456789XXXX",
  "paymentAmount": {
    "value": "4200",
    "currency": "SGD"
  },
  "paymentCreateTime": "2020-01-01T12:01:00+08:30",
  "paymentTime": "2020-01-01T12:01:01+08:30"
}
```  
以下示例代码展示了如何验证通知的签名并做出响应：  
```java
@RequestMapping(path = "/payResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> paymentNotifyProcessor(HttpServletRequest request,
    @RequestBody String body) {  
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  String rawSignature = request.getHeader("signature");
  String signature = "";  

  // 从原始签名中获取有效部分
  if(rawSignature==null||rawSignature.isEmpty()){
    throw new RuntimeException("empty notify signature");
  } else {
    String[] parts = rawSignature.split("signature=");
    if (parts.length > 1) {
      signature = parts[1];
    }
  }  

  // 验证支付结果通知的签名
  boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
      clientId, requestTime, body, signature,
      ALIPAY_PUBLIC_KEY);
  if (!verifyResult) {
    throw new RuntimeException("Invalid notify signature");
  }  

  // 根据通知结果更新记录状态
  // 响应服务器我们已接受通知
  Result result = new Result("SUCCESS", "success", ResultStatusType.S);
  AlipayResponse response = new AlipayResponse();
  response.setResult(result);
  return ResponseEntity.ok().body(response);
}
```  
#### 常见问题  
##### 何时会发送通知？  
这取决于支付是否完成：  
*   如果支付成功完成，蚂蚁金服通常会在3到5秒内向您发送异步通知。对于像柜台支付（OTC）这样的支付方式，通知可能会稍有延迟。
*   如果支付未完成，蚂蚁金服需要先关闭订单，然后才会发送异步通知。不同支付方式关闭订单所需的时间会有所不同，通常默认为14分钟。  
##### 异步通知会被重新发送吗？  
如果您收到蚂蚁金服的异步通知，您需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应。如果您未按要求响应异步通知，或者由于网络原因通知未送达，通知将在24小时内自动重新发送。通知最多可重新发送8次，或者直到收到正确的响应以终止发送。发送间隔为：0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时，15小时。  
##### 我如何理解 `notifyAuthorization` API 中以下关键字段的含义？  
*   `result`: 代表订单的支付结果。
*   `authState`: 由商家生成的代扣请求ID。
*   `accessToken`: 蚂蚁金服生成的用于后续支付的自动扣款ID。
*   `userLoginId`: 用户的脱敏账户号。  
##### 我如何理解 `notifyPayment` API 中以下关键字段的含义？  
*   `result`: 代表订单的支付结果。
*   `paymentRequestId`: 由商家生成的用于查询、取消和对账的支付请求ID。
*   `paymentId`: 蚂蚁金服生成的用于退款和对账的支付订单ID。
*   `paymentAmount`: 如果需要金额对账，可以使用此字段。
### 查询支付结果  
您可以调用 **inquiryPayment** API 来查询订单的结果。  
| 参数名称 | 是否必填 | 描述 |
| --- | --- | --- |
| paymentRequestId | 是 | 您生成的支付请求ID。 |

请注意，以上参数不完整，完整参数集和特定支付方式的额外要求请参考 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 文档。  
以下示例代码展示了如何调用 **inquiryPayment** API：  
```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/sandbox/api/v1/payments/inquiryPayment");  
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}  
```
以下是一个请求消息的示例：  
```json
{
  "paymentRequestId": "2019060811401080010018882020035****"
}
```
以下是一个响应消息的示例：  
```json
{
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "Success"
  },
  "paymentStatus": "SUCCESS",
  "paymentRequestId": "pay_1089760038715669_10277574507XXXX",
  "paymentId": "2019060811401080010018882020035XXXX",
  "paymentAmount": {
    "value": "4200",
    "currency": "SGD"
  },
  "paymentCreateTime": "2019-06-01T12:01:01+08:30",
  "paymentTime": "2019-06-01T12:01:01+08:30",
  "transactions": null
}
```
#### 常见问题解答  
##### 如何理解以下关键字段的含义？  
*   _result_：API调用的结果，仅表示 **inquiryPayment** API 的调用结果。订单结果应根据 _paymentStatus_ 来确定。`SUCCESS` 和 `FAIL` 表示最终结果，而 `PROCESSING` 表示交易仍在进行中。
*   _paymentAmount_：金额验证。如果有金额验证需求，可以使用此字段。  
##### 应该多久发起一次查询？  
建议每2秒轮询一次，直到获取最终支付结果或收到异步支付通知。  

#### 示例代码
以下是前端的完整示例代码：  
```java
// 步骤1：创建AMSEasyPayConfiguration对象。
AMSEasyPayConfiguration configuration = new AMSEasyPayConfiguration();
configuration.setLocale(new Locale("en", "US"));
// 设置showLoading为true（默认值）使用默认加载模式。设置为false以根据onEventCallback自定义加载动画。
configuration.setOption("showLoading", "true");
// 设置沙箱环境。留空则默认使用生产环境。
configuration.setOption("sandbox", "true");
// 横屏模式居中，未设置则默认右对齐。
configuration.setOption("windowGravity", "LANDSCAPE_CENTER");
// 设置用于监听结账页面支付事件的回调。
configuration.setOnCheckoutListener(new OnCheckoutListener() {
    @Override
    public void onEventCallback(String eventCode, AMSEventResult eventResult) {
        if("SDK_PAYMENT_CANCEL".equals(eventCode)){
            // 添加交互提示。
        }
        Toast.makeText(activity, "eventCode=" + eventCode + " message=" + message, Toast.LENGTH_SHORT).show();
    }
});
// 实例化AMSEasyPay。在每次调用createPaymentSession API之前创建一个新的AMSEasyPay组件。
AMSEasyPay checkout = new AMSEasyPay.Builder(activity, configuration).build();  
// 步骤2：调用createPaymentSession API。
String sessionData = createSessionData()  
// 步骤3：初始化支付并把sessionData传递给前端组件。
checkout.createComponent(activity,sessionData);  
// 步骤4：当买家离开商户页面时调用onDestroy()方法。
checkout.onDestroy(activity,sessionData);  
```
#### 事件代码
您可能会遇到两种类型的事件代码：  
*   状态代码：在组件运行时生命周期中由 `onEventCallback` 返回。
*   错误代码：在组件初始化阶段由 `onEventCallback` 或 `onError` 返回。  
| 类型 | 代码 | 描述 | 进一步操作 |
| --- | --- | --- | --- |
| 状态代码 | SDK_START_OF_LOADING | 组件创建时开始显示加载动画。当配置为隐藏加载并使用自定义动画时，此时可以渲染自定义动画。 | 无需进一步操作。 |
| 状态代码 | SDK_END_OF_LOADING | 组件创建时加载动画结束。当配置为隐藏加载并使用自定义动画时，此时可以隐藏动画。 | 无需进一步操作。 |
| 状态代码 | SDK_CALL_URL_ERROR | 事件信息中表示以下情况之一：  
1. 未能重定向到商户页面。  
2. 未能重定向到3D验证页面。  
3. 调用 `createPaymentSession` 请求时未指定或未正确指定 `paymentRedirectUrl` 参数。 | 在Web或WAP场景中，重定向链接通常不异常，建议检查重定向链接。在App场景中，如果此异常频繁发生，请联系蚂蚁金服技术支持排查重定向或调用问题。 | 
| 错误代码 | SDK_INTERNAL_ERROR | SDK内部错误。 | 联系蚂蚁金服技术支持。 |
| 错误代码 | SDK_CREATEPAYMENT_PARAMETER_ERROR | `mountComponent` 方法指定参数异常。 | 检查参数是否正确并重新初始化组件。 |
| 错误代码 | SDK_INIT_PARAMETER_ERROR | `AMSEasyPay` 方法指定参数异常。 | 检查参数是否正确并重新实例化SDK。 |
| 错误代码 | SDK_CREATECOMPONENT_ERROR | 组件初始化异常。 | 联系蚂蚁金服技术支持。 |
| 错误代码 | SDK_SUBMIT_NETWORK_ERROR | 由于网络原因接口调用失败，可能发生在提交方法中。 | 重试提交。 |

要查看文档的最新更新，请访问 [发布说明](https://global.alipay.com/docs/releasenotes)。  
![Image 10](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png)![Image 11](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 本页内容  
[用户体验](#2Rpi7 "用户体验")  
[钱包](#Y01sq "钱包")  
[银行转账](#q7ZbX "银行转账")  
[支付流程](#S3crs "支付流程")  
[集成步骤](#QLFGi "集成步骤")  
[步骤1：创建支付会话](#zhBSk "步骤1：创建支付会话")  
[安装API库](#d3kyo "安装API库")  
[初始化请求实例](#WLui0 "初始化请求实例")  
[创建支付会话](#aQius "创建支付会话")  
[常见问题解答](#UGjGp "常见问题解答")  
[请求中可以使用中文字符吗？](#asEuc "请求中可以使用中文字符吗？")  
[如何设置支付结果通知地址？](#KQLhk "如何设置支付结果通知地址？")  
[步骤2：调用SDK](#Oqulw "步骤2：调用SDK")  
[安装](#JmurT "安装")  
[实例化SDK](#qNMQb "实例化SDK")  
[调用SDK](#bj6Gl "调用SDK")  
[步骤3：获取授权或支付结果](#Jiap6 "步骤3：获取授权或支付结果")  
[接收异步通知](#YWXbW "接收异步通知")  
[常见问题解答](#V1F5v "常见问题解答")  
[查询结果](#1avq0 "查询结果")  
[常见问题解答](#tkpZO "常见问题解答")  
[示例代码](#8Ha2q "示例代码")  
[事件代码](#FZcP1 "事件代码")