创建accessToken | 自动扣款 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fautodebitpay%2Fcreate_accesstoken)  
[返回首页](../../)

自动扣款
[概述](/docs/ac/autodebitpay/overview)  
[用户体验](/docs/ac/autodebitpay/user_ex)  
开发
获取用户授权
[创建accessToken](/docs/ac/autodebitpay/create_accesstoken)  
[接收授权通知](/docs/ac/autodebitpay/notify_auth)  
[从商户到支付方式的重定向](/docs/ac/autodebitpay/redirect_merchant-wallet)  
[从钱包到支付方式的重定向](/docs/ac/autodebitpay/redirect_wallet-merchant)  
[刷新accessToken](/docs/ac/autodebitpay/refresh_accesstoken)  
[撤销accessToken](/docs/ac/autodebitpay/revoke_accesstoken)  
自动扣款
退款
[最佳实践](/docs/ac/autodebitpay/best_practice)  
其他资源
创建accessToken
==================

2024-04-10 03:12

`accessToken` 是用于从用户账户自动扣款所必需的。要获取 `accessToken`，您必须首先获取 `authUrl`，然后获取 `authCode`。

要获取 `authUrl` 和 `authCode`，请按照以下步骤操作：

1. 配置授权通知接收地址：这确保即使[重建重定向URL](#5wBk5)未返回，您也能接收到授权通知并从中获取 `authCode`。
2. 咨询授权URL：调用[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult) API，从响应中获取_authUrl_。_authUrl_在单次授权流程中仅能使用一次。
3. 重定向用户：通过启动用户的支付方式应用或重定向到WEB或WAP页面，将用户导向_authUrl_。
4. 获取authCode：用户在_authUrl_指定的页面上同意授权后，Alipay+移动支付伙伴（MPP）会返回重建的重定向URL，同时支付宝会发送授权通知。你可以从重建的重定向URL或授权通知中获取_authCode_。
5. 创建accessToken：使用authCode，通过调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API获取accessToken。

步骤1：配置授权通知地址
-----------------------

为了确保能够接收到授权通知并从中获取_authCode_，请在[Antom仪表盘](https://global.alipay.com/docs/dashboard_en)中提供接收地址。

提交地址后，当用户授权成功时，支付宝会发送授权结果通知。收到通知后，你必须向支付宝返回接收确认消息。关于如何提供通知接收地址以及向支付宝返回确认消息的详细信息，请参阅[接收授权通知](https://global.alipay.com/docs/ac/43trgzdfg/78e9h)。

步骤2：咨询_authUrl_
------------------
要获取授权URL（_authUrl_），需要向支付宝服务器发起POST请求，调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API。假设您使用的是`https://open-na-global.alipay.com`的域名，请求URL路径应为：`https://<https://open-na-global.alipay.com>/ams/api/v1/authorizations/consult`。在API请求中，必须指定以下字段：

*   _authRedirectUrl_：用户授权后重定向到的商户页面URL的第一部分。
*   _authState_：由您提供的字符串，将在重定向URL中后续使用。授权完成后，用户将被重定向到此URL。
*   _customerBelongsTo_：指定您请求授权的Alipay+ MPP（多伙伴计划）。
*   _scopes_：根据需要指定授权范围。
*   _terminalType_：表示商户端的终端类型。

**请求头**
将_client-id_值`T_111222333`替换为您分配的客户端ID。您可以在Antom仪表板中获取客户端ID。
```
Content-Type:application/json; charset=UTF-8
original_host:open-na.alipay.com
Request-Time:2019-07-12T12:08:56+05:30
client-id:T_111222333
Signature:algorithm=RSA256,keyVersion=1,signature=TgpjpAzwmA7aWDloDEitOp
```
**请求体**
```
{
"customerBelongsTo": "GCASH",
"authRedirectUrl":"https://www.alipay.com/",
"scopes": ["AGREEMENT_PAYMENT"],
"authState": "663A8FA9-D836-48EE-8AA1-1FF682989DC7",
"terminalType": "APP",
"osType": "IOS",
"osVersion": "11.0.2"
}
```
如果调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API后没有响应，使用与前次请求相同的字段再次调用API。如果收到响应，_response.result_表示API调用的结果。
当 _resultStatus_ 为 `S` 时，API 调用成功。只有在这种情况下，才能从响应中获取 _authUrl_ 的值。
当 _resultStatus_ 为 `U` 时，API 的调用状态未知。您需要在不改变 _authState_ 值的情况下重新调用 API。
当 _resultStatus_ 为 `F` 时，根据 _resultCode_ 的值检查失败原因并采取相应行动。

以下是一个成功调用 [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API 的响应示例：

```json
{
"result": {
"resultStatus": "S",
"resultCode": "SUCCESS",
"resultMessage": "success."
},
"authUrl": "https://render.alipay.com/p/c/jzmcoal2?callback=https%3A%<url-encoded-stuff>",
"resultInfo": {
"resultStatus": "S",
"resultCode": "SUCCESS",
"resultMessage": "success."
}
}
```

步骤 3：重定向用户
--------------------

成功获取 _authUrl_ 后，需要将用户重定向到 _authUrl_ 地址，用户可以在该地址同意授权。如果重定向过程失败，您需要使用新的 _authState_ 值再次调用 [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API 重新启动授权过程。为了确保重定向过程的成功，请参阅 [从商户到支付方式的重定向](https://global.alipay.com/docs/ac/43trgzdfg/56xgzfer)。

如果用户成功被重定向到 _authUrl_，用户可以在相应的页面上同意授权。用户同意授权后，相应的 Alipay+ MPP 会将用户重定向回商户端。商户端地址由 _authRedirectUrl_、_authCode_ 和 _authState_ 组成。同时，Alipay 会向您发送授权通知，其中也包含 _authCode_ 和 _authState_ 字段。有关从支付方式重定向到商户端的详细信息，请参阅 [从支付方式到商户的重定向](https://global.alipay.com/docs/ac/autodebitpay/redirect_wallet-merchant)。
步骤4：获取\_authCode\_
======================

如果用户同意授权，可以通过以下方式获取\_authCode\_

*   从Alipay+ MPP返回的重建的重定向URL中获取\_authCode\_。
*   从授权通知中获取\_authCode\_。

> **注意**：建议从授权通知结果中获取\_authCode\_，因为重定向可能会失败。因此，必须集成[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) SPI。

如果用户不同意授权或授权失败，用户将不会被重定向到商户端，或者重定向URL中不会包含\_authCode\_。通常，如果在一定时间内（建议为15分钟）无法获取\_authCode\_，需要从[步骤2](#KbjCb)重新开始以再次获取\_authCode\_。再次调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API时，请求中的\_authState\_字段应使用更新的值。

重建的重定向URL
------------------

Alipay+ MPP返回的重建的重定向URL是商户页面地址，由以下两部分组成：

*   在[**consult**](https://global.alipay.com/docs/ac/ams/authconsult)请求中指定的\_authRedirectUrl\_的值。
*   Alipay+ MPP提供的\_authCode\_的值。
*   在[**consult**](https://global.alipay.com/docs/ac/ams/authconsult)请求中指定的\_authState\_的值。

重定向URL的示例如下：

```text
https://www.alipay.com/?authCode=d2f60253-ecdc-e9bc-27d1-566970191040&authState=663A8FA9-D836-48EE-8AA1-1FF682989DC7
```

用户授权后被重定向到重建的重定向URL，您需要检查：
*   检查URL中的 `_authState_` 值是否与在[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult)请求中指定的 `_authState_` 值一致。如果不一致，授权失败，需要从[步骤2](#KbjCb)重新开始授权流程以重新获取 `authCode`。
*   检查 `_authCode_` 字段是否有值。如果 `authCode` 字段为空，授权失败。
> **注意**：在沙箱环境中测试此步骤时，可以打开 `_authUrl_` 并使用测试支付方式和账户来模拟用户的授权。

步骤5. 创建 `accessToken`
==========================

获取到 `authCode` 值后，需要立即使用 `authCode` 值调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API，在获取 `authCode` 后一分钟内获取 `accessToken`，在 `authCode` 过期前完成。只有获取到有效的 `accessToken`，在支付阶段才能直接从用户账户扣款，无需用户进行额外操作。

通过POST请求调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API，向支付宝服务器发送正确的请求URL路径。例如，如果使用域名 `https://open-na-global.alipay.com`，请求URL路径为：`https://<https://open-na-global.alipay.com>/ams/api/v1/authorizations/applyToken`。在请求中指定以下字段：
*   `grantType`: 将此字段设置为 `AUTHORIZATION_CODE`。
*   `customerBelongsTo`: 将目标Alipay+ MPP设置为此字段。
*   `authCode`: 将调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult) API后获取的 `authCode` 值设置为此字段。

以下是一个[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API请求体的示例：
```json
{
  "grantType": "AUTHORIZATION_CODE",
```
"customerBelongsTo": "GCASH",
"authCode": "d2f60253-ecdc-e9bc-27d1-566970191040"

以下是一个成功调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API的响应示例。从响应中，您可以获取到_AccessToken_的值。同时，用于更新_AccessToken_的_RefreshToken_也会返回。

```
"accessTokenExpiryTime": "2019-09-04T13:41:39+0800",
"result": {
  "resultStatus": "S",
  "resultCode": "SUCCESS",
  "resultMessage": "success."
},
"accessToken": "20190828054139156697089972935735984402094237jmfUWaepj
"refreshTokenExpiryTime": "2019-09-11T13:41:39+0800",
"resultInfo": {
  "resultStatus": "S",
  "resultCode": "SUCCESS",
  "resultMessage": "success."
},
"refreshToken": "20190828054139156697089972935735984402120180HYYGFvfs
```

如果没有收到响应，使用与前一次请求相同的字段再次调用API。如果收到响应，根据以下情况采取相应行动：

*   当`result.resultStatus`为`S`时，API调用成功并返回了AccessToken。您可以使用AccessToken从用户账户中扣款。
*   当`result.resultStatus`为`U`时，使用与前一次请求相同的字段再次调用API。
*   当`result.resultStatus`为`F`时，根据`resultCode`采取相应行动。由于_AuthCode_只能使用一次，如果[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API调用失败，您需要从[步骤2](#U06iL)重新开始，获取新的_AuthCode_，然后再次调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API。
**注意**: 通过调用[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp) API 创建的每个accessToken的有效期因支付方式和用户而异。为了避免因accessToken失效导致交易失败，建议在accessToken过期前使用refreshToken来延长其有效期。维护一个包含accessToken生命周期信息的表格，并定期检查和刷新即将过期的accessToken。

要查看文档的最新更新，请访问[版本更新日志](https://global.alipay.com/docs/releasenotes)。

![图片 3](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 4](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

[步骤1：配置授权通知地址](#U06iL "步骤1：配置授权通知地址")  
[步骤2：获取authUrl](#KbjCb "步骤2：获取authUrl")  
[步骤3：重定向用户](#FZplL "步骤3：重定向用户")  
[步骤4：获取authCode](#S8rJN "步骤4：获取authCode")  
[重建重定向URL](#5wBk5 "重建重定向URL")  
[步骤5：创建accessToken](#yDNrC "步骤5：创建accessToken")