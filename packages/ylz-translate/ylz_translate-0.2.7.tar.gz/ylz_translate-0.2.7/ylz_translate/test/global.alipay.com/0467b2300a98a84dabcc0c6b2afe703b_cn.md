Android | 结账支付 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)](/docs/)
[![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fbank_android)
[返回首页](../../)

结账支付
[概述](/docs/ac/cashierpay/overview)
接收支付
支付后处理
支付方式
其他资源
高级功能
[预前端解决方案API](/docs/ac/cashierpay/prefront)
[先买后付API](/docs/ac/cashierpay/bnpl)
[卡存储API](/docs/ac/cashierpay/cv)
[卡存储SDK](/docs/ac/cashierpay/cvsdk)
[卡支付功能API/SDK](/docs/ac/cashierpay/mf)

Android
=======

在这个主题中，您将学习如何在Android客户端集成银行SDK，以便在移动应用中渲染支付页面。

前提条件
在集成SDK之前，请确保已完成以下任务：

1. 安装最新版本的Android Studio。
2. 目标至少为Android 4.4（API级别19）或更高。
3. 使用Gradle 4.1或更早版本。
4. 配置物理设备或模拟器以运行您的应用。

关键集成步骤
按照以下步骤集成SDK：

1. 集成SDK包
   客户端
   要集成SDK包，请参考[集成SDK包](https://global.alipay.com/docs/ac/antom_sdk/android_en)。
2. 显示可用支付方式
   客户端
   在通过联系支付宝技术支持获取可用支付方式后，您可以通过以下模式显示支付方式：

   * 单一银行模式：按银行显示支付方式。
*   银行类型模式：按银行类型显示支付方式，如手机银行应用、网上银行和银行转账。
*   银行国家模式：按银行国家显示支付方式，如泰国和印度尼西亚。请参考[用户体验](https://global.alipay.com/docs/ac/cashierpay/bank_sdk#7WPiN)了解三种支付方式显示类型。
**注意**：在银行类型模式下，网页客户端无法在手机银行应用类型下显示支付方式。

3. 使用`AMSCashierPayment`方法创建SDK实例：

客户端操作步骤如下：

1. 创建一个`_configuration_`对象：这是必需的对象，必须包含以下所有配置参数：
   * `_setLocale_`：可选字符串，用于商户客户端识别买家浏览器的语言。设置此参数以确保SDK以正确语言显示页面。有效值如下。如果传递其他值，将默认使用英语。
   * `locale("en", "US")`：英语
   * `locale("in", "ID")`：印度尼西亚语
   * `locale("th", "TH")`：泰语
   * `_setOption_`：可选，用于指定是否使用默认加载模式和沙箱环境。有效值为：
   * `"sandbox", "true"`：沙箱环境
   * `"sandbox", "false"`：生产环境
   * `"showLoading", "true"`：使用默认加载模式。
   * `"showLoading", "false"`：不使用默认加载模式。

2. 创建**onCheckoutListener**接口的实例，用于后续过程中的事件处理。该接口包含以下方法：
   * `onEventCallback`：必需。一个回调函数，用于监听结账页面上的支付事件，返回`eventCode`和`eventResult`。

3. 将**onCheckoutListener**接口的实例设置到`_configuration_`对象中，以执行事件回调。
4. 初始化 `AMSCashierPayment` 方法。
创建 SDK 实例：
Java
```java
// 步骤1：创建 AMSCashierPaymentConfiguration 类型实例
AMSCashierPaymentConfiguration configuration = new AMSCashierPaymentConfiguration();
configuration.setLocale(new Locale("en", "US")); // 设置为美国英语
// 设置 showLoading 为 true（默认值），使用默认加载模式
// 设置为 false 可根据 onEventCallback 自定义加载动画
configuration.setOption("showLoading", "true");
// 设置沙箱环境，留空则默认使用生产环境
configuration.setOption("sandbox", "true");
// 设置监听结账页面支付事件的回调
configuration.setOnCheckoutListener(new OnCheckoutListener() {
    @Override
    public void onEventCallback(String eventCode, AMSEventResult eventResult) {
        Log.e(TAG, "onEventCallback eventCode=" + eventCode + " eventResult=" + eventResult.toString());
    }
});
// 初始化 AMSCashierPayment
AMSCashierPayment checkout = new AMSCashierPayment.Builder(activity, configuration).build();
```
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
4. 向支付宝服务器发送 **createPaymentSession（结账支付）** 请求。
服务器端
当用户选择支付方式后，您的客户端检测到支付按钮点击事件，您的服务器需要发送一个[**创建支付会话（结账支付）**](https://global.alipay.com/docs/ac/ams/session_cashier)请求。从createPaymentSession响应中获取paymentSesssionData值，并在步骤5中使用它。

在**创建支付会话（结账支付）**请求中传递以下参数：

*   paymentRequestId：商家为识别支付请求分配的唯一ID。
*   productCode：表示正在使用的支付产品，值固定为`AGREEMENT_PAYMENT`。
*   paymentNotifyUrl：用于接收支付结果通知的URL。
*   paymentRedirectUrl：支付完成后用户重定向到的商家页面URL。
*   paymentAmount：商家在订单货币中请求接收的支付金额。
*   order.orderAmount：商家订单金额。在促销活动中，_orderAmount_值可能与_paymentAmount_值不同。
*   order.orderDescription：订单描述。
*   order.referenceOrderId：商家侧的订单ID。支付宝建议在单个订单有多个支付请求时，使用一个_referenceOrderId_对应多个_paymentRequestId_。
*   paymentMethod.paymentMethodType：设置为`BANK`。
*   paymentMethod.paymentMethodMetaData：
    *   要在单一银行模式下显示支付方式，设置_bankName_为银行名称。
    *   要在银行类型模式下显示支付方式，设置_paymentMethodCaregory_为支付方法类型。有效值为`BANK_TRANSFER`，`MOBILE_BANKING_APP`和`ONLINE_BANKING`。
    *   要在银行国家模式下显示支付方式，设置_paymentMethodRegion_为国家。有效值为`TH`和`ID`。

单一银行模式示例（JSON）：

```json
{
  "paymentRequestId": "your_unique_payment_request_id",
  "productCode": "AGREEMENT_PAYMENT",
  "paymentNotifyUrl": "https://your_merchant_notify_url.com",
  "paymentRedirectUrl": "https://your_merchant_redirect_url.com",
  "paymentAmount": 10000,
  "order": {
    "orderAmount": 10000,
    "orderDescription": "Order description here",
    "referenceOrderId": "your_unique_order_id"
  },
  "paymentMethod": {
    "paymentMethodType": "BANK",
    "paymentMethodMetaData": {
      "bankName": "Bank of China" // 或者 "paymentMethodCategory": "BANK_TRANSFER", 或者 "paymentMethodRegion": "TH"
    }
  }
}
```

请注意，根据实际需要选择paymentMethodMetaData的正确配置。
"订单": {  
"订单金额": {  
"货币": "THB",  
"值": "160"  
},  
"订单描述": "卡布奇诺 #大杯  
(Mika的咖啡店  
)",  
"参考订单号": "ORDER\_20230803165257496"  
},  
"支付金额": {  
"货币": "THB",  
"值": "160"  
},  
"支付方式": {  
"支付方式类型": "BANK",  
"支付方式元数据": "{\\"银行名称\\" : \\"Siam Commercial Bank\\"}"  
},  
"结算策略": {  
"结算货币": "USD"  
},  
"支付通知URL": "https://kademo.intlalipay.cn/payments/notifySuccess",  
"支付重定向URL": "https://kademo.intlalipay.cn/melitigo/Test\_114.html",  
"支付请求ID": "PAY\_20230804165257508",  
"产品代码": "CASHIER\_PAYMENT"  
}  
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  
银行类型模式  
JSON  
1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
23  
24  
25  
{  
"订单": {  
"订单金额": {  
"货币": "THB",  
"值": "160"  
},  
"订单描述": "卡布奇诺 #大杯  
(Mika的咖啡店  
)",  
"参考订单号": "ORDER\_20230803165257496"  
},  
"支付金额": {  
"货币": "THB",  
"值": "160"  
},  
"支付方式": {  
"支付方式类型": "BANK",  
"支付方式元数据": "{\\"支付方式分类\\" : \\"BANK\_TRANSFER\\"}"  
},  
"结算策略": {  
"结算货币": "USD"  
},  
"支付通知URL": "https://kademo.intlalipay.cn/payments/notifySuccess",  
"支付重定向URL":
"https://kademo.intlalipay.cn/melitigo/Test\_114.html",  
"paymentRequestId": "PAY\_20230804165257508"  
,  
"productCode": "CASHIER\_PAYMENT"  
}

支付银行国家模式  
JSON  
1  
2  
3  
4  
5  
6  
7  
8  
9  
10  
11  
12  
13  
14  
15  
16  
17  
18  
19  
20  
21  
22  
23  
24  
25  
{  
"order": {  
"orderAmount": {  
"currency": "THB",  
"value": "160"  
},  
"orderDescription": "卡布奇诺#大杯 (Mika's咖啡店)",  
"referenceOrderId": "ORDER\_20230803165257496"  
},  
"paymentAmount": {  
"currency": "THB",  
"value": "160"  
},  
"paymentMethod": {  
"paymentMethodType": "BANK",  
"paymentMethodMetaData": "{\\"paymentMethodRegion\\":\\"TH\\"}"  
},  
"settlementStrategy": {  
"settlementCurrency": "USD"  
},  
"paymentNotifyUrl": "https://kademo.intlalipay.cn/payments/notifySuccess",  
"paymentRedirectUrl": "https://kademo.intlalipay.cn/melitigo/Test\_114.html",  
"paymentRequestId": "PAY\_20230804165257508"  
,  
"productCode": "CASHIER\_PAYMENT"  
}

请注意，这是一个示例的支付宝支付相关的JSON数据，包含订单信息、支付金额、支付方式、结算策略、通知URL和重定向URL等关键字段。其中，订单描述是购买一杯大杯卡布奇诺，货币单位为泰铢（THB），支付方式为银行支付，结算货币为美元（USD）。
呈现支付页面  
客户端  
在配置对象中调用`createComponent()`方法，并传入以下参数：  
*   _activity_：必需的对象，属于_Activity_类型。用于包含当前页面上下文参数的信息。
*   _sessionData_：必需的字符串。将步骤4中获取的_paymentSessionData_值传递给`createComponent`方法的_sessionData_参数。  
在以下情况下调用`onDestroy()`方法释放SDK组件资源：  
*   当用户离开结账页面时，释放`createPaymentSession`中创建的组件资源。
*   当用户发起多次支付时，释放前一次`createPaymentSession`中创建的组件资源。  
调用`createComponent`方法：  
Java  
```java
checkout.createComponent(activity, sessionData);
// 释放SDK组件资源
checkout.onDestroy();
```

获取支付结果  
服务器端
当支付达到最终的成功或失败状态时，支付宝会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API 向您在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay) API 中传递的 _paymentNotifyUrl_ 发送异步通知。收到支付宝的通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。您也可以通过调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 获取支付结果。

#### 事件代码

SDK 提供以下状态代码：

*   `SDK_START_OF_LOADING`：在创建支付组件时开始播放加载动画。
*   `SDK_END_OF_LOADING`：在创建支付组件时加载动画结束。

SDK 提供以下错误代码：

*   `SDK_INTERNAL_ERROR`：SDK 内部错误发生。请联系支付宝技术支持解决。
*   `SDK_CREATEPAYMENT_PARAMETER_ERROR`：传递给 `AMSCashierPayment` 方法的参数不正确。确保参数正确传递并发送新请求。
*   `SDK_CALL_URL_ERROR`：支付方式客户端撤销失败。请联系支付宝技术支持解决。
*   `SDK_INTEGRATION_ERROR`：找不到依赖项。确保依赖项已正确添加并重试集成过程。

#### 这个页面有帮助吗？

要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。

![图片 3](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 4](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)