支付处理 | 结账支付 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fcapture)  
[返回首页](../../)  

结账支付
[概览](/docs/ac/cashierpay/overview)  
接收支付  
支付后处理  
支付方式  
其他资源  
高级功能  
[预前台解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡存储API](/docs/ac/cashierpay/cv)  
[卡存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API/SDK](/docs/ac/cashierpay/mf)  

资金捕捉
========

2024-04-07 11:37  
默认情况下，支付宝+会自动为您处理资金捕捉。如果您在调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API时将参数 _paymentFactor.captureMode_ 设置为 `MANUAL`，则必须通过调用[**capture**](https://global.alipay.com/docs/ac/ams/capture) API来捕捉支付的资金。

*   **自动捕捉**：在用户授权支付后，支付宝+会立即自动捕捉资金。捕捉结果会通过异步通知传达给您。以下任一条件满足时，自动捕捉将激活：
    *   您在**pay** API中将 _paymentFactor.captureMode_ 的值设置为 `AUTOMATIC`。
    *   您在**pay** API中未设置 _paymentFactor.captureMode_ 的值，或者没有传递此参数。
*   **手动扣款**: 成功授权后，您必须在7天内通过调用 **capture** API 执行扣款操作，否则支付宝+会自动解冻授权的支付资金。扣款总额必须等于授权总额。
> **注意**: 对于信用卡支付，建议在发货前确认扣款成功。
  
  **手动发起扣款请求**
---------------------------

  **capture** API（**POST/v1/payments/capture**）的主要请求参数如下表所示：

| **参数** | **描述** |
| --- | --- |
| captureRequestId | 您为扣款请求分配的唯一标识符。 |
| paymentId | 支付宝+为订单分配的唯一标识符。 |
| captureAmount | 扣款金额，必须等于授权总额。 |

表1. **capture** API 的关键参数

  **获取扣款结果**
-------------------------

  通过 **capture** API 返回的响应中，_resultStatus_ 参数的值表示扣款结果：

*   `S`: 扣款成功。
*   `F`: 扣款失败。
*   `U`: 需要通过 **notifyCapture** 通知或查询扣款结果来获取异步通知的结果。

您可以根据以下图示的逻辑处理响应：

![](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1685588281433-62bee106-ef24-4f7c-89f1-c351ee7cbb00.png)

图1. 响应中的 _resultStatus_ 值
### 异步通知  
可以通过接收异步通知[**notifyCapture**](https://global.alipay.com/docs/ac/ams/notify_capture)来获取扣款结果。当扣款最终状态达成（即，扣款成功或失败）时，支付宝+会通过**notifyCapture**通知向您发送异步消息。收到通知后，您必须按照[要求](https://global.alipay.com/docs/ac/ams/paymentrn_online)返回响应。否则，支付宝+会重试发送通知，直到收到正确的响应为止。  

**异步通知中的关键参数**：  
| **参数** | **描述** |
| --- | --- |
| notifyType | 值为`CAPTURE_RESULT`。 |
| paymentId | 支付宝+为订单分配的唯一标识符。 |
| result | 扣款结果。 |
| acquirerReferenceNo | 如果您已集成在新加坡或香港接收卡支付的能力，通知中会提供收单方编号。 |  
表2. **notifyCapture**通知中的关键参数  

**配置通知接收地址**：  
要接收异步通知，您需要通过以下两种方式之一配置通知地址：  
1. 在**pay** API中指定`_paymentNotifyUrl_`。
2. 在蚂蚁通仪表板的**集成设置**标签页中编辑**通知URL**。  

#### 查询扣款状态  
异步通知和同步重定向都可能接收或执行失败。建议您通过调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API来查询扣款状态。在通过**inquiryPayment** API返回的响应中，`transactions`字段表示扣款状态。详细信息如下表：  
| **参数** | **描述** |
| --- | --- |
| 交易类型 | 交易状态 |
| --- | --- |
| transactions.transactionType | 值为`CAPTURE`，表示扣款状态。 |

| 交易结果 |  |
| --- | --- |
| transactions.transactionResult | 扣款结果。 |

**表3. _transactions_ 的关键子参数**

_transactions_ 的值表示扣款状态。详细信息请参考以下代码示例：

**扣款成功**

```json
{
  "transactions": [
    {
      "transactionType": "CAPTURE",
      "transactionStatus": "SUCCESS",
      "transactionRequestId": "test_test_test_XXXX",
      "transactionAmount": {
        "currency": "BRL",
        "value": "110"
      },
      "transactionId": "2022XXXXXXXX",
      "transactionResult": {
        "resultStatus": "S",
        "resultCode": "SUCCESS",
        "resultMessage": "success"
      }
    }
  ]
}
```

**扣款失败**

```json
{
  "transactions": [
    {
      "transactionType": "CAPTURE",
      "transactionStatus": "FAIL",
      "transactionRequestId": "test_test_test_XXXX",
      "transactionAmount": {
        "currency": "BRL",
        "value": "110"
      },
      "transactionTime": "2022-09-29T07:13:50-07:00",
      "transactionId": "2022XXXXXXXX",
      "transactionResult": {
        "resultStatus": "F",
        "resultCode": "PROCESS_FAIL",
        "resultMessage": "General business failure. No retry."
      }
    }
  ]
}
```

**扣款处理中**

```json
{
  "transactions": [
    {
      "transactionType": "CAPTURE",
      "transactionStatus": "PROCESSING",
      "transactionRequestId": "test_test_test_XXXX",
      "transactionAmount": {
        "currency": "BRL",
        "value": "110"
      },
      "transactionId": "2022XXXXXXXX",
      "transactionResult": {
        "resultStatus": "U",
        "resultCode": "PAYMENT_IN_PROCESS",
        "resultMessage": "payment in process"
      }
    }
  ]
}
```

要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。

![图片4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面是否有帮助？

#### 在这个页面上
[手动发起扣款请求](#20MEH "手动发起扣款请求")  
[获取扣款结果](#seO9b "获取扣款结果")  
[异步通知](#SNrlS "异步通知")  
[查询扣款状态](#mlxp0 "查询扣款状态")