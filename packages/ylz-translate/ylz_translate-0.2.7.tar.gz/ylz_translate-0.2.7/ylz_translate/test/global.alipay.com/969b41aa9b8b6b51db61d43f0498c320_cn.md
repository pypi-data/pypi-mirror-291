最佳实践 | 用户展示模式支付 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fams_upm%2Fbp)  
[返回首页](../../)  

用户展示模式支付
------------------

[介绍](/docs/ac/ams_upm/introduction)  
[开始使用](/docs/ac/ams_upm/start)  
[接收支付](/docs/ac/ams_upm/acceptpayment)  
[支付后服务](/docs/ac/ams_upm/postpayment)  
[最佳实践](/docs/ac/ams_upm/bp)  

开发
----

[API 列表](/docs/ac/ams_upm/apilist)  
[对账](/docs/ac/ams_upm/reconcile)  

参考
----

[版本发布说明](/docs/ac/ams_upm/releasenotes)  
[旧版](/docs/ac/ams_upm/sppmkt)  

最佳实践
==================

2021-08-04 09:32

遵循以下集成最佳实践，为您的客户提供优质的支付体验。这些最佳实践需要在服务器端与支付宝之间以及支付终端的流程中实现。

准备您的设备
==================

为了使用用户展示模式支付服务，需要准备一个能够扫描二维码并进行外部通信的设备。

正确使用支付宝接口
==============================

建议至少集成以下接口：**pay**、**inquiryPayment**、**refund**、**cancel** 和 **notifyPayment**。

*   **pay** 接口：
    - 在支付请求中指定支付通知URL。调用 **pay** 接口后，支付宝可能会返回以下结果，或者商家可能收不到任何结果：
*   支付宝返回_result.resultStatus_为`S`，表示交易成功，资金已成功扣除。
*   支付宝返回_result.resultStatus_为`F`，商家需要根据_result.resultCode_中的错误信息采取进一步行动。
*   支付宝返回_result.resultStatus_为`U`，商家需要使用**查询支付**接口查询支付结果。查询请求可以发送10到20次，每次间隔3秒。
*   如果在发送支付请求后5秒内未收到支付宝的异步通知和支付结果，商家需要使用**查询支付**接口查询支付结果。查询请求可以发送10到20次，每次间隔3秒。
*   当调用**查询支付**接口时，如果超过最大次数发送查询请求后仍无法获取支付结果，商家需要调用**取消**接口取消交易。如果超出可取消期限，商家无法使用**取消**接口，而应调用**退款**接口进行退款。
*   **查询支付**接口：
    *   调用**查询支付**接口后，支付宝可能会返回以下结果，或者商家未收到任何结果：
        *   支付宝返回_result.resultStatus_为`S`，表示查询成功，商家可以从_paymentStatus_的值获取支付状态：
            *   _paymentStatus_的值为`SUCCESS`，表示支付成功。
            *   _paymentStatus_的值为`FAIL`，表示支付失败。商家可以重新发起支付请求。
*   `_paymentStatus_` 的值为 `PROCESSING`，表示支付正在进行中。商家可以在稍后查询最终状态。
*   `_paymentStatus_` 的值为 `CANCELLED`，意味着支付已取消。商家可以重新发起支付请求。
*   若支付宝返回 `_result.resultStatus_` 为 `F`，商家需要根据 `_result.resultCode_` 中的错误信息采取进一步行动。
*   若支付宝返回 `_result.resultStatus_` 为 `U`，商家需使用 **inquiryPayment** 接口查询支付结果。查询请求可发送10至20次，每次间隔3秒。
*   如因网络问题在3秒内未从支付宝收到结果，商家需使用 **inquiryPayment** 接口查询支付结果。查询请求可发送10至20次，每次间隔3秒。
*   调用 **inquiryPayment** 接口时，若超过最大查询次数仍无法获取支付结果，商家需调用 **cancel** 接口取消交易。
*   **cancel** 接口：
    *   调用 **cancel** 接口后，支付宝可能会返回以下结果，或商家未收到任何结果：
        *   支付宝返回 `_result.resultStatus_` 为 `S`，表示交易已成功取消。商家可以再次发起支付请求。
        *   支付宝返回 `_result.resultStatus_` 为 `F`，商家需要根据 `_result.resultCode_` 中的错误信息采取进一步行动。
        *   支付宝返回 `_result.resultStatus_` 为 `U`，商家需使用相同的参数重试取消请求。取消操作可重试60秒，每次间隔5至10秒。
*   如果由于网络问题，支付宝在3秒内没有返回结果，商家需要使用相同的参数重试取消请求。取消操作可以在60秒内重试，每次间隔5到10秒。
*   若多次尝试取消后仍无法获取结果，商家需联系支付宝技术支持团队。
  
以下图表清晰展示了**支付**、**查询支付**和**取消**接口之间的关系：
  
  ![图片1.png](https://cdn.nlark.com/yuque/0/2021/png/12884741/1627962076214-b4ab1f8f-f6ce-4ae1-89a2-a098b63c77d6.png)
  
  图1. 调用支付、查询支付和取消接口。

*   **退款**接口：
    *   调用**退款**接口后，支付宝可能会返回以下结果，或者商家未收到任何结果：
        *   支付宝返回`result.resultStatus`为`S`，表示交易退款成功。
        *   支付宝返回`result.resultStatus`为`F`，商家需根据`result.resultCode`中的错误信息采取进一步行动。
        *   支付宝返回`result.resultStatus`为`U`，商家需要使用相同的参数重试退款请求。退款操作可以在60秒内重试，每次间隔5到10秒。
        *   如果由于网络问题，支付宝在3秒内没有返回结果，商家需要使用相同的参数重试退款请求。退款操作可以在60秒内重试，每次间隔5到10秒。
        *   若多次尝试退款后仍无法获取结果，商家需联系支付宝技术支持团队。
  
以下图表展示了如何使用**退款**接口：
  
  ![image.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1592968693335-6d457953-b595-48af-9115-eb6d77946a66.png)
  
  图2. 调用退款接口
*   **notifyPayment** 接口：
    *   当订单状态到达最终状态时收到通知，商家可以忽略该通知。
    *   商家发起取消请求后收到通知，可忽略通知并根据取消请求的结果来确定支付状态。

**取消重试解决方案**
-------------------

为了避免重复扣款，需要确保取消消息的可靠传递。虽然重试**cancel**接口可以达到很高的成功率，但仍然建议在可能的情况下使用消息队列。以下是使用消息队列的三个步骤：

1.  如果调用**inquiryPayment**接口未能获取结果，启动取消流程。如果无法发出取消请求，需要将取消请求保存到本地队列中，定期或在网络恢复时进行重试。
2.  接收到取消请求后，接收队列确认请求，并在原始交易到达后发起取消请求。
3.  当向支付宝发送取消请求时遇到网络异常或系统错误，将取消请求保存到发送队列并尝试重试。

![](https://cdn.nlark.com/yuque/0/2020/png/561635/1595213697791-2f3872ca-cd59-4922-8a1f-7f9f6d53f113.png)  
图3. 使用消息队列的三个步骤

**获取代理令牌**
----------------

此操作仅适用于ISV集成模式，即由商家或收单机构授权的ISV进行的集成过程，允许ISV代表他们进行实施。
为了代表商家集成支付宝，ISV（独立软件供应商）需要在请求头中使用授权令牌。授权令牌的通知由商家触发，由支付宝发送。以下流程图展示了获取代理令牌的过程。

![图片2.png](https://cdn.nlark.com/yuque/0/2021/png/12884741/1627962410914-c0c8814c-bcf6-401b-ac98-62c1a1e1850b.png)  
图4. 获取代理令牌的过程  

**注意事项：**

1. 支付宝指定通过通知发送的数据。
2. 在支付宝让ISV上线之前，ISV需要提供通知URL。
3. ISV需要实现后端逻辑来接收令牌并返回正确的信息。

正确创建支付请求ID
===================

当同一笔业务订单因之前的支付失败或撤销而需要多次支付时，确保每个**pay**接口的`paymentRequestId`值不重复是必要的。因此，不能直接将业务订单号用作商家支付请求ID，而应为每个支付请求生成独立的支付请求ID。此外，应在商家服务器上建立业务订单号与商家支付请求ID之间的关系。

支付请求ID必须唯一，不可重置，且不能是连续数字。建议以下列方式创建支付请求ID：

`时间戳（精确到秒）+ 终端号 + 交易金额 + 终端交易序列号 + 随机数。`

遵循支付代码标准
===================

您需要支持17到32位数字且以25、26、27、28、29或30开头的支付代码，并且要准备好应对代码长度可能的扩展。

打印收据
==========

打印的收据必须包含以下信息：
*   商家订单号（paymentRequestId）或支付宝交易号（paymentId）。建议也使用条形码显示。
*   支付宝支付标识，以表明交易由支付宝处理。
*   本地时间的交易日期和时间（精确到秒）。
此外，不建议在打印收据上显示以下信息：
*   发卡机构的名称。（如有需要，可以使用支付宝代替。）
*   顾客的支付金额。

使用统一支付按钮
------------------

建议使用统一的支付标识按钮处理来自不同钱包的支付，以避免为每个钱包提供单独支付按钮带来的操作复杂性。

确认支付结果
------------

必须正确确认支付结果。请注意以下事项：
*   必须验证支付异步通知的签名，并检查返回的支付金额及其货币单位是否与支付请求一致。确保接收到的通知未被篡改。
*   收到异步通知或支付结果后，首先要确认通知是否已处理。只有对于未处理且未取消的原始交易，才能继续完成支付。如果从终端收到取消请求，完成取消流程。
*   使用数据锁定进行并发控制，以避免同时从查询请求和异步通知获取支付结果，这可能导致数据库中重复记录相同的交易信息，从而产生数据混乱。

对于收单机构与商家的集成
--------------------------
支付宝交易实时结算，这给保持客户、商家、收单机构和支付宝之间交易状态的一致性带来了挑战。由于客户能够立即在手机上查看交易，任何不一致都可能导致现场投诉。为了保持交易状态的一致性，收单机构不仅需要遵循与支付宝集成的最佳实践，还需要遵循与商家集成的最佳实践。本文档旨在阐述确保收单机构与商家之间高质量集成的原则。这些原则适用于采用用户展示模式支付、订单码支付和入口码支付产品的商家和收单机构。
### 1. 原则
由于商家与收单机构之间的集成方式多样，支付宝建议商家与收单方在集成时遵循以下原则，以确保集成质量：
*   保持所有参与者之间的交易状态一致。
*   如遇到任何不确定状态，如果可能，应启动撤销流程。
*   如果由于数据包丢失或其他异常情况未能执行撤销操作，您需要自行或通过重试队列重新尝试撤销流程。
### 2. 应用各种集成模型的原则：  
以下部分讨论了几种集成模型及其相应的集成原则，以说明商家和收单机构之间的各种集成。如果您的集成模型不在以下任何一种情况中，请联系支付宝技术支持获取帮助。  
#### 前置网关  
这是一种集成模型，其中收单网关简单地将消息从下游（商家）转发到支付宝。转发的消息包括支付、查询、取消和退款请求。  
所有请求都由下游发起并由网关转发，可能涉及协议转换。尽管商家和收单机构之间使用的协议细节或数据字段可能与收单机构和支付宝之间使用的不同，但处理逻辑和交易流程相似。因此，商家和收单机构之间的集成也需要遵循支付宝发布的最佳实践。  
以典型的支付宝条形码交易为例。以下图形显示了发起请求和转发请求的过程。  
![Image 7: Dingtalk_20210624181550.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624529760541-c6036fdf-641f-4fa3-ab25-a51bbfae5bb5.jpeg)  
图5. 发起请求和转发请求的过程  
在任何不确定的状态下，建议主动发起取消过程或使用存储转发队列。  
**主动取消**  
在收单网关仅简单转发下游（商家）消息到支付宝的集成模型中，商家与网关之间的连接问题很常见。当出现连接问题时，建议转发网关向支付宝发送取消请求，以避免交易状态不一致。
例如，在用户授权交易的过程中，下游与网关之间的连接在查询过程中突然断开。然而，用户与支付宝之间的授权过程正常完成。因此，商家将超时视为交易失败，而支付宝则扣除了用户的资金。这就导致了交易状态不一致，需要避免这种情况。

为了避免交易状态不一致，建议当满足以下条件时，转发网关代表下游主动向支付宝发起取消请求：

1. 达成一致的交易超时，即交易无法进一步处理。
2. 支付宝对之前向网关的查询没有返回授权批准的响应。
3. 超时后，网关未收到下游的取消请求。

以下图表展示了从转发网关向支付宝发起主动取消的过程：

![Image 8: 2.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624529963962-e2420fdb-5b18-4184-9e38-3f9bd075f0e6.jpeg)
图6. 主动取消发起过程

**注意**：
网关的超时设置必须大于商家的超时设置。否则交易可能会过早被撤销，影响成功率。

**存储转发队列**

关于取消请求的重传，实现取消的存储转发队列可以降低取消请求未送达的可能性。
实现存储转发队列可以帮助收银员在后台办公室发送取消请求直到成功。因此，建议在商家端和网关端都实现存储转发队列。如果不想在两端都实现，至少要在商家端实现。

#### RESTful API 网关

这是一种集成模型，利用了收单方的现有支付基础设施。例如，将收单方的RESTful API与商家连接起来以实现支付宝的集成。虽然这种集成模型增加了服务器端的集成复杂性，但商家端的集成变得更简单，因为大部分查询和取消逻辑可以在服务器端实现。

对于这种集成，需要谨慎考虑保持所有参与者之间的交易状态一致性的原则。

以典型的支付宝条形码交易为例。在商家初始化交易后，网关遵循我们的集成最佳实践（包括查询和重试）开始支付宝交易。商家使用收单方的API异步检查交易结果。商家和收单方各自独立维护超时值。以下图表展示了使用收单方API检查交易结果的过程。

![Image 9: 3.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624529974928-24bef1ca-38e3-4e80-b540-d77ac9b4af3f.jpeg)
图7. 使用收单方API检查交易结果的过程

在遇到任何不确定状态时，建议采取以下行动以确保所有参与者之间的交易状态一致性：
*   网关负责确定交易的关闭时间，并向支付宝发起最终的取消请求，以关闭与支付宝的交易。
*   网关需要能够通过设置比商家端更短的超时值，向商家提供最终的交易状态。
*   商家向网关发起取消请求，以减少交易状态不一致的可能性。

为了在收单机构和支付宝之间关闭交易，当满足以下条件之一时，网关需要主动发送取消请求：
*   网关超时后，未从支付宝收到授权批准的响应。
*   支付宝返回了授权批准，但网关无法将批准信息下游传递，超时后需要发起取消请求以逆转交易。

以下图表展示了向支付宝发起取消请求的流程：
![图片10: 4.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624529984772-f381c817-999e-470f-b9a4-65c539694ab9.jpeg)
图8. 向支付宝发起取消请求的流程

尽管网关需要能够将最终交易状态传递给商家，但可能由于某些原因商家未收到消息。在这种情况下，商家需要以某种方式通知网关，而网关需要能够将其解释为向支付宝的取消请求。此外，建议商家启动取消流程作为安全措施，以减少交易状态不一致的可能性。

#### 请求和响应切换
这是一种集成模型，其中收单机构使用现有的支付切换系统。
在这种情况下，下游（通常是商家系统）负责在超时后发起撤销请求。开关（支付系统中的中间件）将撤销建议存储在存储转发队列中，并将这些建议转换为对支付宝的取消请求。开关需要通过存储转发队列来确保取消请求成功送达支付宝。

以下图示展示了商家发起撤销建议的过程。商家向开关发送撤销建议，开关立即向商家返回响应，并负责成功向支付宝发送取消请求。

![图片11: 5.jpg](https://cdn.nlark.com/yuque/0/2021/jpeg/12884741/1624529996452-2ff549f5-95cd-4117-aa83-61df69056690.jpeg)
图9. 向支付宝发起撤销建议的过程

要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。

![图片12](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片13](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

[准备你的设备](#DuWDN "准备你的设备")  
[正确使用支付宝接口](#wR4R1 "正确使用支付宝接口")  
[取消请求重试解决方案](#Ilw5H "取消请求重试解决方案")  
[获取代理令牌](#LQnSI "获取代理令牌")  
[正确创建支付请求ID](#RIqvg "正确创建支付请求ID")  
[遵循支付代码标准](#27fzz "遵循支付代码标准")  
[打印收据](#33js7 "打印收据")  
[使用统一支付按钮](#xBNGy "使用统一支付按钮")  
[确认支付结果](#5PzCZ "确认支付结果")  
[对于收单机构与商家的集成](#ULVTT "对于收单机构与商家的集成")
1. 原则
   1.1 通用原则
   1.2 设计考量
   1.3 安全性与隐私

2. 应用原则于不同集成模型：
   2.1 前置网关
       2.1.1 功能描述
       2.1.2 实现细节
       2.1.3 示例用例
   2.2 RESTful API网关
       2.2.1 API设计规范
       2.2.2 路由与资源管理
       2.2.3 认证与授权
   2.3 请求-响应切换器
       2.3.1 工作机制
       2.3.2 用例场景
       2.3.3 性能优化

请注意，蚂蚁金服的业务涉及金融服务、支付、风险管理等多个领域，而上述文档结构并未直接提及蚂蚁金服的具体业务。如果需要将这些概念与蚂蚁金服的业务相结合，例如支付宝的API接口或蚂蚁链的集成方案，需要提供更详细的内容。不过，上述翻译提供了一个通用的技术文档框架，适用于讨论任何系统的集成模型和相关原则。