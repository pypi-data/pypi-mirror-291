卡信息存储 | 结算支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)](/docs/)
[![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fcv)
[返回首页](../../)

结算支付
[概览](/docs/ac/cashierpay/overview)
接受支付
支付后操作
支付方式
其他资源
高级功能
[预前端解决方案API](/docs/ac/cashierpay/prefront)
[先买后付API](/docs/ac/cashierpay/bnpl)
[卡信息存储API](/docs/ac/cashierpay/cv)
[卡信息存储SDK](/docs/ac/cashierpay/cvsdk)
[卡支付功能API SDK](/docs/ac/cashierpay/mf?pageVersion=7)

卡信息存储
=============

2024-05-11 10:13
本文档指导您完成独立的卡信息存储API的集成，使买家能够在支付过程的任何阶段绑定卡片。您可以收集买家的卡信息并存储在Antom中。在后续交易中，您可以使用_token_参数发起支付，而无需再次收集买家的卡信息。

支付流程
============

以下图示展示了卡信息存储的集成步骤：

![图片3：image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1713413213279-838f65c4-9428-416b-94ee-319828ce18fb.png)

集成步骤
================= 

按照以下步骤使买家能够在支付过程的任何阶段绑定卡片：

1.  发起卡信息存储请求
2.  获取卡信息存储结果

步骤1：发起卡信息存储请求
----------------------------------------
Antom 提供了多种编程语言的服务器端 API 库。以下是一个使用 Java 作为示例的代码。要在 Java 中使用 Antom API，请确保你的系统安装了 Java 6 或更高版本。
### 安装API库  
在[GitHub](https://github.com/alipay/global-open-sdk-java)上查找最新版本。  
复制以下内容：  

```xml
<dependency>
    <groupId>com.alipay.global.sdk</groupId>
    <artifactId>global-open-sdk-java</artifactId>
    <version>2.0.21</version>
</dependency>
```

这段代码是用于Maven项目的依赖配置，将允许你引入蚂蚁金服的全球开放SDK Java版本2.0.21。
### 初始化请求实例  
复制  
String 商户私钥 = "YOUR PRIVATE KEY";
String 支付宝公钥 = "ALIPAY PUBLIC KEY"
AlipayClient 默认支付宝客户端 = new DefaultAlipayClient(EndPointConstants.SG,
商户私钥, 支付宝公钥);
### 创建请求  
在请求中指定以下参数：
**参数名称** | **是否必需** | **描述**
------------ | ----------- | -------------
`param1` | 是 | 描述参数1的用途和格式。
`param2` | 否 | 可选参数2，如果存在则提供额外功能。
`param3` | 是 | 必须提供的参数3，用于指定特定操作。
`param4` | 否 | 默认值为`default4`，可自定义的配置项。
`param5` | 是 | 只接受特定值的枚举类型参数，例如`value1`或`value2`。
`param6` | 否 | 用于设置安全级别的布尔值，`true`或`false`。
`param7` | 是 | 必须是有效日期格式的参数，如`YYYY-MM-DD`。
`param8` | 否 | 可以是JSON对象的复杂参数，包含子参数。
`param9` | 是 | 限制为正整数的参数，表示数量。
`param10` | 否 | 用户自定义的字符串，无特定格式要求。

请注意，所有必需参数（标记为“是”）都必须提供，否则请求将无法执行。可选参数可以根据需要提供，它们提供了额外的灵活性和配置选项。
<td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="2ac5c79ba9d3ecad33358e41623cb64a" id="u683387be" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>Yes</span></p></td><td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="3807b1a8bc639f491c830c632263d2d9" id="ufbb2ca1a" style="font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px">提供用于存储卡信息的请求ID</p></td></tr><tr style="height:33px"><td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake-id="2ac5c79ba9d3ecad33358e41623cb64a" id="u683387be" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><em><span style="color:#333333">customerExperienceType</span></em></p></td><td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default"><p data-lake
<style>
  table, td, th {
    border: 1px solid #D9D9D9;
    padding: 4px 8px;
    text-align: center;
    font-size: 14px;
    line-height: 1.74;
    letter-spacing: 0.05em;
    white-space: normal;
    overflow-wrap: break-word;
    cursor: default;
  }
  th {
    background-color: #F2F2F2;
  }
</style>

<table>
  <tr style="height: 38px">
    <th>参数</th>
    <th>是否必需</th>
    <th>描述</th>
  </tr>
  <tr>
    <td>merchantSessionId</td>
    <td>是</td>
    <td>商家生成的唯一ID。每次进行卡存储时，必须有一个新的ID。</td>
  </tr>
  <tr style="height: 38px">
    <td>paymentMethodDetail.paymentMethod</td>
    <td>是</td>
    <td>支付方式的详细信息，包括支付方法类型。</td>
  </tr>
</table>

请注意，以上内容是关于一个支付或卡存储相关API的参数说明。在蚂蚁金服的业务中，这可能涉及到如支付宝的用户支付方式保存功能。`merchantSessionId`是商家在处理交易时用于标识特定会话的标识符，而`paymentMethodDetail.paymentMethod`则可能包含用户选择的支付方式（如信用卡、借记卡或支付宝余额等）的详细信息。
该字段固定为 `<code>CARD</code>`。

---

`redirectUrl`  
是  
商家端绑定的结果页面，需要根据服务器端的结果进行展示。
`vaultingNotificationUrl` 是一个用于接收卡存储结果通知的地址，可以通过 API 设置，也可以在门户中设定一个固定值。

`env` 代表环境，指的是应用运行的环境，如开发环境（dev）、测试环境（test）、生产环境（prod）等。
<table style="width:100%;border-collapse:collapse;border:1px solid #ccc;font-family:Arial,Helvetica,sans-serif;box-sizing:border-box">
  <tbody>
    <tr style="background-color:#f8f9fa">
      <th style="min-width:120px;font-size:14px;font-weight:normal;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;padding:8px 16px;border:1px solid rgb(217, 217, 217);text-align:left">参数</th>
      <th style="min-width:120px;font-size:14px;font-weight:normal;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;padding:8px 16px;border:1px solid rgb(217, 217, 217);text-align:left">类型</th>
      <th style="min-width:120px;font-size:14px;font-weight:normal;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;padding:8px 16px;border:1px solid rgb(217, 217, 217);text-align:left">是否必填</th>
      <th style="min-width:120px;font-size:14px;font-weight:normal;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;padding:8px 16px;border:1px solid rgb(217, 217, 217);text-align:left">描述</th>
    </tr>
    <tr>
      <td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default">
        <p id="u959a4e54" style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>yes</span></p>
      </td>
      <td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default">
        <p style="font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px">String</p>
      </td>
      <td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default">
        <p style="text-align:center;font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px"><span>Yes</span></p>
      </td>
      <td style="min-width:90px;font-size:14px;white-space:normal;overflow-wrap:break-word;border:1px solid rgb(217, 217, 217);padding:4px 8px;cursor:default">
        <p id="u959a4e54" style="font-size:14px;color:rgb(38, 38, 38);line-height:1.74;letter-spacing:0.05em;outline-style:none;overflow-wrap:break-word;margin-top:0px;margin-bottom:0px">买家发起卡存储请求的环境。</p>
      </td>
    </tr>
  </tbody>
</table>

请注意，上述表格描述了一个参数的详细信息，包括参数名、类型、是否必填以及参数的描述。在实际应用中，这可能是某个API接口或服务的一部分，用于处理卡信息的存储请求。
有关所有参数的更多信息，请参考[**vault**](https://global.alipay.com/docs/ac/ams/vaulting_session) API文档。  
以下示例代码展示了如何发起支付：

```java
AlipayPayRequest alipayPayRequest = new AlipayPayRequest();
alipayPayRequest.setClientId(CLIENT_ID);
alipayPayRequest.setPath("/ams/api/v1/vaults/vaultPaymentMethod");  

// 用实际的vaultingRequestId替换
String vaultingRequestId = UUID.randomUUID().toString();
alipayPayRequest.setPaymentRequestId(vaultingRequestId);
```

这段代码中，`AlipayPayRequest`对象被初始化，并设置了客户端ID(`CLIENT_ID`)和请求路径。`vaultingRequestId`用了一个随机生成的UUID（在实际使用时应替换为实际的请求ID），`paymentRequestId`也应设置为实际的支付请求ID。
### 常见问题
#### 如何设置_terminalType_的值？
如果买家是从PC端发起请求，_terminalType_ 需要设置为 `WEB`。
#### 如何设置结果通知地址？
蚂蚁金服会通过[**notifyVaulting**](https://global.alipay.com/docs/ac/ams/notify_vaulting)接口发送支付结果。
#### 如何处理联名卡？
如果买家输入的是一张联名卡，你需要通过_paymentMethodDetail.card.selectedCardBrand_指定要绑定的卡品牌，后续的_token_支付将从该卡品牌扣款。
> **注意**：对于欧洲的联名卡，你需要给予买家选择要绑定的卡品牌的权利。
步骤2：获取卡托管结果
-----------------------
### 同步响应  
卡片存档结果的返回代码如下：  
复制  
{
"paymentMethodDetail": {
"card": {
"brand": "VISA",
"cardToken": "ALIPAY9CGwsAeMBug+G2dSKDV6AIsNKTxAFNkOMoj8Gxvt8h0eDUbd6nO5CwMFIjEFERWxCAo/b1OjVTvtl1zspyMGcg==",
"maskedCardNo": "************8764"
},
"paymentMethodType": "CARD"
},
"vaultingRequestId": "123487889889",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}  
#### 常见问题  
##### 如何在字段中指定参数？  
_resultStatus_ 表示此次卡片存档请求的结果：`S` 表示成功，`F` 表示失败，`U` 表示需要重定向到 normalUrl 进行3D验证。  
当卡片存档成功时，**vaultPaymentMethod** API 将会同步返回这些字段。其中，_cardToken_ 用于令牌支付，_maskedCardNo_ 用于向客户显示卡号，_brand_ 用于向客户显示卡品牌。您可以在商家端将这些信息与购买者ID关联存储。  
##### 卡片存档成功后是否仍有异步通知？  
在**vaultPaymentMethod** API 返回 `S` 或 `F` 后，您将收到相应的异步通知。
### 异步响应  
当买家完成支付或支付超时时，您可以通过蚂蚁金服的异步通知或查询存卡结果来获取存卡操作的结果。  

#### 异步通知  
完成存卡或超时时，蚂蚁金服会通过[**notifyVaulting**](https://global.alipay.com/docs/ac/ams/notify_vaulting)发送异步通知。  

##### 常见问题  
###### 何时发送通知？  
支付完成后，蚂蚁金服会在3~5秒内向您发送异步通知。  
###### 异步通知会被重发吗？  
如果您收到蚂蚁金服的异步通知，需要按照[示例代码](https://global.alipay.com/docs/ac/cpnew/nf)格式返回响应。如果您未按要求响应异步通知，或者由于网络原因通知未送达，通知将在24小时内自动重发，最多重发8次，直到收到正确的响应为止。重发间隔为：0分钟、2分钟、10分钟、10分钟、1小时、2小时、6小时和15小时。  
###### 需要对响应进行签名吗？  
如果您收到蚂蚁金服的异步通知，需要按照示例代码格式返回响应，但不需要对响应进行签名。  

#### 查询存卡结果  
调用[**inquireVaulting**](https://global.alipay.com/docs/ac/ams/inquire_vaulting) API 来查询存卡结果。  

##### 常见问题  
###### 如何使用存卡请求返回的关键参数？  
_resultStatus_ 的值表示此次存卡请求的结果：  
*   `S`：表示存卡成功。
*   `F`：表示存卡失败。
`U`: 表示买家需要被重定向到 _normalUrl_ 进行3D验证。  
当卡存储成功后，**vaultPaymentMethod** API 会同步返回以下字段：  
*   _cardToken:_ 用于令牌支付，
*   _maskedCardNo:_ 用于向客户显示卡号，
*   _brand:_ 用于向客户显示卡品牌。您可以在商家端将这些信息与买家ID关联存储。  
###### 卡存储成功后还有异步通知吗？  
在 **vaultPaymentMethod** API 返回 `S` 或 `F` 后，您将收到相应的异步通知。  
要查看文档的最新更新，请访问 [版本更新日志](https://global.alipay.com/docs/releasenotes)。  
![图片 4](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 5](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面有帮助吗？  
#### 本页内容  
[支付流程](#N7q25 "支付流程")  
[集成步骤](#nbBeY "集成步骤")  
[步骤1：发起卡存储请求](#P1Nao "步骤1：发起卡存储请求")  
[安装API库](#TQwe2 "安装API库")  
[初始化请求实例](#3HXct "初始化请求实例")  
[创建请求](#fNYHp "创建请求")  
[常见问题](#5Vqv9 "常见问题")  
[如何设置terminalType的值？](#Ei1Hy "如何设置terminalType的值？")  
[如何设置结果通知地址？](#Gt9QT "如何设置结果通知地址？")  
[如何处理联名卡？](#jZ0O4 "如何处理联名卡？")  
[步骤2：获取卡存储结果](#jIRdT "步骤2：获取卡存储结果")  
[同步响应](#GT4Y4 "同步响应")  
[常见问题](#49Lhn "常见问题")
异步响应
---

异步通知
---

查询保管箱结果
---