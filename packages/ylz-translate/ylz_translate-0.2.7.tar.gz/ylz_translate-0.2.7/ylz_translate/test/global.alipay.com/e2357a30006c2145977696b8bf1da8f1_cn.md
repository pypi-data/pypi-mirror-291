易安宝支付 (iOS) | 易安宝支付 | 支付宝文档
==================

[![图片 1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片 2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Feasypay_en%2Fios)
[返回首页](../../)

易安宝支付
[概览](/docs/ac/easypay_en/overview_en)
接收支付
[易安宝支付 (Web/WAP)](/docs/ac/easypay_en/WW)
[易安宝支付 (Android)](/docs/ac/easypay_en/android)
[易安宝支付 (iOS)](/docs/ac/easypay_en/ios)
支付后
易安宝支付 (iOS)
==================

2024-05-16 03:26

本文档介绍了支持从桌面浏览器或移动浏览器接收支付的集成解决方案。集成后，您可以提供数字钱包、银行卡和银行转账等多种支付方式。

用户体验
===============

以下截图展示了钱包支付和银行转账的用户体验。首次支付时，买家可以启用免密支付，以便后续支付时无需输入支付密码。后续支付的整个过程将在您的网站或应用中完成。

钱包支付
------
买家可以在您的网站或应用内完成支付，并在首次支付时启用免密支付，从而在后续支付中无需输入支付密码。

**首次支付**

**后续支付**
### 首次支付
在首次支付时，买家会完成授权流程，以便后续可以无密码支付。
![图片3: Android.webp](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715066288848-e2320b94-0703-4e53-b983-ea67d0baa5d5.webp)
### 后续支付  
后续支付无需密码即可完成。对于较大的支付金额，您可以设定一个最低支付阈值，超过这个金额时需要额外的验证步骤以增强安全性。  
**小额支付**  
对于小额订单，买家可以直接提交订单并进行支付，无需额外确认。  
![图片4: Android1.webp](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715066312838-31881f90-467a-4a5f-bd48-b42205a9b32c.webp)  
**大额支付**  
为了提高支付安全性，您可以设置一个预定义的金额上限，当买家的支付金额超过这个上限时，需要他们确认支付。  
![图片5: Android2.webp](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715066342302-adddc275-f533-4041-875e-cbe8366c8321.webp)
### 银行转账  
对于银行转账支付方式，以下图表展示了首次支付和后续支付的用户体验。  

#### 首次支付  
[此处应插入首次支付用户体验的图形]

#### 后续支付  
[此处应插入后续支付用户体验的图形]

请注意，由于这是一个Markdown格式的文档，实际的图形或图片无法在此文本中显示。在实际的文档中，这些位置会被相应的设计图或流程图所填充，以详细说明用户在进行银行转账时的步骤和界面。
### 首次支付
在首次支付时，用户需要输入支付密码和验证码。
![图片6: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715070406188-a847b804-69eb-48dd-a94c-629b8ae9dd55.png)
### 后续支付  
后续支付无需验证号码即可进行。  
![图片 7: image.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715070451156-745092ab-03ae-4521-9824-42c39547e23c.png)  
支付流程
==========  
首次支付
------------  
当买家选择蚂蚁金服提供的支付方式时，您需要收集关键信息，如支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL。调用**createPaymentSession** API来创建订单并通过SDK弹出页面。  
![图片 8: Easy Pay 首次支付流程图@3x.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715829717098-08c6fec2-d6eb-4905-bc74-4bd7d9f62260.png)  
1.  **买家进入结账页面。**
2.  **创建**[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**请求**
买家选择支付方式并提交订单后，您可以调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口获取支付会话。
3.  **调用客户端SDK**
在客户端，通过支付会话调用SDK。SDK将根据支付方式的特性收集支付元素，显示代码信息，重定向，调用并引导买家完成支付。
4.  **获取授权结果**  
    *   异步通知：授权成功后，蚂蚁金服会通过[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API向您发送异步通知。
    *   同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口检查授权状态。  
5.  **获取支付结果**
通过以下两种方式之一获取支付结果：

1. 异步通知：在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口中指定_paymentNotifyUrl_，设置接收异步通知的地址。支付成功或超时时，Antom会使用[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)向您发送异步通知。
2. 同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口检查支付状态。

后续支付
-------------------

当买家选择Antom提供的支付方式时，您需要收集支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL等关键信息。通过SDK调用**createPaymentSession** API来创建订单并弹出页面。

![图片9: Easy Pay 再次支付流程图@3x.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715829794923-012efc3e-7b30-41fb-9327-0a6fc00e016a.png)

1. **买家进入结账页面。**
2. **创建[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**请求
   买家选择支付方式并提交订单后，您可以调用[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口获取支付会话。
3. **调用客户端SDK**
   在客户端，通过支付会话调用SDK。SDK会根据支付方式的特性收集支付要素，显示代码信息，重定向，调用并引导买家完成支付。
4. **获取支付结果**
   使用以下两种方法之一获取支付结果：
异步通知：在[**createPaymentSession**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)接口中指定_paymentNotifyUrl_，设置接收异步通知的地址。当支付成功或超时时，Antom会使用[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)向您发送异步通知。

同步查询：调用[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口查询支付状态。

集成步骤
------------

1. 创建支付会话
2. 调用SDK
3. 获取授权或支付结果

步骤1：创建支付会话（服务器端）
--------------------------------------------

当买家选择Antom提供的支付方式时，您需要收集关键信息，如支付请求ID、订单金额、支付方式、订单描述、支付重定向页面URL和支付结果通知URL。调用**createPaymentSession** API创建支付会话，并将支付会话返回给客户端。

Antom提供了多种语言的服务器端API库。以下代码以Java为例，您需要安装Java 6或更高版本。
### 安装API库
您可以在[GitHub](https://github.com/alipay/global-open-sdk-java)上找到最新版本。  
复制以下内容：  
```xml
<dependency>
    <groupId>com.alipay.global.sdk</groupId>
    <artifactId>global-open-sdk-java</artifactId>
    <version>2.0.21</version>
</dependency>
```

这段代码是用于Maven项目的依赖配置，将它添加到您的`pom.xml`文件中，即可引入蚂蚁金服的全球开放SDK Java版本2.0.21。
### 初始化请求实例  
创建一个单例资源以向Antom发起请求。  
复制  
```java
import com.alipay.global.api.AlipayClient;
import com.alipay.global.api.DefaultAlipayClient;

String merchantPrivateKey = "您的私钥";
String alipayPublicKey = "支付宝公钥";
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);
```

这里的代码是在Java环境中，导入了蚂蚁金服的API库，然后初始化了一个默认的`AlipayClient`实例。`merchantPrivateKey`是商户的私钥，`alipayPublicKey`是支付宝的公钥，`EndPointConstants.SG`是请求的端点常量，通常代表服务器的URL。这个实例用于后续与蚂蚁金服接口的交互。
### 创建支付会话  
首次支付  
后续支付  
#### 首次支付  
创建支付会话涉及以下参数：  
| 参数名称 | 是否必填 | 描述 |
| --- | --- | --- |
| paymentRedirectUrl | ✅ | 支付完成后，买家被重定向到的商家页面URL。 |
| authState | ✅ | 您分配的用于启动授权的唯一标识，用于后续免密支付获取令牌。此参数仅在首次支付时传递，后续支付不需要传递。 |
| paymentNotifyUrl | ✅ | 支付结果通知地址。该地址必须是HTTPS。 |
| paymentSessionExpiryTime | ✅ | 支付会话超时时间。默认为1小时，可设置为1小时内超时，值的格式遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准。例如，2019-11-27T12:01:01+08:00。 |
| userLoginId | ✅ | 买家的钱包侧登录账号，可以是买家的电子邮件地址或电话号码。 |
| order.buyer: referenceBuyerId/buyerPhoneNo/buyerEmail | ✅ | 为风险决策传递买家信息。只需传递referenceBuyerId、buyerPhoneNo、buyerEmail中的一个参数即可。 |  

以上参数是创建支付会话的基本参数。完整的参数列表和支付方式的额外要求，请参阅[**createPaymentSession (EasySafePay)**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**。**  
以下示例代码展示了如何调用**createPaymentSession** API：  
```java
AlipayPaymentSessionRequest alipayPaymentSessionRequest = new AlipayPaymentSessionRequest();
alipayPaymentSessionRequest.setClientId(clientId);
alipayPaymentSessionRequest.setPath("/ams/sandbox/api/v1/payments/createPaymentSession");
alipayPaymentSessionRequest.setProductCode(ProductCodeType.AGREEMENT_PAYMENT);
```

请注意，这是一段关于使用Alipay（可能是指蚂蚁金服）API创建支付会话的文档，适用于首次和后续支付场景。
```java
alipayPaymentSessionRequest.setProductScene(ProductSceneConstants.EASY_PAY);  
// 替换为你的支付请求ID
alipayPaymentSessionRequest.setPaymentRequestId("paymentRequestId001");  
Amount amount = new Amount();
// 设置金额
amount.setCurrency("CNY");
amount.setValue("100");
alipayPaymentSessionRequest.setPaymentAmount(amount);  
// 设置结算货币
SettlementStrategy settlementStrategy = new SettlementStrategy();
settlementStrategy.setSettlementCurrency("USD");
alipayPaymentSessionRequest.setSettlementStrategy(settlementStrategy);  
// 设置协议信息
AgreementInfo agreementInfo = new AgreementInfo();
agreementInfo.setAuthState("authState001");
agreementInfo.setUserLoginId("userLoginId001");
alipayPaymentSessionRequest.setAgreementInfo(agreementInfo);  
// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("ALIPAY_CN");  
// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId001");
order.setOrderDescription("orderDescription001");
order.setOrderAmount(amount);
Buyer buyer = new Buyer();
buyer.setReferenceBuyerId("referenceBuyerId001");
order.setBuyer(buyer);
order.setOrderAmount(amount);
alipayPaymentSessionRequest.setOrder(order);  
// 替换为你的回调URL
alipayPaymentSessionRequest.setPaymentNotifyUrl("https://www.yourNotifyUrl");
alipayPaymentSessionRequest.setPaymentRedirectUrl("https://www.yourMerchantWeb.com");  
AlipayPaymentSessionResponse alipayPaymentSessionResponse = defaultAlipayClient
.execute(alipayPaymentSessionRequest);  
```

以下是一个请求消息的示例：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId001",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentMethod": {
    "paymentMethodType": "ALIPAY_CN"
  },
  "agreementInfo": {
    // ...
  }
}
```

这段代码展示了如何设置支付宝支付会话请求，包括产品场景、支付请求ID、金额、结算策略、协议信息、支付方式、订单信息以及回调和重定向URL。执行请求后，将得到响应。
"authState": "authState001",
"userLoginId": "userLoginId001"
},
"paymentAmount": {
"currency": "CNY",
"value": "100"
},
"order": {
"orderAmount": {
"currency": "CNY",
"value": "100"
},
"referenceOrderId": "referenceOrderId001",
"orderDescription": "orderDescription001",
"buyer": {
"referenceBuyerId": "referenceBuyerId001"
}
}
}
以下是一个示例响应，其中包含以下参数：
*   _paymentSessionData_: 需要返回给前端的支付会话数据
*   _paymentSessionExpiryTime_: 支付会话的过期时间
复制
{
"paymentSessionData": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Kvvmsdk+akdLvoShW5avHX8e8J15P8uNVEf/PcCMyXg==&&SG&&111",
"paymentSessionExpiryTime": "2023-04-06T03:28:49+08:00",
"paymentSessionId": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Ikyj9FPVUOpv+DjiIZqMe",
"result": {
"resultCode": "SUCCESS",
"resultMessage": "success.",
"resultStatus": "S"
}
}
#### 后续支付
创建支付会话涉及以下参数：
| 参数名称 | 是否必填 | 描述 |
| --- | --- | --- |
| paymentMethod.paymentMethodId | ✅ | 传递在第一次支付后从[**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API 接收到的 *accessToken* 的值。 |
| paymentRedirectUrl | ✅ | 买家支付完成后重定向的商户页面URL。 |
| paymentNotifyUrl | ✅ | 支付结果通知地址。该地址必须是HTTPS。 |
| paymentSessionExpiryTime | ✅ | 支付会话超时时间。默认为1小时，可设置为1小时内超时，值的格式遵循[ISO 8601](https://www.iso.org/iso-8601-date-and-time-format.html)标准。例如，2019-11-27T12:01:01+08:00。 |
| order.buyer: referenceBuyerId/buyerPhoneNo/buyerEmail | ✅ | 用于风险决策的用户信息。传递referenceBuyerId、buyerPhoneNo、buyerEmail中的一个参数即可。 |
以下参数是创建支付会话的基本参数。要查看完整参数列表以及支付方式的额外要求，请参阅[**createPaymentSession (EasySafePay)**](https://global.alipay.com/docs/ac/ams/createpaymentsession_easypay)**。**  
以下示例代码展示了如何调用**createPaymentSession** API：

```java
AlipayPaymentSessionRequest alipayPaymentSessionRequest = new AlipayPaymentSessionRequest();
alipayPaymentSessionRequest.setClientId(clientId);
alipayPaymentSessionRequest.setPath("/ams/sandbox/api/v1/payments/createPaymentSession");
alipayPaymentSessionRequest.setProductCode(ProductCodeType.AGREEMENT_PAYMENT);
alipayPaymentSessionRequest.setProductScene(ProductSceneConstants.EASY_PAY);  

// 将paymentRequestId替换为您的实际值
alipayPaymentSessionRequest.setPaymentRequestId("paymentRequestId002");  

Amount amount = new Amount();
// 设置金额
amount.setCurrency("CNY");
amount.setValue("100");
alipayPaymentSessionRequest.setPaymentAmount(amount);  

// 设置结算货币
SettlementStrategy settlementStrategy = new SettlementStrategy();
settlementStrategy.setSettlementCurrency("USD");
alipayPaymentSessionRequest.setSettlementStrategy(settlementStrategy);  

// 设置支付方式
PaymentMethod paymentMethod = new PaymentMethod();
paymentMethod.setPaymentMethodType("ALIPAY_CN");
paymentMethod.setPaymentMethodId("*****************************");  

// 设置订单信息
Order order = new Order();
order.setReferenceOrderId("referenceOrderId002");
order.setOrderDescription("orderDescription001");
order.setOrderAmount(amount);
Buyer buyer = new Buyer();
buyer.setReferenceBuyerId("referenceBuyerId001");
order.setBuyer(buyer);
order.setOrderAmount(amount);
alipayPaymentSessionRequest.setOrder(order);  

// 将redirect url替换为您的实际值
alipayPaymentSessionRequest.setPaymentNotifyUrl("https://www.yourNotifyUrl");
alipayPaymentSessionRequest.setPaymentRedirectUrl("https://www.yourMerchantWeb.com");
```

请注意替换示例代码中的占位符（如`clientId`、`paymentRequestId`、`redirect url`等）为实际的值。
支付宝支付会话响应示例：

```java
AlipayPaymentSessionResponse alipayPaymentSessionResponse = defaultAlipayClient.execute(alipayPaymentSessionRequest);
```

请求消息示例：

```json
{
  "settlementStrategy": {
    "settlementCurrency": "USD"
  },
  "productCode": "AGREEMENT_PAYMENT",
  "productScene": "EASY_PAY",
  "paymentNotifyUrl": "https://www.yourNotifyUrl",
  "paymentRequestId": "paymentRequestId002",
  "paymentRedirectUrl": "https://www.yourMerchantWeb.com",
  "paymentMethod": {
    "paymentMethodId": "*****************************",
    "paymentMethodType": "ALIPAY_CN"
  },
  "paymentAmount": {
    "currency": "CNY",
    "value": "30000"
  },
  "order": {
    "orderAmount": {
      "currency": "CNY",
      "value": "30000"
    },
    "referenceOrderId": "referenceOrderId002",
    "orderDescription": "orderDescription002",
    "buyer": {
      "referenceBuyerId": "referenceBuyerId002"
    }
  }
}
```

响应示例，包含以下参数：

*   `paymentSessionData`：返回给前端的支付会话数据
*   `paymentSessionExpiryTime`：支付会话的过期时间

```json
{
  "paymentSessionData": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Kvvmsdk+akdLvoShW5avHX8e8J15P8uNVEf/PcCMyXg==&&SG&&111",
  "paymentSessionExpiryTime": "2023-04-06T03:28:49+08:00",
  "paymentSessionId": "UNvjVWnWPXJA4BgW+vfjsQj7PbOraafHY19X+6EqMz6Ikyj9FPVUOpv+DjiIZqMe",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```

这段代码和示例展示了使用默认的AlipayClient执行支付会话请求以及请求和响应的JSON格式。请求中包含了结算策略、产品代码、场景、通知URL、请求ID、重定向URL、支付方法、支付金额和订单详情。响应中则包含了支付会话数据、过期时间、会话ID以及结果状态。
### 常见问题
#### 请求中可以使用中文字符吗？
请勿在请求中的字段，包括`paymentRequestId`、`referenceOrderId`、`orderDescription`和`goods`使用中文字符，以避免与QRIS和Mastercard等不兼容的支付方式产生问题。

#### 如何设置支付结果通知地址？
蚂蚁金服会通过[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)接口发送支付结果。您可以在`createPaymentSession` API中通过`paymentNotifyUrl`参数指定通知地址。如果每个支付的地址都相同，您也可以在蚂蚁金服控制台中进行配置。如果您既配置了地址又在API中设置了参数，蚂蚁金服将使用API中设置的地址。

步骤2：创建并调用SDK客户端
---------------------------------------------
### 安装  
版本要求：  
*   安装Xcode 12或更高版本。
*   使用iOS 11或更高版本。  

要集成SDK包，请参考[集成SDK包](https://global.alipay.com/docs/ac/antom_sdk/ios_en)。
### 初始化客户端SDK  
创建SDK实例并指定基础配置。创建一个`AMSEasyPayConfiguration`对象包括以下参数：

| 参数名 | 是否必需 | 描述 |
| --- | --- | --- |
| *locale* |  | 用于传递语言信息。有效值如下，根据支付方式所在地区选择传递的值。如果传递其他值，默认使用本地语言：* `en_US`: 英语 * `in_ID`: 印尼语 * `th_TH`: 泰语 * `ms_MY`: 马来语 * `tl_PH`: 菲律宾语 * `ko_KR`: 韩语 * `vi_VN`: 越南语 * `zh_HK`: 繁体中文 |

| *options* |  | 用于指定是否使用默认加载样式以及沙盒环境。有效值如下：* `"sandbox", "true"`: 沙盒环境 * `"sandbox", "false"`: 生产环境 * `"showLoading", "true"`: 使用默认加载样式 * `"showLoading", "false"`: 不使用默认加载样式 |

实现`AMSPaymentProtocol`，用于处理后续流程中的相应事件。包含以下方法：

| 方法 | 是否必需 | 描述 |
| --- | --- | --- |
| *onEventCallback* |  | 用于监听结账页面支付事件的回调函数，返回`eventCode`和`eventResult`。 |

实现`AMSLoggerProtocol`，用于管理日志输出。包含以下方法：

| 方法 | 是否必需 | 描述 |
| --- | --- | --- |
| *logWithName* |  | 用于默认输出日志的回调函数。 |

以下示例代码展示了如何实例化SDK：

```swift
#import <AMSComponent/AMSComponent-Swift.h>
AMSEasyPayConfiguration *componentConfig = [AMSEasyPayConfiguration new];
componentConfig.locale = @"en_US";
// 设置showLoading为true（默认值）以使用默认加载样式。设置为false则根据onEventCallback自定义加载动画。
```

请注意，这段代码是基于Swift的，如果你需要其他编程语言的示例，请告知。
// 设置沙盒环境。如果不设置，则默认使用生产环境。
NSDictionary *options = @{@"showLoading": @"true", @"sandbox": @"true"};
componentConfig.options = options;  
[[AMSEasyPay shared] initConfiguration:componentConfig];  
// 设置回调以监控结账页面的支付事件。
[AMSEasyPay shared].paymentDelegate = self;
[AMSEasyPay shared].loggerDelegate = self;  
// 服务器调用createPaymentSession API 获取paymentSessionData。
### 调用SDK
调用`createComponent`方法：
| **参数名** | **必需** | **描述** |
| --- | --- | --- |
| *sessionData* | ✅ | 使用*sessionData*参数创建配置对象：将通过**createpaymentSession（结账支付）**API获取的*paymentSessionData*参数中的完整数据传给*sessionData*参数。 |

在以下情况下调用`onDestroy`方法释放SDK组件资源：
*   当买家离开结账页面时，释放**createPaymentSession**中创建的组件资源。
*   当买家发起多次支付时，释放之前**createPaymentSession**中创建的组件资源。
以下示例代码展示了如何调用SDK：
```swift
[[AMSEasyPay shared] createComponent:sessionData];
// 释放SDK组件资源
[[AMSEasyPay shared] onDestroy];
```
步骤3：获取授权结果或支付结果（服务器端）
-------------------------------------------
对于首次支付，您可以获取授权和支付结果；对于后续支付，仅获取支付结果。可以通过以下方法之一获取授权或支付结果：
*   接收异步通知
*   查询结果
### **接收异步通知**
获取授权结果  
获取支付结果  
#### 获取授权结果  
当授权成功时，蚂蚁金服会通过 [**notifyAuthorization**](https://global.alipay.com/docs/ac/ams/notifyauth) API 向您发送异步通知。收到通知后，您必须按照 [要求](https://global.alipay.com/docs/ac/ams/paymentrn_online) 返回响应。同时，您需要在您的系统中更新买家的授权状态，并在授权管理页面上显示从通知中获取的买家脱敏账户。

以下是一个通知请求的示例代码：
```json
{
  "accessToken": "2810123456789012345678901234567890",
  "authState": "AUTHSTATE_SAMPLE_1234567890",
  "authorizationNotifyType": "TOKEN_CREATED",
  "userLoginId": "852-52***184",
  "result": {
    "resultCode": "SUCCESS",
    "resultMessage": "success.",
    "resultStatus": "S"
  }
}
```
以下是验证并返回通知的代码示例：
```java
@RequestMapping(path = "/authResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> authNotifyProcessor(HttpServletRequest request,
    @RequestBody String body) {
  // 从请求头中获取所需参数。
  String requestTime = request.getHeader("request-time");
  String clientId = request.getHeader("client-id");
  String rawSignature = request.getHeader("signature");
  String signature = "";  

  // 从原始签名中获取有效部分
  if(rawSignature==null||rawSignature.isEmpty()){
    throw new RuntimeException("empty notify signature");
  } else {
    String[] parts = rawSignature.split("signature=");
    if (parts.length > 1) {
      signature = parts[1];
    }
  }  

  // 验证授权结果通知的签名
  boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
      clientId, requestTime, body, signature,
      ALIPAY_PUBLIC_KEY);
  if (!verifyResult) {
```
抛出运行时异常：“无效的通知签名”
}  
// 根据通知结果更新记录状态  
// 向服务器发送我们已接收通知的响应
Result 结果 = new Result("SUCCESS", "success", ResultStatusType.S);
AlipayResponse 响应 = new AlipayResponse();
响应.setResult(结果);
return ResponseEntity.ok().body(响应);
}  
#### 获取支付结果  
当支付达到成功或失败的最终状态时，蚂蚁金服会通过 [**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online) API，向在 **createPaymentSession** API 中指定的 _paymentNotifyUrl_ 发送异步通知。收到蚂蚁金服的通知后，您需要按照 [要求](https://global.alipay.com/docs/ac/cashier_payment_cn/notification) 返回响应。

以下是一个通知请求的示例：
```json
{
"notifyType": "PAYMENT_RESULT",
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "success"
},
"paymentRequestId": "2020010123456789XXXX",
"paymentId": "2020010123456789XXXX",
"paymentAmount": {
"value": "4200",
"currency": "SGD"
},
"paymentCreateTime": "2020-01-01T12:01:00+08:30",
"paymentTime": "2020-01-01T12:01:01+08:30"
}
```
以下示例代码展示了如何验证通知的签名并做出响应：
```java
@RequestMapping(path = "/payResult", method = RequestMethod.POST)
public ResponseEntity<AlipayResponse> paymentNotifyProcessor(HttpServletRequest request,
@RequestBody String body) {
// 从请求头中获取所需参数。
String requestTime = request.getHeader("request-time");
String clientId = request.getHeader("client-id");
String rawSignature = request.getHeader("signature");
String signature = "";  

// 从原始签名中获取有效部分
if(rawSignature==null||rawSignature.isEmpty()){
    throw new RuntimeException("空的通知签名");
}else {
    // 验证签名的代码将放在这里
    // ...
}
```
请注意，上述代码中验证签名的部分需要根据实际使用的签名算法和蚂蚁金服的文档来实现。
```java
String[] parts = rawSignature.split("signature=");
if (parts.length > 1) {
    signature = parts[1];
}
}  
// 验证支付结果通知的签名
boolean verifyResult = SignatureTool.verify(request.getMethod(), request.getRequestURI(),
        clientId, requestTime, body, signature,
        ALIPAY_PUBLIC_KEY);
if (!verifyResult) {
    throw new RuntimeException("无效的通知签名");
}  
// 根据通知结果更新记录状态
// 响应服务器我们已接受通知
Result result = new Result("SUCCESS", "success", ResultStatusType.S);
AlipayResponse response = new AlipayResponse();
response.setResult(result);
return ResponseEntity.ok().body(response);
}  
#### 常见问题解答 (FAQs)
##### 何时会发送通知？
这取决于支付是否完成：
*   如果支付成功完成，蚂蚁金服通常会在3到5秒内发送异步通知。对于像柜台支付（OTC）这样的支付方式，通知可能会稍有延迟。
*   如果支付未完成，蚂蚁金服需要先关闭订单，然后才会发送异步通知。不同支付方式关闭订单的时间会有所不同，通常默认为14分钟。  
##### 异步通知会被重新发送吗？
如果您收到蚂蚁金服的异步通知，您需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应。如果您未按要求响应异步通知，或者由于网络原因通知未送达，通知将在24小时内自动重试发送，最多重试8次，直到收到正确的响应为止。发送间隔为：0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时和15小时。  
##### 是否需要在响应中添加数字签名？
```

在中文翻译中，我保留了原始代码结构，并将英文文本翻译成中文。请注意，代码注释和文本已转换为简体中文。
如果您收到蚂蚁金服的异步通知，您需要按照[示例代码](https://global.alipay.com/docs/ac/cashier_payment_cn/notification)的格式返回响应，但不需要在响应中添加数字签名。

##### 如何理解`notifyAuthorization` API 中的关键字段含义？
*   `_result_`: 表示订单的支付结果。
*   `_authState_`: 商户生成的代扣请求ID。
*   `_accessToken_`: 蚂蚁金服生成的自动扣款ID，用于后续支付。
*   `_userLoginId_`: 用户的脱敏账号号。

##### 如何理解`notifyPayment` API 中的关键字段含义？
*   `_result_`: 订单的支付结果。
*   `_paymentRequestId_`: 商户生成的支付请求ID，用于查询、取消和对账。
*   `_paymentId_`: 蚂蚁金服生成的支付订单ID，用于退款和对账。
*   `_paymentAmount_`: 如需进行金额对账，可以使用此字段。
### 查询支付结果  
您可以调用 **inquiryPayment** API 来查询订单的支付结果。  
| **参数名称** | **是否必需** | **描述** |
| --- | --- | --- |
| *paymentRequestId* |  | 您生成的支付请求ID。 |

参数列表不完整，完整参数集及特定支付方式的额外要求请参考 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) API 文档。

以下示例代码展示了如何调用 **inquiryPayment** API：

```java
AlipayClient defaultAlipayClient = new DefaultAlipayClient(EndPointConstants.SG,
    merchantPrivateKey, alipayPublicKey);  
AlipayPayQueryRequest alipayPayQueryRequest = new AlipayPayQueryRequest();
alipayPayQueryRequest.setClientId(CLIENT_ID);
alipayPayQueryRequest.setPath("/ams/sandbox/api/v1/payments/inquiryPayment");  
AlipayPayQueryResponse alipayPayQueryResponse;
try {
    alipayPayQueryResponse = defaultAlipayClient.execute(alipayPayQueryRequest);
} catch (AlipayApiException e) {
    String errorMsg = e.getMessage();
    // 处理错误情况
}  
```

以下是一个请求消息的示例：

```json
{
    "paymentRequestId": "2019060811401080010018882020035****"
}
```

以下是一个响应消息的示例：

```json
{
    "result": {
        "resultCode": "SUCCESS",
        "resultStatus": "S",
        "resultMessage": "Success"
    },
    "paymentStatus": "SUCCESS",
    "paymentRequestId": "pay_1089760038715669_10277574507XXXX",
    "paymentId": "2019060811401080010018882020035XXXX",
    "paymentAmount": {
        "value": "4200",
        "currency": "SGD"
    },
    "paymentCreateTime": "2019-06-01T12:01:01+08:30",
    "paymentTime": "2019-06-01T12:01:01+08:30",
    "transactions": null
}
```

#### 常见问题解答  
##### 如何理解以下关键字段的含义？
*   _result_: API调用的结果。它仅表示**inquiryPayment** API调用的结果。订单状态应根据_paymentStatus_来确定。`SUCCESS`和`FAIL`表示最终结果，而`PROCESSING`表示交易仍在进行中。
*   _paymentAmount_: 金额验证。如果需要验证金额，可以使用此字段。
#### 我应该多久发起一次查询？
建议以2秒的间隔进行轮询查询，直到获取到最终的支付结果或接收到异步支付通知为止。

示例代码
==========

前端完整示例代码：

```swift
#import <AMSComponent/AMSComponent-Swift.h>  
// 步骤1：创建AMSEasyPayConfiguration类型。
AMSEasyPayConfiguration *componentConfig = [AMSEasyPayConfiguration new];
componentConfig.locale = @"en_US";  
// 设置showLoading为true（默认值）以使用默认加载模式。设置为false以根据onEventCallback自定义加载动画。
// 设置沙盒环境。如果不设置，将默认使用生产环境。
NSDictionary *options = @{@"showLoading": @"true", @"sandbox": @"true"};
componentConfig.options = options;  
[[AMSEasyPay shared] initConfiguration:componentConfig];  
// 设置回调以监控结账页面上的支付事件。
[AMSEasyPay shared].paymentDelegate = self;
[AMSEasyPay shared].loggerDelegate = self;  
// 步骤2：服务器调用createPaymentSession API获取paymentSessionData。
// 步骤3：创建并渲染组件。
[[AMSEasyPay shared] createComponent:paymentSessionData];  

#pragma mark - AMSPaymentProtocol
- (void)onEventCallback:(NSString *)eventCode eventResult:(AMSEventResult *)eventResult
{
    NSLog(@"eventCode%@ eventResult%@", eventCode, eventResult);
}  

#pragma mark - AMSLogProtocol
- (void)logWithName:(NSString *)name parameter:(NSDictionary<NSString *,id> *)parameter
{
    //...
}
```

请注意，以上代码是Swift语言的示例，用于展示如何在前端使用蚂蚁金服的支付组件。`onEventCallback`方法用于处理事件回调，`logWithName:parameter:`方法用于日志记录。实际使用时，需要根据具体业务逻辑进行相应的实现。
NSLog(@"名称%@，参数%@", name, parameter);
事件代码
==========

您可能会遇到两种类型的事件代码：

* 状态代码：在组件运行时生命周期中由`onEventCallback`返回。
* 错误代码：在组件初始化阶段由`onEventCallback`或`onError`返回。

| 类型 | 代码 | 描述 | 进一步行动 |
| --- | --- | --- | --- |
| 状态代码 | SDK\_START\_OF\_LOADING | 组件创建时开始显示加载动画。若配置为隐藏加载并使用自定义动画，此时可渲染自定义动画。 | 无需进一步行动。 |
| SDK\_END\_OF\_LOADING | 组件创建时加载动画结束。若配置为隐藏加载并使用自定义动画，此时可隐藏动画。 | 无需进一步行动。 |
| SDK\_CALL\_URL\_ERROR | \* 事件信息中表示以下情况之一： + 未能重定向到商家页面。 + 未能重定向到3D挑战页面。 + 调用**createPaymentSession**请求时，*paymentRedirectUrl*参数未指定或指定不正确。 在Web或WAP场景中，重定向链接通常不异常。建议您验证重定向链接。在App场景中，如果此异常频繁发生，请联系Antom技术支持以解决重定向或调用问题。 | 无需进一步行动。 |
| 错误代码 | SDK\_INTERNAL\_ERROR | SDK内部错误。 | 联系Antom技术支持。 |
| SDK\_CREATEPAYMENT\_PARAMETER\_ERROR | mountComponent方法指定的参数异常。 | 检查参数是否正确并重新初始化组件。 |
| SDK\_INIT\_PARAMETER\_ERROR | AMSEasyPay方法指定的参数异常。 | 检查参数是否正确并重新实例化SDK。 |
| SDK\_CREATECOMPONENT\_ERROR | 组件初始化异常。 | 联系Antom技术支持。 |
| SDK\_SUBMIT\_NETWORK\_ERROR | 网络原因导致接口调用失败，可能发生在提交方法提交时。 | 请尝试再次提交。 |

要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。

![图片10](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片11](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)

@2024 蚂蚁金服 [法律信息](https://global.alipay.com/docs/ac/platform/membership)

#### 这个页面有帮助吗？

#### 本页内容

[用户体验](#2Rpi7 "用户体验")  
[钱包](#GJSLV "钱包")  
[银行转账](#Ndar7 "银行转账")  
[支付流程](#S3crs "支付流程")  
[集成步骤](#QLFGi "集成步骤")  
[步骤1：创建支付会话](#zhBSk "步骤1：创建支付会话")  
[安装API库](#d3kyo "安装API库")  
[初始化请求实例](#WLui0 "初始化请求实例")  
[创建支付会话](#aQius "创建支付会话")  
[常见问题](#UGjGp "常见问题")  
[请求中可以使用中文字符吗？](#asEuc "请求中可以使用中文字符吗？")  
[如何设置支付结果通知地址？](#KQLhk "如何设置支付结果通知地址？")  
[步骤2：创建并调用SDK](#xhgER "步骤2：创建并调用SDK")  
[安装](#tK4gw "安装")  
[实例化客户端SDK](#LK85U "实例化客户端SDK")  
[调用SDK](#OXd8h "调用SDK")  
[步骤3：获取授权结果或支付结果](#Jiap6 "步骤3：获取授权结果或支付结果")  
[接收异步通知](#YWXbW "接收异步通知")  
[常见问题](#V1F5v "常见问题")  
[查询结果](#wlAb8 "查询结果")  
[常见问题](#tkpZO "常见问题")  
[示例代码](#8Ha2q "示例代码")  
[事件代码](#FZcP1 "事件代码")