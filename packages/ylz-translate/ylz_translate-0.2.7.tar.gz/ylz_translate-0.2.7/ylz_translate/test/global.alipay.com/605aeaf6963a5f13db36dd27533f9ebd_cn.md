活跃订阅 | 订阅支付 | 支付宝文档
===============

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg) ![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fsubscriptionpay_en%2Factivation)  
[返回首页](../../)

订阅支付
[概述](/docs/ac/subscriptionpay_en/overview)  
[激活订阅](/docs/ac/subscriptionpay_en/activation?pageVersion=9)  
[取消订阅或退款](/docs/ac/subscriptionpay_en/cancel_refund)  
[对账](/docs/ac/subscriptionpay_en/reconcile)  

激活订阅
===================  
2024-05-09 03:17

在订阅支付流程中，买家选择计划和支付方式，经过授权确认信息，然后被重定向到授权结果页面。在集成过程中，您需要开发订阅激活页面，该页面显示支付方式，使用授权URL将用户重定向到结账，并处理支付回调，根据订阅状态将买家重定向。

用户体验
===============

订阅支付的支付体验如下：

![图片3：激活订阅](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1693364623906-5dad7f2b-3e13-4049-892e-b60ba9e09559.jpeg)

图1. 订阅支付的用户体验

各部分功能如下：

1.  **订阅激活页面**：买家选择订阅计划和支付方式，确认激活。生成订阅订单，买家进入订阅授权流程。
2. **授权流程**: 将用户重定向到支付方式授权页面，买家在此确认信息、验证身份并完成授权。然后买家会被重定向到Antom中间页。
3. **授权结果页**: 完成授权后，买家会自动被重定向到授权结果页。

快速开始
==========

在集成过程中，您需要专注于开发订阅激活页面。此页面有以下作用：
* **显示可用支付方式**: 根据支付信息（如支付金额和买家所在地区）对支付方式排序。
* **引导用户授权**: 使用Antom提供的授权URL将买家重定向到授权页面。
* **接收支付回调（可选）**: 通过监听页面调用或使用生命周期函数接收支付回调。然后根据订阅状态将买家重定向到订阅结果页。

步骤1：获取并显示可用支付方式
--------------------------------

获取钱包名称和logo，并在页面上显示可用支付方式。

#### 获取钱包名称和钱包logo
联系Antom技术支持获取对应于每个支付方式的钱包名称和logo。

#### 过滤支付方式
在显示支付方式之前，建议不显示或禁用正在维护的支付方式，以避免订阅失败。您可以联系Antom技术支持查询支付方式的维护状态。

#### 显示支付方式
对于Alipay+支付方式，必须显示Alipay+合作伙伴的logo。您可以选择以下样式之一，确保正确使用每个支付方式的名称和logo：
步骤2：调用授权流程
-----------------------

首先，你需要获取一个授权URL，然后启动授权过程。

#### 拦截无效订单
为了避免重复订阅或订阅过期，建议买家点击或触摸“立即订阅”后，你检查订单的状态和有效期。

![图片4：订阅图片1.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715224527938-ce910a61-e22a-4cf9-8f66-a34a5f779ef7.png)

要拦截过期的订阅授权，你可以通过设置`paymentExpiryTime`参数来设定订阅过期时间。如果买家在订阅过期时间后授权，系统将返回错误。设置订阅过期时间还可以防止买家在被重定向到支付方式页面后长时间才进行授权时的重复订阅。

服务器的时间偏移也可能导致重复的订阅授权。建议你在收到订阅和支付状态的异步通知时检查状态。如果发生重复授权，使用[**cancel**](https://global.alipay.com/docs/ac/ams/cancel_sub) API来取消订单。

#### 获取授权URL
买家点击或触摸“立即订阅”后，你的客户端向服务器请求授权URL，然后你的服务器调用[**create**](https://global.alipay.com/docs/ac/ams/create_sub) API获取授权URL并将其返回给客户端。在发送请求后等待获取授权URL期间，应禁用“立即订阅”按钮，以防用户触发重复操作。
在请求授权URL的过程中，由于网络问题，客户端和服务器端的请求都可能失败。建议在客户端的HTTP请求中设置超时，以防止买家等待过久。如果无法获取授权URL，应允许买家重新发起订阅授权。

订阅授权请求的关键字段如下：

| **字段名** | **描述** |
| --- | --- |
| *subscriptionRequestId* | 商家为识别订阅请求分配的唯一ID。 |
| *env* | 根据客户端类型指定*terminalType*：<br>**Web**: 将*terminalType*设为`WEB`。<br>**WAP**: 将*terminalType*设为`WAP`，并指定*osType*。<br>**App**: 将*terminalType*设为`APP`，并指定*osType*。 |
| *subscriptionRedirectUrl* | 用户授权订阅后重定向到的商家页面URL：<br>**Web**: 传入H5 URL。<br>**WAP**: 传入H5 URL。<br>**App**: 传入深度链接URL。 |
| *subscriptionNotifyUrl* | 用于接收订阅结果通知的URL。指定为HTTPS URL。 |
| *paymentNotifyUrl* | 用于接收每个订阅周期支付结果通知的URL。指定为HTTPS URL。 |

#### 进行授权流程
授权过程的用户体验如下：

| image.png | image.png |
| --- | --- |

#### 重定向到结果页面
在**create** API中，可以通过_subscriptionRedirectUrl_参数设置授权URL。根据以下的_terminalType_值，建议传入H5 URL或深度链接：

| terminalType | subscriptionRedirectUrl |
| --- | --- |
| WEB | 传入H5 URL。 |
| WAP | 传入H5 URL。 |
| 应用 | 传递深度链接URL。 |
| --- | --- |
| 当买家完成授权后，他们首先会被重定向到Antom中间页面，然后再被重定向到商家页面。 |
| ![订阅图片3.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1715224557113-a5a672e2-6e85-4995-8dbd-eac2f2e6d761.png) |
| 完成授权后，Antom会向`subscriptionNotifyUrl`发送异步通知，告知授权是否成功。 |
| 当您收到Antom的通知时，必须按照[**notifySubscription**](https://global.alipay.com/docs/ac/ams/notify_sub)的代码示例返回响应。如果您未向Antom返回响应，或者由于网络问题Antom未接收到响应，Antom会在24小时内自动重试发送异步通知，最多八次，直到收到正确的响应。发送间隔为：0s，2分钟，10分钟，10分钟，1小时，2小时，6小时和15小时。 |

**订阅场景示例**
------------------

特别注意与订阅周期和订阅开始时间相关的参数，这些参数定义了为买家提供的订阅计划。

**关键参数**
------------

您可以通过在**create**接口中配置以下参数来管理订阅周期和循环支付逻辑：

| **字段名** | **描述** |
| --- | --- |
| *subscriptionStartTime* | 订阅生效的日期和时间。可以设置为过去的时间，但不能早于订阅请求发起前的一个周期。 |
| *subscriptionEndTime* | 订阅结束的日期和时间。 |
| *paymentAmount* | 每个订阅周期向用户收取的支付金额。 |
| *periodRule.periodType* | 订阅周期类型。有效值为：`YEAR`，`MONTH`，`WEEK`或`DAY`。 |
`periodRule.periodCount` | 订阅周期内的周期类型数量。例如，如果`periodType`的值为`MONTH`，而`periodCount`的值为3，这意味着订阅周期为三个月。
`trials.trialStartPeriod` | 试用期的起始订阅周期。
`trials.trialAmount` | 每个订阅试用周期的折扣金额。
`trials.trialEndPeriod` | 试用期的结束订阅周期。如果此参数留空，默认值与`trialStartPeriod`的值相同。

`subscriptionStartTime` 参数设置订阅付款的开始时间，而`periodRule`参数定义订阅的计费间隔，从而定义计费周期。

假设`subscriptionStartTime`为2023-08-01T08:00:00+8:00，`periodRule.periodType`为`MONTH`，`periodRule.periodCount`为1，计费周期为一个月，重复付款详情如下：

| **周期编号** | **订阅开始时间** | **扣款时间** | **扣款失败时** |
| --- | --- | --- | --- |
| 1 | 2023-08-01T08:00:00+8:00 | 授权完成时间 | 授权失败 |
| 2 | 2023-09-01T08:00:00+8:00 | 2023-08-31T08:00:00+8:00至2023-09-01T08:00:00+8:00 | 无影响 |
| 3 | 2023-10-01T08:00:00+8:00 | 2023-09-30T08:00:00+8:00至2023-10-01T08:00:00+8:00 | 无影响 |
| 4 | 2023-11-01T08:00:00+8:00 | 2023-10-31T08:00:00+8:00至2023-11-01T08:00:00+8:00 | 无影响 |
| ... | ... | ... |  |

如果第一个订阅周期的扣款成功，Antom会在每个后续周期开始前24小时开始尝试扣款，直到扣款成功或24小时过去。
如果在第二个订阅周期收到扣款失败的通知，您不能自行发起这个周期的扣款请求。您需要调用取消接口来取消买家后续的订阅服务。

首次支付总是在买家完成订阅授权时执行，无论`subscriptionStartTime`是在订阅授权完成之前还是之后。后续的支付按照计费周期计划进行，蚂蚁金服会在每个周期开始前24小时发起扣款。如果扣款失败，蚂蚁金服会连续尝试24小时，直到支付成功或24小时尝试期结束。

扣款成功或失败后，会通过异步通知的方式将支付状态通知给您，通知地址可以在蚂蚁金服控制台或创建请求中的`paymentNotificationUrl`参数中指定。

**注意：**关于扣款失败：

*   如果首次扣款失败：订阅授权将失败，订阅不会生效。
*   如果在后续的支付周期中扣款失败：
    *   订阅状态不会改变，订阅仍然有效。
    *   对于特定周期的失败扣款，您不能尝试重新扣款。但是，当前周期的扣款失败不会影响后续周期的扣款。

**示例**
------------

通过指定相应的参数，您可以为多种订阅场景使用订阅支付服务。以下示例展示了如何在创建API中为几个典型的订阅场景指定参数。

#### 常规订阅

成功订阅授权后，立即进行扣款。随后，每隔一个周期进行扣款。

```json
{
  "...": "...",
  "paymentAmount": {
    "currency": "PHP",
    "value": "1100"
  },
  "period": {
    "periodCount": 1,
  }
}
```

这个示例中，`paymentAmount`指定了支付金额（货币为菲律宾比索PHP，金额为1100），`periodCount`为1，意味着按照设定的周期进行扣款。其他参数未显示，但可能包括订阅的类型、周期频率、开始时间等。
#### 期数类型：月度
```json
{
  "periodType": "MONTH",
  "subscriptionStartTime": "2023-08-01T08:00:00+8:00"
}
```

| **期数** | **订阅开始时间** | **付款金额** |
| --- | --- | --- |
| **1** | **2023-08-01T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| **2** | **2023-09-08T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| **3** | **2023-10-08T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| **4** | **2023-11-08T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| .... | | |  

#### 预售
订阅授权成功后，立即扣款，但服务将在未来某个时间生效，后续每期都会扣款。

```json
{
  "...": "...",
  "paymentAmount": {
    "currency": "PHP",
    "value": "1100"
  },
  "period": {
    "periodCount": 1,
    "periodType": "MONTH"
  },
  "subscriptionStartTime": "2023-08-08T08:00:00+8:00"
}
```

| **期数** | **订阅开始时间** | **付款金额** |
| --- | --- | --- |
| **1** | **2023-08-01T08:00:00+8:00** | **1100PHP** |
| 1周 | | |
| `subscriptionStartTime` | **2023-08-08T08:00:00+8:00** | - |
| 1个月 | | |
| **2** | **2023-09-08T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| **3** | **2023-10-08T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| **4** | **2023-11-08T08:00:00+8:00** | **1100PHP** |
| 1个月 | | |
| .... | | |  

#### 订阅促销
订阅授权成功后立即扣款，之后每月扣款。前两期的订阅费用减半，从第三期开始恢复正常费用。

```json
{
  "...": "...",
  "paymentAmount": {
    "currency": "PHP",
    "value": "1100"
  },
  "period": {
    "periodCount": 1,
    "periodType": "MONTH"
  },
  "subscriptionStartTime": "2023-08-01T08:00:00+8:00",
  "trials": [
    {
      "trialStartPeriod": 1,
      "trialAmount": {
        "currency": "PHP",
        "value": "550"
      },
      "trialEndPeriod": 2
    }
  ]
}
```
| **期数** | **订阅开始时间** | **付款金额** |
| --- | --- | --- |
| **1**`subscriptionStartTime` | **2023年8月1日 08:00:00 +8:00** | **550PHP** |
| 1个月 | | |
| **2** | **2023年9月8日 08:00:00 +8:00** | **550PHP** |
| 1个月 | | |
| **3** | **2023年10月8日 08:00:00 +8:00** | **1100PHP** |
| 1个月 | | |
| **4** | **2023年11月8日 08:00:00 +8:00** | **1100PHP** |
| 1个月 | | |
| .... | | |  
#### 7天试用期  
订阅生效后立即开始服务，但首次扣款将在一周后进行，之后每月扣款一次。  
复制  
```json
{
  "...": "...",
  "paymentAmount": {
    "currency": "PHP",
    "value": "1100"
  },
  "period": {
    "periodCount": 1,
    "periodType": "MONTH"
  },
  "subscriptionStartTime": "2023-07-08T08:00:00+8:00",
  "trials": [
    {
      "trialStartPeriod": 1,
      "trialAmount": {
        "currency": "PHP",
        "value": "0"
      },
      "trialEndPeriod": 1
    }
  ]
}
```  
| **期数** | **订阅开始时间** | **付款金额** |
| --- | --- | --- |
| `subscriptionStartTime` | **2023年8月8日 08:00:00 +8:00** | - |
| 1个月（不包括第一周） | | |
| 1 | **2023年8月8日 08:00:00 +8:00** | **0PHP** |
| 1周 | | |
| **2** | **2023年9月8日 08:00:00 +8:00** | **1100PHP** |
| 1个月 | | |
| **3** | **2023年10月8日 08:00:00 +8:00** | **1100PHP** |
| 1个月 | | |
| **4** | **2023年11月8日 08:00:00 +8:00** | **1100PHP** |
| 1个月 | | |
| .... | | |  
要查看文档的最新更新，请访问 [版本说明](https://global.alipay.com/docs/releasenotes)。  
![图片10](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片11](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  
#### 这个页面是否有帮助？  
#### 在此页面上  
[用户体验](#mXFW1 "用户体验")  
[快速开始](#4FTCv "快速开始")
**步骤1：获取并展示可用支付方式**

**获取钱包名称和钱包图标**
获取用户可以使用的支付方式时，通常需要展示钱包的名称和图标，以便用户识别。

**过滤支付方式**
根据业务需求，可能需要过滤掉某些支付方式，例如根据用户偏好或特定条件。

**展示支付方式**
将过滤后的支付方式以用户友好的方式展示，例如通过列表或按钮。

**步骤2：启动授权过程**

**拦截无效订单**
在开始授权之前，确保订单有效，防止处理无效或错误的请求。

**获取授权URL**
调用相关API以获取用户授权支付的URL。

**进行授权过程**
引导用户通过获取的URL进行支付授权。

**重定向到结果页面**
用户完成授权后，将他们重定向到你的结果页面，显示支付状态。

**订阅场景示例**

**关键参数**
在订阅场景中，需要关注的关键参数可能包括订阅类型、价格、周期等。

**示例**

**普通订阅**
提供标准的周期性订阅服务，如每月或每年付费。

**预售**
允许用户提前购买即将推出的产品或服务。

**订阅促销**
提供限时的订阅优惠，鼓励用户尽快订阅。

**七天试用**
提供免费的七天试用期，让用户在购买前体验产品或服务。