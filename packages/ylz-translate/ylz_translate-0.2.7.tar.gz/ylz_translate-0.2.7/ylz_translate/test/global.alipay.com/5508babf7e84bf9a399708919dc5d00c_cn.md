最佳实践 | 自动扣款 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fagreementpayment%2Fautodebit_bp)  
[返回首页](../../)

自动扣款
[Introduction](/docs/ac/agreementpayment/intro)  
[开始使用](/docs/ac/agreementpayment/getting_started)  
[授权与支付](/docs/ac/agreementpayment/payment)  
[支付后服务](/docs/ac/agreementpayment/post_payment)  
[报表与对账](/docs/ac/agreementpayment/report)  
[最佳实践](/docs/ac/agreementpayment/autodebit_bp)  
[幂等性](/docs/ac/agreementpayment/api_idemptcy)  
开发
[API 列表](/docs/ac/agreementpayment/apis)  
参考
[版本说明](/docs/ac/agreementpayment/releasenotes)  
最佳实践
==================

2021-12-28 01:44

使用自动扣款产品进行收款包括四个步骤：授权、自动扣款、退款和结算。本节提供所有参与方成功集成自动扣款的最佳实践。

字段与定义
==================

*_terminalType_:* 客户使用的商家终端类型。可能的值包括：
*   `WEB`: 表示终端是PC
*   `WAP`: 表示终端是WAP页面
*   `APP`: 表示终端是移动应用

*_osType_:* 商家移动操作系统的类型，包括iOS或Android

*_accessToken_:* 用于客户授权和从特定钱包进行自动扣款

*_refreshToken_:* 当accessToken即将过期时，用于刷新accessToken
_accessTokenExpiryTime_: 访问令牌的过期时间  
_refreshTokenExpiryTime_: 刷新令牌的过期时间  
_authState_: 每个客户授权的标识，用于防止篡改  
_authCode_: 用于获取访问令牌，客户授权成功后生成并返回给商家  

整体流程
==========

集成过程可以通过以下图形来说明。在授权阶段，建议创建一个包含每个账户生成的访问令牌数据的表格。当需要刷新或失效访问令牌时，表格将相应更新。在支付和退款阶段，建议创建一个包含交易数据的表格，当支付或退款操作进行时，表格会相应更新。

授权完成后，只要访问令牌有效，就可以进行自动扣款支付，无需为每次支付重新发起授权。

![图3：一般流程.png](https://yuque.antfin.com/images/lark/0/2021/png/134374/1615355994217-3473d47e-20f6-42b7-bee1-f50fde3d040f.png)

图1. 自动扣款集成的整体流程

授权
==========

在授权过程中，商家通过调用[**consult**](https://global.alipay.com/docs/ac/ams/authconsult)和[**applyToken**](https://global.alipay.com/docs/ac/ams/accesstokenapp)接口获取用户的访问令牌。访问令牌允许商家在支付阶段直接从用户账户扣款，用户无需进行额外操作。

授权体验
------------------------
授权流程
----------------
商家可以通过PC网站、WAP页面或移动应用程序发起授权过程。这个视频展示了这些终端的授权体验。

关于访问令牌
------------------
通过[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult)和[**申请令牌**](https://global.alipay.com/docs/ac/ams/accesstokenapp)接口创建的访问令牌，其有效期因钱包和用户的不同而异。在访问令牌过期之前，商家可以使用刷新令牌延长其有效期，以防止因访问令牌失效导致的交易失败。

建议维护一个包含访问令牌生命周期信息的表格，定期检索即将过期的访问令牌，并使用刷新令牌更新访问令牌。

当用户想要解绑访问令牌时，撤销令牌的失效过程只能由商家发起，用户不能直接从钱包中解绑。因此，商家必须集成[**撤销**](https://global.alipay.com/docs/ac/ams/authrevocation)接口。

以下部分提供了更多关于创建和管理访问令牌的信息：
*   [如何创建访问令牌](#r2mPH)
*   [如何刷新访问令牌](#2ZKcc)
*   [如何失效访问令牌](#nEjNj)
### 访问令牌创建  
创建访问令牌的步骤：  
1. 调用[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult)接口，获取钱包的授权地址（_authUrl_）。
2. 商户使用_authUrl_引导用户进入钱包授权页面。
3. 用户通过验证后，钱包会重定向到商户URL（_authRedirectUrl_），带上_authcode_和_authstate_字段。同时，支付宝会向商户发送授权通知，其中也包含_authcode_和_authstate_字段。
4. 商户检查URL中_authstate_字段的值是否与[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult)请求中的值一致。
5. 商户在[**申请令牌**](https://global.alipay.com/docs/ac/ams/accesstokenapp)请求中使用_authcode_字段，以获取访问令牌和刷新令牌。  

**注意事项**：  
* 在上述步骤中，_authUrl_和_authcode_只能使用一次。如果授权过程失败，商户需要重新调用接口，并在请求中更新_authState_字段的值。例如，可以将之前的_authState_值后面附加数字，如authstatexxxx\_1。
* 商户有两种方式获取_authcode_。一种是用户验证后被重定向到商户URL，URL中包含_authcode_。另一种是支付宝向商户发送授权通知，其中也包含_authcode_。建议商户根据授权通知的结果调用_applytoken_接口，因为重定向可能失败。因此，商户必须集成[notifyAuthorization](https://global.alipay.com/docs/ac/ams/notifyauth)接口。
*   用于接收通知的地址可以在支付宝开发者中心配置。请前往集成设置 > 通知URL > alipay.ams.authorizations.notify > 编辑通知URL进行设置。详细信息见下图所示。
    ![图片4: image](https://yuque.antfin.com/images/lark/0/2021/png/303011/1637829351715-a00348fd-f59f-466b-9d57-8dc12899a878.png)
    图2. 配置通知URL
    下图是创建访问令牌的总体流程。
    ![图片5: 图片1.png](https://cdn.nlark.com/yuque/0/2021/png/12884741/1638180255730-d498faf8-bbd6-4b2c-b252-3e0cd7640669.png)
    图3. 创建访问令牌的总体流程
1.  **调用** **[咨询](https://global.alipay.com/docs/ac/ams/authconsult)** **接口**
    在收到用户绑定钱包的请求后，商家需要通过调用**[咨询](https://global.alipay.com/docs/ac/ams/authconsult)**接口，使用以下请求URL获取钱包的授权地址：
    *   沙箱端点: /ams/sandbox/api/v1/authorizations/consult
    *   生产端点: /ams/api/v1/authorizations/consult
    ![图片6: 图2.png](https://cdn.nlark.com/yuque/0/2021/png/561635/1619059520274-a751bad6-0e22-4c2f-8014-008595aee346.png)
    图4. 调用咨询接口的过程
    请求中需要正确配置以下字段：
    *   _request.__authRedirectUrl_: 这表示钱包授权完成后重定向到的商家地址。在自动扣款中，_authcode_ 字段包含在商家URL中。因此，必须确保该地址可用于重定向到商家端。下表显示了不同终端类型的商家所使用的地址：

        |商家的终端Type| 直接集成支付宝的商家| 收单机构|
        |---|---|---|

        | | |
| WEB | 商家PC网站的HTTPS地址 | PC网站的HTTPS地址 |
| --- | --- | --- |
| WAP | 商家移动网页（WAP页面）的HTTPS地址 | WAP页面的HTTPS地址 |
| APP | 可用于重定向到商家应用的URL方案 | 用于重定向到商家网站的WAP地址 |
**表1. 不同终端类型的地址**  
**注意：**  
1. 由于安全原因，地址必须是HTTPS地址，而不是HTTP地址。
2. 对于APP类型的终端，收单方使用一个可以重定向到URL方案的WAP地址，然后URL方案再重定向到商家网站。这样，调用**[咨询](https://global.alipay.com/docs/ac/ams/authconsult)**接口时，收单方无需为不同的子商家提供不同的URL方案。
3. `_request.terminalType`和`_request.osType`：这些代表用户发起请求时的商家终端类型。请注意，这些字段并不表示商家想要触发的钱包终端类型。字段详细信息如下：  
| **terminalType** | **osType** |
| --- | --- |
| WEB | Null |
| WAP | IOS或ANDROID |
| APP | IOS或ANDROID |  
**表2. 终端类型和操作系统类型的详细信息**  
**返回值处理：**  
1. 如果没有返回响应，必须使用与前一次请求相同的字段再次调用接口。
2. 如果收到响应，`response.result`表示授权状态的咨询结果：
   - 当`resultStatus`为`U`时，不改变`authState`的值再次调用接口。
   - 当`resultStatus`为`F`时，根据`resultCode`的值检查失败原因。
* 当 _resultStatus_ 为 `S` 时，响应中会返回 _authUrl_。商家页面需要重定向到由 _authUrl_ 指定的钱包授权页面地址。
**注意**：
* `_response.authUrl_` 是钱包授权页面的地址，只有当 _resultStatus_ 为 `S` 时，此字段才会在响应中返回。不同终端类型的返回地址类型不同：
| **终端类型** | **authUrl** |
| --- | --- |
| WEB | 个人电脑浏览器的地址 |
| WAP | 移动网页（WAP 页面）的地址 |
| APP | 可以触发钱包应用的地址 |

**表 3. 商家不同终端类型的 authUrl**

2. **重定向到授权地址**
授权地址由 **[咨询](https://global.alipay.com/docs/ac/ams/authconsult)** 接口响应中的 _authUrl_ 字段返回。商家使用 _authUrl_ 的值进入钱包的授权页面。在一次授权流程中，_authUrl_ 只能使用一次。如果授权失败，需要重新发起 **[咨询](https://global.alipay.com/docs/ac/ams/authconsult)** 请求以获取新的 _authUrl_。不同商家终端类型重定向到 _authUrl_ 地址的方式如下：
| **商家终端类型** | **如何打开 authUrl** |
| --- | --- |
| WEB | 在浏览器中打开 |
| WAP | 在浏览器中打开 |
| APP-IOS | 使用 openURL |
| APP-ANDROID | 使用 startActivity |

**表 4. 不同终端类型打开 authUrl 的方式**

有关如何打开 _authUrl_ 地址的更多信息，请参阅 [与钱包的客户端集成](https://global.alipay.com/docs/ac/agreementpayment/clientsideint)。

**注意事项**：
*   对于终端类应用，相应的URL需要能够打开数字钱包应用。因此，商家需要通过系统来打开URL，不要在应用内嵌的WebView、容器或中间页中打开链接。
*   想了解更多数字钱包支持的支付终端信息，请参阅[与钱包的客户端集成](https://global.alipay.com/docs/ac/agreementpayment/clientsideint)。
3.  **重定向到商家URL**  
在钱包中完成认证后，用户需要被重定向到商家URL（_authRedirectUrl_），同时带上_authcode_和_authstate_字段。支付宝同时会向商家发送授权通知，其中也包含_authcode_和_authstate_字段。商家仅需使用_authcode_和_authstate_字段：
    1.  检查URL中_authstate_字段的值是否与[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult)请求中的值一致。
    2.  检查_authCode_字段是否有值。如果_authCode_字段为空，表示授权失败。如果_authCode_字段非空，其值将用于调用**[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)**接口。

如果用户未启动认证流程或认证流程失败，用户将不会被重定向到商家URL，或者重定向过程中不包含authCode。因此，商家无法获取_authCode_字段。如果商家在一定时间内（建议为15分钟）未获取到_authCode_，则需要放弃授权流程。如果用户需要重新绑定，商家应再次发起[**咨询**](https://global.alipay.com/docs/ac/ams/authconsult)接口。
从钱包页面到商户页面的授权流程针对不同终端类型有不同的重定向路径。商户页面由**[咨询](https://global.alipay.com/docs/ac/ams/authconsult)**接口的`_authRedirectUrl`字段指定。

| **终端类型** | **重定向到商户** |
| --- | --- |
| WEB | 从二维码扫描页面或授权页面到商户网站 |
| WAP | 从钱包的授权页面到商户的移动网页（WAP页面） |
| APP | * 已安装钱包应用的用户：从钱包应用启动商户应用 * 未安装钱包应用的用户：从移动浏览器启动商户应用 |  

表5. 不同终端类型重定向到商户页面的方式

4. 授权异步通知  
在商户集成[notifyAuthorization](https://global.alipay.com/docs/ac/ams/notifyauth)接口后，支付宝会根据以下规则将用户的授权结果发送给商户：
* 授权成功时，立即发送异步通知给商户。
* 如果授权令牌被撤销，也会立即发送异步通知给商户。

以下是一个支付宝发送的成功授权结果示例：
```json
{
"authorizationNotifyType ": "AUTHCODE_CREATED ",
"authState": "489767958497 ",
"authCode": "28100113_1631148338197000019ba74",
"resultInfo ": {
"resultCode ": "SUCCESS ",
"resultMessage ": "success ",
"resultStatus ": "S "
}
}
```
收到异步通知后，商户需要立即返回SUCCESS给支付宝，无需数字签名。此消息表示成功接收了授权通知。代码示例如下：
```json
{
"result":{
"resultCode":"SUCCESS",
"resultStatus":"S",
"resultMessage":"success"
}
}
```

请注意，以上翻译已尽可能简洁明了，同时保留了原始文档的结构和信息。
如果商家未对支付宝的异步通知发送响应，或者由于网络原因商家的响应未能成功送达支付宝，支付宝将在24小时内最多重试8次，直到收到正确的响应为止。重试间隔如下：
0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时，15小时

在[notifyAuthorization](https://global.alipay.com/docs/ac/ams/notifyauth)请求中，需要正确理解以下字段：
*   _authorizationNotifyType_：授权成功时，此字段的值为`AUTHCODE_CREATED`。如果授权令牌被撤销，此字段的值为`TOKEN_CANCELED`。
*   _authState_：此字段由商家生成，代表请求。应使用此字段进行验证。此字段的值需要与[consult](https://global.alipay.com/docs/ac/ams/authconsult)请求中的_authState_字段相同。
*   _authCode_：此字段可用于在[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)请求中获取访问令牌和刷新令牌。

5.  **调用[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)接口**
获取_authCode_值后，后台系统应立即调用**[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)**接口，以防_authCode_过期。商家需要在获取authCode后1分钟内调用**[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)**接口，使用以下请求URL：
*   沙箱端点：/ams/sandbox/api/v1/authorizations/applyToken
*   生产端点：/ams/api/v1/authorizations/applyToken

![图3.png](https://cdn.nlark.com/yuque/0/2021/png/561635/1619059696814-ee03de1c-39e0-4405-8537-8aa13eff8237.png)
图5. 调用applyToken接口获取访问令牌的过程  
**返回值处理：**  
1. 如果没有收到响应，必须使用与前一次请求相同的字段再次调用接口。
2. 如果收到响应，针对以下情况采取相应行动：  
   - _response.result_ 表示调用 **[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)** 接口的结果：  
     - 当 _result.resultStatus_ 为 `S` 时，授权成功。
     - 当 _result.resultStatus_ 为 `U` 时，使用与前一次请求相同的字段再次调用接口。
     - 当 _result.resultStatus_ 为 `F` 时，商家需要根据 _resultCode_ 采取相应行动。由于authCode只能使用一次，商家需要再次调用 [**consult**](https://global.alipay.com/docs/ac/ams/authconsult) 接口重新发起授权流程。
   - _response.accessToken_ 是授权完成后返回的访问令牌，只有当 _result.resultStatus_ 为 `S` 时才返回。
   - _response.accessTokenExpiryTime_ 是访问令牌的过期时间。如果商家在访问令牌过期后使用它发起支付，支付将会失败。
   - _response.refreshToken_ 用于在accessToken过期前刷新其有效期。
   - _response.refreshTokenExpiryTime_ 是刷新令牌的过期时间。通常，_refreshTokenExpiryTime_ 应大于 _accessTokenExpiryTime_ 以确保 _refreshToken_ 可用。如果商家在刷新令牌过期后尝试刷新访问令牌的有效期，不能保证每个钱包都能成功刷新。
### 访问令牌刷新  
出于风险控制要求，不同国家的数字钱包的访问令牌有效期各不相同，最短有效期为一年。以下是Alipay+ MPP钱包的访问令牌有效期：

| **钱包** | **访问令牌有效期** | **可刷新令牌？** | **applyToken 接口响应字段** |
| --- | --- | --- | --- |
| Gcash | 2年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| Dana | 10年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| TNG | 2年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| TrueMoney | 2年 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| AlipayHK | 至2038年1月1日 | 是 | accessToken, accessTokenExpiryTime, refreshToken, refreshTokenExpiryTime |
| Kakaopay | 至2120年8月25日 | 否 | accessToken, accessTokenExpiryTime |

表6. 不同钱包的访问令牌有效期

商家需要在访问令牌过期前刷新它。建议至少在访问令牌到期前10天进行刷新，以便支付宝技术支持团队有足够的时间采取相应措施。因此，使用以下机制来确定启动访问令牌刷新过程的时间：

当当前日期距离`accessTokenExpiryTime`指定的日期少于10天时，调用**[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)**接口来刷新访问令牌的有效期，请求URL如下：

* 沙盒端点：/ams/sandbox/api/v1/authorizations/applyToken
* 生产端点：/ams/api/v1/authorizations/applyToken
对于具有长期有效访问令牌的数字钱包，如KakaoPay，相同的规则适用。因此，**[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)** 接口将不会在预设日期之前被调用。  
![图4.png](https://cdn.nlark.com/yuque/0/2021/png/561635/1619059851847-ad719577-87bc-4485-ac66-398260e5d422.png)  
图6. 刷新访问令牌的过程  
在请求中需要正确配置以下字段：  
*   _grantType_: 在令牌刷新过程中，该值应为 `REFRESH_TOKEN`。
*   _refreshToken_: 这是一个必需字段。该字段的值也是当调用 **[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)** 接口创建访问令牌时，响应中的 _refreshToken_ 值。使用 refreshToken 发起请求时，确保在 accessToken 过期之前发起刷新令牌的调用。  
**返回值处理：**  
*   如果没有返回响应，您必须使用与前一次请求相同的字段再次调用接口。
*   如果收到响应，针对每种情况采取以下行动：  
*   _response.result_ 表示调用 **[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)** 接口的结果：  
    *   当 _result.resultStatus_ 为 `S` 时，访问令牌的有效期成功刷新。
    *   当 _result.resultStatus_ 为 `U` 时，商家需要使用与前一次请求相同的字段再次调用接口。
    *   当 _result.resultStatus_ 为 `F` 时，商家需要根据 _resultCode_ 采取相应的行动。  
*   _response.accessToken_ 是刷新过程完成后返回的访问令牌，仅当 _result.resultStatus_ 为 `S` 时返回。在自动扣款支付过程中使用此值。
*   _response.accessTokenExpiryTime_ 是刷新流程完成后访问令牌的过期时间。
*   _response.refreshToken_ 用于在访问令牌过期前延长其有效期，只有当 _result.resultStatus_ 为 `S` 时才会返回。
**注意事项**:
*   由于某些钱包在使用 `REFRESH_TOKEN` 类型的 **[applyToken](https://global.alipay.com/docs/ac/ams/accesstokenapp)** 接口后可能会更新 _refreshToken_ 的值，商家需要使用最新的 _refreshToken_ 来延长访问令牌的有效期。
*   访问令牌有效期较长的钱包（如 Kakaopay）不会提供 _refreshToken_ 和 _refreshTokenExpiryTime_ 字段。
### 访问令牌失效  
要启动访问令牌撤销过程，有以下两种方式：  
1. 用户在钱包中撤销访问令牌以发起授权取消。
2. 商家调用撤销接口来发起授权取消。  
因此，商家需要集成[**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation)接口，并使用以下请求URL为用户启动访问令牌撤销过程：  
* 沙箱端点：/ams/sandbox/api/v1/authorizations/revoke
* 生产端点：/ams/api/v1/authorizations/revoke  
![图5.png](https://cdn.nlark.com/yuque/0/2021/png/561635/1619060022175-a458c3a6-4b47-4ea4-abea-8a72e3a1dc5f.png)  
图7. 访问令牌失效的过程  
**授权取消通知**  
当用户在钱包中撤销访问令牌后，支付宝会向商家发送授权取消通知。以下示例显示了一个已取消的授权结果：  
```json
{
"authorizationNotifyType": "TOKEN_CANCELED",
"accessToken": "28100103_20215703001538122119",
"resultInfo": {
"resultCode": "SUCCESS",
"resultMessage": "success",
"resultStatus": "S"
}
}
```
收到通知后，商家需要立即向支付宝返回SUCCESS。不需要数字签名。此消息表示成功接收了授权取消通知。代码示例如下：  
```json
{
"result": {
"resultCode": "SUCCESS",
"resultStatus": "S",
"resultMessage": "success"
}
}
```
有关授权取消通知的更多信息，请参阅notifyAuthorization API的详细信息。  
**返回值处理：**  
1. 如果没有返回响应，必须使用与前次请求相同的字段再次调用接口。
2. 如果收到响应，针对每种情况采取以下行动：
响应结果表示调用[**revoke**](https://global.alipay.com/docs/ac/ams/authrevocation)接口的结果：

*   当`result.resultStatus`为`S`时，撤销成功。
*   当`result.resultStatus`为`U`时，商家需要使用与前次请求相同的字段再次调用接口。
*   当`result.resultStatus`为`F`时，商家需要根据`resultCode`采取相应的行动。

**注意**：

如果撤销过程成功，访问令牌将失效。如果继续使用该访问令牌进行自动扣款支付，支付将会失败。

自动扣款支付
------------

在用户完成授权后，商家可以直接使用访问令牌发起自动扣款支付，无需为每次支付重新进行授权流程。对于自动扣款支付，需要集成[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement)、[**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online)、[**notifyPayment**](https://global.alipay.com/docs/ac/ams/paymentrn_online)和[**cancel**](https://global.alipay.com/docs/ac/ams/paymentc_online)接口。

![图片10: 支付流程.png](https://cdn.nlark.com/yuque/0/2021/png/12884741/1634625827449-3dd499ff-b21d-4912-bb4c-cbc8bc87a92e.png)

图8. 支付、查询和取消流程的启动过程

1.  用户选择钱包发起支付。商家客户端获取用户信息、订单金额和选择的钱包，然后调用商家服务器上的接口下单。（步骤1）
2.  商家服务器调用支付宝[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement)接口。（步骤2）
3.  支付宝返回支付结果。（步骤4）
*   如果 _**result.resultStatus**_ 的值为 `**S**` 或 `**F**`，商家在接收到异步通知时无需调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口或更新订单状态。（步骤5）
*   如果 _**result.resultStatus**_ 的值为 `**U**`，商家在接收到异步通知时需要更新订单状态，或调用 [**inquiryPayment**](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口以获取最终的支付结果。（步骤5）
*   商家服务器通过接收 [notifyPayment](https://global.alipay.com/docs/ac/ams/paymentrn_online) 的通知并主动调用 [inquiryPayment](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口来获取支付结果。（步骤6）
*   如果商家在获取最终支付结果（SUCCESS 或 FAIL）之前希望放弃交易，需要调用 [cancel](https://global.alipay.com/docs/ac/ams/paymentc_online) 接口。如果交易已成功支付但商家仍希望放弃，也需要调用 [cancel](https://global.alipay.com/docs/ac/ams/paymentc_online) 接口。通过调用 [cancel](https://global.alipay.com/docs/ac/ams/paymentc_online) 接口，商家和用户的支付状态将保持一致。（步骤8）
*   商家更新内部订单状态并向用户展示支付结果。（步骤10）
**支付结果查询**
为了获取支付结果，商家需要监听异步通知，或者主动调用 [查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口来获取支付状态。尽管异步通知有重试机制，但用户成功完成支付后，由于网络问题可能会收不到通知。因此，需要通过 [查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口主动查询支付结果。

**支付超时时间**

对于自动扣款产品，支付宝的支付超时时间为1分钟。商家可以通过轮询的方式调用 [查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口来获取最终的支付结果，轮询的时间间隔需要大于1分钟。

**最终支付结果**

在 [查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口的响应中，以下状态表示最终的支付结果：

*   `SUCCESS`: 支付成功。
*   `FAIL`: 支付失败。
*   `CANCELLED`: 支付已取消。

除了上述最终支付结果，响应还可能是中间状态：

*   `PROCESSING`: 支付处理中。如果返回此结果，商家需要继续调用 [查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online) 接口，直到获取到最终支付结果（SUCCESS、FAIL 或 CANCELLED）。

**交易取消**

对于有特定交易关闭时间的支付场景，例如限时抢购、酒店预订或机票购买，遵循以下规则以确保商家和用户之间的支付结果一致性：

当以下条件全部满足时：

*   商家未收到通知。
*   [查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online)接口没有返回最终的支付结果。
*   商家需要在支付宝支付超时时间（1分钟）前主动关闭交易。
    *   需要调用[取消](https://global.alipay.com/docs/ac/ams/paymentc_online)接口来取消交易，以避免商家和用户之间的支付结果不一致。只要商家发起取消请求，支付宝将确保交易会被取消或退款。通过调用[取消](https://global.alipay.com/docs/ac/ams/paymentc_online)接口，如果用户未完成支付，交易将被取消；如果用户已完成支付，交易将被退款。

调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement)接口
--------------------------------------------------------------------------------

调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_agreement)接口来发起自动扣款，请求URL如下：

*   沙箱环境端点：/ams/sandbox/api/v1/payments/pay
*   生产环境端点：/ams/api/v1/payments/pay

请求中需要正确配置以下字段：

*   _request.__paymentMethod.paymentMethodId_：表示用户完成授权后获取的访问令牌。

**返回值处理：**

*   如果没有返回响应，使用与前一次请求相同的字段再次调用接口。
*   如果收到响应，针对以下情况采取相应行动：

    *   _response.result.resultStatus_：表示支付结果：
        *   `S`：表示支付成功。
        *   `F`：表示支付失败。有关失败的具体原因，请查看_resultCode_。
*   `U`: 表示支付正在进行中。在这种情况下，需要调用[**查询支付**](https://global.alipay.com/docs/ac/ams/paymentri_online)接口，直到支付状态为`SUCCESS`、`FAIL`或`CANCELLED`，或直到收到异步通知。
*   _response.paymentAmount_: 表示支付金额，可用于对账。
*   _response.paymentCreateTime_: 表示支付发起的时间。
*   _response.paymentTime_: 表示支付完成的时间。如果支付失败，此字段不会返回。

处理支付结果
----------------------
为了获取准确的支付结果，商家必须同时集成异步通知和支付结果查询服务。因为某些钱包在支付失败时可能不会返回通知，因此，同时集成这两种服务可以确保从任何钱包获取支付结果。

支付完成后，支付宝服务器会发送异步通知，告知商家相应的支付结果。然而，对于某些钱包，支付失败时可能不会发送异步通知。异步通知也不保证100%送达。

因此，可能出现用户完成支付但商家未收到支付结果的情况。为了避免这种情况，商家必须集成支付结果查询服务，以轮询方式不断查询支付结果。

建议如下方式使用异步通知和支付结果查询服务：
![Image 11: 图片](https://cdn.nlark.com/yuque/0/2021/png/561635/1619061903693-545f78ce-8cd7-4a54-8a83-763289bf7bbf.png)
图9. 使用异步通知和支付结果查询服务获取支付结果

*   商户需要在数据库中维护一个订单表，至少包含两个字段：订单号和订单状态。
*   异步通知：商户需要监听支付宝的异步通知，并在接收到通知时作出响应。然后检查数据库中的订单状态：
    *   如果订单状态为INIT（初始化），根据异步通知更新订单状态。
    *   如果订单状态不是INIT，说明已经通过查询获取了最终的支付结果，并已相应地更新了订单状态。无需采取进一步行动。
*   查询：商户需要主动轮询方式查询支付结果。
    *   在每次查询之前，商户需要检查数据库中的订单状态。
        *   如果订单状态为INIT，发起查询。如果获取到最终支付结果，更新数据库中的订单状态，否则继续轮询过程。
    *   如果订单状态不是INIT，说明已经进行了查询操作，并获取了最终支付结果，用于更新订单状态。无需采取进一步行动。
### 支付异步通知  
商户在集成[notifyPayment](https://global.alipay.com/docs/ac/ams/paymentrn_online)接口后，支付宝会根据以下规则将用户的支付结果通知给商户：  
- 如果支付成功，会立即向商户发送异步通知。
- 如果支付失败，会在1分钟的支付宝支付超时后向商户发送异步通知。
- 如果用户未支付，也会在1分钟的支付宝支付超时后向商户发送异步通知。

收到异步通知后，商户需要立即向支付宝返回SUCCESS，无需数字签名。这个消息表示支付通知已成功接收。示例代码如下：  
```json
{
  "result": {
    "resultCode": "SUCCESS",
    "resultStatus": "S",
    "resultMessage": "success"
  }
}
```
如果商户未对异步通知向支付宝发送上述响应，或者由于网络原因商户的响应未能成功送达支付宝，支付宝会在24小时内自动重试最多8次，直到收到正确的响应。重试发送间隔如下：  
0分钟，2分钟，10分钟，10分钟，1小时，2小时，6小时，15小时

需要正确理解[notifyPayment](https://global.alipay.com/docs/ac/ams/paymentrn_online)请求中的字段：  
*   `_notifyType_`: 在此情况下，值为PAYMENT_RESULT。
*   `_result.resultStatus_`: 该字段表示订单的支付结果。可能的值包括：
    *   S: 表示支付成功。
    *   F: 表示支付失败，具体原因在resultCode字段中说明。
    
注意：表示未知状态的值U，在此接口中不使用。
*   _支付请求ID（paymentRequestId）_: 由商家分配，用于识别每个独特的请求。
*   _支付ID（paymentId）_: 支付宝分配的唯一标识符，用于识别一笔支付。
*   _支付金额（paymentAmount）_: 表示用户支付的金额。商家可以使用此字段的值来对比金额。
*   _支付创建时间（paymentCreateTime）_: 表示支付创建的时间。
*   _支付完成时间（paymentTime）_: 表示支付完成的时间。如果支付失败，此字段不会返回。
### 查询请求
商家在调用[支付](https://global.alipay.com/docs/ac/ams/payment_cashier)接口完成支付后，或者在收到支付请求响应后1分钟内未收到支付结果通知时，可以使用[查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online)接口查询支付结果。以下是对[查询支付](https://global.alipay.com/docs/ac/ams/paymentri_online)接口中需要正确理解的字段：

**请求字段**：
*   _paymentRequestId_：此字段由商家分配，用于标识每个唯一的请求。建议在查询过程中使用此字段。

**响应字段**：
*   _result_：此字段仅表示查询请求的调用状态，不表示支付状态。
*   _paymentStatus_：此字段表示订单的支付状态。只有当result.resultStatus的值为S时，才会返回此字段。该字段的值可能为：
    *   SUCCESS：表示支付成功。这是一个最终支付状态，商家可以停止查询流程。
    *   FAIL：表示支付失败。这也是一个最终支付状态，商家可以停止查询流程。
    *   CANCELLED：表示支付已取消。这是一个最终支付状态，商家可以停止查询流程。
    *   PROCESSING：表示支付仍在处理中。这是一个中间支付状态。当返回此值时，商家需要以轮询方式继续查询流程，直到获取到最终支付状态或收到异步通知。轮询时间应至少持续1分钟（支付宝的支付超时时间）。

### （如果需要）取消交易
---------------------
如果商家处理的支付场景有特定的交易关闭时间，必须集成[取消](https://global.alipay.com/docs/ac/ams/paymentc_online)接口。商家在以下情况下可以发起支付取消：

1. 支付成功后且在可取消期内。取消不收取费用，但通常可取消期只有一天。
2. 支付过程中，轮询过程无法获取最终支付结果。商家可以通过调用[取消](https://global.alipay.com/docs/ac/ams/paymentc_online)接口来终止交易，以保持用户和商家端的交易状态一致。

在[取消](https://global.alipay.com/docs/ac/ams/paymentc_online)接口中，需要正确理解以下字段：

**请求中的字段**：

*   `paymentRequestId`：由商家分配，用于标识每个唯一请求。建议在取消流程中使用此字段。

**响应中的字段**：

*   `result.resultStatus`：此字段表示取消结果：
    *   S：表示取消成功。
    *   F：表示取消失败。根据`resultCode`采取进一步行动。
    *   U：表示取消结果未知。使用相同的请求参数重试取消请求。如果商家连续三次调用取消请求仍得到U，联系支付宝技术支持。
*   `paymentId`：由支付宝分配，用于标识每个唯一请求。
*   `paymentRequestId`：由商家分配，用于标识每个唯一请求。
*   `cancelTime`：支付取消成功的时间。

**退款**：
（此处应有退款相关的内容，但原文缺失，需要补充）
对于成功支付的交易，商家可以通过调用[**退款**](https://global.alipay.com/docs/ac/ams/refund_online)接口或在商家后台手动发起退款。退款期限由合同规定，通常为12个月。请求URL可选择以下之一：

* 沙箱端点：/ams/sandbox/api/v1/payments/refund
* 生产端点：/ams/api/v1/payments/refund

![图片12: 图片1.png](https://cdn.nlark.com/yuque/0/2021/png/12884741/1638433898889-e430d45c-82d8-4fb2-8645-02df65b3e1f7.png)

图10. 退款流程

**返回值处理：**

* 如果没有返回响应，必须使用与前次请求相同的字段再次调用接口。
* 如果返回了响应，`response.result.resultStatus` 的值指示退款状态：
  * `S`：表示退款成功。
  * `U`：表示退款状态不确定。您必须使用与原始请求相同的字段再次调用接口。您可以再次使用与原始请求相同的字段调用退款接口，或者调用查询退款接口以获取原始退款请求的最终状态。
  * `F`：表示退款失败。需要采取的进一步行动由`resultCode`字段指示。例如，如果返回的结果代码为`MERCHANT_BALANCE_NOT_ENOUGH`，则表示待结算的商家余额不足，即商家待结算余额小于退款金额。因此，商家需要等待产生新的成功支付，待结算余额大于交易的退款金额，然后重新发起退款流程。重新发起退款时，request.refundRequestId 的值必须更新。
响应中的`refundAmount`表示退款金额，可用于对账。

**注意**：

退款与取消交易的区别：
1. 退款和取消的期限由合同规定。默认情况下，退款期为12个月，取消期为1天。
2. 退款过程会产生费用，而取消交易则不收取费用。
3. 退款仅适用于已成功支付的交易。取消则用于交易未收到最终成功或失败支付结果，且商家需要放弃交易的情况。
4. 退款过程支持部分退款，而取消过程会取消整个交易。

关于支付金额和货币
------------------

API 和对账报告中都存在与货币相关的数据字段。其中一个字段是通过`amount`字段表示的支付金额。`amount`字段有子字段`currency`和`value`，所有支付宝API或报告中的货币字段遵循相同的定义。

**金额**

| **字段** | **描述** |
| --- | --- |
| currency | **必填** 字符串 (3)：遵循[*ISO 4217*](https://www.iso.org/iso-4217-currency-codes.html)标准的3字母货币代码。 |
| value | **必填** 字符串 (16)：以正整数形式表示的最小货币单位金额。 (即，100分表示$1.00，或100表示JPY 100，零小数货币)。 |

表7. `amount`字段的子字段。

**注意**：
`amount`字段中`value`字段的实际值以货币的**最小单位**表示。支付宝遵循[*ISO 4217*](https://en.wikipedia.org/wiki/ISO_4217)标准定义货币的最小单位。

不同货币的最小单位
--------------------------------------
| **货币代码** | **最小单位（小数点后位数）** | **金额表示** |
| --- | --- | --- |
| USD | 分（2） | 1.00 USD 应设置为 "value:100" |
| PHP | 分（2） | 1.00 PHP 应设置为 "value:100" |
| IDR | 分（2） | 1.00 IDR 应设置为 "value:100" |
| KRW | 元（0） | 1 KRW 应设置为 "value:1" |
| THB | 分（2） | 1.00 THB 应设置为 "value:100" |
| HKD | 分（2） | 1.00 HKD 应设置为 "value:100" |
| MYR | 分（2） | 1.00 MYR 应设置为 "value:100" |
| CNY | 分（2） | 1.00 CNY 应设置为 "value:100" |
| BDT | 分（2） | 1.00 BDT 应设置为 "value:100" |
| PKR | 分（2） | 1.00 PKR 应设置为 "value:100" |
表 8. 货币详细信息

最小支付或退款金额
--------------------------------
每个钱包的最小支付或退款金额不同。下表显示了每个钱包的最小支付或退款金额详情。

| **钱包** | **详情** |
| --- | --- |
| TrueMoney 钱包 | * 该钱包允许的最小支付金额为 1 THB。 * 该钱包允许的最小退款金额为 1 THB。 |
| Alipay HK 钱包 | * 对于自动扣款支付，该钱包允许的最小支付金额为 0.01 HKD。 * 对于自动扣款支付，该钱包允许的最小退款金额为 0.01 HKD。 * 对于收银员支付，该钱包允许的最小支付金额为 0.1 HKD。 * 对于收银员支付，该钱包允许的最小退款金额为 0.1 HKD。 |
| Touch'n Go 钱包 | * 该钱包允许的最小支付金额为 0.1 MYR。 * 该钱包允许的最小退款金额为 0.1 MYR。 |
| Gcash 钱包 | * 该钱包允许的最小支付金额为 1 PHP。 * 该钱包允许的最小退款金额为 1 PHP。 |
| Dana 钱包 | * 允许的最低支付金额为 300 IDR。 * 允许的最低退款金额为 300 IDR。 |
| --- | --- |
| bKash 钱包 | * 允许的最低支付金额为 0.01 BDT。 * 允许的最低退款金额为 0.01 BDT。 |
| EasyPaisa 钱包 | * 允许的最低支付金额为 100 PKR。 * 允许的最低退款金额为 100 PKR。 |
| KakaoPay 钱包 | * 允许的最低支付金额为 50 KRW。 * 允许的最低退款金额为 50 KRW。 |
表 9. 不同钱包的最低支付或退款金额。  
要查看文档的最新更新，请访问 [发行说明](https://global.alipay.com/docs/releasenotes)。  
![图片 13](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片 14](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  

#### 这个页面有帮助吗？  

#### 本页内容  
[字段和定义](#2euG8 "字段和定义")  
[整体流程](#Lwa8I "整体流程")  
[授权](#2ow3q "授权")  
[授权体验](#B0kRL "授权体验")  
[关于访问令牌](#7zF4S "关于访问令牌")  
[访问令牌创建](#r2mPH "访问令牌创建")  
[刷新访问令牌](#2ZKcc "刷新访问令牌")  
[失效访问令牌](#nEjNj "失效访问令牌")  
[自动扣款支付](#VFFMV "自动扣款支付")  
[调用支付接口](#Zvx3X "调用支付接口")  
[处理支付结果](#474zB "处理支付结果")  
[支付异步通知](#VSogc "支付异步通知")  
[查询](#B8FBx "查询")  
[取消交易（如有需要）](#TKBPQ "取消交易（如有需要）")  
[退款](#56hJ3 "退款")
关于支付金额和货币
----------------

### 不同货币的最小单位

### 各种货币的最小单位

### 最低支付或退款金额

### 最低支付或退款金额说明