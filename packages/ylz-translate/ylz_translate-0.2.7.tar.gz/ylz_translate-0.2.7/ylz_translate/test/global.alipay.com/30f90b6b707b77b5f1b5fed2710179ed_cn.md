集成 | 智能餐厅 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Frestaurant%2Frestaurantintegration)  
[返回首页](../../)  

智能餐厅
[Introduction](/docs/ac/restaurant/restaurantintroduction)  
[Integration](/docs/ac/restaurant/restaurantintegration)  
[API 列表](/docs/ac/restaurant/restaurantapi)  

集成
==========

2021-03-04 04:43

以下部分解释如何设计您的系统并集成支付宝。

系统架构
--------------

支付宝餐厅解决方案可以设计为三个模块：前端、后端和数据分析层。每个模块包含提供相应服务的具体功能。以下系统架构示例展示了如何设计扫码、点餐和支付系统：

![图片3：示例图像](https://cdn.nlark.com/yuque/0/2020/png/561635/1587708782013-d08d415e-7849-472b-960e-79ef5cd0c852.png)

*   **前端：** 包含多个底层组件，以确保用户友好的界面。预点餐、点餐、营销和送餐部分可以设计，为顾客提供便捷的餐厅服务入口。需要电子菜单来支持在线点餐服务。餐厅POS系统和独立平板电脑用于结账。云服务、对象存储和负载均衡也是应考虑的功能组件。
*   **后端：** 包含至少菜单系统、订餐系统、支付系统和其他处理业务逻辑的信息技术系统。还需要提供云服务。
*   **数据分析器：** 包含处理客户数据和销售数据的模块，以及可定制的几个子模块。
**支付宝可以为以下模块提供技术支持：**
*   **数字菜单：** 可以使用支付宝提供的接口 [a](https://global.alipay.com/doc/solution_api/oauth_token)[lipay.system.oauth.token](https://global.alipay.com/doc/global/oauth_token) 获取用户ID，用于数字菜单模型中识别不同用户订购的菜品。
*   **餐厅POS系统和独立平板：** 支付宝可以为餐厅POS系统和独立平板模块提供支付接口，以收集付款。
*   **支付系统：** 直接或通过收单网关间接连接到支付宝网关。
*   **销售数据：** 支付宝可以为商家提供销售数据进行进一步分析。
*   **业务分析、市场营销、流程优化、用户研究、行业趋势：** 支付宝可以提供交易数据和市场营销相关数据，以支持这些模块。
*   **云服务器、对象存储、负载均衡、大数据平台：** 阿里巴巴集团有许多成熟的产品和服务，可以支持这些模块的功能。
**与支付宝集成**
-----------------------

在集成之前，您需要创建一个支付宝账户和一个支付宝应用。此外，还需要配置开发环境和密钥。在正式上线前，可以在沙箱环境中测试集成。以下内容提供了一些集成过程的关键信息。有关集成的更多详细信息，请联系全球商户技术支持：[overseas\_support@service.alibaba.com](mailto:overseas_support@service.alibaba.com)。
### 准备账户信息  
获取用于生产环境的APPID：  
1. 检查您是否已提交公司信息并完成了验证。如果没有，请联系支付宝全球商户技术支持寻求帮助。
2. 访问支付宝开放平台，并在提示时输入您的全球支付宝账户凭据。
3. 在左上角点击**创建应用**按钮以创建新应用。按照指示提供所需信息。
4. 应用成功创建后，选择该应用，然后点击**查看**。在**概览**标签页下，您可以查看APPID、密钥等信息。此外，您还可以配置如authRedirect URL等其他设置。  

获取用于沙箱环境的测试APPID：  
1. 检查您是否已提交公司信息并完成了验证。如果没有，请联系支付宝全球商户技术支持寻求帮助。
2. 访问支付宝开放平台，并在提示时输入您的全球支付宝账户凭据。
3. 在顶部导航栏中，点击**开发者中心** > **研发服务** > **沙箱应用**。在右侧窗格中查看APPID和其他应用详情。
### 准备密钥  
生成数字签名通常需要一个密钥来签署数据。您必须准备MD5私钥，或者RSA/RSA2的私钥和公钥对，以便生成和验证数字签名。
### 实现API接口

为了集成支付宝系统以提供特定服务，可以通过向支付宝发送HTTP/HTTPS请求调用支付宝API，并在发送请求前使用密钥对请求进行签名。

以下序列图展示了商家、机构和支付宝如何协同工作，为客户提供服务的概览。

![图片4：智能餐厅 出租车.png](https://cdn.nlark.com/yuque/0/2020/png/561635/1596510038696-dfe97dd7-f666-4afa-80a1-badcbad6ee4a.png)

1. 客户打开支付宝应用，扫描合作伙伴提供的二维码，访问合作伙伴提供的页面。
2. 当合作伙伴服务器处理HTTP请求时，可以通过HTTP请求头中的User-Agent值识别来自支付宝钱包的请求。然后，合作伙伴服务器将用户重定向到支付宝授权页面，并在请求参数中指定回调页面URL。
3. 支付宝授权页面立即（用户不会注意到页面跳转）将用户重定向到合作伙伴的回调页面，附带auth\_code。使用auth\_code，调用[alipay.system.oauth.token](https://global.alipay.com/doc/global/oauth_token) API获取支付宝用户ID，然后将支付宝用户ID记录到会话中。之后，合作伙伴渲染支付页面。
4. 用户在支付页面上输入支付金额，然后提交给合作伙伴服务器处理。使用存储在会话中的支付宝用户ID和其他必需参数，合作伙伴调用[alipay.acquire.create](https://global.alipay.com/doc/global/acquire_create) API创建订单，然后将返回的支付宝交易号回传给H5页面。
5. 在H5页面中，合作伙伴使用JavaScript语言调用[jsapi:tradepay](https://global.alipay.com/doc/global/jsapitradepay)接口，使用交易号请求支付。
6. 支付宝应用程序提示用户确认订单并付款。用户输入密码以完成支付。
7. 支付成功后，支付宝向合作伙伴发送异步通知。
8. 同时，支付宝通过消息通知用户支付成功。

**授权过程**
授权过程是为了获取创建支付订单所需的 _user_id_ 参数。要获取 _user_id_，请执行以下步骤：
1. 配置账户信息
2. 配置回调URL
3. 获取支付宝用户ID
有关详细信息，请参阅[如何获取支付宝 user_id](https://global.alipay.com/doc/common/obtain_uid)。使用的API：[**alipay.system.oauth.token**](https://global.alipay.com/doc/global/oauth_token)

**支付过程**
完成授权过程后，将渲染支付页面。顾客将被提示输入支付金额并提交进行后续处理。

1. **服务器端创建支付订单：** 使用获取到的支付宝用户ID和其他必需参数，通过调用支付宝API来创建支付订单。返回的支付宝交易号将在下一步中使用。
   使用的API：[**alipay.acquire.create**](https://global.alipay.com/doc/global/acquire_create)
2. **渲染支付宝内购页面：** 要显示支付宝内购支付页面，用户确认支付并输入密码付款，需要调用支付宝的 **jsapi.tradePay** API，传入返回的支付宝交易号。
   使用的API：[**jsapi.tradePay**](https://global.alipay.com/doc/global/jsapitradepay)
### 在沙箱环境中测试
沙箱是一个环境，允许您模拟生产环境的特性，并在应用程序上线前对所有依赖的API创建模拟响应。您可以根据自己的需求进行API测试，包括发起交易、取消交易或退款交易等。
### 正式上线  
当您在沙箱环境中完成测试并准备正式上线时，可以通过更换网关、PID和密钥为真实值来切换到生产环境。  

#### 异常处理
-   **超时或系统错误**
    网络状况不稳定时，QUERY和REFUND接口请求可能会出现超时错误。同时，支付宝可能会因内部系统问题返回SYSTEM\_ERROR。这两种情况下，您可以重试或查询以与支付宝的最终交易状态保持一致。
    在集成阶段需要设计处理此类错误的机制。如果在生产环境中出现此类错误，应触发合作伙伴的报警机制，并进行调查以解决问题。
-   **业务错误**
    业务错误需要以收银员易于理解的方式表达。此外，需要培训收银员处理这些错误或向顾客解释错误。
    
要查看文档的最新更新，请访问[发行说明](https://global.alipay.com/docs/releasenotes)。
    
![图片5](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片6](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  

#### 本页面是否有帮助？  

#### 本页面内容  
-   [系统架构](#ae52c2ef "系统架构")
-   [集成支付宝](#2dcdb0ad "集成支付宝")
-   [准备账户信息](#253f23ff "准备账户信息")
-   [准备密钥](#593eaf6b "准备密钥")
-   [实现API](#b5b168ba "实现API")
-   [沙箱环境测试](#2480d56a "沙箱环境测试")
-   [正式上线](#c41c7a16 "正式上线")
-   [异常处理](#8fe3bb19 "异常处理")