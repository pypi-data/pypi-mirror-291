支付继续URL配置最佳实践 | 结账支付 | 支付宝文档
==================

[![图片1：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/d66c43c0-440d-4c97-9976-f2028a2c8c5e.svg)![图片2：中国领先的第三方在线支付解决方案 - 支付宝](https://ac.alipay.com/storage/2024/3/26/a48bd336-aea0-4f16-bf83-616eacbb4434.svg)](/docs/)

[登录](https://global.alipay.com/ilogin/account_login.htm?goto=https%3A%2F%2Fglobal.alipay.com%2Fdocs%2Fac%2Fcashierpay%2Fredirection)  
[返回首页](../../)  

结账支付  
[概览](/docs/ac/cashierpay/overview)  
接收支付  
支付后操作  
支付方式  
其他资源  
高级功能  
[预前端解决方案API](/docs/ac/cashierpay/prefront)  
[先买后付API](/docs/ac/cashierpay/bnpl)  
[卡存储API](/docs/ac/cashierpay/cv)  
[卡存储SDK](/docs/ac/cashierpay/cvsdk)  
[卡支付功能API/SDK](/docs/ac/cashierpay/mf)  
支付继续URL配置最佳实践
==========================

2023年12月28日 08:32

调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API后，根据所使用的支付方式，API响应中会返回不同类型的支付继续URL。本文档提供了针对不同客户端类型使用支付继续URL的最佳实践。有关每种支付方式返回的支付继续URL的详细信息，请参阅[某些支付方式返回的URL](https://global.alipay.com/docs/ac/cashierpay/urls)。

支付继续URL参数
=================
对于不同的商家客户端类型（Web、WAP、App），在调用[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 的响应中，不同的支付方式会返回以下三种支付继续URL中的一种或全部，以进行支付流程。

| 类型 | 描述 |
| --- | --- |
| normalUrl | 一个HTTPS地址的URL，用于在同一个浏览器页面上重定向到支付方式的网站页面。示例：<https://msp.boost-my.com/onlinepayment/authorise?source=alipay-connect&codeValue=https%3A%2F%2Fglobal.alipay.com%2F2810020400931LFH2t2mq1jjJ8zSetyv31VU> |
| applinkUrl | 用于支付过程中重定向的Android App Link或iOS Universal Link。示例：<https://myboost.app.link/IvWm7QZkfjb?%24fallback_url=https%3A%2F%2Fmsp.boost-my.com%2Fonlinepayment%2Fauthorise&source=alipay-connect&codeValue=https%3A%2F%2Fglobal.alipay.com%2F2810020400931LFH2t2mq1jjJ8zSetyv31VU> |
| schemeUrl | 用于打开支付方式应用的scheme URL。示例：boostapp://inAppDeeplink?deeplink_path=deeplink/onetimepayment&source=alipay-connect&codeValue=https%3A%2F%2Fglobal.alipay.com%2F2810020400931LFH2t2mq1jjJ8zSetyv31VU |

**注意事项**：

1.  使用上述链接发起支付时，如果买家未安装支付方式应用，重定向过程中可能会出现异常。请妥善处理任何异常情况。
2.  有些支付方式返回的URL不能多次使用。如果使用URL未能成功调起支付页面，建议使用新的_paymentRequestId_值获取URL并重新调起支付页面。
除了URL重定向方法，[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API响应可能对某些支付方式包含_orderCodeForm_字段。该字段值包含二维码或支付码信息，可用于在您的网站上显示代码，从而在您的网站内实现无缝支付流程。有关此解决方案的更多信息，请参阅[自定义结账方案](https://global.alipay.com/docs/ac/cashierpay/custom_checkout)。

Web
---

对于计算机网站上的支付，[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API响应会返回_normalUrl_。

打开URL
-------

获取到_normalUrl_值后，需要使用支付继续URL将买家重定向到支付页面。建议在新标签页中打开URL，引导买家完成支付。打开新页面的代码如下：

```javascript
if (serverResponse.normalUrl != null) {
  window.open(serverResponse.normalUrl, '_blank');
}
```

用户体验
--------

使用_normalUrl_渲染的支付页面可能是二维码扫描页或登录页。以下是两种情况下的支付流程图：

| **二维码扫描页** | 收银台扫码.png |
| --- | --- |
| **登录页** | 收银台登录.png |

WAP
---

对于移动网站上的支付，[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API响应可能包含以下一个或多个URL：

*   _normalUrl_
*   _applinkUrl_
*   _schemeUrl_

选择URL
-------

如果[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API响应仅包含三个URL中的一个，直接将接收到的URL用作重定向链接。如果收到多个URL，建议按照以下指导选择URL：

*   对于iOS系统：优先使用_applinkUrl_，然后是_schemeUrl_，最后是_normalUrl_。
对于Android系统：优先使用_schemeUrl_，其次使用_applinkUrl_，最后使用_normalUrl_。  
打开URL
----------------
要使用JavaScript的重定向方法打开URL，请使用以下代码：
```javascript
window.location.href = URL;
```
用户体验
-------------

| 类型 | 支付体验 |
| --- | --- |
| normalUrl | 买家从您的移动网页被重定向到支付方式的移动网页。买家在支付方式移动网页上看到的内容取决于支付方式，可以分为以下两类：* 登录页面：后续支付过程在支付方式的移动网页内完成。 ![手机浏览器](手机浏览器.png)* 引导买家点击按钮启动支付方式应用。后续支付过程在支付方式应用内完成。 ![app支付](app支付.png)* 显示支付口令。买家复制口令并在支付方法应用中付款。 ![支付口令](支付口令.png)* 显示二维码。买家扫描二维码并在支付方法应用中付款。 ![支付二维码](支付二维码.png) |
| applinkUrl | 后续支付过程会根据买家是否安装了支付方式应用自动确定：* 如果买家已安装支付方式的应用：应用会被打开，买家在应用内完成支付过程。 ![applink](applink.png)* 如果买家未安装支付方式的应用：移动网页会被打开，买家根据移动网页上的指示继续支付过程。此过程在默认浏览器中打开并渲染。 ![applink2](applink2.png) |
| schemeUrl | 支付体验取决于买家是否安装了支付方式的应用：* 买家已安装支付方式应用：应用会被打开，买家在应用内完成支付流程。 ![schemeurl1.png](schemeurl1.png)* 买家未安装支付方式应用：无法通过此URL启动应用，买家可能停留在当前页面，无法继续支付流程。 ![schemeurl2.png](schemeurl2.png) |  
**APP**
-------

对于移动应用中的支付，[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 的响应可能包含以下一个或多个 URL：

*   _normalUrl_
*   _applinkUrl_
*   _schemeUrl_

> **注意**：对于移动应用支付，除了上述提到的重定向 URL 参数外，[**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 的响应还包含 _appIdentifier_ 参数。此参数是对应支付方式应用的包名，用于判断是否已安装应用以进行应用内支付。在 Android 中，它也可用于避免歧义对话框。

**选择 URL**
------------

如果 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) API 响应只包含三个 URL 中的一个，直接将接收到的 URL 用作重定向链接。如果你收到多个 URL，建议按照以下指导选择：

*   对于 iOS 系统：优先使用 _applinkUrl_，然后是 _schemeUrl_，最后是 _normalUrl_。
*   对于 Android 系统：优先使用 _schemeUrl_，然后是 _applinkUrl_，最后是 _normalUrl_。

**打开 URL**
------------

对于 Android 和 iOS，使用以下方法打开支付继续的 URL：

| **iOS** | **Android** |
| --- | --- |
| * 应用外部重定向：调用iOS方法来打开支付继续的URL。 * 应用内部重定向： + 使用WKWebView + 使用WKWebView和JSBridge + 使用SafariViewController * 根据支付方式应用是否已安装，选择在应用外部或内部打开支付继续的URL。 | * 应用外部重定向：调用Android方法来打开支付继续的URL。 * 应用内部重定向： + 使用WKWebView + 使用WKWebView和JavascriptInterface + 使用Custom Tabs插件 * 根据支付方式应用是否已安装，选择在应用外部或内部打开支付继续的URL。 |

这段文档描述的是在iOS和Android平台上处理支付流程的重定向策略。在iOS上，可以调用特定方法在应用外部打开URL，或者在应用内部使用WKWebView、WKWebView与JSBridge或SafariViewController来实现。在Android上，同样可以选择应用外部重定向，或者使用WKWebView、WKWebView与JavascriptInterface或Custom Tabs插件。重定向的选择取决于用户是否已安装支付方式的应用。
### 每种重定向方法的优缺点
每种重定向方法都有其优点和缺点。建议您根据操作系统和集成场景选择最适合的重定向方法。

| **重定向方法** | | **描述** |
| --- | --- | --- |
| 应用外部重定向：调用Android/iOS方法打开支付继续的URL。 | | **支付宝推荐此方法。*** 优点：集成成本低。一次性集成适用于所有支付方式。 * 缺点：支付流程不完全在您的客户端内完成。 |
| 应用内部重定向 | * WKWebView * WebView | WKWebView/WebView是内置控件，可以在应用中嵌入一个网络浏览器。可以用来加载网站链接。* 优点：可以为买家定制更好的支付体验。通过在应用内重定向买家，实现无缝支付体验，即买家无需离开您的应用，即可在应用内完成后续支付流程。 * 缺点：需要更多的开发和测试工作。 |
| * WKWebView+JSBridge * WebView+JavascriptInterface | 基于WKWebView/WebView的升级解决方案。使用JSBridge/JavascriptInterface后，可以直接在WebView中调用Android/iOS方法打开支付继续的URL。* 优点：相比WKWebView/WebView，性能、可扩展性和安全性有所提升。为买家提供定制的支付体验。 * 缺点：需要更多的开发和测试工作。 |
| * SafariViewController * 自定义标签页 | 由iOS/Android提供，在应用内打开支付继续的URL，功能比WebView更全面。* 优点：可以与系统浏览器集成，与系统浏览器共享如cookies的能力。集成相对简单。 * 缺点：不支持自定义支付体验。 |
| 根据支付方式应用是否已安装，选择在应用外部或内部打开支付继续的URL。 | | 根据支付方式应用的安装情况，提供不同的重定向方法。* 优点：为购买者提供友好的支付体验。 * 缺点：需要更多的开发和测试工作。 |
### 代码示例（iOS）
#### 方法1：调用iOS方法打开支付继续URL
以下代码示例展示了如何使用iOS系统中的方法，将买家从您的应用重定向到支付应用进行支付。
```swift
if ([[[UIDevice currentDevice] systemVersion] floatValue] >= 10.0) {
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:Url] options:@{} completionHandler:nil];
} else {
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:Url]];
}
```
#### 方法2：在应用内打开支付继续URL
要在您的应用内打开支付继续URL，可以使用以下URL类型：
*   normalUrl
*   applinkUrl

**注意**：某些支付方式不支持在移动网页上支付。打开`normalUrl`会触发通过重定向调用相应的支付方式应用，而WKWebView会拦截这个重定向。您需要使用WKWebView的`decidePolicyForNavigationAction`方法并调用iOS方法来打开支付继续URL，以实现从您的WKWebView到支付方式应用的重定向。

##### 使用WKWebView
以下代码示例展示了如何在iOS应用中使用WKWebView加载支付方式页面：
```swift
// 初始化webView配置
WKWebViewConfiguration *configuration = [[WKWebViewConfiguration alloc]init];
// 初始化webView
WKWebView *webView = [[WKWebView alloc]initWithFrame:CGRectMake(0, 0, [UIScreen mainScreen].bounds.size.width, [UIScreen mainScreen].bounds.size.height) configuration:configuration];
webView.navigationDelegate = self;
// 加载支付方法URL
[webView loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:Url]]];
[self.view addSubview:self.webView];
```
以下代码示例展示了如何使用WKWebView的`decidePolicyForNavigationAction`方法实现从您的WKWebView到支付方式应用的重定向：
```swift
- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler {
    if (navigationAction.request.URL) {
        // 检查URL是否需要重定向到支付应用
        if (/* 判断URL是否需要重定向 */) {
            // 调用iOS方法打开URL
            [[UIApplication sharedApplication] openURL:navigationAction.request.URL options:@{} completionHandler:nil];
            decisionHandler(WKNavigationActionPolicyCancel); // 阻止WKWebView加载
        } else {
            decisionHandler(WKNavigationActionPolicyAllow); // 允许WKWebView加载
        }
    }
}
```
请注意，您需要根据实际的URL判断逻辑替换`/* 判断URL是否需要重定向 */`部分的代码。
```swift
- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler{
    // WKWebView 默认拦截重定向，以下方式允许重定向
    // 操作如打开 Safari
    NSURL *url = navigationAction.request.URL;
    NSString *absoluteUrlString = url.absoluteString;
    NSString *scheme = url.baseURL.scheme;
    DLog(@"navigationAction.request.URL.absoluteString=====> %@", absoluteUrlString);
    
    if ([absoluteUrlString isEqualToString:@"about:blank"]) {
        decisionHandler(WKNavigationActionPolicyCancel);
    }
    
    if (!([absoluteUrlString containsString:@"https://"] || [absoluteUrlString containsString:@"http://"])) {
        if ([absoluteUrlString containsString:@"://"]) {
            NSString *urlHeader = [absoluteUrlString componentsSeparatedByString:@"://"][0];
            [MBProgressHUD showAutoMessage:[NSString stringWithFormat:@"Scheme\n%@://", urlHeader] toView:self.view];
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                [self openAppWithUrlStr:navigationAction.request.URL];
                decisionHandler(WKNavigationActionPolicyAllow);
            });
        }
    } else {
        decisionHandler(WKNavigationActionPolicyAllow);
    }
}
```

### 使用WKWebView和JSBridge

通过WKWebView和JSBridge，可以优化买家的支付体验，但需要强大的开发能力。结合JSBridge和通过WKWebView打开URL，有利于项目的维护和扩展性，同时提升性能和安全性。JSBridge使得网页和原生应用之间能进行交互，允许WAP页面直接调用应用的原生方法。以下代码展示了如何在WKWebView中使用JSBridge：

```swift
[self.wkWebView evaluateJavaScript:bridge completionHandler:nil];
```

### 使用SFSafariViewController

SFSafariViewController 提供了一种在应用内以Safari浏览器的样式加载网页内容的方式，它提供了更好的用户体验，特别是在处理登录和支付等敏感信息时。使用SFSafariViewController可以保持用户在应用内的体验，同时利用Safari的浏览器功能和安全性。
SFSafariViewController 支持打开和渲染 _normalUrl_、_applinkUrl_ 以及 _schemeUrl_。相比 WebView，它具有更全面的功能和更简单的集成。要了解如何使用 SFSafariViewController 打开支付延续 URL，请参阅 [SFSafariViewController](https://developer.apple.com/documentation/safariservices/sfsafariviewcontroller) 用户指南。以下代码示例展示了如何使用 SFSafariViewController：

```swift
SFSafariViewController *safariVC = [[SFSafariViewController alloc] initWithURL:Url entersReaderIfAvailable:NO];
safariVC.delegate = self;
[self.navigationController presentViewController:safariVC animated:YES completion:nil];
```

#### 方法 3：根据支付应用是否已安装处理重定向

首先需要判断买家是否已安装支付应用，然后根据情况处理支付延续 URL 的打开方式。步骤如下：

1. 在 `info.plist` 的配置中添加 _LSApplicationQueriesSchemes_。请注意，`info.plist` 中的方案数量有限制。
2. 使用 `canOpenURL` 方法判断支付应用是否已安装。参考以下代码：

```swift
NSString *walletSchemeUrl = @"gcash://";  
if ([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:walletSchemeUrl]]){
    // 支付应用已安装。直接打开应用。
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:Url] options:@{} completionHandler:nil];  
    return YES;
} else {
    // 支付应用未安装。建议在 WebView 中加载移动网站。
    SFSafariViewController *safariVC = [[SFSafariViewController alloc] initWithURL:Url entersReaderIfAvailable:NO];
    safariVC.delegate = self;
    [self.navigationController presentViewController:safariVC animated:YES completion:nil];  
    return NO;
}
```

请注意，这里的代码示例是用 Swift 编写的，但根据上下文，您可能需要将其转换为 Objective-C 或其他编程语言，具体取决于您的项目需求。
### 代码示例 (Android)
#### 方法1：调用Android方法打开支付继续URL
以下代码示例展示了如何使用Android方法打开支付继续URL，从而实现从您的应用重定向到支付应用的流程。

```java
try {
    Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(Url));
    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
    // 使用startActivity函数重定向到钱包应用
    startActivity(intent);
} catch (Exception e) {
    e.printStackTrace();
}
```
使用这种方法可能会导致出现歧义对话框。

**什么是歧义对话框**
Android App Link在安装应用时会向Google服务器请求验证。如果验证失败，Android App Link将变得无效，当买家尝试通过此类链接打开应用时，会出现一个歧义对话框。买家需要手动选择如何打开链接。

| 当买家点击Android App Link时，会出现一个示例歧义对话框。用户需要手动选择如何打开链接：使用Google Maps还是Google浏览器。 | 1632448161329-0aef337a-b4eb-4700-a8d0-042ca36658e4.png |
| --- | --- |

**防止出现歧义对话框**
当出现歧义对话框时，买家需要手动选择打开应用的方式，这可能影响支付成功率。因此，您需要采取以下措施（根据需要）来防止歧义对话框的出现：

* 如果买家已经安装了支付方式应用，指定支付方式的包名并打开支付方式的URL。
* 如果买家未安装支付方式应用，使用以下示例代码打开URL。

```java
Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(applinkUrl));
intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
```
// 指定支付方式的包名
intent.setPackage(walletPackageName);
PackageManager packageManager = MainActivity.this.getPackageManager();
// 检查是否有支持打开此链接的应用
List<ResolveInfo> activities = packageManager.queryIntentActivities(intent, 0);
if (activities.size() <= 0) {
// 支付方式应用未安装。初始化Intent对象，此链接将由默认的Android方法打开。
intent = new Intent(Intent.ACTION_VIEW, Uri.parse(applinkUrl));
intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
startActivity(intent);
} else {
// 支付方式应用已安装。指定支付方式的包名并打开支付方式URL，不会出现选择对话框。
startActivity(intent);
}  
> 注意：某些支付方式的_packageName_ 示例如下：
>
> *   AlipayHK: hk.alipay.wallet
> *   GCash: com.globe.gcash.android
> *   TrueMoney: th.co.truemoney.wallet
> *   KakaoPay: com.kakao.talk
> *   Touch 'n Go: my.com.tngdigital.ewallet
> *   Dana: id.dana  
#### 方法2：在应用内打开支付继续URL  
要在应用内打开支付继续URL，使用WebView加载_normalUrl_ 或_applinkUrl_ 作为移动网站：
*   _normalUrl_
*   _applinkUrl_  
> **注意**：某些支付方式不支持在移动网站上支付。打开_normalUrl_ 会通过重定向调用相应的支付方式应用，而WKWebView会拦截重定向。您需要使用WKWebView的`shouldOverrideUrlLoading`方法，并调用Android方法来打开支付继续URL，以实现从WKWebView到支付方式应用的重定向。
##### 使用WebView  
以下代码示例展示了如何在WebView中加载支付方式页面。
```java
WebView webView = findViewById(R.id.webview);
// 设置WebView
webView.setWebViewClient(new WebViewClient() {
    @Override
```
```java
public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {
    view.loadUrl(request.getUrl().toString());
    return super.shouldOverrideUrlLoading(view, request);
}});  
WebSettings webSettings = webView.getSettings();
// 启用JavaScript
webSettings.setJavaScriptEnabled(true);
// 启用缩放
webSettings.setSupportZoom(true);
// 启用缩放控件（按钮）
webSettings.setBuiltInZoomControls(true);
// 禁用WebView使用缓存
webSettings.setCacheMode(WebSettings.LOAD_NO_CACHE);
// 允许JavaScript自动打开新标签页（默认为false）
webSettings.setJavaScriptCanOpenWindowsAutomatically(true);
// 启用JavaScript加载本地存储
webSettings.setDomStorageEnabled(true);
// WAP缓存大小（无需设置）
// webSettings.setAppCacheMaxSize(1024 * 1024 * 8);
// WAP缓存路径
String absolutePath = getApplicationContext().getCacheDir().getAbsolutePath();
// WAP缓存大小
webSettings.setAppCachePath(absolutePath);
// 设置是否允许WebView访问文件（默认为true）
webSettings.setAllowFileAccess(true);
// 启用WAP缓存保存
webSettings.setAppCacheEnabled(true);
// 预览模式下，如果页面宽度超过WebView显示范围，缩小页面以适应WebView（默认为false）
webSettings.setLoadWithOverviewMode(true);
// 支持视口HTML元标签
webSettings.setUseWideViewPort(true);
// 加载支付方法URL
webView.loadUrl(Url);  
// 为WebView设置WebViewClient，使用`WebViewClient.shouldOverrideUrlLoading`方法拦截URL，调用相应的Android方法。参考以下代码示例：
```
```markdown
# 蚂蚁金服支付集成指南

## 使用Intent启动第三方应用

```java
Intent intent = new Intent();
intent.setData(Uri.parse("your_payment_url"));
try {
    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
    view.getContext().startActivity(intent);
} catch (URISyntaxException e) {
    // 提示不支持的协议
}
return false;
}
```

> **注意**：如果您的应用有可重定向应用的白名单，请正确配置白名单，考虑与旧版本的兼容性，并减少应用发布次数。

## 使用WebView和JavascriptInterface

这种方法优化了买家的支付体验，但需要较强的研发能力。推荐在WebView中使用JavascriptInterface来实现Android应用和WebView之间的双向通信，让网页可以直接调用应用的原生方法，增强应用的灵活性和功能，有利于后续的维护和升级。以下是如何在WebView中使用JavascriptInterface的示例：

1. 在WebView中声明JavascriptInterface

```java
@JavascriptInterface
public void openActivity(String url) {
    // 根据需要添加代码
    try {
        Intent intent = Intent.parseUri(url, Intent.URI_INTENT_SCHEME);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        context.startActivity(intent);
    } catch (Exception e) {
        Toast.makeText(context, "App not installed", Toast.LENGTH_SHORT).show();
    }
}
```

2. 将JavascriptInterface添加到WebView

```java
mWebView.addJavascriptInterface(this, "bridge");
```

3. 使用以下代码打开支付继续URL

```javascript
window.bridge.openActivity("Url");
```

## 使用自定义标签（Custom Tabs）

Custom Tabs 支持打开和渲染 _normalUrl_、_applinkUrl_ 和 _schemeUrl_。相比WebView，它具有更全面的功能和更简单的集成。以下是如何使用Custom Tabs的示例：

1. 在 `build.gradle` 文件中添加Custom Tabs依赖

```groovy
dependencies {
    ...
    implementation 'androidx.browser:browser:1.3.0' // 或者使用最新版本
    ...
}
```

2. 初始化并使用Custom Tabs

```java
CustomTabsIntent customTabsIntent = new CustomTabsIntent.Builder().build();
customTabsIntent.launchUrl(context, Uri.parse("your_payment_url"));
```

通过以上方法，您可以根据项目需求选择合适的支付集成方式，以提供流畅的用户体验。
```
```kotlin
// 引入 androidx 浏览器库
implementation "androidx.browser:browser:1.4.0"
```
2. 使用自定义标签（Custom Tabs）在应用中打开一个 Chrome 标签页。
```java
// 使用 CustomTabsIntent.Builder 配置 CustomTabsIntent
// 使用 CustomTabsIntent.Builder.build() 创建 CustomTabsIntent
// 使用 CustomTabsIntent.launchUrl() 启动 URL
CustomTabsIntent.Builder builder = new CustomTabsIntent.Builder();
CustomTabsIntent customTabsIntent = builder.build();
customTabsIntent.launchUrl(this, Uri.parse(url));
```
有关如何使用 CustomTabs 打开 URL 的更多信息，请参阅 [自定义标签用户指南](https://developer.chrome.com/docs/android/custom-tabs/)。

#### 方法 3：根据支付方式应用是否安装处理重定向

首先，您需要确定买家是否已安装支付方式应用，然后相应地处理支付继续 URL 的打开方式。请按照以下步骤操作：

1. 为了遵循 Android 系统的隐私和安全政策，需要在 `AndroidManifest.xml` 中添加 `<queries>` 标签，以确保支付继续 URL 可以调用相应的支付方式应用。需要在 `<queries>` 标签中配置支付方式应用的包名。您可以从支付宝 [**pay**](https://global.alipay.com/docs/ac/ams/payment_cashier) 响应返回的 `appIdentifier` 参数中获取相应值，或联系支付宝技术支持获取。
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="com.llw.scandemo">
...
<queries>
    <package android:name="th.co.truemoney.wallet" />
    <package android:name="com.eg.android.AlipayGphone" />
    <package android:name="my.com.tngdigital.ewallet" />
    ...
</queries>
...
</manifest>
```
2. 检查支付方式应用是否已安装并调用支付页面：
```java
String Url = "applinkUrl/schemeUrl";
try {
```
请注意，文档中未提供完整的 `try` 块内容。通常，您会在 `try` 块内使用 `PackageManager` 检查应用是否已安装，然后根据安装状态选择使用 `Intent` 打开 URL 或使用其他方法（如 Custom Tabs 或内置浏览器）。例如：
```java
PackageManager pm = getPackageManager();
if (isPackageInstalled(Url, pm)) {
    // 应用已安装，直接启动
    Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(Url));
    startActivity(intent);
} else {
    // 应用未安装，使用 Custom Tabs 或其他方式打开
    customTabsIntent.launchUrl(this, Uri.parse(Url));
}

// 检查应用是否已安装的辅助方法
private boolean isPackageInstalled(String packageName, PackageManager pm) {
    try {
        pm.getPackageInfo(packageName, 0);
        return true;
    } catch (PackageManager.NameNotFoundException e) {
        return false;
    }
}
```
请根据实际需求完成 `try` 块内的代码。
意图 intent = new Intent(Intent.ACTION_VIEW, Uri.parse(Url));
intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
intent.setPackage("my.com.tngdigital.ewallet");
// 检查支付应用是否已安装
PackageManager packageManager = MainActivity.this.getPackageManager();
List<ResolveInfo> activities = packageManager.queryIntentActivities(intent, 0);  
if (activities.size() <= 0) {
// 支付应用未安装。建议在WebView中打开移动网站URL。
intent = new Intent(MainActivity.this, WebviewActivity.class);
intent.setData(Uri.parse(Url));
startActivity(intent);
} else {  
// 支付应用已安装。直接打开支付应用。
startActivity(intent);
}
} catch (Exception e) {
// 处理异常
e.printStackTrace();
}  
用户体验
-----------

不同支付链接打开方式对应的支付流程如下：

| **重定向方法** | **支付流程** |
| --- | --- |
| 应用外部重定向：调用Android/iOS方法打开支付继续的URL。 | 应用外部重定向。支付流程取决于买家是否已安装支付方式应用：* **已安装**：从你的应用重定向到支付方式应用。买家选择支付方式后，通过支付宝返回的`schemeUrl`或`applinkUrl`直接启动支付方法应用，买家在支付方法应用中完成支付。  ![app1.png](app1.png)* **未安装**：从你的应用重定向到默认浏览器。 + **默认浏览器中支付**：买家选择支付方式后，通过支付宝返回的`normalUrl`或`applinkUrl`从你的应用重定向到默认浏览器中的支付页面，买家在此页面完成支付。  ![appd2.png](appd2.png)+ **支付方式应用中支付**：买家选择支付方式后，通过支付宝返回的`normalUrl`或`applinkUrl`从你的应用重定向到默认浏览器中的支付页面，支付页面会启动支付方式应用，买家在支付方法应用中完成支付。  ![app3.png](app3.png) |
| 应用内重定向支付 | 支付体验有两种类型：从您的应用外部重定向和在您的应用内部重定向。* **支付方式应用支付（从应用外部重定向）：**买家选择支付方式后，通过支付宝返回的*normalUrl*或*applinkUrl*，他们从您的应用被重定向到WebView中的支付页面。支付页面会启动支付方式的应用，买家在支付方式应用中完成支付。  ![应用内支付](应用内.png)* **WebView支付（在应用内部重定向）：**买家选择支付方式后，通过支付宝返回的*normalUrl*或*applinkUrl*，他们从您的应用被重定向到应用内的WebView支付页面，并在此页面上完成支付。  ![应用内支付2](应用内2.png) |
### 最佳实践  
建议您根据不同的支付方式设定支付继续URL的配置，或者根据支付方式、设备环境和URL类型进行路由。以下是一个基于不同支付方式的固定配置示例：  
![图片19: 打开链接.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1692185554471-ed9470f8-75d8-40ce-a87c-4f82b7762e80.png)  
对于每种支付方式，我们建议您根据以下逻辑确定打开支付继续URL的方法：  
![图片20: app2.png](https://idocs-assets.marmot-cloud.com/storage/idocs87c36dc8dac653c1/1694511248343-6af99c10-ebfa-4d97-ab83-8bf5261ed06f.png)  
要查看文档的最新更新，请访问[版本说明](https://global.alipay.com/docs/releasenotes)。  
![图片21](https://ac.alipay.com/storage/2021/5/20/19b2c126-9442-4f16-8f20-e539b1db482a.png) ![图片22](https://ac.alipay.com/storage/2021/5/20/e9f3f154-dbf0-455f-89f0-b3d4e0c14481.png)  
@2024 支付宝 [法律信息](https://global.alipay.com/docs/ac/platform/membership)  

#### 这个页面有帮助吗？  

#### 本页面内容  
[支付继续URL参数](#wGxyV "支付继续URL参数")  
[Web](#P9Fiw "Web")  
[打开URL](#FLe0c "打开URL")  
[用户体验](#HkreT "用户体验")  
[WAP](#FH33G "WAP")  
[选择URL](#BMKoi "选择URL")  
[打开URL](#BcQ7m "打开URL")  
[用户体验](#PoBZZ "用户体验")  
[APP](#eK0wp "APP")  
[选择URL](#6z5bs "选择URL")  
[打开URL](#fFC1f "打开URL")  
[每种重定向方法的优缺点](#lSqKX "每种重定向方法的优缺点")  
[代码示例（iOS）](#GnZMZ "代码示例（iOS）")  
[方法1：调用iOS方法打开支付继续URL](#vlgjI "方法1：调用iOS方法打开支付继续URL")
**方法2：在应用内打开支付继续URL**

**方法3：根据支付方式应用是否已安装处理重定向**

**代码示例（Android）**

**方法1：调用Android方法打开支付继续URL**

**方法2：在应用内打开支付继续URL**

**方法3：根据支付方式应用是否已安装处理重定向**

**用户体验**

**最佳实践**