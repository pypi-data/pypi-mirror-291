{% load i18n %}
{% load humanize %}
{% load static %}

<div role="tabpanel" class="tab-pane fade" id="tab-open-requests">
    <div class="table-responsive">
        <table class="table table-striped table-hover requests" id="requests" style="width: 100%;">
            <thead>
                <tr>
                    <th class="col-id" style="width: 5%;"></th>
                    <th class="col-order" style="width: 10%;">{% translate "Order List" %}</th>
                    <th class="col-requester" style="width: 20%;">{% translate "Requestor" %}</th>
                    <th class="col-status" style="width: 5%;">{% translate "Status" %}</th>
                    <th class="col-date" style="width: 20%;">{% translate "Created" %}</th>
                    <th class="col-action" style="width: 20%;">{% translate "Action" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="col-id"></td>
                    <td class="col-order"></td>
                    <td class="col-requester"></td>
                    <td class="col-status"></td>
                    <td class="col-date"></td>
                    <td class="col-action"></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add this modal structure to your HTML file -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script>
var orderData;

function initializeRequests(tableId, url) {
    return $(tableId).DataTable({
        'ajax': {
            'url': url,
            'dataSrc': function(json) {
                // Store the data in a global variable
                orderData = json;
                return json;
            }
        },
        'columns': [
            {
                'data': 'id',
                'render': function(data, type, row) {
                    return data;
                }
            },
            {
                'data': 'order',
                'render': function(data, type, row) {
                    return '<button type="button" class="btn btn-info" onclick=\'showOrderDetails(`' + data + '`)\'><span class="fas fa-info"></span></button>';
                }
            },
            {
                'data': 'requestor',
                'render': function(data, type, row) {
                    return data;
                }
            },
            {
                'data': 'status',
                'render': function(data, type, row) {
                    return data;
                }
            },
            {
                'data': 'created',
                'render': function(data, type, row) {
                    return moment(data).format('L LT');
                }
            },
            {
                'data': null,
                'render': function(data, type, row) {
                    return '';
                }
            }
        ],
        'order': [[4, 'desc']],
        'pageLength': 25,
        'autoWidth': false,
        'columnDefs': [
            { 'sortable': false, 'targets': [0, 5] },
        ],
    });
}

function showOrderDetails(data) {
    // Parse the JSON string
    var jsonData = JSON.parse(data);

    // Initialize an empty HTML string
    var html = '';

    // Iterate through each entry in the JSON data
    jsonData.forEach(function(entry) {
        // Extract the required fields
        var item_id = entry.item_id;
        var name = entry.name;
        var quantity = Number(entry.quantity);

        // Append the formatted data to the HTML string
        html += '<div class="d-flex justify-content-between align-items-center">';
        html += '<img class="card-img-zoom" src="https://imageserver.eveonline.com/types/' + item_id + '/icon/?size=32" height="32" width="32"/>';
        html += '<span>' + name + ':</span> <span class="text-end">' + quantity.toLocaleString() + ' {% translate "pieces" %}</span>';
        html += '</div><br>';
    });

    // Set the HTML content of the modal body
    document.getElementById('orderModalBody').innerHTML = html;

    // Show the modal
    var orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
    orderModal.show();
}

document.addEventListener('DOMContentLoaded', function () {
    urlRequests = '/assets/api/requests/';
    // Initialisieren Sie die DataTable f√ºr assets
    assets = initializeRequests('#requests', urlRequests);
});

</script>
